<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="upload-labs1"><meta name="keywords" content="文件上传"><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>upload-labs1 | Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">文件上传漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%9B%A0"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">成因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A7%E7%94%9F%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">产生条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B3"><span class="toc-number">1.0.0.3.</span> <span class="toc-text">危害</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs1"><span class="toc-number">1.1.</span> <span class="toc-text">upload-labs1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs2"><span class="toc-number">1.2.</span> <span class="toc-text">upload-labs2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#move-uploaded-file-%E5%87%BD%E6%95%B0%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">move_uploaded_file()函数漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upload-labs3"><span class="toc-number">1.2.1.</span> <span class="toc-text">upload-labs3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">黑名单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs-4"><span class="toc-number">1.3.</span> <span class="toc-text">upload-labs 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs5"><span class="toc-number">1.4.</span> <span class="toc-text">upload-labs5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs6"><span class="toc-number">1.5.</span> <span class="toc-text">upload-labs6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs7"><span class="toc-number">1.6.</span> <span class="toc-text">upload-labs7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs8"><span class="toc-number">1.7.</span> <span class="toc-text">upload-labs8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs9"><span class="toc-number">1.8.</span> <span class="toc-text">upload-labs9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs10"><span class="toc-number">1.9.</span> <span class="toc-text">upload-labs10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs11"><span class="toc-number">1.10.</span> <span class="toc-text">upload-labs11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs12"><span class="toc-number">1.11.</span> <span class="toc-text">upload-labs12</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-number">1.11.0.1.</span> <span class="toc-text">白名单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%AA%E6%96%AD%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.11.0.2.</span> <span class="toc-text">截断上传</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs13"><span class="toc-number">1.12.</span> <span class="toc-text">upload-labs13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs14"><span class="toc-number">1.13.</span> <span class="toc-text">upload-labs14</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.13.0.1.</span> <span class="toc-text">文件包含漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%EF%BC%9A"><span class="toc-number">1.13.0.1.1.</span> <span class="toc-text">拓展：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84pathinfo%E6%BC%8F%E6%B4%9E-%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.13.0.1.2.</span> <span class="toc-text">web服务器的pathinfo漏洞(文件解析漏洞)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs15"><span class="toc-number">1.14.</span> <span class="toc-text">upload-labs15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs16"><span class="toc-number">1.15.</span> <span class="toc-text">upload-labs16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs17"><span class="toc-number">1.16.</span> <span class="toc-text">upload-labs17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs18"><span class="toc-number">1.17.</span> <span class="toc-text">upload-labs18</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.17.0.1.</span> <span class="toc-text">条件竞争漏洞:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%93%E5%B1%95"><span class="toc-number">1.17.0.2.</span> <span class="toc-text">拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.17.0.2.1.</span> <span class="toc-text">参数污染漏洞</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs19"><span class="toc-number">1.18.</span> <span class="toc-text">upload-labs19</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs20"><span class="toc-number">1.19.</span> <span class="toc-text">upload-labs20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload-labs21"><span class="toc-number">1.20.</span> <span class="toc-text">upload-labs21</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.21.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">180</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">upload-labs1</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-12-17</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="文件上传漏洞原理"><a href="#文件上传漏洞原理" class="headerlink" title="文件上传漏洞原理"></a>文件上传漏洞原理</h1><h4 id="成因"><a href="#成因" class="headerlink" title="成因"></a>成因</h4><p>1.服务器配置不当会导致任意文件上传<br>2.web应用开放了文件上传的功能，并对上传的文件没有进行足够的限制和过滤<br>3.web应用开放了文件上传功能，虽然在开发时加入了一定的过滤功能，但并不严格，可以被绕过<br>4.上传文件时如果服务端代码未对客户端上传的文件进行严格的验证和过滤，就容易造成可以上传任意文件的情况，包括上传脚本文件（asp、aspx、php、jsp等格式的文件）。<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36119192/article/details/84593150">https://blog.csdn.net/qq_36119192/article/details/84593150</a><br>上面这个是关于那几个后缀的文件的说明                            <a id="more"></a></p>
<h4 id="产生条件"><a href="#产生条件" class="headerlink" title="产生条件"></a>产生条件</h4><p>1.web服务器要开启文件上传功能，并且上传API（接口）对外开放，即web用户可以访问；<br>2.web用户对目标目录具有可写权限，甚至具有执行权限，一般情况下，web目录都具有执行权限；<br>3.我们上传的文件在服务器的系统环境里能够正常运行，即web容器能够解析我们上传的脚本，不论脚本以什么样的形式存在。</p>
<h4 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h4><p>恶意的脚本文件，又被称为webshell，webshell脚本称为一种网页后门，webshell脚本具有非常强大的功能，比如查看服务器目录、服务器中的文件、执行系统命令等<br><strong>导图</strong></p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210105224221.png" alt="img"><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2435?spm=5176.12901015.0.i12901015.74b5525csqU5p2">https://xz.aliyun.com/t/2435?spm=5176.12901015.0.i12901015.74b5525csqU5p2</a></p>
<h2 id="upload-labs1"><a href="#upload-labs1" class="headerlink" title="upload-labs1"></a>upload-labs1</h2><p>步骤其实很简单，之前在学一句话木马的时候已经有学习过了<br>流程是：在txt文本中写下一句话代码——&gt;将后缀改为jpg等图片格式的后缀——&gt;然后上传，在上传的时候抓包，在burp里面将后缀修改为php，使其在后面能够被运行——&gt;然后利用蚁剑等工具连接一句话木马即可。<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201219214436.png" alt="img" style="zoom:67%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201219214607.png" alt="img"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201219214709.png" alt="img"></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201219215012.png" alt="img" style="zoom:50%;">
将后缀改为php 并发送 然后在蚁剑中连接
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201219215148.png" alt="img" style="zoom:67%;">

<p>好了 成功了<br>以上为方法一，我们可以在burp中修改后缀，从而达到注入的效果<br>这里就简述一下吧，因为之前打过一遍了忘记保存印象还挺深刻的：<br>方法二：<br>我们在index.php看到一个chekfile的过滤函数，然后再show_code里面看到一个JavaScript写的网页代码，我们可以知道，PHP中的代码在JavaScript中发挥作用，而在审查元素中我们可以看到JavaScript的函数调用<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201224183709.png" alt="img" style="zoom:67%;"><br>当我们把他删除掉后，也就不存在过滤这一说，直接上传即可了<br>方法三，直接禁用JavaScript函数调用<br>思考：PHP，JavaScript的联动操作</p>
<h2 id="upload-labs2"><a href="#upload-labs2" class="headerlink" title="upload-labs2"></a>upload-labs2</h2><p>第二关提示中说对MIME进行检查<br><strong>什么是MIME？</strong>使用MIME (Multipurpose Internet Mail Extensions) 是描述消息内容类型的因特网标准，使用MIME类型可以设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。</p>
<p>在JSP页面中，contentType属性设置为：contentType=“text/html;charset=GBK”。</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201224174432.png" alt="img" style="zoom:67%;">

<p>所以这里有两种方法：<br><strong>1.**：我们还是上传jpg然后抓包更改后缀为php，因为这个时候MIME-Type已经变为image/jpeg避开过滤了<br>**2.**我们也可直接修改MIME-Type中的类型，将其修改为image/jpeg<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201224180855.png" alt="img"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201224181619.png" alt="img" style="zoom:67%;"><br>依旧是可以成功的<br>接着看一下源代码<br>**move_uploaded_file()函数</strong><br>将上传的文件移动到新的位置<br>语法：<br>move_uploaded_file(file,newloc)</p>
<table>
<thead>
<tr>
<th>file</th>
<th>必需。规定要移动的文件。</th>
</tr>
</thead>
<tbody><tr>
<td>newloc</td>
<td>必需。规定文件的新位置。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>newloc</th>
<th>必需。规定文件的新位置。</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="move-uploaded-file-函数漏洞"><a href="#move-uploaded-file-函数漏洞" class="headerlink" title="move_uploaded_file()函数漏洞"></a>move_uploaded_file()函数漏洞</h4><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201224171842.png" alt="img" style="zoom:67%;">

<h3 id="upload-labs3"><a href="#upload-labs3" class="headerlink" title="upload-labs3"></a>upload-labs3</h3><h4 id="黑名单"><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h4><p><strong>基于黑名单验证：只针对黑名单中没有的后缀名，文件才能上传成功。</strong><br>从这里开始 我们就进入了黑名单的关卡：<br>看看代码吧<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20201231010952.png" alt="img" style="zoom:67%;"><br>因为已经写过一遍我就大概说一下：<br>他是定义一组后缀名，然后对于传输过去的文件，经过删除文件名末尾的点，从文件的点开始向后截取，<br>以及将文件名全部转化成小写，最后移除旁边的空格。<br>其中strrchr()函数的作用就是搜素并窃取搜索点及以后的位置<br>他禁用了挺多的类型的后缀的但是，我们还可以使用其他后缀进行绕过<br><strong>phtml,php3,php4,php5,pht</strong></p>
<h2 id="upload-labs-4"><a href="#upload-labs-4" class="headerlink" title="upload-labs 4"></a>upload-labs 4</h2><p>在这一关中 将很多php的拓展形式都过滤了<br>这个时候我们需要引进一个.htaccess文件<br><strong>作用</strong>：<br>htaccess文件时Apache服务器中的一个配置文件，负责相关目录下网页配置，可以帮我们实现网页301重定向，自定义404错误页面，改变文件扩展名等功能，其中.htaccess文件内容:<strong>SetHandler application/x-httpd-php</strong>设置当前目录所有文件都使用PHP解析，无论上传任何文件，只要符合php语言代码规范，就会被当做php文件执行。<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/cmzhuang/article/details/53537591%EF%BC%88%E6%B7%B1%E5%B1%82%E7%90%86%E8%A7%A3%E5%8D%9A%E5%AE%A2%EF%BC%89">https://blog.csdn.net/cmzhuang/article/details/53537591（深层理解博客）</a></p>
<p><strong>上传.htaccess文件</strong><br>文件内容如下：<br>SetHandler application/x-httpd-php<br><strong>PS：</strong>这里需要将上传的文件不用前缀 即.htaccess<br>指定文件进行php的转化：<br>在写入.htaccess的时候，我们可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;shuaige&quot;&gt;</span><br><span class="line">SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>写出这段代码，注意到开头”shuaige”意为含有文件内含有shuaige的文件都会被解析为php文件<br>这里要使用这个.htaccess要记得去apache里面配置一下</p>
<h2 id="upload-labs5"><a href="#upload-labs5" class="headerlink" title="upload-labs5"></a>upload-labs5</h2><p>在这关当中，我们注意到，他过滤空格和.只过滤了一次，所以我们可以通过构建123.php. .的形式进行绕过过滤</p>
<h2 id="upload-labs6"><a href="#upload-labs6" class="headerlink" title="upload-labs6"></a>upload-labs6</h2><p>在第六关中，发现他是没有对大小写进行过滤的<br>所以我们</p>
<p>在后缀做点手脚即可 然后抓包改回即可</p>
<h2 id="upload-labs7"><a href="#upload-labs7" class="headerlink" title="upload-labs7"></a>upload-labs7</h2><p>在第七关中没有去空，所以可以在后缀加个空格，然后抓包改回</p>
<h2 id="upload-labs8"><a href="#upload-labs8" class="headerlink" title="upload-labs8"></a>upload-labs8</h2><p>这关是在文件后加个. 在windows系统中，会自动把.给删除掉，所以可以先抓包加个.绕过过滤，然后文件上传到目录后，.会自动被删除</p>
<h2 id="upload-labs9"><a href="#upload-labs9" class="headerlink" title="upload-labs9"></a>upload-labs9</h2><p>在window的时候如果文件名+<code>&quot;::$DATA&quot;</code>会把<code>::$DATA</code>之后的数据当成文件流处理,不会检测后缀名，且保持<code>::$DATA</code>之前的文件名，他的目的就是不检查后缀名<br>然后我们点击上传图像后的文件，点击查看图像，删除后面的::$DATA即可<br>此时有个问题，为什么文件上传后，文件名变成随机数字了呢？<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210114192735.png" alt="img" style="zoom:67%;"><br>原因就在这<br>一开始猜测是有其他保护机制，查看源码 果然如此<br>但是修改后的文件名可以</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210105232428.png" alt="img"><br>使用burp 的go后 可以查找得到</p>
<h2 id="upload-labs10"><a href="#upload-labs10" class="headerlink" title="upload-labs10"></a>upload-labs10</h2><p>这一题和第五题的解题方法是一样的，但是注意到它的源码有些地方不太一样了<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210114192146.png" alt="img" style="zoom:67%;"><br>就是他的路径变成是直接加file.name，感觉还是上一个保护机制更强一些，虽然用处也不大哈哈哈</p>
<h2 id="upload-labs11"><a href="#upload-labs11" class="headerlink" title="upload-labs11"></a>upload-labs11</h2><p>首先来分析一下源码<br>其中有一个<br><strong>str_ireplace()</strong></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210115165321.png" alt="img" style="zoom:67%;">
它的作用是这样的：将file_name中符合deny_ext格式的全部替换成空
而在上面 它是将两边的空格全部去掉，所以我们其实可以使用**双写**的方式进行绕过：
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210115165633.png" alt="img" style="zoom:67%;">
上传成功
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210115165852.png" alt="img" style="zoom:67%;">
并且可以成功显示
这就让人联想到sql绕过过滤了。

<p>为什么要采取替换为空的方式？<br>因为如果为空后缀 是不符合格式，直接就上传失败了</p>
<h2 id="upload-labs12"><a href="#upload-labs12" class="headerlink" title="upload-labs12"></a>upload-labs12</h2><h4 id="白名单"><a href="#白名单" class="headerlink" title="白名单"></a>白名单</h4><p><strong>基于白名单验证：只针对白名单中有的后缀名，文件才能上传成功。</strong></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210115171230.png" alt="img" style="zoom:67%;">

<p>前面 都是对于文件后缀名的过滤，首先是使用substr()和strrpos()截取后缀进行白名单匹配，这里没什么能操作的空间，再往下看，看到一个在img_path中 file_ext是可控的！<br>这里就要介绍一下</p>
<h4 id="截断上传"><a href="#截断上传" class="headerlink" title="截断上传"></a>截断上传</h4><p>前提条件：php 版本 &lt; 5.3.4且php的参数magic_quotes_gpc必须关闭</p>
<p>在url中<code>%00</code>表示ascll码中的0 ，而ascii中0作为特殊字符保留，表示字符串结束，所以当url中出现%00时就会认为读取已结束，而忽略后面上传的文件或图片，只上传截断前的文件或图片<br>一下为例子：</p>
<p>此时</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path=<span class="string">&quot;upload/web/&quot;</span></span><br><span class="line">file=<span class="string">&quot;1.jpg&quot;</span></span><br></pre></td></tr></table></figure>

<p>此时如果我将路径改为，path=”upload/web/1.php%00”,那么拼接上去之后就变成”upload/web/1.php%001.jpg”，那么此时就相当于是上传的是1.php，而1.jpg的jpg被截断了，其实类似于mysql的注释符吧</p>
<p>注意下这里是get形式上传的</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://bealright.github.io/2019/08/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E2%80%94%E2%80%94upload-labs(11-20)/">https://bealright.github.io/2019/08/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E2%80%94%E2%80%94upload-labs(11-20)/</a></p>
<h2 id="upload-labs13"><a href="#upload-labs13" class="headerlink" title="upload-labs13"></a>upload-labs13</h2><p>这一题和上一题没多大区别，依旧参数可控，不过上一题是get形式，而这题是POST<br>那么<strong>区别是什么呢？</strong>：<br>因为post不会像get对%00进行自动解码，所以需要用16进制进行解码<br>这里我们可以将burpsuit抓包以后将其发送至decoder，将php后的16进制码改为00即可<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210115190436.png" alt="img" style="zoom:67%;"><br>将20改为00即可<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210115190540.png" alt="img" style="zoom:67%;"><br>补充一张截图，这里的a只是为了说明空格的位置，空格其实也可以替换为其他的，因为我们后面会将这个位置的内容换成00，后面的内容均会被截断</p>
<h2 id="upload-labs14"><a href="#upload-labs14" class="headerlink" title="upload-labs14"></a>upload-labs14</h2><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210115192248.png" alt="img" style="zoom:67%;">
分析源码，fopen为什么后面使用的是rb？
“r”，即文本读取模式，应该使用“rb”模式，也就是二进制读取模式打开文件。
发现他只读两个字节
unpack：从二进制字符串对数据进行解包（用什么打包就用什么解包），加@的原因就是让其怎么都可以执行不报错和一句话木马的那个一个意思
而这里的unpack的意思是 将$bin中的以二进制的形式解包输出到chars中。
而下面这个intval是转化十进制的意思，将本来输出的二进制再转化为十进制，接下来通过这个进行对比
**我一直在想如果是直接解析文件内容，都没解析后缀，怎么知道是什么文件，答案是这样的**
其实,文件对自身文件内容,有着自己的文件头标识,我们只需要文件转为16进制,然后看各个文件类型对文件头的定义,就可以知道文件的类型了,例如,jpeg图片格式的文件头(2byte)标识为:0xff, 0xd8,结尾(2byte)标识为:0xff,0xd9 
而转化为二进制再转化为十进制也是一样的
https://blog.csdn.net/LiuBuZhuDeFanHua/article/details/82949144
这里是一些图片文件头以及解码

<p>查阅了一些资料以后发现：<br>数据通信(通过二进制格式与其它语言通信)<br>数据加密(如果不告诉第三方你的打包方式，对方解包的难度就相对很大)<br>节省空间(比如比较大的数字按字符串储存会浪费很多空间，打包成二进制格式才需要4位&lt;32位数字&gt;</p>
<p>解题：<br>因为他只读文本的前两个字节来判断是否为图片形式，我们先上传图片，看看图片的前两个字节是什么<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210116104816.png" alt="img" style="zoom:67%;"><br>是这样的，那我们创建一个图片马试试</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ltysg0645/article/details/53996658">https://blog.csdn.net/ltysg0645/article/details/53996658</a><br>这是制作教程链接，这里采取的是使用cmd命令符窗口指令制作的方式<br>指令是： </p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy 1.png/b+1.php/a 12.png</span><br></pre></td></tr></table></figure>

<p>接下来上传文件<br>利用文件包含漏洞<br>在inlude.php界面，输入?file=路径+文件名<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210116122542.png" alt="img" style="zoom:67%;"></p>
<p>这样就是成功了</p>
<h4 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h4><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/182280.html">https://www.freebuf.com/articles/web/182280.html</a><br>在这里已经讲得很清楚了，就不重复赘述了<br>这里用我的话讲就是：<br>1.在PHP中含有<br>require()<br>require_once()<br>include()<br>include_once() 这几个函数的时候，可以通过文件包含函数加载另一个文件中的PHP代码<br>然后我们再来分析一下源码<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210116130248.png" alt="img" style="zoom:67%;"></p>
<p>get一个file，如果这个file存在就输出file的内容（这边使用了<strong>include函数</strong>）<br>而这里为什么图片里的php代码能被解析呢？<br>原因是，在混合代码html+php的框架下，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>文件内包含这个的内容会被解析并输出结果，但是如果不是PHP内容的则会直接原样输出。</p>
<h5 id="拓展："><a href="#拓展：" class="headerlink" title="拓展："></a>拓展：</h5><h5 id="web服务器的pathinfo漏洞-文件解析漏洞"><a href="#web服务器的pathinfo漏洞-文件解析漏洞" class="headerlink" title="web服务器的pathinfo漏洞(文件解析漏洞)"></a>web服务器的pathinfo漏洞(文件解析漏洞)</h5><p>文件解析漏洞,是指Web容器（Apache、Nginx、IIS等）在解析文件时将文件解析成脚本文件格式并得以执行而产生的漏洞。从而,黑客可以利用该漏洞实现非法文件的解析。（PS:全称是Internet信息服务（baiInternet Information Service，IIS）。是微软提供的一个zhiWeb服务程序，在开发中称之为Web容器）</p>
<p>web容器：web容器是一种服务程序，在服务器一个端口就有一个提供相应服务的程序，而这个程序就是处理从客户端发出的请求，如tomcat、apache、nginx等。(可以理解为编程语言提供环境)</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210117130704.png" alt="img" style="zoom:67%;">
https://www.anquanke.com/post/id/219107#h2-14

<h2 id="upload-labs15"><a href="#upload-labs15" class="headerlink" title="upload-labs15"></a>upload-labs15</h2><p>查看源码，发现他这次使用了一个<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210117135338.png" alt="img" style="zoom:67%;"><br>getimagesize获取文件后缀类型<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210117135948.png" alt="img" style="zoom:67%;"><br>——来自菜鸟教程<br>他的每个后缀都对应一个编号，png对应的就是3<br>这个时候就在想，如果他有多个后缀呢？<br>这个时候我们需要知道getimagesize他读取文件针对的是文件内容，也就是他会对目标文件内容转化而为16进制再去进行一个读取，而根据前面我们可以知道，不同文件类型他的16进制是不同的，在这题当中，我测试了.php.png .png.php的后缀，只要这个文件的本质是图片形式的，他最后上传后显示出来的后缀即为.png（图片）格式后缀的，我们看源码，他最后保存的路径，文件名即为</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210117190807.png" alt="img" style="zoom:67%;">

<p>看上面这个图，他说是前面的十位随机数+.$res的后缀，而这个后缀，就是我们前面通过读取这个图片的十六进制内容所得到的。</p>
<p>所以这题，我们还是直接使用图片马的形式上传就行，因为图片马前面的内容刚好可以绕过过滤（还是图片）。<br>然后先点击查看图片，看看这个随机生成的文件名是什么<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210117193528.png" alt="img" style="zoom:67%;"><br>知道以后就直接利用文件包含漏洞打开即可</p>
<p><strong>PS：</strong>这里有个神奇的东西<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210117193500.png" alt="img" style="zoom:67%;"><br>在一堆乱码中居然有一个小星星，哇哦哈哈哈哈哈</p>
<h2 id="upload-labs16"><a href="#upload-labs16" class="headerlink" title="upload-labs16"></a>upload-labs16</h2><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210117194503.png" alt="img" style="zoom:67%;">
首先是exit_imagetupe()函数：
这个函数也是用来检查是否为图片类型的，函数读取一个图像的第一个字节并检查其签名，如果发现了恰当的签名则返回一个对应的常量，否则返回 FALSE。返回值和 getimagesize() 的值是一样的，但该函数要快得多。
所以说还是图片马的事情嘛~
上传图片马
成功，这里就不放截图了

<h2 id="upload-labs17"><a href="#upload-labs17" class="headerlink" title="upload-labs17"></a>upload-labs17</h2><p>还是依旧分析一下源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="literal">false</span>;</span><br><span class="line">$msg = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></span><br><span class="line">    $filename = $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    $filetype = $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">    $tmpname = $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">     <span class="comment">//basename($...)获取文件名，如果是base($...,&quot;php&quot;)，获取无后缀的文件名</span></span><br><span class="line">    $target_path=UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.basename($filename);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得上传文件的扩展名</span></span><br><span class="line">    $fileext= substr(strrchr($filename,<span class="string">&quot;.&quot;</span>),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></span><br><span class="line">    <span class="keyword">if</span>(($fileext == <span class="string">&quot;jpg&quot;</span>) &amp;&amp; ($filetype==<span class="string">&quot;image/jpeg&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($tmpname,$target_path))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片，此处发挥功能的是imagecreatefromjpeg()函数，并且要让这个函数发挥作用，还需开启PHP组件中gd2</span></span><br><span class="line">            $im = imagecreatefromjpeg($target_path);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>($im == <span class="literal">false</span>)&#123;</span><br><span class="line">                $msg = <span class="string">&quot;该文件不是jpg格式的图片！&quot;</span>;</span><br><span class="line">   <span class="comment">//这里unlike删除原文件！！</span></span><br><span class="line">                @unlink($target_path);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                srand(time());</span><br><span class="line">                $newfilename = strval(rand()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                $img_path = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.$newfilename;</span><br><span class="line">                imagejpeg($im,$img_path);</span><br><span class="line">                <span class="comment">//这里unlike删除原文件！！</span></span><br><span class="line">                @unlink($target_path);</span><br><span class="line">                $is_upload = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">imagecreatefromgif()：创建一块画布，并从 GIF 文件或 URL 地址载入一副图像</span><br><span class="line">imagecreatefromjpeg()：创建一块画布，并从 JPEG 文件或 URL 地址载入一副图像</span><br><span class="line">imagecreatefrompng()：创建一块画布，并从 PNG 文件或 URL 地址载入一副图像</span><br><span class="line">imagecreatefromwbmp()：创建一块画布，并从 WBMP 文件或 URL 地址载入一副图像</span><br><span class="line">imagecreatefromstring()：创建一块画布，并从字符串中的图像流新建一副图像</span><br><span class="line">move_uploaded_file() 函数将上传的文件移动到新位置。</span><br></pre></td></tr></table></figure>

<p>有大神说：这里move_uploaded_file已经将图片马上传到服务器当中了，后面的二次渲染是不影响这个图片马的，所以说可以不管这个二次渲染，但是他后面有删除原文件的代码呀，最终上传到服务器的，也就只有二次渲染的文件，所以我也搞不懂为什么可以直接利用move_uploaded_file？原因就是他将第一个 @unlink($target_path); 给删除了</p>
<p>接下来我们就开始解题吧：<br>网上说gif的图比较好过 所以我们就照一张gif<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210118073218.png" alt="img" style="zoom:50%;"><br>对比我们的原图片，发现是这个位置的数据没有发生变化，所以我们就将木马插在这里，后面继续利用文件包含漏洞即可</p>
<h2 id="upload-labs18"><a href="#upload-labs18" class="headerlink" title="upload-labs18"></a>upload-labs18</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="literal">false</span>;</span><br><span class="line">$msg = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    $file_name = $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    $temp_file = $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    $file_ext = substr($file_name,strrpos($file_name,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    $upload_file = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . $file_name;</span><br><span class="line">    <span class="comment">//in_array() 函数搜索数组中是否存在指定的值。</span></span><br><span class="line">    <span class="comment">//rename() 函数重命名文件或目录</span></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file($temp_file, $upload_file))&#123;</span><br><span class="line">        <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">             $img_path = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.$file_ext;</span><br><span class="line">             rename($upload_file, $img_path);</span><br><span class="line">             $is_upload = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            unlink($upload_file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关需要代码审计，那就让我们康康代码将文件上传到服务器，然后进行判断，是否存在白名单后缀，如果存在的话，就保留下来，反之就使用unlink删除这个文件。<br>这题考的是条件竞争</p>
<h4 id="条件竞争漏洞"><a href="#条件竞争漏洞" class="headerlink" title="条件竞争漏洞:"></a>条件竞争漏洞:</h4><p>条件竞争漏洞是一种服务器端的漏洞，由于服务器端在处理不同用户的请求时是并发进行的，因此，如果并发处理不当或相关操作逻辑顺序设计的不合理时，将会导致此类问题的发生。</p>
<p>所以解题方向就是，<strong>在上传以后储存在服务器，到检查不通过的这段时间如果我们可以利用起来，就算后续他将文件删除了也无所谓，那么这段时间太短了，如何将其放大？那就利用burp的intruder，随便弄一个peyload让他在那边跑就行，然后我们在浏览器中直接访问该文件</strong></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210118122944.png" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210118122942.png" alt="img" style="zoom:67%;">
在观察文件再文件夹的状态时
![img](https://raw.githubusercontent.com/Hwwg/myphoto/master/20210118122943.png)
便发现他一直处于删除恢复的状态，此时需要注意的是，burp的线程需要设置得大一些。

<h4 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h4><h5 id="参数污染漏洞"><a href="#参数污染漏洞" class="headerlink" title="参数污染漏洞"></a>参数污染漏洞</h5><p>HTTP参数污染，也叫HPP（HTTP Parameter Pollution）。简单地讲就是给一个参数赋上两个或两个以上的值，由于现行的HTTP标准没有提及在遇到多个输入值给相同的参数赋值时应该怎样处理，而且不同的网站后端做出的处理方式是不同的，从而造成解析错误。<br><strong>即针对多个请求， 处理方式不同</strong><br>HPP漏洞的产生原因一方面来自服务器处理机制的不同，另一方面来自开发人员后端检测逻辑的问题。HTTP 参数污染的风险实际上取决于后端所执行的操作，以及被污染的参数提交到了哪里。总体上HPP一般有两种利用场景：<br> 1）逻辑漏洞，通常会造成IDOR，信息泄露，越权等漏洞;<br> 2）作为其他漏洞的辅助，用于绕过漏洞的检测和Waf等。<br>这个漏洞其实之前在sql-labs的时候就有遇到过了。<br>参考文章<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI3MTQyNzQxMA==&amp;mid=2247483892&amp;idx=1&amp;sn=bf1b7c8e6242a5b6c3ef2f6169df308b&amp;chksm=eac0b3c9ddb73adfac67da0512b172dbe0a4eda1fab4108646e9e3d714f9a72b927d259ed307&amp;scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzI3MTQyNzQxMA==&amp;mid=2247483892&amp;idx=1&amp;sn=bf1b7c8e6242a5b6c3ef2f6169df308b&amp;chksm=eac0b3c9ddb73adfac67da0512b172dbe0a4eda1fab4108646e9e3d714f9a72b927d259ed307&amp;scene=21#wechat_redirect</a></p>
<h2 id="upload-labs19"><a href="#upload-labs19" class="headerlink" title="upload-labs19"></a>upload-labs19</h2><p>这一关他让我们代码审计，发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ret = <span class="keyword">$this</span>-&gt;move();</span><br><span class="line">  <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check if we need to rename the file</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;cls_rename_file == <span class="number">1</span> )&#123;</span><br><span class="line">    $ret = <span class="keyword">$this</span>-&gt;renameFile();</span><br><span class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>本关对文件后缀名做了白名单判断，然后会一步一步检查文件大小、文件是否存在等等，将文件上传后，对文件重新命名，同样存在条件竞争的漏洞。可以不断利用burp发送上传图片马的数据包，由于条件竞争，程序会出现来不及rename的问题，从而上传成功</p>
<h2 id="upload-labs20"><a href="#upload-labs20" class="headerlink" title="upload-labs20"></a>upload-labs20</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        $file_name = $_POST[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</span><br><span class="line"> <span class="comment">//pathinfo将文件信息以数组的形式返回，这里返回的是后缀</span></span><br><span class="line">        <span class="keyword">if</span>(!in_array($file_ext,$deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123; </span><br><span class="line">                $is_upload = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $msg = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析源码：他是这样的，比对黑名单，如果后缀和黑名单里的不一样，那么就禁止保存，如果一样，则将文件名保存为上传时的文件的文件名（这是有分步骤的）。<br>这里就需要用到我们之前看过的move_uploaded_file()截断漏洞<br>思路：<br>上传一个jpg文件，内容为php代码，再上传过程中，由于最后保存的文件名我们可控，根据漏洞，将.jpg截断<br>即：</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210119215331.png" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210119215411.png" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210119215032.png" alt="img" style="zoom:67%;">

<h2 id="upload-labs21"><a href="#upload-labs21" class="headerlink" title="upload-labs21"></a>upload-labs21</h2><p>在这一关中需要代码审计<br>可以看到后面</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_array($ext, $allow_suffix)) &#123;</span><br><span class="line">           $msg = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           $file_name = reset($file) . <span class="string">&#x27;.&#x27;</span> . $file[count($file) - <span class="number">1</span>];</span><br><span class="line">           $temp_file = $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">           $img_path = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .$file_name;</span><br><span class="line">           <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">               $msg = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">               $is_upload = <span class="literal">true</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               $msg = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>前面的过滤绕过似乎都没有多大意义，毕竟后面还有白名单，但是这个判断条件就很奇怪，如果不是数组类型，则执行此判断，反之就不执行了？？？？那我们就将文件定名变成数组怎么弄呢？先往下看，他文件的命名也很有趣<br>1.reset()函数：指向数组中的第一个元素<br>2.count()返回数组中元素的个数<br>3.end()最后一个元素的值<br>4.explode() 函数使用一个字符串分割另一个字符串，并返回由字符串组成的数组。<br>接下来让我们逐个破解：<br>它先将file分割成一个个数组，假设为1.php<br>那么数组为file[0]=1 file[1]=php<br>为了绕过白名单限制，我们可以命名为1.php.jpg<br>接下来是.php最为后缀，1作为前缀变成新文件的文件名  这样好像可行？？<br>试试，不行诶，<br>再来思考一下：<br>1.count()返回数组中元素的个数 而数组从0开始，说明3-1返回的还是后缀，也就是一开始的jpg，这也就说明了为什么最后重新拼接过后的文件名不是我们设想中的123.php<br>那么该如何解决这个麻烦呢？<br>看到move_uploaded_file，使用/.截断试试，或者00截断<br>但是这个时候我们需要让他构造完后变成123.php/.jpg才会起到截断作用，但是我们知道有.就会被分割成数组，这时又该如何呢？<br>再代码以上看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$file = <span class="keyword">empty</span>($_POST[<span class="string">&#x27;save_name&#x27;</span>]) ? $_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : $_POST[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">       <span class="keyword">if</span> (!is_array($file)) &#123;</span><br><span class="line">           $file = explode(<span class="string">&#x27;.&#x27;</span>, strtolower($file));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>结合burpsuit<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210119232717.png" alt="img" style="zoom:67%;"><br>推测现在的file名字为这个save_name的值，如果我们直接 更改这个save_name为一个数组，那么file也会变成一个数组，这样就不会经过被分割的那个数组，处理恰当，也不会经过白名单，看来是不行，因为他选取的是file这个数组的最后一个元素并将其值直接赋值给ext，故这里的ext不可能再是一个数组，所以，数组最后的元素一定是jpg</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210119234308.png" alt="img" style="zoom:67%;">
但是还是不行？没有报错但却无事发生？？？说明上面是错的
再次调整，将0和1数组调换位置发现报错信息改变了，（这里说明数组要从大到小）变成是文件上传失败
这里尝试了几种组合方式得出：
加不加反斜杠都无所谓，只要为file[1]=0即可
必须先save_name[0]再save_name[2]
唯一不懂的点：
1.count不是返回数组数目吗，count算了一下有0 1 2 三个元素 那么3-1=2 那么返回的为什么是file[1]而不是2
截断上传漏洞原理：http://salt-neko.com/2019/10/27/%E6%88%AA%E6%96%AD%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/



<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210105224221.png" alt="img" style="zoom: 80%;">
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">vague huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2020/12/17/upload-labs1/">http://example.com/2020/12/17/upload-labs1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/12/24/postPython%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99%E7%9B%B2%E6%B3%A8%E8%84%9A%E6%9C%AC/"><i class="fa fa-chevron-left">  </i><span>Python编写盲注脚本</span></a></div><div class="next-post pull-right"><a href="/2020/12/17/sqlmap%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99%E5%AD%A6%E4%B9%A0/"><span>sqlmap学习</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>