<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="java_cc链小结"><meta name="keywords" content=""><meta name="author" content="vague huang"><meta name="copyright" content="vague huang"><title>java_cc链小结 | Tlife</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">vague huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">260</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Tlife</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">java_cc链小结</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-01-10</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>##前言<br>感觉自己最近越来越浮躁了，也没有静下心来好好分析点什么，所以这次打算好好整理一下之前学过的CC链</p>
<p>##总览</p>
<p>##CC1<br>1.适用版本：commons-collections 3.2.1<br>2.细节描述<br>在构造链子的过程中一般是倒着来看感觉会比较顺一点，所以我们从<code>InvokeTransform</code>来看：<br>在<code>InvokeTransform</code>中<code>transform</code>方法中实现了getMethod和invoke方法，刚好可以将我们的Runtime.exe那一段进行命令执行<br><img src="/.com//2023-01-08-15-05-44.png"><br>这里用了一个chainedTransform数组进行一个整体的transform起到简化代码的作用，接下来我们只需要寻找哪里调用了transform就可以，<br>可以看到，在<code>LazyMap</code>中的<code>get</code>方法中调用了<code>transform</code>，接下来关注一下这<code>factory</code>是如何传入的，可以发现，这边是LazyMap的构造方法，由于是protected，还需要使用反射的方式来进行赋值<br><img src="/.com//2023-01-08-15-22-53.png">但是再往下看，发现其<code>decorate</code>方法会直接返回一个LazyMap对象<br><img src="/.com//2023-01-08-15-24-47.png">，所以我们直接调用这个方法进行赋值就行了<br>具体赋值方式如下：<br><img src="/.com//2023-01-08-15-34-49.png"><br>接下来我们要看一下哪里调用了这个get，在annotationinvocationhandler的invoke方法中就调用了这个get，但是需要思考的是，如何触发这个invoke方法，这里我们回想一下php里面的__call方法，通过调用不存在的方法，就会调用到invoke方法中，那么接下来我们就只需要寻找符合条件的即可<code>这里需要注意的是，我们要使用无参的方法</code>，正好在readObject中就有一个符合条件的，但是要在其他类的内部进行这操作，我们需要借助代理<br><img src="/.com//2023-01-08-15-52-53.png"><br>因此赋值方式如下：<br>首先关注一下其构造方法，需要传入的类型，直接传入的话就会对我们需要的<code>memberValue</code>赋值了<br><img src="/.com//2023-01-08-16-05-46.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//反射调用AnnotationInvocationHandler类</span></span><br><span class="line">        Class&lt;?&gt; b= Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="comment">//获取其构造方法</span></span><br><span class="line">        Constructor annotationInvocationhdlconstructor=b.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationInvocationhdlconstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//实例化对象并进行赋值操作</span></span><br><span class="line">        InvocationHandler handler = (InvocationHandler) annotationInvocationhdlconstructor.newInstance(Override.class,Lazymap);</span><br><span class="line"><span class="comment">//实例化一个代理对象</span></span><br><span class="line">        Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">//在实例化一个annotationInvocationHadnler,里面装的是代理的内容，相当于是套了一个壳</span></span><br><span class="line">        Object o = annotationInvocationhdlconstructor.newInstance(Override.class,mapProxy);</span><br></pre></td></tr></table></figure>
<p><img src="/.com//2023-01-07-20-12-58.png"><br>另外一条cc1链比较简单，就不细讲了，</p>
<p>##CC6<br>1.适用版本：没有版本限制<br>在CC6中，主要是前半部分有区别，在调用到get部分采用的是<code>TiedMapEntry.hashCode</code>方法，因为在hashcode中会调用到getValue方法<br><img src="/.com//2023-01-09-13-47-33.png"><br>并且在getValue中会调用到get方法<br><img src="/.com//2023-01-09-14-14-10.png"><br>而这里是对map进行调用了，我们看看map是如何赋值的，直接构造方法穿参就可以了<br><img src="/.com//2023-01-09-14-14-38.png"><br>接下来就是寻找哪里有调用这个hashcode了，可以看到在HashMap的readObject中就有调用<br><img src="/.com//2023-01-09-14-16-28.png"><br>那么解析来就来看一下两处是如何赋值的：<br><code>TiedMapEntry.hashcode</code>就是采用直接赋值的形式就可以了，因为他有这个构造函数<br><img src="/.com//2023-01-09-15-17-54.png"><br>接下来就是赋值到hashmap里面去，因为，hashmap其实是一个键值对，前面是key，后面是value<br><img src="/.com//2023-01-09-16-33-24.png"><br>然后我们接下来就是对其赋值，但是在hashmap里面，要对其键值对进行赋值需要调用put函数，但是这还不够，由于在put的时候就有hash了<br><img src="/.com//2023-01-09-16-31-37.png"><br>也就是这里<br><img src="/.com//!%5B%5D(img/2023-01-09-19-24-58.png).png"><br>然后接下来他就会走一遍我们之前的链子了，那么这样会造成什么后果呢<br><img src="/.com//!%5B%5D(img/2023-01-09-20-49-10.png).png"><br>我们往下继续看一下，在反序列化的过程中，此时由于我们前面put过一次了，所以此时就contains那个key，那么就进不到这个transform里面，因此我们这条链就断了<br><img src="/.com//2023-01-09-20-53-19.png"><br>所以此时，我们首先需要将这个a给remove掉，在反序列化的时候才能进入<br><img src="/.com//2023-01-11-17-54-28.png"><br>ok，到这里我们捋一下</p>
<ul>
<li>由于在对map2进行put的赋值操作的时候，走到了get方法，此时说get方法就会判断是否还有key，因为是第一次走到这里，所以肯定是没有这个key的，那么就进入到transform中，并且进行了一个put的操作，此时这个hashmap就有了这个key了</li>
<li>针对以上问题，我们首先要在put以后将这个key给删掉，也就是使用上面的remove操作<br>接下来是第二个问题，如何解决序列化过程就命令执行这一问题，那么就是在一开始的先赋值一个不存在命令执行效果的<br><img src="/.com//2023-01-11-18-36-28.png"><br>然后再利用反射更改值<br><img src="/.com//2023-01-11-18-36-41.png"></li>
</ul>
<p>##cc3<br>1.invoketransform被过滤、需要调用字节码<br>2.代码执行—（动态类加载）<br>我们要使用<code>defineclass</code>调用字节码实现动态类加载以达到命令执行的目的，那么就需要找到一处有调用<code>newinstance</code>的<br>首先，我们找到的是<code>TemplatesImpl.newTransformer</code>里面有一个<code>getTransletInstance</code><br><img src="/.com//2023-01-12-16-06-47.png"><br>在这里面就有一个newInstance<br><img src="/.com//2023-01-12-16-08-18.png"><br>而这个newInstance前面调用的内容，来源于上面这个函数<br><img src="/.com//2023-01-12-16-42-15.png"><br>可以发现这里就实现了使用defineclass对<code>_class[i]</code>的赋值<br><img src="/.com//2023-01-12-16-43-01.png"><br>首先我们来看这一部分如何赋值：<br>在上面的代码中，我们发现，要到<code>newInstance</code>的位置，需要对__name 和__bytecodes（传入的字节码）进行赋值<br><img src="/.com//2023-01-12-16-44-10.png"><br>看看构造函数，发现是无参的，所以我们直接利用反射来更改值就行<br><img src="/.com//2023-01-12-16-21-31.png"><br>根据前面的分析，我们进行了一下的赋值<br><img src="/.com//2023-01-12-19-04-22.png"><br>但是此时还是无法成功命令执行<br><img src="/.com//2023-01-12-19-05-18.png"><br>因为在defineclass中，如果没有满足父类是<code>ABSTRACT_TRANSLET</code>则会报错<br><img src="/.com//2023-01-12-19-09-24.png"><br>因此，我们在前面些字节码的类中，还需要加上下面的extends<br><img src="/.com//2023-01-12-19-08-57.png"><br>此时才可以成功执行<br>而这部分内容，其实是我们为了在序列化的时候测试能否成功命令执行而加上去的<br><img src="/.com//2023-01-12-19-10-53.png"><br>这个_tfactory的属性是transient，是无法被序列化的，但是在readObject中会自动赋值，所以我们可以不用管<br><img src="/.com//2023-01-12-19-11-50.png"><br>前面的部分进行transform方法以后就可以实现命令执行了，接下来就只需要将后面的方法完善好就行，如果invoketansform还能用的话，直接进行以下方法的调用即可<br><img src="/.com//2023-01-12-19-15-21.png"></p>
<p>在cc3中，和前面两条链子最大的不同就是后半段，前面是适用invoketransform来进行命令执行的触发，这里需要对<code>invoketransform</code>进行一下解释，这个类，里面的tansform实现了getMethod和invoke方法，那就是可以反射调用任意的方法并执行，所以前面才说调用newTransformer和templatesImple就呼应上了，但是如果过滤了<code>invoketransform</code>，那么此时我们就要另外寻找调用了newTransformer的地方——<code>TrAXFilter</code>这个类<br>还有一种是利用<code>TrAXFilter</code>的构造方法<br><img src="/.com//2023-01-12-12-53-41.png"><br>在这里调用了newTransformer，所以我们直接对其构造函数进行赋值就行了，接下来就是找哪里有触发获取构造函数的位置，在<code>InstantiateTransformer</code>的<code>transform</code>中使用了<code>getConstructor</code><br><img src="/.com//2023-01-13-12-17-29.png"><br>跟进去可以发现，这里就会调用前面的<code>TrAXFilter</code>的构造方法，并对其赋值为<code>templatesImple</code><br><img src="/.com//2023-01-13-12-21-13.png"><br>接下来就看看如何对其进行赋值,这里参考一下<code>InstantiateTransformer</code>的构造函数以及参数就可以了<br><img src="/.com//2023-01-13-12-23-35.png"><br>cc3主要是梳理这些即可<br><img src="/.com//2023-01-13-19-19-31.png"></p>
<p>##cc4<br>1.版本：cc4<br><img src="/.com//2023-01-13-19-30-51.png"><br><img src="/.com//2023-01-13-19-31-17.png"></p>
<p>##cc2<br>1.这条cc链是没有用到数组的<br>然后这里的put我们跟一下，连同上面的cc4一起理解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InvokerTransformer&lt;Object,Object&gt; invokerTransformer = <span class="keyword">new</span> InvokerTransformer&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> Class[]&#123;&#125;,<span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">TransformingComparator transformingComparator = <span class="keyword">new</span> TransformingComparator&lt;&gt;(<span class="keyword">new</span> ConstantTransformer&lt;&gt;(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">priorityQueue.add(template);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先size要大于等于2，不然无法进入到siftDown，也就无法执行后续的链条了<br><img src="/.com//2023-01-13-20-44-39.png"><br>接下来是哪个部分放template的问题，可以发现如果是第一个元素是其他值，那么就会造成这里发生错误，因为1.getClass明显是有问题的<br><img src="/.com//2023-01-13-20-47-01.png"><br><img src="/.com//2023-01-13-20-48-03.png"></p>
<p>##cc5<br><img src="/.com//2023-01-13-20-12-48.png"></p>
<p>##cc7<br>往上调用equals，最后调用到父类的，然后转到get<br><img src="/.com//2023-01-13-20-16-00.png"></p>
<p>c</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">vague huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/01/10/java_cc链小结/">http://example.com/2023/01/10/java_cc链小结/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/01/12/javacc4/"><i class="fa fa-chevron-left">  </i><span>java-cc4、cc2、cc5、cc7</span></a></div><div class="next-post pull-right"><a href="/2023/01/09/javacc3/"><span>java-cc3</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By vague huang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>